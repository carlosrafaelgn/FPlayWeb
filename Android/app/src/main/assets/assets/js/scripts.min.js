'use strict';class Icon extends HTMLElement{static createHTML(a,b,c,d,e,f){return`<f-icon name="${a}"${b?' color="'+b+'"':""}${c?" large":""}${d?' class="'+d+'"':""}${e?' id="'+e+'"':""}${f?' sr-title="'+f+'"':""} />`}static create(a,b,c,d,e,f){const g=document.createElement("f-icon");g.name=a;b&&(g.color=b);c&&(g.large=c);d&&(g.className=d);e&&(g.id=e);f&&(g.srTitle=f);return g}constructor(){super();this._color=this._name=null;this._large=!1;this._use=this._svg=this._srTitleElement=this._srTitle=
null}get name(){return this._name}set name(a){null!==a?this.setAttribute("name",a):this.removeAttribute("name")}get color(){return this._color}set color(a){null!==a?this.setAttribute("color",a):this.removeAttribute("color")}get large(){return this._large}set large(a){a?this.setAttribute("large",""):this.removeAttribute("large")}get srTitle(){return this._srTitle}set srTitle(a){null!==a?this.setAttribute("sr-title",a):this.removeAttribute("sr-title")}connectedCallback(){if(!this._use){this._svg=document.createElementNS("http://www.w3.org/2000/svg",
"svg");this._use=document.createElementNS("http://www.w3.org/2000/svg","use");this._svg.ariaHidden="true";this._svg.appendChild(this._use);var a=this._name;a&&(this._name=null,this.attributeChangedCallback("name",null,a));if(a=this._color)this._color=null,this.attributeChangedCallback("color",null,a);this._large=!this._large;this.attributeChangedCallback("large",null,this._large?null:"");if(a=this._srTitle)this._srTitle=null,this.attributeChangedCallback("sr-title",null,a);this.appendChild(this._svg)}}attributeChangedCallback(a,
b,c){b=this._use;switch(a){case "name":if(this._name===c)break;this._name=c;if(!b)break;b.setAttribute("href","#"+c);break;case "color":if(this._color===c)break;if(!b){this._color=c;break}this._color&&this.classList.remove(this._color);(this._color=c)&&this.classList.add(c);break;case "large":a=null!==c;if(this._large===a)break;if(!b){this._large=a;break}this._large&&this.classList.remove("large");(this._large=a)&&this.classList.add("large");break;case "sr-title":this._srTitle!==c&&(this._srTitle=
c,b&&(c?this._srTitleElement?Strings.changeText(this._srTitleElement,c):(this._srTitleElement=Strings.createSrOnlyText(c),this.insertAdjacentElement("afterbegin",this._srTitleElement)):this._srTitleElement&&(this.removeChild(this._srTitleElement),this._srTitleElement=null)))}}}Icon.disabledFeatures=["shadow"];Icon.observedAttributes=["name","color","large","sr-title"];Icon.baseSizePX=12;customElements.define("f-icon",Icon);
class Strings{static toFixed(a,b){return a.toFixed(b)}static init(){Strings.comparer="Intl"in window&&Intl.Collator?(new Intl.Collator(void 0,{usage:"sort",sensitivity:"variant",numeric:!0})).compare:function(b,c){return b.localeCompare(c)};const a=App.hostInterface&&App.hostInterface.getBrowserLanguage()||navigator.userLanguage||navigator.language;a&&0===a.toLowerCase().indexOf("pt")&&(Strings.language="pt-br",document.documentElement.lang="pt-br",Strings.decimalSeparator=",",Strings.oppositeDecimalSeparator=
".",Strings.About="Sobre",Strings.Options="Op\u00e7\u00f5es",Strings.Edit="Edit",Strings.Delete="Excluir",Strings.DeleteSongs="Excluir m\u00fasicas",Strings.DeleteAllSongs="Excluir todas",Strings.Enable="Ativar",Strings.Disable="Desativar",Strings.Enabled="Ativado",Strings.Disabled="Desativado",Strings.Selected="Selecionado",Strings.AdvancedFilter="Filtro avan\u00e7ado",Strings.TraditionalFilter="Filtro tradicional",Strings.Missing="Faltando",Strings.MissingSongError="A m\u00fasica est\u00e1 faltando! \ud83d\ude22 Por favor, apenas adicione novamente a m\u00fasica antes de tocar. Quando voc\u00ea adiciona uma m\u00fasica que est\u00e1 faltando, ela fica na mesma posi\u00e7\u00e3o dentro da playlist! \ud83d\ude0a",
Strings.FileNotFoundOrNoPermissionError="O arquivo da m\u00fasica n\u00e3o foi encontrado ou n\u00e3o foi dada permiss\u00e3o de acesso a ele! \ud83d\ude22",Strings.NothingSelected="Nada foi selecionado! \ud83d\ude05",Strings.Cancel="Cancelar",Strings.Clear="Limpar",Strings.Back="Voltar",Strings.Close="Fechar",Strings.Refresh="Recarregar",Strings.Exit="Sair",Strings.Done="Conclu\u00eddo",Strings.Up="Acima",Strings.All="Tudo",Strings.Storage="Armazenamento",Strings.Previous="Anterior",Strings.Play=
"Tocar",Strings.Pause="Pausar",Strings.PlayPause="Tocar / Pausar",Strings.Stop="Parar",Strings.Next="Pr\u00f3xima",Strings.Seek="Buscar",Strings.Path="Caminho",Strings.PathLabel="Caminho: ",Strings.Title="T\u00edtulo",Strings.TitleLabel="T\u00edtulo: ",Strings.CurrentTitleLabel="T\u00edtulo atual: ",Strings.Album="\u00c1lbum",Strings.AlbumLabel="\u00c1lbum: ",Strings.CurrentAlbumLabel="\u00c1lbum atual: ",Strings.Artist="Artista",Strings.ArtistLabel="Artista: ",Strings.CurrentArtistLabel="Artista atual: ",
Strings.Duration="Dura\u00e7\u00e3o",Strings.DurationLabel="Dura\u00e7\u00e3o: ",Strings.Track="Faixa",Strings.TrackLabel="Faixa: ",Strings.Year="Ano",Strings.YearLabel="Ano: ",Strings.SampleRate="Taxa de amostragem",Strings.SampleRateLabel="Taxa de amostragem: ",Strings.Channels="Canais",Strings.ChannelsLabel="Canais: ",Strings.ShowInfo="Exibir informa\u00e7\u00f5es",Strings.SongInfo="Informa\u00e7\u00f5es da m\u00fasica",Strings.Search="Pesquisar",Strings.SearchResults="Resultados da pesquisa",
Strings.SearchPlaceholder="T\u00edtulo, artista, \u00e1lbum, ano ou caminho",Strings.NoSongPlaying="Nenhuma m\u00fasica tocando! \ud83d\ude05",Strings.Playlist="Playlist",Strings.FileList="Lista de arquivos",Strings.CurrentPathLabel="Caminho atual: ",Strings.Loading="Carregando",Strings.LoadingLabel="Carregando\u2026 ",Strings.LoadingCurrentPathLabel="Carregando camino atual: ",Strings.Folder="Pasta",Strings.FolderLabel="Pasta: ",Strings.LeftAbbrev="E",Strings.RightAbbrev="D",Strings.DownMixToMono=
"Fazer down-mix para mono",Strings.UnknownError="Algo saiu errado durante a reprodu\u00e7\u00e3o. \ud83d\ude22",Strings.Add="Adicionar",Strings.AddFiles="Adicionar arquivos",Strings.AddSongs="Adicionar m\u00fasicas",Strings.AddFolders="Adicionar pastas",Strings.AddMoreFolders="Adicionar mais pastas\u2026",Strings.ShowEffects="Exibir efeitos",Strings.ShowPlaylist="Exibir playlist",Strings.NoSongsInFolder="Nenhuma m\u00fasica na pasta. \ud83d\ude33",Strings.NoSongsFoundInPlaylist="Nenhuma m\u00fasica encontrada na playlist. \ud83d\ude33",
Strings.PlaylistControlEmptyMessage=`Utilize o bot\u00e3o \"${Strings.AddSongs}\" para adicionar m\u00fasicas \u00e0 playlist. \ud83d\ude0a`,Strings.UpdateAvailable="Atualiza\u00e7\u00e3o dispon\u00edvel!",Strings.PleaseRefresh="Por favor, recarregue a p\u00e1gina para atualizar a aplica\u00e7\u00e3o. \ud83d\ude0a",Strings.RGBMode="Modo RGB",Strings.AnimatedRGBMode="Modo RGB Animado",Strings.ExtraRGBMode="Modo RGB Extra",Strings.NeonMode="Modo Neon",Strings.AboutHTML='<p>FPlay Web \u00e9 um player de \u00e1udio experimental. \ud83d\ude0a</p>\n<p>Para mais informa\u00e7\u00f5es sobre o projeto, seu c\u00f3digo-fonte e depend\u00eancias, confira seu reposit\u00f3rio em <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb">github.com/carlosrafaelgn/FPlayWeb</a>.</p>\n<p>Este projeto \u00e9 licenciado sob a <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb/blob/master/LICENSE">MIT License</a>.</p>',
Strings.DeleteModeHTML="Clique as m\u00fasicas para exclu\u00ed-las.")}static translate(a){const b=Strings[a];return void 0!==b?b:a}static translateChildren(a){a=a.childNodes;for(let d=a.length-1;0<=d;d--){const e=a[d];if(!e.tagName)continue;e.childNodes&&e.childNodes.length&&Strings.translateChildren(e);let f;if(f=e.title)e.title=Strings.translate(f);if(f=e.dataset.string){delete e.dataset.string;var b=0;do{let g=f.indexOf(";",b);g<b&&(g=f.length);var c=f.indexOf("|",b);0>c||c>=g?e.appendChild(document.createTextNode(Strings.translate(f))):
(b=f.substring(b,c),c=f.substring(c+1,g),e[b]=Strings.translate(c));b=g+1}while(b<f.length)}}}static changeText(a,b){if(a){null===b&&(b="");var c=a.lastChild;c?c.nodeValue=b:a.appendChild(document.createTextNode(b))}}static createSrOnlyText(a){const b=document.createElement("span");b.className="sr-only";Strings.changeText(b,a);return b}static htmlEncode(a){return a?a.replace(Strings._regExpAmp,"&amp;").replace(Strings._regExpLT,"&lt;").replace(Strings._regExpGT,"&gt;"):""}static htmlEncodeValue(a){return a?
a.replace(Strings._regExpAmp,"&amp;").replace(Strings._regExpLT,"&lt;").replace(Strings._regExpGT,"&gt;").replace(Strings._regExpQuot,"&#34;").replace(Strings._regExpApos,"&#39;").replace(Strings._regExpGrave,"&#96;"):""}static removeDiacritics(a){return a?a.normalize("NFD").replace(Strings._regExpDiacritics,"").toLowerCase():""}}Strings._regExpAmp=/&/g;Strings._regExpLT=/</g;Strings._regExpGT=/>/g;Strings._regExpQuot=/"/g;Strings._regExpApos=/'/g;Strings._regExpGrave=/`/g;
Strings._regExpDiacritics=/[\u0300-\u036f]/g;Strings.language="en";Strings.decimalSeparator=".";Strings.oppositeDecimalSeparator=",";Strings.Oops="Oops\u2026";Strings.AppName="FPlay";Strings.Menu="Menu";Strings.About="About";Strings.Options="Options";Strings.Edit="Edit";Strings.Delete="Delete";Strings.DeleteSongs="Delete songs";Strings.DeleteAllSongs="Delete all";Strings.Enable="Enable";Strings.Disable="Disable";Strings.Enabled="Enabled";Strings.Disabled="Disabled";Strings.Selected="Selected";
Strings.AdvancedFilter="Advanced filter";Strings.TraditionalFilter="Traditional filter";Strings.Missing="Missing";Strings.MissingSongError="The song is missing! \ud83d\ude22 Please, just add it again before playing it. When you add a missing song, it keeps its position in the playlist! \ud83d\ude0a";Strings.FileNotFoundOrNoPermissionError="The song's file could not be found or the permission to access it was not granted! \ud83d\ude22";Strings.NothingSelected="Nothing selected! \ud83d\ude05";
Strings.OK="OK";Strings.Cancel="Cancel";Strings.Clear="Clear";Strings.Back="Back";Strings.Close="Close";Strings.Refresh="Refresh";Strings.Exit="Exit";Strings.Done="Done";Strings.Up="Up";Strings.All="All";Strings.Storage="Storage";Strings.Previous="Previous";Strings.Play="Play";Strings.Pause="Pause";Strings.PlayPause="Play / Pause";Strings.Stop="Stop";Strings.Next="Next";Strings.Seek="Seek";Strings.Path="Path";Strings.PathLabel="Path: ";Strings.Title="Title";Strings.TitleLabel="Title: ";
Strings.CurrentTitleLabel="Current title: ";Strings.Album="Album";Strings.AlbumLabel="Album: ";Strings.CurrentAlbumLabel="Current album: ";Strings.Artist="Artist";Strings.ArtistLabel="Artist: ";Strings.CurrentArtistLabel="Current artist: ";Strings.Duration="Duration";Strings.DurationLabel="Duration: ";Strings.Track="Track";Strings.TrackLabel="Track: ";Strings.Year="Year";Strings.YearLabel="Year: ";Strings.SampleRate="Sample rate";Strings.SampleRateLabel="Sample rate: ";Strings.Channels="Channels";
Strings.ChannelsLabel="Channels: ";Strings.ShowInfo="Show information";Strings.SongInfo="Song information";Strings.Search="Search";Strings.SearchResults="Search results";Strings.SearchPlaceholder="Title, artist, album, year or path";Strings.NoSongPlaying="No song playing! \ud83d\ude05";Strings.Playlist="Playlist";Strings.FileList="File list";Strings.CurrentPathLabel="Current path: ";Strings.Loading="Loading";Strings.LoadingLabel="Loading\u2026 ";Strings.LoadingCurrentPathLabel="Loading current path: ";
Strings.Folder="Folder";Strings.FolderLabel="Folder: ";Strings.LeftAbbrev="L";Strings.RightAbbrev="R";Strings.Volume="Volume";Strings.Panning="Panning";Strings.DownMixToMono="Down-mix to mono";Strings.UnknownError="Something went wrong during playback. \ud83d\ude22";Strings.Add="Add";Strings.AddFiles="Add files";Strings.AddSongs="Add songs";Strings.AddFolders="Add folders";Strings.AddMoreFolders="Add more folders\u2026";Strings.ShowEffects="Show effects";Strings.ShowPlaylist="Show playlist";
Strings.NoSongsInFolder="No songs in folder. \ud83d\ude33";Strings.NoSongsFoundInPlaylist="No songs found in the playlist. \ud83d\ude33";Strings.PlaylistControlEmptyMessage=`Use the \"${Strings.AddSongs}\" button to add songs to the playlist. \ud83d\ude0a`;Strings.UpdateAvailable="Update available!";Strings.PleaseRefresh="Please, refresh the page to update the app. \ud83d\ude0a";Strings.RGBMode="RGB Mode";Strings.AnimatedRGBMode="Animated RGB Mode";Strings.ExtraRGBMode="Extra RGB Mode";
Strings.NeonMode="Neon Mode";Strings.AboutHTML='<p>FPlay Web is an experimental audio player. \ud83d\ude0a</p>\n<p>For more information about the project, its source code and dependencies, check out its repository at <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb">github.com/carlosrafaelgn/FPlayWeb</a>.</p>\n<p>This project is licensed under the <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb/blob/master/LICENSE">MIT License</a>.</p>';
Strings.DeleteModeHTML="Click songs to delete them.";class DelayControl{static delayShortCB(a){return setTimeout(a,DelayControl.shortDelayMS)}static delayFadeCB(a){return setTimeout(a,DelayControl.fadeDelayMS)}static delayShort(){return new Promise(function(a){setTimeout(a,DelayControl.shortDelayMS)})}static delayFade(){return new Promise(function(a){setTimeout(a,DelayControl.fadeDelayMS)})}}DelayControl.shortDelayMS=50;DelayControl.fadeDelayMS=350;
class Formatter{static formatTimeMS(a){if(0>a)return Formatter.none;a=a/1E3|0;let b=(a/60|0)+":";a%=60;10>a&&(b+="0");return b+a}static formatTimeS(a){if(0>a)return Formatter.none;let b=(a/60|0)+":";a%=60;10>a&&(b+="0");return b+a}static formatDB(a){return 0>a?Strings.toFixed(a,1):0===a?"-"+Strings.toFixed(a,1):"+"+Strings.toFixed(a,1)}}Formatter.zero="0:00";Formatter.none="-";Formatter.noneInt=-1;
class FileUtils{static isTypeSupported(a){const b=a.lastIndexOf(".");if(0>b)return!1;a=a.substring(b);return FileUtils.supportedExtensions[a]||FileUtils.supportedExtensions[a.toLowerCase()]||!1}static urlOrPathToURL(a){return!a||a.startsWith(FileUtils.httpURLPrefix)||a.startsWith(FileUtils.fileURLPrefix)||a.startsWith(FileUtils.localURLPrefix)?a:FileUtils.pathToURL(a)}static pathToURL(a){return encodeURI(47===a.charCodeAt(0)?FileUtils.fileURLPrefix+a:FileUtils._fileURLPrefixWindows+a.replace(FileUtils._regExpSepWindows,
"/")).replace(FileUtils._regExpHash,"%23")}static nameFromLinuxPath(a){if(!a)return a;let b=a.lastIndexOf("/");return 0<=b?a.substring(b+1):a}}FileUtils.separator="\u0004";FileUtils.httpURLPrefix="http";FileUtils.fileURLPrefix="file://";FileUtils.localURLPrefix="local://";FileUtils._fileURLPrefixWindows="file:///";FileUtils._regExpSepWindows=/\\/g;FileUtils._regExpHash=/#/g;FileUtils.supportedExtensions={".aac":!0,".flac":!0,".mp3":!0,".ogg":!0,".wav":!0};
FileUtils.concatenatedSupportedExtensions=function(){let a="";for(let b in FileUtils.supportedExtensions)a=a?a+","+b:b;return a}();
class DataReader{constructor(a){this._arrayBuffer=a;this._dataView=new DataView(a);this._textDecoder=new TextDecoder("utf-8",{ignoreBOM:!0});this._position=0;this.length=a.byteLength}get position(){return this._position}get available(){return this.length-this._position}destroy(){zeroObject(this)}readInt8(){return this._dataView.getInt8(this._position++)}readUint8(){return this._dataView.getUint8(this._position++)}readInt16(){const a=this._dataView.getInt16(this._position,!0);this._position+=2;return a}readUint16(){const a=
this._dataView.getUint16(this._position,!0);this._position+=2;return a}readInt32(){const a=this._dataView.getInt32(this._position,!0);this._position+=4;return a}readFloat32(){const a=this._dataView.getFloat32(this._position,!0);this._position+=4;return a}readFloat64(){const a=this._dataView.getFloat64(this._position,!0);this._position+=8;return a}readString(){const a=this._dataView.getUint16(this._position,!0);this._position+=2;return a?this._textDecoder.decode(this._arrayBuffer.slice(this._position,
this._position+=a)):""}}
class DataWriter{constructor(a){this._capacity=a&&0<a?a:16384;this._arrayBuffer=new ArrayBuffer(this._capacity);this._dataView=new DataView(this._arrayBuffer);this._textEncoder=new TextEncoder;this._length=0}get trimmedArrayBuffer(){return this._arrayBuffer.slice(0,this._length)}get length(){return this._length}get capacity(){return this._capacity}destroy(){zeroObject(this)}ensureCapacity(a){a=this._length+a;a<=this._capacity||(a=new ArrayBuffer(a+(a>>2)),(new Uint8Array(a)).set(new Uint8Array(this._arrayBuffer)),this._arrayBuffer=
a,this._dataView=new DataView(this._arrayBuffer),this._capacity=a.byteLength)}writeInt8(a){this.ensureCapacity(1);this._dataView.setInt8(this._length++,a);return this}writeUint8(a){this.ensureCapacity(1);this._dataView.setUint8(this._length++,a);return this}writeInt16(a){this.ensureCapacity(2);this._dataView.setInt16(this._length,a,!0);this._length+=2;return this}writeUint16(a){this.ensureCapacity(2);this._dataView.setUint16(this._length,a,!0);this._length+=2;return this}writeInt32(a){this.ensureCapacity(4);
this._dataView.setInt32(this._length,a,!0);this._length+=4;return this}writeFloat32(a){this.ensureCapacity(4);this._dataView.setFloat32(this._length,a,!0);this._length+=4;return this}writeFloat64(a){this.ensureCapacity(8);this._dataView.setFloat64(this._length,a,!0);this._length+=8;return this}writeString(a){if(!a)return this.writeInt16(0);this.ensureCapacity(2+6*a.length);a=this._textEncoder.encodeInto(a,new Uint8Array(this._arrayBuffer,this._length+2));if(!a.written)throw Error("String encoding error");
if(65535<a.written)throw Error("String too large");this._dataView.setUint16(this._length,a.written,!0);this._length+=2+a.written;return this}}var MetadataFlags;(function(a){a[a.None=0]="None";a[a.Seekable=1]="Seekable"})(MetadataFlags||(MetadataFlags={}));class ResizeableBuffer{constructor(a){this.buffer=new Uint8Array(a)}resizeCapacity(a){a<=this.buffer.length||(a=new Uint8Array(a),a.set(this.buffer),this.buffer=a)}}class BufferedReader{constructor(a){this.totalLength=a}}
BufferedReader.minBufferLength=65536;
class BufferedFileReader extends BufferedReader{get bufferAvailable(){return this._bufferAvailable}get bufferLength(){return this._buffer.length}get readPosition(){return this._position-this._bufferAvailable}get eof(){return this._eof}constructor(a,b){super(a.size);if(b.length<BufferedReader.minBufferLength)throw Error("Buffer length too small: "+b.length);this._file=a;this._buffer=b;this._bufferAvailable=this._bufferPosition=this._position=0;this._eof=!1}seekTo(a){if(0>a)throw Error("Invalid position");
this._bufferAvailable=this._bufferPosition=0;a>=this.totalLength?(this._position=this.totalLength,this._eof=!0):(this._position=a,this._eof=!1)}skip(a){0>=a||(a>=this._bufferAvailable?(a-=this._bufferAvailable,this._position+=a,this._position>=this.totalLength&&(this._position=this.totalLength,this._eof=!0),this._bufferAvailable=this._bufferPosition=0):(this._bufferPosition+=a,this._bufferAvailable-=a))}fillBuffer(a){if(0>=a)a=this._buffer.length;else if(0>a||a>this._buffer.length)throw Error("Invalid length");
const b=this._bufferAvailable;if(a<=b||this._eof)return null;a=this._buffer.length;b&&this._bufferPosition&&(this._buffer.copyWithin(0,this._bufferPosition,this._bufferPosition+b),this._bufferPosition=0);a-=b;return new Promise((c,d)=>{this._file.slice(this._position,this._position+a).arrayBuffer().then(e=>{e.byteLength?(this._position+=e.byteLength,this._position>=this.totalLength&&(this._position=this.totalLength,this._eof=!0),this._bufferAvailable+=e.byteLength):this._eof=!0;this._buffer.set(new Uint8Array(e),
b);c()},d)})}readByte(){if(!this._bufferAvailable)return-1;this._bufferAvailable--;return this._buffer[this._bufferPosition++]}readUInt32BE(){if(4>this._bufferAvailable)return null;this._bufferAvailable-=4;return this._buffer[this._bufferPosition++]<<24|this._buffer[this._bufferPosition++]<<16|this._buffer[this._bufferPosition++]<<8|this._buffer[this._bufferPosition++]}readUInt32LE(){if(4>this._bufferAvailable)return null;this._bufferAvailable-=4;return this._buffer[this._bufferPosition++]|this._buffer[this._bufferPosition++]<<
8|this._buffer[this._bufferPosition++]<<16|this._buffer[this._bufferPosition++]<<24}readUInt16BE(){if(2>this._bufferAvailable)return null;this._bufferAvailable-=2;return this._buffer[this._bufferPosition++]<<8|this._buffer[this._bufferPosition++]}readUInt16LE(){if(2>this._bufferAvailable)return null;this._bufferAvailable-=2;return this._buffer[this._bufferPosition++]|this._buffer[this._bufferPosition++]<<8}read(a,b,c){if(0>c)throw Error("Invalid length");const d=this._bufferAvailable;if(c<=d)return a.set(this._buffer.subarray(this._bufferPosition,
this._bufferPosition+=c),b),this._bufferAvailable-=c,this._bufferAvailable||(this._bufferPosition=0),c;let e=0;d&&(a.set(this._buffer.subarray(this._bufferPosition,this._bufferPosition+d),b),e+=d,b+=d,c-=d,this._bufferAvailable=this._bufferPosition=0);return this._eof?e:new Promise((f,g)=>{this._file.slice(this._position,this._position+c).arrayBuffer().then(h=>{h.byteLength?(this._position+=h.byteLength,this._position>=this.totalLength&&(this._position=this.totalLength,this._eof=!0)):this._eof=!0;
a.set(new Uint8Array(h),b);f(h.byteLength+e)},g)})}}
class MetadataExtractor{static async extractRIFF(a,b,c){if(44>b.totalLength)return null;var d=b.readUInt32LE();if(null===d||b.totalLength<8+d)return null;var e=d;let f=!1,g=!1,h=d=0,k=0;a:for(;0<e;){var n=!1,m=0,l=void 0;switch(b.readUInt32BE()){case null:break a;case 1463899717:n=!0;e-=4;break;case 1279873876:m=b.readUInt32LE();if(null===m)break a;e-=8;if(0>m||m>e)break a;break;case 1768174368:m=b.readUInt32LE();if(null===m)break a;e-=8;if(0>m||m>e)break a;(l=b.fillBuffer(1024))&&await l;if(4<m){n=
b.readByte();var p=b.readByte();l=b.readByte();if(null===n||null===p||null===l)break a;e-=3;m-=3;if(73===n||68===p||51===l)if(d=b.totalLength-e,f&&g){d=-1;break a}}b.skip(m);(l=b.fillBuffer(1024))&&await l;continue;default:m=b.readUInt32LE();if(null===m)break a;e-=8;if(0>m||m>e)break a;b.skip(m);(l=b.fillBuffer(1024))&&await l;continue}for((l=b.fillBuffer(1024))&&await l;n&&(!f||!g)||0<m;){var r=b.readUInt32BE();p=0;if(null===r)break a;e-=4;m-=4;if(1229866575!==r){p=b.readUInt32LE();if(null===p||
0>p||p>e||!n&&p>m)break a;e-=4;m-=4}1684108385!==r&&(l=b.fillBuffer(Math.min(264,8+p)))&&await l;switch(r){case 1718449184:if(!n)break;l=b.readUInt16LE();r=b.readUInt16LE();var q=b.readUInt32LE(),t=b.readUInt32LE();const u=b.readUInt16LE(),y=b.readUInt16LE();p-=16;e-=16;m-=16;if(null===l||null===r||null===q||null===t||null===u||null===y)break a;f=!0;k||(k=t);a.sampleRate=q;a.channels=r;break;case 1684108385:n&&(g=!0,h||(h=p));break;case 1229866575:function w(v){b.read(c,0,v);return MetadataExtractor.finishReadingV2Frame(0,
v,c)}for(;0<m;){if(4>m){b.skip(m);(l=b.fillBuffer(8))&&await l;break}(l=b.fillBuffer(8))&&await l;r=b.readUInt32BE();e-=4;m-=4;if(null===r)break a;q=b.readUInt32LE();e-=4;m-=4;if(null===q||0>q||q>m)b.skip(m),e-=m,m=0;else if(1>=q)b.skip(q),e-=q,m-=q;else{t=Math.min(257,q)-1;(l=b.fillBuffer(t))&&await l;switch(r){case 1229865293:a.title=w(t);break;case 1230000708:a.album=w(t);break;case 1229017684:a.artist=w(t);break;case 1229148740:a.year=parseInt(w(t))||0;break;case 1230262859:a.track=parseInt(w(t))||
0;break;default:t=0}b.skip(q-t);e-=q;m-=q}}}0<p&&(b.skip(p),e-=p,m-=p);e&&(l=b.fillBuffer(8))&&await l}}return f&&g?(d&&(0<d&&b.seekTo(d),(e=b.fillBuffer(1024))&&await e),a.lengthMS=Math.floor(1E3*h/k),[a,!!d]):null}static finishReadingV2Frame(a,b,c){let d=0;var e=b-1;a:for(;0<b;)switch(c[d]){case 0:case 9:case 10:case 11:case 12:case 13:case 32:case 133:case 160:b--;d++;break;default:break a}a:for(;0<b;)switch(c[e]){case 0:case 9:case 10:case 11:case 12:case 13:case 32:case 133:case 160:b--;e--;
break;default:break a}e=null;switch(a){case 1:case 2:if(b&1&&d+b<c.length&&b++,2<=b&&1===a&&(254===c[d]&&255===c[d+1]?(a=2,d+=2,b-=2):255===c[d]&&254===c[d+1]&&(d+=2,b-=2),!b))return null}switch(a){case 0:e=MetadataExtractor.textDecoderIso88591.decode(c.subarray(d,d+b));break;case 1:e=MetadataExtractor.textDecoderUtf16.decode(c.subarray(d,d+b));break;case 2:e=MetadataExtractor.textDecoderUtf16be.decode(c.subarray(d,d+b));break;case 3:e=MetadataExtractor.textDecoderUtf8.decode(c.subarray(d,d+b))}return e&&
e.length?e:null}static readV2Frame(a,b,c){if(2>b)return a.skip(b),null;const d=a.readByte();b--;if(0>d||3<d)return a.skip(b),null;c.resizeCapacity(b);const e=c.buffer;a=a.read(e,0,b);return"number"===typeof a?MetadataExtractor.finishReadingV2Frame(d,a,e):a.then(function(f){return MetadataExtractor.finishReadingV2Frame(d,f,e)})}static async extractID3v1(a,b,c,d){try{b.seekTo(b.totalLength-128);const g=b.read(d,0,128);"number"!==typeof g&&await g;if(84==d[0]&&65==d[1]&&71==d[2]){var e;if(!(c&MetadataExtractor.TITLE_B)){var f=
3;for(e=0;30>e&&d[f];)e++,f++;e&&(a.title=MetadataExtractor.textDecoderIso88591.decode(d.subarray(3,3+e)))}if(!(c&MetadataExtractor.ARTIST_B)){f=33;for(e=0;30>e&&d[f];)e++,f++;e&&(a.artist=MetadataExtractor.textDecoderIso88591.decode(d.subarray(33,33+e)))}if(!(c&MetadataExtractor.ALBUM_B)){f=63;for(e=0;30>e&&d[f];)e++,f++;e&&(a.album=MetadataExtractor.textDecoderIso88591.decode(d.subarray(63,63+e)))}if(!(c&MetadataExtractor.YEAR_B)){f=93;for(e=0;4>e&&d[f];)e++,f++;e&&(a.year=parseInt(MetadataExtractor.textDecoderIso88591.decode(d.subarray(93,
93+e))))}c&MetadataExtractor.TRACK_B||d[125]||!d[126]||(a.track=d[126]&255)}}catch(g){}}static async extractSampleRateAndChannels(a,b,c,d){try{b.seekTo(c);c=4092;var e=b.fillBuffer(c+4);e&&await e;for(e=0;0<=c;){const f=b.readByte();if(0>f)break;if(f){255===f&&(e=f<<24|b.readByte()<<16|b.readByte()<<8|b.readByte());break}c--}if(d){if(e&&4095===(e>>20&4095)&&(b=e>>10&15,!(13<=b))){switch(b){case 0:a.sampleRate=96E3;break;case 1:a.sampleRate=88200;break;case 2:a.sampleRate=64E3;break;case 3:a.sampleRate=
48E3;break;case 4:a.sampleRate=44100;break;case 5:a.sampleRate=32E3;break;case 6:a.sampleRate=24E3;break;case 7:a.sampleRate=22050;break;case 8:a.sampleRate=16E3;break;case 9:a.sampleRate=12E3;break;case 10:a.sampleRate=11025;break;case 11:a.sampleRate=8E3;break;default:a.sampleRate=7350}e=e>>6&7;switch(e){case 0:a.channels=2;break;case 7:a.channels=8;break;default:a.channels=e}}}else if(e&&2047===(e>>21&2047)&&(b=e>>19&3,1!==b&&(d=e>>10&3,3!==d))){switch(b){case 0:switch(d){case 0:a.sampleRate=11025;
break;case 1:a.sampleRate=12E3;break;case 2:a.sampleRate=8E3}break;case 2:switch(d){case 0:a.sampleRate=22050;break;case 1:a.sampleRate=24E3;break;case 2:a.sampleRate=16E3}break;case 3:switch(d){case 0:a.sampleRate=44100;break;case 1:a.sampleRate=48E3;break;case 2:a.sampleRate=32E3}}a.channels=3===(e>>6&3)?1:2}}catch(f){}}static async extractID3v2Andv1(a,b,c,d,e,f){const g=MetadataExtractor.createBasicMetadata(a);g.url?g.url.startsWith(FileUtils.localURLPrefix)&&(g.file=a):(g.file=a,g.fileSize=a.size,
g.fileName=a.name);a=0;var h=b.readByte()<<24|b.readByte()<<16|b.readByte()<<8;if(1229206272!==h)if(h|=b.readByte(),1380533830===h){e=!1;h=await MetadataExtractor.extractRIFF(g,b,c.buffer);if(!h)return null;if(!h[1])return g;g.lengthMS&&(a|=MetadataExtractor.LENGTH_B)}else return e&&await MetadataExtractor.extractSampleRateAndChannels(g,b,0,d),await MetadataExtractor.extractID3v1(g,b,0,c.buffer),g;var k=b.readByte(),n=b.readByte();h=b.readByte();var m=b.readByte(),l=b.readByte();const p=b.readByte(),
r=b.readByte();h=(h&16?10:0)+(r&127|(p&127)<<7|(l&127)<<14|(m&127)<<21);m=10+h;if(2<(k&255)||n){for(;0<h&&a!==MetadataExtractor.ALL_B;){(k=b.fillBuffer(1024))&&await k;n=b.readUInt32BE();k=b.readUInt32BE();b.skip(2);if(!n||0>=k||k>h)break;switch(n){case 1414091826:a&MetadataExtractor.TITLE_B?b.skip(k):(n=MetadataExtractor.readV2Frame(b,k,c),g.title=n&&n.then?await n:n,g.title&&(a|=MetadataExtractor.TITLE_B));break;case 1414546737:a&MetadataExtractor.ARTIST_B?b.skip(k):(n=MetadataExtractor.readV2Frame(b,
k,c),g.artist=n&&n.then?await n:n,g.artist&&(a|=MetadataExtractor.ARTIST_B));break;case 1413565506:a&MetadataExtractor.ALBUM_B?b.skip(k):(n=MetadataExtractor.readV2Frame(b,k,c),g.album=n&&n.then?await n:n,g.album&&(a|=MetadataExtractor.ALBUM_B));break;case 1414677323:a&MetadataExtractor.TRACK_B?b.skip(k):(n=MetadataExtractor.readV2Frame(b,k,c),g.track=n&&n.then?parseInt(await n):parseInt(n),g.track?a|=MetadataExtractor.TRACK_B:g.track=0);break;case 1414284622:a&MetadataExtractor.LENGTH_B?b.skip(k):
(n=MetadataExtractor.readV2Frame(b,k,c),g.lengthMS=n&&n.then?parseInt(await n):parseInt(n),g.lengthMS?a|=MetadataExtractor.LENGTH_B:g.lengthMS=0);break;case 1415136594:case 1413763651:a&MetadataExtractor.YEAR_B?b.skip(k):(n=MetadataExtractor.readV2Frame(b,k,c),g.year=n&&n.then?parseInt(await n):parseInt(n),g.year?a|=MetadataExtractor.YEAR_B:g.year=0);break;case 1095780675:if(f){(n=b.fillBuffer(-1))&&await n;n=0;b.skip(1);n++;l=b.readByte();for(n++;0<l;)l=b.readByte(),n++;b.skip(1);n++;l=b.readByte();
for(n++;0<l;)l=b.readByte(),n++;l=new Uint8Array(k-n);n=await b.read(l,0,l.length);n===l.length&&(g.albumArt=l)}else b.skip(k);break;default:b.skip(k)}h-=10+k}e&&await MetadataExtractor.extractSampleRateAndChannels(g,b,m,d);(a&MetadataExtractor.ALL_BUT_LENGTH_B)!==MetadataExtractor.ALL_BUT_LENGTH_B&&await MetadataExtractor.extractID3v1(g,b,a,c.buffer)}return g}static createBasicMetadata(a){return{url:FileUtils.urlOrPathToURL(a["data-path"])||"",flags:MetadataFlags.Seekable}}static async extract(a,
b,c,d=!1){if(!a)return null;b||(b=new Uint8Array(BufferedReader.minBufferLength));c||(c=new ResizeableBuffer(2048));let e=!1;if(!a.name.endsWith(".mp3")&&!(e=a.name.endsWith(".aac"))&&!a.name.endsWith(".wav")){if(a.name.endsWith(".flac"))return FLACMetadataExtractor.extract(a,b,c,d);if(a.name.endsWith(".ogg"))return OggMetadataExtractor.extract(a,b,c,d);const f=a.name.toLowerCase();if(!f.endsWith(".mp3")&&!(e=f.endsWith(".aac"))&&!f.endsWith(".wav"))return f.endsWith(".flac")?FLACMetadataExtractor.extract(a,
b,c,d):f.endsWith(".ogg")?OggMetadataExtractor.extract(a,b,c,d):null}try{const f=new BufferedFileReader(a,b);await f.fillBuffer(-1);return await MetadataExtractor.extractID3v2Andv1(a,f,c,e,!0,d)}catch(f){return null}}}MetadataExtractor.ALL_B=63;MetadataExtractor.ALL_BUT_LENGTH_B=31;MetadataExtractor.TITLE_B=1;MetadataExtractor.ARTIST_B=2;MetadataExtractor.ALBUM_B=4;MetadataExtractor.TRACK_B=8;MetadataExtractor.YEAR_B=16;MetadataExtractor.LENGTH_B=32;MetadataExtractor.textDecoderIso88591=new TextDecoder("iso-8859-1");
MetadataExtractor.textDecoderUtf16=new TextDecoder("utf-16");MetadataExtractor.textDecoderUtf16be=new TextDecoder("utf-16be");MetadataExtractor.textDecoderUtf8=new TextDecoder("utf-8");function decodeBase64(a){return 65<=a&&90>=a?a-65:97<=a&&122>=a?a-97+26:48<=a&&57>=a?a-48+52:43===a?62:63}
class VorbisCommentExtractor extends MetadataExtractor{static async extractVorbisComment(a,b,c,d,e){var f=c.fillBuffer(1024);f&&await f;var g=c.readUInt32LE();a-=4;if(!g||g>a)return!1;c.skip(g);a-=g;if(!a)return!0;(f=c.fillBuffer(1024))&&await f;g=c.readUInt32LE();a-=4;if(null===g||0>a||g>a)return!1;let h=null,k=null,n=null;for(;0<g;){g--;(f=c.fillBuffer(4))&&await f;const p=c.readUInt32LE();a-=4;if(null===p||0>a||p>a)return!1;var m=Math.min(2048,p);d.resizeCapacity(m);var l=d.buffer;(f=c.fillBuffer(m+
4))&&await f;c.read(l,0,m);f=m;a-=p;try{let r;for(r=0;r<m;r++)if(61===l[r]){if(r&&r<m-1){let q;switch(MetadataExtractor.textDecoderUtf8.decode(l.subarray(0,r)).normalize().trim().toUpperCase()){case "TITLE":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())b.title=q;break;case "ARTIST":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())b.artist=b.artist?b.artist+(", "+q):q;break;case "PERFORMER":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+
1,m)).normalize().trim())h=q;break;case "ALBUMARTIST":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())k=q;break;case "COMPOSER":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())n=q;break;case "ALBUM":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())b.album=q;break;case "TRACKNUMBER":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())b.track=parseInt(q)||0;break;
case "DATE":if(q=MetadataExtractor.textDecoderUtf8.decode(l.subarray(r+1,m)).normalize().trim())b.year=parseInt(q)||0;break;case "METADATA_BLOCK_PICTURE":if(e&&!b.albumArt){const t=new Uint8Array(p-r-1),u=l.subarray(r+1,m);t.set(u);p>f&&(await c.read(t,u.length,p-f),f=p);let y=t.length;if(y&3)break;m=3*(y>>>2);l=0;61===t[y-2]?(y-=4,l=1,m-=2):61===t[y-1]&&(y-=4,l=2,m--);if(32>m)break;if(decodeBase64(t[0])||decodeBase64(t[1])||decodeBase64(t[2])||decodeBase64(t[3])||decodeBase64(t[4])||48!==(decodeBase64(t[5])&
48))break;let w=4,v=3;for(;w<y;w+=4,v+=3){const A=decodeBase64(t[w]),z=decodeBase64(t[w+1]),B=decodeBase64(t[w+2]),D=decodeBase64(t[w+3]);t[v]=(A<<2)+((z&48)>>>4);t[v+1]=((z&15)<<4)+((B&60)>>>2);t[v+2]=((B&3)<<6)+D}if(1===l){const A=decodeBase64(t[w]),z=decodeBase64(t[w+1]);t[v]=(A<<2)+((z&48)>>>4)}else if(2===l){const A=decodeBase64(t[w]),z=decodeBase64(t[w+1]),B=decodeBase64(t[w+2]);t[v]=(A<<2)+((z&48)>>>4);t[v+1]=((z&15)<<4)+((B&60)>>>2)}l=4;if(l+4>=m)break;const x=t[l++]<<24|t[l++]<<16|t[l++]<<
8|t[l++];l+=x;if(l+4>=m)break;const E=t[l++]<<24|t[l++]<<16|t[l++]<<8|t[l++];l+=E;if(l+4>=m)break;l+=16;if(l+4>=m)break;const C=t[l++]<<24|t[l++]<<16|t[l++]<<8|t[l++];l+C>m||(b.albumArt=t.subarray(l,l+C))}}}break}}catch(r){}p>f&&c.skip(p-f)}b.artist||(h?b.artist=h:k?b.artist=k:n&&(b.artist=n));return!0}}
class FLACMetadataExtractor extends VorbisCommentExtractor{static readHeaderAndStreamInfo(a,b,c){if(1716281667!==b.readUInt32BE())return 0;var d=b.readUInt32BE();if(!d)return 0;c=d&2147483648;if(34!==(d&2147483647))return 0;b.skip(10);d=b.readUInt32BE();let e=b.readUInt32BE();if(!d||null===e)return 0;b.skip(16);e+=4294967296*(d&15);d>>=4;b=(d&31)+1;d>>=5;const f=(d&7)+1;d>>=3;if(4>b||!d)return 0;e&&(a.lengthMS=Math.floor(1E3*e/d));a.sampleRate=d;a.channels=f;return c?-1:1}static async readMetadataBlock(a,
b,c,d){var e=b.fillBuffer(4);e&&await e;e=b.readUInt32BE();if(!e)return 0;const f=e&2147483648;e&=2147483647;const g=e>>24;e&=16777215;if(127===g||e+b.readPosition>b.totalLength)return 0;if(4===g)return await VorbisCommentExtractor.extractVorbisComment(e,a,b,c,d)?-2:0;if(6===g&&d){(c=b.fillBuffer(4))&&await c;c=b.readUInt32BE();if(null===c)return 0;if(3!==c)return b.skip(e-4),1;(c=b.fillBuffer(-1))&&await c;e=b.readUInt32BE();if(null===e)return 0;b.skip(e);e=b.readUInt32BE();if(null===e)return 0;
b.skip(e);if(null===b.readUInt32BE()||null===b.readUInt32BE()||null===b.readUInt32BE()||null===b.readUInt32BE())return 0;e=b.readUInt32BE();if(null===e)return 0;e=new Uint8Array(e);await b.read(e,0,e.length)===e.length&&(a.albumArt=e);return-3}b.skip(e);return f?-1:1}static async extract(a,b,c,d){try{const e=new BufferedFileReader(a,b);await e.fillBuffer(-1);const f=MetadataExtractor.createBasicMetadata(a);let g=FLACMetadataExtractor.readHeaderAndStreamInfo(f,e,c.buffer);if(!g)return null;if(0>g)return f;
if(d){b=a=!1;do{g=await FLACMetadataExtractor.readMetadataBlock(f,e,c,d);if(!g)return null;-2===g?(g=1,a=!0):-3===g&&(g=1,b=!0);if(a&&b)break}while(0<g)}else{do if(g=await FLACMetadataExtractor.readMetadataBlock(f,e,c,d),!g)return null;while(0<g)}return f}catch(e){return null}}}
class OggBufferedReader extends BufferedFileReader{constructor(a,b){super(a,b);this._additionalSkipLength=this._currentPageLength=0}readPageLength(){if(super.bufferAvailable<OggBufferedReader._basicPageStructureLength||1332176723!==super.readUInt32BE())return-1;super.skip(22);let a=super.readByte();if(super.bufferAvailable<a)return-1;if(!a)return 0;let b=0;for(;0<a--;)b+=super.readByte();return b}async findInitialVorbisCommentPage(a){for(;;){var b=super.fillBuffer(OggBufferedReader._maximumOggPageHeaderLength+
OggBufferedReader._vorbisIdentifierLength);b&&await b;b=this.readPageLength();if(0>b)return!1;if(b)if(b>OggBufferedReader._vorbisIdentifierLength){if(super.bufferAvailable<OggBufferedReader._vorbisIdentifierLength)return!1;var c=super.readByte();if(0>c)return!1;var d=void 0;switch(c){case 1:c=super.readUInt32BE();d=super.readUInt16BE();if(1987015266===c&&26995===d){this._currentPageLength=b-7;(c=this.fillBuffer(9))&&await c;super.skip(4);c=super.readByte();d=super.readUInt32LE();if(0>c||!d)return!1;
a.channels=c;a.sampleRate=d;this._currentPageLength=b-16;super.skip(b-16);continue}super.skip(b-7);break;case 3:c=super.readUInt32BE();d=super.readUInt16BE();if(1987015266===c&&26995===d)return this._currentPageLength=b-7,(a=this.fillBuffer(this._currentPageLength))&&await a,!0;super.skip(b-7);break;default:super.skip(b-1)}}else super.skip(b)}}seekTo(a){throw Error("Unsupported operation");}skip(a){if(!(0>=a)){if(0<this._additionalSkipLength)this._additionalSkipLength+=a;else{if(a<=this._currentPageLength){this._currentPageLength-=
a;super.skip(a);return}this._additionalSkipLength=a-this._currentPageLength;super.skip(this._currentPageLength);this._currentPageLength=0}for(;super.bufferAvailable>OggBufferedReader._maximumOggPageHeaderLength;){this._currentPageLength=this.readPageLength();if(0>this._currentPageLength){super.skip(this.totalLength);break}if(this._currentPageLength){if(this._additionalSkipLength<=this._currentPageLength){this._currentPageLength-=this._additionalSkipLength;super.skip(this._additionalSkipLength);this._additionalSkipLength=
0;break}this._additionalSkipLength-=this._currentPageLength;super.skip(this._currentPageLength);this._currentPageLength=0}}}}async skipAdditionalSkipLength(){for(;0<this._additionalSkipLength;){let a=super.fillBuffer(OggBufferedReader._maximumOggPageHeaderLength+OggBufferedReader._maximumOggPageHeaderLength+4);a&&await a;if(!this._currentPageLength&&!this.readNextPageLength()){this._additionalSkipLength=0;break}if(this._additionalSkipLength<=this._currentPageLength){this._currentPageLength-=this._additionalSkipLength;
super.skip(this._additionalSkipLength);this._additionalSkipLength=0;(a=super.fillBuffer(OggBufferedReader._maximumOggPageHeaderLength+OggBufferedReader._maximumOggPageHeaderLength+4))&&await a;break}this._additionalSkipLength-=this._currentPageLength;super.skip(this._currentPageLength);this._currentPageLength=0}}readNextPageLength(){for(;super.bufferAvailable>OggBufferedReader._maximumOggPageHeaderLength;){this._currentPageLength=this.readPageLength();if(0>this._currentPageLength){super.skip(this.totalLength);
break}if(this._currentPageLength){if(!super.bufferAvailable)break;return!0}}return!1}fillBuffer(a){if(0<this._additionalSkipLength)return this.skipAdditionalSkipLength().then(()=>this.fillBuffer(a));const b=super.fillBuffer(Math.min(a+OggBufferedReader._maximumOggPageHeaderLength+OggBufferedReader._maximumOggPageHeaderLength+4,super.bufferLength));if(b)return b.then(()=>this.fillBuffer(a));this._currentPageLength||this.readNextPageLength();return null}readByte(){if(!this._currentPageLength&&!this.readNextPageLength())return-1;
this._currentPageLength--;return super.readByte()}readUInt32BE(){if(4<=this._currentPageLength)return this._currentPageLength-=4,super.readUInt32BE();const a=this.readByte(),b=this.readByte(),c=this.readByte(),d=this.readByte();return 0>a||0>b||0>c||0>d?null:a<<24|b<<16|c<<8|d}readUInt32LE(){if(4<=this._currentPageLength)return this._currentPageLength-=4,super.readUInt32LE();const a=this.readByte(),b=this.readByte(),c=this.readByte(),d=this.readByte();return 0>a||0>b||0>c||0>d?null:a|b<<8|c<<16|d<<
24}readUInt16BE(){if(2<=this._currentPageLength)return this._currentPageLength-=2,super.readUInt16BE();const a=this.readByte(),b=this.readByte();return 0>a||0>b?null:a<<8|b}readUInt16LE(){if(2<=this._currentPageLength)return this._currentPageLength-=2,super.readUInt16LE();const a=this.readByte(),b=this.readByte();return 0>a||0>b?null:a|b<<8}async readAsync(a,b,c,d,e){if("number"!==typeof a&&(a=await a,0>=a))return e;d-=a;this._currentPageLength-=a;c+=a;for(e+=a;0<d&&!super.eof;){if(!this._currentPageLength&&
(this.bufferAvailable<OggBufferedReader._maximumOggPageHeaderLength&&await super.fillBuffer(OggBufferedReader._maximumOggPageHeaderLength+OggBufferedReader._maximumOggPageHeaderLength+4),!this.readNextPageLength()))return e;a=super.read(b,c,Math.min(d,this._currentPageLength));"number"!==typeof a&&(a=await a);if(0>=a)break;d-=a;this._currentPageLength-=a;c+=a;e+=a}this._currentPageLength||(this.bufferAvailable<OggBufferedReader._maximumOggPageHeaderLength&&await super.fillBuffer(OggBufferedReader._maximumOggPageHeaderLength+
OggBufferedReader._maximumOggPageHeaderLength+4),this.readNextPageLength());return e}read(a,b,c){if(0<this._additionalSkipLength)return this.skipAdditionalSkipLength().then(()=>this.read(a,b,c));let d=0;for(;0<c&&!super.eof;){if(!this._currentPageLength){if(this.bufferAvailable<OggBufferedReader._maximumOggPageHeaderLength)return this.readAsync(0,a,b,c,d);if(!this.readNextPageLength())return d}const e=super.read(a,b,Math.min(c,this._currentPageLength));if("number"!==typeof e)return this.readAsync(e,
a,b,c,d);if(0>=e)break;c-=e;this._currentPageLength-=e;b+=e;d+=e}!this._currentPageLength&&this.bufferAvailable>OggBufferedReader._maximumOggPageHeaderLength&&this.readNextPageLength();return d}}OggBufferedReader._basicPageStructureLength=27;OggBufferedReader._maximumOggPageHeaderLength=OggBufferedReader._basicPageStructureLength+255;OggBufferedReader._vorbisIdentifierLength=7;
class OggMetadataExtractor extends VorbisCommentExtractor{static async extract(a,b,c,d){try{const e=new OggBufferedReader(a,b),f=MetadataExtractor.createBasicMetadata(a);return await e.findInitialVorbisCommentPage(f)?await VorbisCommentExtractor.extractVorbisComment(e.totalLength-e.readPosition,f,e,c,d)?f:null:null}catch(e){return null}}}
class ListAdapter{constructor(a,b){this.list=a;this.control=b||null;a.adapter=this}destroy(){const a=this.list,b=this.control;a&&(zeroObject(this),a.adapter=null,b&&(b.adapter=null))}cleared(){this.control&&this.control.notifyCleared()}itemsChanged(a){this.control&&(this.control.notifyCleared(),this.control.notifyItemsAdded(0,a-1))}itemsAdded(a,b){this.control&&this.control.notifyItemsAdded(a,b)}itemsRemoved(a,b){this.control&&this.control.notifyItemsRemoved(a,b)}currentItemChanged(a,b){this.control&&
this.control.notifyCurrentItemChanged(a,b)}}
class List{constructor(a,b){this.items=a||[];this._currentIndex=void 0===b?-1:b;this._adapter=null;this.modified=!1;this.items.length?(0>this._currentIndex?this._currentIndex=-1:this._currentIndex>=this.items.length&&(this._currentIndex=this.items.length-1),this._currentItem=0<=this._currentIndex?this.items[this._currentIndex]:null):(this._currentIndex=-1,this._currentItem=null)}destroy(){if(this.items){this.items.fill(null);var a=this._adapter;zeroObject(this);a&&a.destroy()}}get adapter(){return this._adapter}set adapter(a){this.items&&
this._adapter!==a&&(this._adapter&&this._adapter.destroy(),this._adapter=a)}get length(){return this.items?this.items.length:0}get currentIndex(){return this._currentItem?this._currentIndex:-1}set currentIndex(a){a>=this.items.length&&(a=this.items.length-1);0>a&&(a=0);const b=a<this.items.length?this.items[a]:null,c=this._currentIndex,d=this._currentItem;this._currentIndex=b?a:-1;if(c!==a||d!==b)this.modified=!0,this._currentItem=b,this._adapter&&this._adapter.currentItemChanged(d?c:-1,this._currentIndex)}get currentItem(){return this._currentItem}get nextItem(){let a=
this._currentIndex+1;a>=this.items.length&&(a=this.items.length-1);0>a&&(a=0);return a<this.items.length?this.items[a]:null}item(a){return this.items[a]}estimateSerializedLength(){const a=this.items;if(!(a&&a[0]&&"estimateSerializedLength"in a[0]))return 0;let b=0;for(let c=a.length-1;0<=c;c--)b+=a[c].estimateSerializedLength();return b+128}get version(){return 0}serializeExtraProperties(a,b){return a}serializeExtraPropertiesWeb(a){return a}serialize(a){a||(a=new DataWriter(this.estimateSerializedLength()));
const b=this.items,c=b&&b[0]&&"serialize"in b[0]?b.length:0;a.writeUint8(this.version).writeInt32(c).writeInt32(this._currentIndex);this.serializeExtraProperties(a,c);for(let d=0;d<c;d++)b[d].serialize(a);return a}serializeWeb(){const a=this.items,b=a&&a[0]&&"serializeWeb"in a[0]?a.length:0,c=Array(b);for(let d=0;d<b;d++)c[d]=a[d].serializeWeb();return this.serializeExtraPropertiesWeb({currentIndex:this._currentIndex,items:c})}moveCurrentToPrevious(){this.currentIndex=this._currentItem?0>=this._currentIndex?
this.items.length-1:this._currentIndex-1:this._currentIndex;return this._currentIndex}moveCurrentToNext(){this.currentIndex=this._currentItem?this._currentIndex>=this.items.length-1?0:this._currentIndex+1:this._currentIndex;return this._currentIndex}clear(){const a=this._currentIndex,b=this._currentItem;this.items&&this.items.fill(null);this.modified=!0;this.items=[];this._currentIndex=-1;this._currentItem=null;this._adapter&&(this._adapter.cleared(),b&&this._adapter.currentItemChanged(a,-1))}changeItems(a){a&&
a.length?(this.items&&this.items.fill(null),this.modified=!0,this.items=a.slice(),this._currentIndex=-1,this._currentItem=null,this._adapter&&this._adapter.itemsChanged(a.length)):this.clear()}addItem(a,b){if(!this.items||!a)return-1;void 0===b||0>b||b>=this.items.length?(b=this.items.length,this.items.push(a)):this.items.splice(b,0,a);this.modified=!0;this._adapter&&this._adapter.itemsAdded(b,b);0<=this._currentIndex&&b<=this._currentIndex&&this._currentIndex++;return b}addItems(a,b){if(!this.items||
!a||!a.length)return-1;void 0===b||0>b||b>=this.items.length?(b=this.items.length,this.items.push(...a)):this.items.splice(b,0,...a);this.modified=!0;this._adapter&&this._adapter.itemsAdded(b,b+a.length-1);0<=this._currentIndex&&b<=this._currentIndex&&(this._currentIndex+=a.length);return b}removeItems(a,b){if(!this.items||0>a||a>=this.items.length)return 0;void 0===b||b>=this.items.length?b=this.items.length-1:b<a&&(b=a);const c=b-a+1;this.items.splice(a,c);this.modified=!0;0<=this._currentIndex&&
(b<this._currentIndex?this._currentIndex-=c:a<=this._currentIndex&&this._currentItem&&(this._currentItem=null,this._adapter&&this._adapter.currentItemChanged(this._currentIndex,-1)));this._adapter&&this._adapter.itemsRemoved(a,b);return c}}
class FileSystemAPI{static isSupported(){return"FileSystemHandle"in window&&"showDirectoryPicker"in window}static openDatabase(a,b){return new Promise(function(c,d){function e(g,h){if(f)try{f.close()}catch(k){}h?d(h):c(g)}let f=null;try{const g=indexedDB.open(FileSystemAPI._dbName);g.onupgradeneeded=function(){g.result.createObjectStore(FileSystemAPI._dbStoreName)};g.onsuccess=function(){f=g.result;try{b(f,f.transaction(FileSystemAPI._dbStoreName,a).objectStore(FileSystemAPI._dbStoreName),e)}catch(h){e(null,
h)}};g.onerror=function(){e(null,g.error)}}catch(g){e(null,g)}})}static init(){return FileSystemAPI.openDatabase("readonly",function(a,b,c){const d=b.openCursor();d.onsuccess=function(){const e=d.result;if(e){var f=e.key.toString(),g=e.value;f&&g&&(FileSystemAPI._roots.push([f,g]),FileSystemAPI._directoryHandles.set(f,g));e.continue()}else{const h=Strings.comparer;FileSystemAPI._roots.sort(function(k,n){return h(k[0],n[0])});c()}};d.onerror=function(){c(null,d.error)}})}static async addNewRoot(){try{const a=
await window.showDirectoryPicker();if(a)return await FileSystemAPI.addRoot(a),!0}catch(a){}return!1}static addRoot(a){return a?FileSystemAPI.openDatabase("readwrite",function(b,c,d){c.put(a,a.name);const e=c.transaction;e.onabort=function(){d()};e.oncomplete=function(){const f=FileSystemAPI._roots,g=a.name;let h=!1;for(let k=f.length-1;0<=k;k--)if(f[k][0]===g){f[k][1]=a;h=!0;break}if(!h){const k=Strings.comparer;f.push([g,a]);f.sort(function(n,m){return k(n[0],m[0])})}FileSystemAPI._directoryHandles.set(g,
a);d()};e.onerror=function(){d(null,e.error)}}):Promise.resolve()}static removeRoot(a){return a?FileSystemAPI.openDatabase("readwrite",function(b,c,d){c.delete(a);const e=c.transaction;e.onabort=function(){d()};e.oncomplete=function(){const f=FileSystemAPI._roots;for(let g=f.length-1;0<=g;g--)if(f[g][0]===a){f.splice(g,1);break}d(!0)};e.onerror=function(){d(null,e.error)}}):Promise.resolve(!1)}static getRootHandles(){const a=FileSystemAPI._roots,b=Array(a.length);for(let c=a.length-1;0<=c;c--)b[c]=
a[c][1];return b}static async checkRootPermission(a){if(!a)return 0;var b=a.indexOf("/");0<b&&(a=a.substring(0,b));a=FileSystemAPI._directoryHandles.get(a);if(!a)return 0;try{switch(b={mode:"read"},await a.queryPermission(b)){case "granted":return 1;case "prompt":return"granted"===await a.requestPermission(b)?-1:0;default:return 0}}catch(c){return 0}}static async getDirectoryHandle(a,b){let c=FileSystemAPI._directoryHandles.get(a);if(c)return c;try{const d=a.lastIndexOf("/");if(0>=d||d>=a.length-
1)return null;c=b||await FileSystemAPI.getDirectoryHandle(a.substring(0,d));if(!c)return null;c=await c.getDirectoryHandle(a.substring(d+1));if(!c)return null;FileSystemAPI._directoryHandles.set(a,c);return c}catch(d){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.getDirectoryHandle(a):null}}static async getFile(a,b){try{if(b)return b.getFile();const c=a.lastIndexOf("/");if(0>=c||c>=a.length-1)return null;const d=await FileSystemAPI.getDirectoryHandle(a.substring(0,c));if(!d)return null;
const e=await d.getFileHandle(a.substring(c+1));return e?e.getFile():null}catch(c){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.getFile(a,b):null}}static async enumerate(a,b){try{const c=b||await FileSystemAPI.getDirectoryHandle(a);if(!c)return null;const d=[];for await(const e of c.values())("file"!==e.kind||FileUtils.isTypeSupported(e.name))&&d.push(e);return d}catch(c){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.enumerate(a,b):null}}}
FileSystemAPI._dbName="fplay";FileSystemAPI._dbStoreName="fplay-roots";FileSystemAPI._roots=[];FileSystemAPI._directoryHandles=new Map;
class FilePickerFileSystemAPIProvider{constructor(){this._version=0}editableRoots(){return!0}addNewRoot(){return FileSystemAPI.addNewRoot()}removeRoot(a){return FileSystemAPI.removeRoot(a.name)}async getDirectoryFiles(a,b,c,d){if((d=await FileSystemAPI.enumerate(c,d))&&a===this._version){var e=Strings.comparer;d.sort(function(g,h){return g.kind===h.kind?e(g.name,h.name):"file"===g.kind?1:-1});c.endsWith("/")||(c+="/");for(let g=0;g<d.length&&a===this._version;g++){var f=d[g];const h=c+f.name;if("file"===
f.kind){if(f=await FileSystemAPI.getFile(h,d[g]))f["data-path"]=FileUtils.localURLPrefix+h,b.push(f)}else await this.getDirectoryFiles(a,b,h,f)}}}async getFiles(a,b){this.cancel();const c=[],d=this._version;if(a)for(var e=0;e<a.length&&d===this._version;e++)await this.getDirectoryFiles(d,c,a[e].path,a[e].handle);if(b)for(a=0;a<b.length&&d===this._version;a++){e=b[a].path;const f=await FileSystemAPI.getFile(e,b[a].handle);f&&(f["data-path"]=FileUtils.localURLPrefix+e,c.push(f))}return c}async navigate(a){this.cancel();
if(!a){a=FileSystemAPI.getRootHandles();var b=Array(a.length);for(var c=a.length-1;0<=c;c--)b[c]={name:a[c].name,dir:1,path:a[c].name,root:!0,deletable:!0,handle:a[c]};return b}c=this._version;b=await FileSystemAPI.enumerate(a);if(!b||!b.length||c!==this._version)return null;a.endsWith("/")||(a+="/");c=Array(b.length);for(let e=b.length-1;0<=e;e--)c[e]={name:b[e].name,dir:"file"===b[e].kind?0:1,path:a+b[e].name,handle:b[e]};const d=Strings.comparer;c.sort(function(e,f){return e.dir===f.dir?d(e.name,
f.name):f.dir-e.dir});return c}cancel(){this._version++}destroy(){this.cancel()}}
class FilePickerAndroidProvider{static callbackPermission(a){FilePickerAndroidProvider._permissionGranted=!!a;FilePickerAndroidProvider._callbackPermissionResolve&&(FilePickerAndroidProvider._callbackPermissionResolve(FilePickerAndroidProvider._permissionGranted),FilePickerAndroidProvider._callbackPermissionResolve=null)}static callbackClickDone(){FilePickerAndroidProvider._callbackClickDoneResolve&&(FilePickerAndroidProvider._callbackClickDoneResolve(),FilePickerAndroidProvider._callbackClickDoneResolve=
null)}static checkPermission(){FilePickerAndroidProvider._callbackPermissionResolve&&(FilePickerAndroidProvider._callbackPermissionResolve(!1),FilePickerAndroidProvider._callbackPermissionResolve=null);return App.hostInterface?App.hostInterface.checkFilePermission()?(FilePickerAndroidProvider._permissionGranted=!0,Promise.resolve(!0)):new Promise(function(a){App.hostInterface?(FilePickerAndroidProvider._callbackPermissionResolve=a,App.hostInterface.requestFilePermission()):a(!1)}):Promise.resolve(!1)}constructor(){this._enumerationVersion=
this._version=0}editableRoots(){return!1}addNewRoot(){return Promise.resolve(!1)}removeRoot(a){return Promise.resolve(!1)}enumerate(a){this._enumerationVersion++;FilePickerAndroidProvider.callback&&(FilePickerAndroidProvider.callback(0,null),FilePickerAndroidProvider.callback=null);return new Promise(b=>{if(!App.hostInterface)return null;FilePickerAndroidProvider.callback=(c,d)=>{c!==this._enumerationVersion?b(null):(FilePickerAndroidProvider.callback=null,b(d))};App.hostInterface.enumerateFiles(this._enumerationVersion,
a)})}async getDirectoryFiles(a,b,c){if((c=await this.enumerate(c))&&a===this._version){var d=Strings.comparer;c.sort(function(e,f){const g=47===e.charCodeAt(0),h=47===f.charCodeAt(0);return g===h?d(e,f):g?1:-1});for(let e=0;e<c.length&&a===this._version;e++){const f=c[e];47===f.charCodeAt(0)?b.push(f):await this.getDirectoryFiles(a,b,f)}}}async getFiles(a,b){this.cancel();const c=[];var d=this._version,e=new Promise(function(g){FilePickerAndroidProvider._callbackClickDoneResolve=g}),f=App.showOpenDialogWeb(!1,
!0);await e;if(!App.hostInterface||d!==this._version)return null;if(a)for(e=0;e<a.length&&d===this._version;e++)await this.getDirectoryFiles(d,c,a[e].path);if(b&&d===this._version)for(a=0;a<b.length;a++)c.push(b[a].path);if(!App.hostInterface||!c.length)return null;for(b=c.length-1;0<=b;b--)c[b]=FileUtils.pathToURL(c[b]);App.hostInterface.setFileURLs(c);f=await f;if(!f||f.length!==c.length||d!==this._version)return null;for(d=c.length-1;0<=d;d--)f[d]["data-path"]=c[d];return f}async navigate(a){this.cancel();
var b=this._version;if(!FilePickerAndroidProvider._permissionGranted&&!await FilePickerAndroidProvider.checkPermission()||b!==this._version)return null;const c=await this.enumerate(a);if(!c||!c.length||b!==this._version)return null;b=Array(c.length);if(a)for(a=b.length-1;0<=a;a--){var d=c[a];b[a]={name:FileUtils.nameFromLinuxPath(d),dir:47===d.charCodeAt(0)?0:1,path:d}}else for(a=b.length-1;0<=a;a--){d=c[a];const f=d.indexOf(FileUtils.separator);b[a]={name:0<f?d.substring(0,f):Formatter.none,dir:1,
path:0<f?d.substring(f+1):d,root:!0}}const e=Strings.comparer;b.sort(function(f,g){return f.dir===g.dir?e(f.name,g.name):g.dir-f.dir});return b}cancel(){this._version++;this._enumerationVersion++;FilePickerAndroidProvider.callbackClickDone()}destroy(){this.cancel();App.hostInterface&&App.hostInterface.cancelFileEnumeration(this._enumerationVersion)}}FilePickerAndroidProvider.callback=null;FilePickerAndroidProvider._callbackPermissionResolve=null;
FilePickerAndroidProvider._callbackClickDoneResolve=null;FilePickerAndroidProvider._permissionGranted=!1;
class Song{static isPathHttp(a){return a.startsWith("http:")||a.startsWith("https:")||a.startsWith("icy:")}static deserialize(a){a.readUint8();return new Song(a.readString(),a.readInt32(),a.readString(),a.readString(),a.readString(),a.readInt16(),a.readInt32(),a.readInt16(),a.readInt32(),a.readInt8(),a.readString(),a.readInt32())}constructor(a,b,c,d,e,f,g,h,k,n,m,l){if("string"!==typeof a){l=a;a=l.url;b=l.flags;c=l.title;d=l.artist;e=l.album;f=l.track;g=l.lengthMS;h=l.year;k=l.sampleRate;n=l.channels;
if(l.file){if(!a||a.startsWith(FileUtils.localURLPrefix))this.file=l.file;c||(c=l.file.name.lastIndexOf("."),c=0<c?l.file.name.substring(0,c):l.file.name)}m=l.fileName;l=l.fileSize}this.id=++Song._lastId;this.url=a;this.flags=b||0;this.isHttp=Song.isPathHttp(this.url);c||(a=decodeURI(a),b=a.lastIndexOf("/"),c=0<=b?a.substring(b+1):a,this.isHttp||(b=c.lastIndexOf("."),0<b&&(c=c.substring(0,b))));this.title=c||Formatter.none;this.artist=d||Formatter.none;this.album=e||Formatter.none;this.track=f&&0<
f?f:Formatter.noneInt;this.lengthMS=g&&0<g?g:Formatter.noneInt;this.year=h&&0<h?h:Formatter.noneInt;this.sampleRate=k&&0<k?k:Formatter.noneInt;this.channels=n&&0<n?n:Formatter.noneInt;this.length=Formatter.formatTimeMS(this.lengthMS);this.fileName=m||null;this.fileSize=l||0}get isSeekable(){return this.flags&MetadataFlags.Seekable?!0:!1}estimateSerializedLength(){return(this.url.length+this.title.length+this.artist.length+this.album.length+(this.fileName?this.fileName.length:0)<<1)+17}serialize(a){return a.writeUint8(0).writeString(this.url).writeInt32(this.flags).writeString(this.title).writeString(this.artist).writeString(this.album).writeInt16(this.track).writeInt32(this.lengthMS).writeInt16(this.year).writeInt32(this.sampleRate).writeInt8(this.channels).writeString(this.fileName||
null).writeInt32(this.fileSize||0)}serializeWeb(){return{url:this.url,flags:this.flags,title:this.title,artist:this.artist,album:this.album,track:this.track,lengthMS:this.lengthMS,year:this.year,sampleRate:this.sampleRate,channels:this.channels,fileName:this.fileName,fileSize:this.fileSize}}normalizedInfoContainsAllTerms(a){var b=this._normalizedInfo;void 0===b&&(b=[],this.title&&this.title!==Formatter.none&&b.push(this.title),this.artist&&this.artist!==Formatter.none&&b.push(this.artist),this.album&&
this.album!==Formatter.none&&b.push(this.album),this.year&&0<this.year&&b.push(this.year.toString()),this.url&&b.push(this.url),this._normalizedInfo=b=Strings.removeDiacritics(b.join(" ")));for(let c=a.length-1;0<=c;c--)if(!b.includes(a[c]))return!1;return!0}}Song._lastId=0;
class PlaylistAdapter extends ListAdapter{constructor(a){super(a)}get itemHeight(){return AppUI.playlistItemSizePX}createEmptyElement(a){const b=document.createElement("div");b.className=a+" playlist-item";a=document.createElement("span");a.className="playlist-item-row1";a.appendChild(Icon.create("icon-title","pink",!1,"playlist-item-icon margin",null,Strings.TitleLabel));a.appendChild(document.createTextNode(Formatter.none));b.appendChild(a);a=document.createElement("span");a.className="playlist-item-s-row1";
a.appendChild(Strings.createSrOnlyText(Strings.DurationLabel));a.appendChild(document.createTextNode(Formatter.none));b.appendChild(a);a=document.createElement("span");a.className="playlist-item-row2";a.appendChild(Icon.create("icon-artist","orange",!1,"playlist-item-icon margin",null,Strings.ArtistLabel));a.appendChild(document.createTextNode(Formatter.none));b.appendChild(a);a=document.createElement("span");a.className="playlist-item-row3";a.appendChild(Icon.create("icon-album","green",!1,"playlist-item-icon margin",
null,Strings.AlbumLabel));a.appendChild(document.createTextNode(Formatter.none));b.appendChild(a);a=document.createElement("span");a.className="playlist-item-s-row3";a.ariaHidden="true";a.appendChild(document.createTextNode(Formatter.none));b.appendChild(a);return b}prepareElement(a,b,c,d){d=d.childNodes;d[0].childNodes[1].nodeValue=a.title;d[1].childNodes[1].nodeValue=a.length;d[2].childNodes[1].nodeValue=a.artist;d[3].childNodes[1].nodeValue=a.album;d[4].firstChild.nodeValue=a.url||a.file?`${b+
1} / ${c}`:`(${Strings.Missing}) ${b+1} / ${c}`}prepareElementIndexOrLengthChanged(a,b,c,d){d.childNodes[8].firstChild.nodeValue=a.url||a.file?`${b+1} / ${c}`:`(${Strings.Missing}) ${b+1} / ${c}`}}
class Playlist extends List{static deserialize(a){a.readUint8();const b=a.readInt32(),c=a.readInt32(),d=a.readInt32(),e=Array(b);for(let f=0;f<b;f++)e[f]=Song.deserialize(a);return new Playlist(e,c,d)}static deserializeWeb(a){try{const b=JSON.parse(a);if(!b||!b.items||!Array.isArray(b.items))return null;const c=b.items,d=c.length,e=Array(d),f=new Map;for(a=0;a<d;a++){const g=new Song(c[a]);e[a]=g;!g.url&&g.fileName&&f.set(g.fileName+g.fileSize,g)}return new Playlist(e,b.currentIndex||0,b.currentIndexResumeTimeS||
0,f.size?f:null)}catch(b){return null}}constructor(a,b,c,d){super(a,b);this._currentIndexResumeTimeS=c||0;this._missingSongs=d||null;this.onsonglengthchange=null}get currentIndexResumeTimeS(){return this._currentIndexResumeTimeS}set currentIndexResumeTimeS(a){if(!this.currentItem||!a||0>a)a=0;this._currentIndexResumeTimeS!==a&&(this.modified=!0,this._currentIndexResumeTimeS=a)}serializeExtraProperties(a,b){a.writeInt32(b?this._currentIndexResumeTimeS:0);return a}serializeExtraPropertiesWeb(a){a.currentIndexResumeTimeS=
this._currentIndexResumeTimeS;return a}findIndexById(a){const b=this.items;for(let c=b.length-1;0<=c;c--)if(b[c].id===a)return c;return-1}updateSongLength(a,b){if(0>=b||isNaN(b)||!isFinite(b)){if(0>a.lengthMS)return!1;b=-1}else if(b=1E3*b|0,0<=a.lengthMS&&(a.lengthMS|0)===b)return!1;this.modified=!0;a.lengthMS=b;a.length=Formatter.formatTimeMS(b);if(this.onsonglengthchange)this.onsonglengthchange(a);return!0}clear(){this._missingSongs&&(this._missingSongs.clear(),this._missingSongs=null);super.clear()}changeItems(a){this._missingSongs&&
(this._missingSongs.clear(),this._missingSongs=null);super.changeItems(a)}removeItems(a,b){if(this._missingSongs&&this.items&&0<=a&&a<this.items.length){const c=this._missingSongs,d=this.items;void 0===b||b>=d.length?b=d.length-1:b<a&&(b=a);for(let e=a;e<=b;e++){const f=d[e];if(!f.url&&!f.file&&f.fileName&&(c.delete(f.fileName+f.fileSize),!c.size)){this._missingSongs=null;break}}}return super.removeItems(a,b)}async addSong(a,b){let c,d=0;"string"!==typeof a?(c=a.fileURL,d=a.fileSize):c=a;if(!FileUtils.isTypeSupported(c))return!1;
a=await App.extractMetadata(c,d);if(!a)return!1;super.addItem(new Song(a),b);return!0}async addSongWeb(a,b,c,d){if(!FileUtils.isTypeSupported(a.name))return!1;if(this._missingSongs){const e=a.name+a.size,f=this._missingSongs.get(e);if(f)return f.file=a,this._missingSongs.delete(e),this._missingSongs.size||(this._missingSongs=null),!0}a=await MetadataExtractor.extract(a,b,c);if(!a)return!1;super.addItem(new Song(a),d);return!0}findItems(a){a=Strings.removeDiacritics(a.trim()).split(" ");for(var b=
a.length-1;0<=b;b--)a[b]||a.splice(b,1);b=[];if(a.length){const c=this.items;for(let d=0;d<c.length;d++)c[d].normalizedInfoContainsAllTerms(a)&&b.push(c[d])}return b}}
class PointerHandler{constructor(a,b=null,c=null,d=null,e=!0,f=null){this._documentTarget=document.documentElement||document.body;this._element=a;this._downCallback=b;this._moveCallback=c;this._upCallback=d;this._boundExtraTouchStart=null;"onpointerdown"in a?(this._documentDownEvent="pointerdown",this._documentMoveEvent="pointermove",this._documentUpEvent="pointerup",this._documentCancelEvent="pointercancel",this._boundDocumentDown=this.pointerDown.bind(this),this._boundDocumentUp=this.pointerUp.bind(this),
this._boundDocumentMove=this.pointerMove.bind(this),"ontouchstart"in a&&(this._boundExtraTouchStart=this.extraTouchStart.bind(this))):"ontouchstart"in a?(this._documentDownEvent="touchstart",this._documentMoveEvent="touchmove",this._documentUpEvent="touchend",this._documentCancelEvent="touchcancel",this._boundDocumentDown=this.touchStart.bind(this),this._boundDocumentUp=this.touchEnd.bind(this),this._boundDocumentMove=this.touchMove.bind(this)):(this._documentDownEvent="mousedown",this._documentMoveEvent=
"mousemove",this._documentUpEvent="mouseup",this._documentCancelEvent=null,this._boundDocumentDown=this.mouseDown.bind(this),this._boundDocumentUp=this.mouseUp.bind(this),this._boundDocumentMove=this.mouseMove.bind(this));this._lazy=e;this._outsidePointerHandler=f;this._boundExtraTouchStart&&a.addEventListener("touchstart",this._boundExtraTouchStart);a.addEventListener(this._documentDownEvent,this._boundDocumentDown);e||this.addSecondaryHandlers();this._captured=!1;this._pointerId=-1}destroy(){this._element&&
(this._boundExtraTouchStart&&this._element.removeEventListener("touchstart",this._boundExtraTouchStart),this._boundDocumentDown&&this._element.removeEventListener(this._documentDownEvent,this._boundDocumentDown));this.removeSecondaryHandlers();this.mouseUp({});zeroObject(this)}get captured(){return this._captured}addSecondaryHandlers(){this._documentTarget&&(this._documentTarget.addEventListener(this._documentMoveEvent,this._boundDocumentMove,{capture:!0,passive:!1}),this._documentTarget.addEventListener(this._documentUpEvent,
this._boundDocumentUp,!0),this._documentCancelEvent&&this._documentTarget.addEventListener(this._documentCancelEvent,this._boundDocumentUp,!0))}removeSecondaryHandlers(){this._documentTarget&&(this._boundDocumentUp&&(this._documentTarget.removeEventListener(this._documentUpEvent,this._boundDocumentUp,!0),this._documentCancelEvent&&this._documentTarget.removeEventListener(this._documentCancelEvent,this._boundDocumentUp,!0)),this._boundDocumentMove&&this._documentTarget.removeEventListener(this._documentMoveEvent,
this._boundDocumentMove,!0))}extraTouchStart(a){if(a.target===this._element||this._outsidePointerHandler&&this._outsidePointerHandler(a))return cancelEvent(a)}pointerDown(a){if(0<=this._pointerId&&"mouse"!==a.pointerType)return cancelEvent(a);const b=this.mouseDown(a);this._captured&&(this._pointerId=a.pointerId);return b}pointerMove(a){if(this._captured&&a.pointerId===this._pointerId)return this.mouseMove(a)}pointerUp(a){if(this._captured&&a.pointerId===this._pointerId)return this._pointerId=-1,
this.mouseUp(a)}touchStart(a){if(!(1<a.touches.length))return 0<=this._pointerId&&this.touchEnd(a),this._pointerId=1,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a=this.mouseDown(a),void 0===a&&(this._pointerId=-1),a}touchMove(a){if(this._captured&&!(1<a.touches.length))return a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,this.mouseMove(a)}touchEnd(a){if(this._captured&&!(0>this._pointerId))return this._pointerId=-1,this.mouseUp(a)}mouseDown(a){this.mouseUp(a);if(!a.button&&
(!a.target||a.target===this._element||this._outsidePointerHandler&&this._outsidePointerHandler(a))){if(this._downCallback&&!this._downCallback(a))return cancelEvent(a);this._captured=!0;"setPointerCapture"in this._element&&0<=a.pointerId&&this._element.setPointerCapture(a.pointerId);this._lazy&&this.addSecondaryHandlers();return cancelEvent(a)}}mouseMove(a){if(this._captured)return this._moveCallback&&this._moveCallback(a),cancelEvent(a)}mouseUp(a){if(this._captured)return this._captured=!1,this._lazy&&
this.removeSecondaryHandlers(),this._upCallback&&this._upCallback(a),cancelEvent(a)}}
class GraphicalFilterEditorStrings{static toFixed(a,b){return a.toFixed(b)}static init(a){a&&0===a.toLowerCase().indexOf("pt")&&(GraphicalFilterEditorStrings.Minus0="-0,00",GraphicalFilterEditorStrings.Curve="Curva: ",GraphicalFilterEditorStrings.Frequency="Frequ\u00eancia: ",GraphicalFilterEditorStrings.SameCurve="Mesma curva para ambos canais",GraphicalFilterEditorStrings.UseLeftCurve="Usar curva da esquerda",GraphicalFilterEditorStrings.UseRightCurve="Usar curva da direita",GraphicalFilterEditorStrings.OneForEach=
"Uma curva por canal",GraphicalFilterEditorStrings.ShowLeftCurve="Exibir curva da esquerda",GraphicalFilterEditorStrings.ShowRightCurve="Exibir curva da direita",GraphicalFilterEditorStrings.ResetCurve="Zerar curva",GraphicalFilterEditorStrings.EditMode="Modo de edi\u00e7\u00e3o",GraphicalFilterEditorStrings.Regular="Normal",GraphicalFilterEditorStrings.Zones="Zonas",GraphicalFilterEditorStrings.SmoothNarrow="Suave (estreito)",GraphicalFilterEditorStrings.SmoothWide="Suave (largo)",GraphicalFilterEditorStrings.PeakingEq=
'Filtro "Peaking" de 10 Bandas',GraphicalFilterEditorStrings.ShelfEq='Filtro "Low Shelf" de 7 Bandas',GraphicalFilterEditorStrings.NormalizeCurves="Normalizar curvas",GraphicalFilterEditorStrings.ShowZones="Exibir zonas",GraphicalFilterEditorStrings.ShowActualResponse="Exibir resposta real",GraphicalFilterEditorStrings.toFixed=function(b,c){return b.toFixed(c).replace(".",",")})}}GraphicalFilterEditorStrings.Minus0="-0.00";GraphicalFilterEditorStrings.Cursor="Cursor: ";
GraphicalFilterEditorStrings.Curve="Curve: ";GraphicalFilterEditorStrings.Frequency="Frequency: ";GraphicalFilterEditorStrings.SameCurve="Same curve for both channels";GraphicalFilterEditorStrings.UseLeftCurve="Use left curve";GraphicalFilterEditorStrings.UseRightCurve="Use right curve";GraphicalFilterEditorStrings.OneForEach="One curve for each channel";GraphicalFilterEditorStrings.ShowLeftCurve="Show left curve";GraphicalFilterEditorStrings.ShowRightCurve="Show right curve";
GraphicalFilterEditorStrings.ResetCurve="Reset curve";GraphicalFilterEditorStrings.EditMode="Edit mode";GraphicalFilterEditorStrings.Regular="Regular";GraphicalFilterEditorStrings.Zones="Zones";GraphicalFilterEditorStrings.SmoothNarrow="Smooth (narrow)";GraphicalFilterEditorStrings.SmoothWide="Smooth (wide)";GraphicalFilterEditorStrings.PeakingEq="10-band Peaking Filter";GraphicalFilterEditorStrings.ShelfEq="7-band Low Shelf Filter";GraphicalFilterEditorStrings.NormalizeCurves="Normalize curves";
GraphicalFilterEditorStrings.ShowZones="Show zones";GraphicalFilterEditorStrings.ShowActualResponse="Show actual response";GraphicalFilterEditorStrings.MinusInfinity="-Inf.";var GraphicalFilterEditorIIRType;(function(a){a[a.None=0]="None";a[a.Peaking=1]="Peaking";a[a.Shelf=2]="Shelf"})(GraphicalFilterEditorIIRType||(GraphicalFilterEditorIIRType={}));
class Filter{constructor(a){this._source=null;this.filterChangedCallback=a}connectSourceAndDestination(a,b){a=this.connectSourceToInput(a);return this.connectOutputToDestination(b)&&a}disconnectSourceAndDestination(){const a=this.disconnectSourceFromInput();return this.disconnectOutputFromDestination()&&a}disconnectSourceFromInput(){return this._source?(this._source.disconnect(),this._source=null,!0):!1}connectSourceToInput(a){this.disconnectSourceFromInput();if(this._source=a){a.disconnect();const b=
this.inputNode;if(b)return a.connect(b,0,0),!0}return!1}connectOutputToDestination(a){const b=this.outputNode;return b?(b.disconnect(),a&&b.connect(a,0,0),!0):!1}disconnectOutputFromDestination(){const a=this.outputNode;return a?(a.disconnect(),!0):!1}destroy(){this.disconnectSourceFromInput();this.disconnectOutputFromDestination()}}
class GraphicalFilterEditor extends Filter{static encodeCurve(a){const b=GraphicalFilterEditor.minimumChannelValueY,c=GraphicalFilterEditor.validYRangeHeight,d=a.length,e=Array(d<<1);let f=0;for(let g=0;g<d;g++){let h=a[g];h=h>b?0:c-h;254>=h?e[f++]=h:(e[f++]=255,e[f++]=h-254)}e.splice(f);return btoa(String.fromCharCode(...e))}static decodeCurve(a){if(!a||a.length<4*GraphicalFilterEditor.visibleBinCount/3)return null;try{a=atob(a)}catch(f){return null}if(a.length<GraphicalFilterEditor.visibleBinCount)return null;
const b=GraphicalFilterEditor.validYRangeHeight,c=a.length,d=Array(GraphicalFilterEditor.visibleBinCount);let e=0;for(let f=0;f<c;f++){const g=a.charCodeAt(f);254>=g?d[e++]=b-g:f<c-1&&(f++,d[e++]=b-(a.charCodeAt(f)+254))}return d}constructor(a,b,c,d){super(c);if(8>a||a&a-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this._filterLength=a;this._sampleRate=b.sampleRate?b.sampleRate:44100;this._isNormalized=!1;this._iirType=(this.iirSupported="createBiquadFilter"in
b&&"createIIRFilter"in b)&&d||GraphicalFilterEditorIIRType.None;this._binCount=(a>>>1)+1;this._filterKernel=b.createBuffer(2,a,this._sampleRate);this._audioContext=b;this._editorPtr=cLib._graphicalFilterEditorAlloc(this._filterLength,this._sampleRate);a=cLib.HEAP8.buffer;this._filterKernelBuffer=new Float32Array(a,cLib._graphicalFilterEditorGetFilterKernelBuffer(this._editorPtr),GraphicalFilterEditor.maximumFilterLength);this.channelCurves=[new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this._editorPtr,
0),GraphicalFilterEditor.visibleBinCount),new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this._editorPtr,1),GraphicalFilterEditor.visibleBinCount)];this.actualChannelCurve=new Int32Array(a,cLib._graphicalFilterEditorGetActualChannelCurve(this._editorPtr),GraphicalFilterEditor.visibleBinCount);this.visibleFrequencies=new Float64Array(a,cLib._graphicalFilterEditorGetVisibleFrequencies(this._editorPtr),GraphicalFilterEditor.visibleBinCount);this.equivalentZones=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZones(this._editorPtr),
GraphicalFilterEditor.equivalentZoneCount);this.equivalentZonesFrequencyCount=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZonesFrequencyCount(this._editorPtr),GraphicalFilterEditor.equivalentZoneCount+1);this._curveSnapshot=this._biquadFilterActualPhase=this._biquadFilterActualMag=this._biquadFilterActualAccum=this._biquadFilterActualFrequencies=this._biquadFilterActualGains=this._biquadFilterGains=this._biquadFilterOutput=this._biquadFilterInput=this._biquadFilters=this._convolver=null;
this.updateFilter(0,!0,!0);this.updateActualChannelCurve(0);this.updateBuffer();this.filterChangedCallback=c}get sampleRate(){return this._sampleRate}get isNormalized(){return this._isNormalized}get iirType(){return this._iirType}get convolver(){return this._convolver}get inputNode(){return this._biquadFilterInput||this._convolver}get outputNode(){return this._biquadFilterOutput||this._convolver}destroy(){this._editorPtr&&(super.destroy(),cLib._graphicalFilterEditorFree(this._editorPtr),zeroObject(this))}clampX(a){return 0>=
a?0:a>=GraphicalFilterEditor.visibleBinCount?GraphicalFilterEditor.visibleBinCount-1:a}clampY(a){return a<=GraphicalFilterEditor.maximumChannelValueY?GraphicalFilterEditor.maximumChannelValueY:a>GraphicalFilterEditor.minimumChannelValueY?GraphicalFilterEditor.validYRangeHeight+1:a}dBToMagnitude(a){return Math.pow(10,a/20)}yToDB(a){return a<=GraphicalFilterEditor.maximumChannelValueY?40:a>GraphicalFilterEditor.minimumChannelValueY?-Infinity:lerp(GraphicalFilterEditor.maximumChannelValueY,40,GraphicalFilterEditor.minimumChannelValueY,
-40,a)}yToMagnitude(a){return a<=GraphicalFilterEditor.maximumChannelValueY?100:a>GraphicalFilterEditor.minimumChannelValueY?0:Math.exp(lerp(GraphicalFilterEditor.maximumChannelValueY,2,GraphicalFilterEditor.minimumChannelValueY,-2,a)*Math.LN10)}magnitudeToY(a){return 100<=a?GraphicalFilterEditor.maximumChannelValueY:.009>a?GraphicalFilterEditor.validYRangeHeight+1:Math.round(GraphicalFilterEditor.zeroChannelValueY-GraphicalFilterEditor.zeroChannelValueY*Math.log(a)/Math.LN10*.5-.4)}visibleBinToZoneIndex(a){if(a>=
GraphicalFilterEditor.visibleBinCount-1)return this.equivalentZones.length-1;if(0<a){const b=this.equivalentZonesFrequencyCount;for(let c=b.length-1;0<=c;c--)if(a>=b[c])return c}return 0}visibleBinToFrequency(a,b){const c=this.equivalentZones,d=this.visibleFrequencies;var e=GraphicalFilterEditor.visibleBinCount;if(a>=e-1)return b?[d[e-1],c[c.length-1]]:d[e-1];if(0<a)if(b){e=this.equivalentZonesFrequencyCount;for(let f=e.length-1;0<=f;f--)if(a>=e[f])return[d[a],c[f]]}else return d[a];return b?[d[0],
c[0]]:d[0]}getZoneY(a,b){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[b]]}changeZoneY(a,b,c){b=this.visibleBinToZoneIndex(b);const d=this.equivalentZonesFrequencyCount[b+1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeZoneYByIndex(a,b,c){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);const d=this.equivalentZonesFrequencyCount[b+
1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeShelfZoneYByRegularIndex(a,b,c){switch(b){case 0:case 1:this.changeZoneYByIndex(a,0,c);this.changeZoneYByIndex(a,1,c);break;case 4:case 5:this.changeZoneYByIndex(a,4,c);this.changeZoneYByIndex(a,5,c);break;case 6:case 7:this.changeZoneYByIndex(a,6,c);this.changeZoneYByIndex(a,7,c);break;default:this.changeZoneYByIndex(a,b,c)}}getShelfZoneY(a,b){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&
(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[GraphicalFilterEditor.shelfEquivalentZones[b]]]}changeShelfZoneY(a,b,c){this.changeShelfZoneYByRegularIndex(a,this.visibleBinToZoneIndex(b),c)}changeShelfZoneYByIndex(a,b,c){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);this.changeShelfZoneYByRegularIndex(a,GraphicalFilterEditor.shelfEquivalentZones[b],c)}startSmoothEdition(a){this._curveSnapshot||
(this._curveSnapshot=new Int32Array(GraphicalFilterEditor.visibleBinCount));this._curveSnapshot.set(this.channelCurves[a])}changeSmoothY(a,b,c,d){var e=this._curveSnapshot;if(e){var f=GraphicalFilterEditor.visibleBinCount;c=this.clampY(c);a=this.channelCurves[a];a.set(e);d>>=1;for(let g=b-d,h=Math.min(b,f),k=Math.max(0,g);k<h;k++)e=512*smoothStep(g,b,k)|0,a[k]=this.clampY(Math.round((c*e+a[k]*(512-e))/512));for(let g=b+d,h=Math.min(g,f),k=Math.max(0,b);k<h;k++)d=512*smoothStep(g,b,k)|0,a[k]=this.clampY(Math.round((c*
d+a[k]*(512-d))/512))}}updateBuffer(){const a=this._convolver;this._convolver||(this._convolver=this._audioContext.createConvolver(),this._convolver.normalize=!1);try{this._convolver.buffer=this._filterKernel}catch(b){this._convolver=this._audioContext.createConvolver(),this._convolver.normalize=!1,this._convolver.buffer=this._filterKernel}a!==this._convolver&&this.filterChangedCallback&&this.filterChangedCallback()}copyToChannel(a,b){if(this._filterKernel.copyToChannel)this._filterKernel.copyToChannel(a,
b);else{b=this._filterKernel.getChannelData(b);for(let c=this._filterLength-1;0<=c;c--)b[c]=a[c]}}copyFromChannel(a,b){if(this._filterKernel.copyToChannel)this._filterKernel.copyFromChannel(a,b);else{b=this._filterKernel.getChannelData(b);for(let c=this._filterLength-1;0<=c;c--)a[c]=b[c]}}copyFilter(a,b){this.copyToChannel(this._filterKernel.getChannelData(a),b);this.updateBuffer()}updateFilter(a,b,c){switch(this._iirType){case GraphicalFilterEditorIIRType.Peaking:this.updatePeakingEq(a);return;case GraphicalFilterEditorIIRType.Shelf:this.updateShelfEq(a);
return}cLib._graphicalFilterEditorUpdateFilter(this._editorPtr,a,this._isNormalized);this.copyToChannel(this._filterKernelBuffer,a);b?this.copyFilter(a,1-a):c?this.updateFilter(1-a,!1,!1):this.updateBuffer()}updateActualChannelCurve(a){this._iirType?this.updateActualChannelCurveIIR():(this.copyFromChannel(this._filterKernelBuffer,a),cLib._graphicalFilterEditorUpdateActualChannelCurve(this._editorPtr,a))}updatePeakingEq(a){var b=this._audioContext;const c=this.channelCurves[a],d=this.equivalentZones,
e=this.equivalentZonesFrequencyCount;a=GraphicalFilterEditor.equivalentZoneCount;let f=this._biquadFilters,g=this._biquadFilterGains,h=!1;if(!f||!g){h=!0;f=Array(a);g=Array(a);const m=Array(a);var k=.5*Math.log(2),n=this._audioContext.sampleRate;const l=2*Math.PI;for(let p=a-1;0<=p;p--){const r=l*d[p]/n;m[p]=1/(2*Math.sinh(r/Math.sin(r)*k))}for(k=a-1;0<=k;k--)n=b.createBiquadFilter(),n.type="peaking",n.frequency.value=d[k],n.Q.value=m[k],f[k]=n,k<a-1&&f[k+1].connect(f[k]);this._biquadFilters=f;this._biquadFilterInput=
f[a-1];this._biquadFilterOutput=f[0]}for(b=a-1;0<=b;b--)g[b]=Math.max(-40,this.yToDB(c[e[b]]));for(b=a-1;0<=b;b--)f[b].gain.value=g[b]+(b<a-1?-.15*g[b+1]:0)+(0<b?-.15*g[b-1]:0);h&&this.filterChangedCallback&&this.filterChangedCallback()}updateShelfEq(a){var b=this._audioContext,c=this.channelCurves[a],d=this.equivalentZonesFrequencyCount,e=GraphicalFilterEditor.shelfEquivalentZoneCount,f=GraphicalFilterEditor.shelfEquivalentZones;a=this._biquadFilters;let g=this._biquadFilterGains,h=this._biquadFilterActualGains;
a&&g&&h||(a=Array(e),g=Array(e),h=Array(e),this._biquadFilters=a,this._biquadFilterGains=g,this._biquadFilterActualGains=h,a[e-1]=b.createGain(),this._biquadFilterInput=a[e-1]);for(b=e-1;0<=b;b--)g[b]=Math.max(-40,this.yToDB(c[d[f[b]]]));--e;b=0;c=!1;d=a[e];d.gain.value=this.dBToMagnitude(g[e]);for(--e;0<=e;e--)f=b+(g[e]-g[e+1]),-22>f?(b=f+22,f=-22):22<f?(b=f-22,f=22):b=0,h[e]!==f?(c=!0,h[e]=f,a[e]&&a[e].disconnect(),d.disconnect(),f?(a[e]=this.createIIRFilter(e,f),d.connect(a[e]),d=a[e]):a[e]=null):
a[e]&&(c&&(c=!1,d.connect(a[e])),d=a[e]);this._biquadFilterOutput!==d&&(this._biquadFilterOutput=d,this.filterChangedCallback&&this.filterChangedCallback())}createIIRFilter(a,b){const c=this._audioContext;var d=c.sampleRate;switch(a){case 0:a=92.75;break;case 1:a=187.5;break;case 2:a=375;break;case 3:a=1500;break;case 4:a=6E3;break;default:a=12E3}b=Math.pow(10,b/40);a=6.283185307179586*a/d;d=Math.cos(a);a=1*Math.sqrt(b)*Math.sin(a)*Math.sqrt(-.5*(b+1/b)+2);return c.createIIRFilter([b*(b+1-(b-1)*d+
a),2*b*(b-1-(b+1)*d),b*(b+1-(b-1)*d-a)],[b+1+(b-1)*d+a,-2*(b-1+(b+1)*d),b+1+(b-1)*d-a])}updateActualChannelCurveIIR(){var a=this._biquadFilters;if(a){var b=this._biquadFilterActualFrequencies,c=this._biquadFilterActualAccum,d=this._biquadFilterActualMag,e=this._biquadFilterActualPhase;if(!(b&&c&&d&&e)){e=this.visibleFrequencies;b=new Float32Array(e.length);for(c=e.length-1;0<=c;c--)b[c]=e[c];c=new Float32Array(e.length);d=new Float32Array(e.length);e=new Float32Array(e.length);this._biquadFilterActualFrequencies=
b;this._biquadFilterActualAccum=c;this._biquadFilterActualMag=d;this._biquadFilterActualPhase=e}var f=b.length;if(this._iirType===GraphicalFilterEditorIIRType.Shelf)c.fill(a[a.length-1].gain.value);else{a[a.length-1].getFrequencyResponse(b,c,e);for(var g=f-1,h=1;0<=g&&isNaN(h=c[g]);)g--;for(g++;g<f;)c[g++]=h}for(g=a.length-2;0<=g;g--)if(a[g]){a[g].getFrequencyResponse(b,d,e);for(let k=0,n=0;k<f;k++)h=d[k],isNaN(h)||(n=h),c[k]*=n}a=this.actualChannelCurve;b=this.magnitudeToY;for(d=a.length-1;0<=d;d--)a[d]=
b(c[d])}}changeFilterLength(a,b,c){return this._filterLength!==a?(this._filterLength=a,this._binCount=(a>>>1)+1,this._filterKernel=this._audioContext.createBuffer(2,a,this._sampleRate),cLib._graphicalFilterEditorChangeFilterLength(this._editorPtr,a),this.updateFilter(b,c,!0),!0):!1}changeSampleRate(a,b,c){return this._sampleRate!==a?(this._sampleRate=a,this._filterKernel=this._audioContext.createBuffer(2,this._filterLength,a),this.updateFilter(b,c,!0),!0):!1}changeIsNormalized(a,b,c){return!this._isNormalized!==
!a?(this._isNormalized=!!a,this.updateFilter(b,c,!0),!0):!1}changeIIRType(a,b,c){if(this._iirType!==a&&this.iirSupported){this._iirType=a;this.disconnectOutputFromDestination();this._convolver=null;if(a=this._biquadFilters){for(let d=a.length-1;0<=d;d--)a[d]&&a[d].disconnect();a.fill(null);this._biquadFilters=null}this._biquadFilterActualPhase=this._biquadFilterActualMag=this._biquadFilterActualAccum=this._biquadFilterActualFrequencies=this._biquadFilterGains=this._biquadFilterOutput=this._biquadFilterInput=
null;this.updateFilter(b,c,!0);return!0}return!1}changeAudioContext(a,b,c){if(this._audioContext!==a){this.disconnectOutputFromDestination();this._convolver=null;const d=this._biquadFilters;if(d){for(let e=d.length-1;0<=e;e--)d[e]&&d[e].disconnect();d.fill(null);this._biquadFilters=null}this._biquadFilterActualPhase=this._biquadFilterActualMag=this._biquadFilterActualAccum=this._biquadFilterActualFrequencies=this._biquadFilterGains=this._biquadFilterOutput=this._biquadFilterInput=null;this._audioContext=
a;this._sampleRate=a.sampleRate?a.sampleRate:44100;this._filterKernel=a.createBuffer(2,this._filterLength,this._sampleRate);this.updateFilter(b,c,!0);this.updateBuffer();return!0}return!1}}GraphicalFilterEditor.visibleBinCount=500;GraphicalFilterEditor.validYRangeHeight=321;GraphicalFilterEditor.zeroChannelValueY=GraphicalFilterEditor.validYRangeHeight>>>1;GraphicalFilterEditor.maximumChannelValue=GraphicalFilterEditor.zeroChannelValueY;GraphicalFilterEditor.minimumChannelValue=-GraphicalFilterEditor.zeroChannelValueY;
GraphicalFilterEditor.minusInfiniteChannelValue=GraphicalFilterEditor.minimumChannelValue-1;GraphicalFilterEditor.maximumChannelValueY=0;GraphicalFilterEditor.minimumChannelValueY=GraphicalFilterEditor.validYRangeHeight-1;GraphicalFilterEditor.maximumFilterLength=8192;GraphicalFilterEditor.equivalentZoneCount=10;GraphicalFilterEditor.shelfEquivalentZoneCount=7;GraphicalFilterEditor.shelfEquivalentZones=[0,2,3,4,6,8,9];
class GraphicalFilterEditorRenderer{constructor(a,b,c){this.element=a;this.leftMargin=b;this.editor=c}destroy(){zeroObject(this)}}
class GraphicalFilterEditorCanvasRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("canvas"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this._pixelRatio=1;this._rangeImage=this._ctx=null;this.scaleChanged()}scaleChanged(){var a=this.element,b=this.editor;if(a&&b){var c=GraphicalFilterEditorControl.controlWidth,d=GraphicalFilterEditorControl.controlHeight,e=1<devicePixelRatio?
devicePixelRatio:1,f=b.scale,g=f*e;a.width=c*g|0;a.height=d*g|0;b.element.style.width=(c*f|0)+"px";a.style.width=(c*f|0)+"px";a.style.height=(d*f|0)+"px";b=this.element.getContext("2d",{alpha:!1});if(!b)throw Error("Null canvas context");a=b.createLinearGradient(0,0,1,a.height);a.addColorStop(0,"#ff0000");a.addColorStop(.1875,"#ffff00");a.addColorStop(.39453125,"#00ff00");a.addColorStop(.60546875,"#00ffff");a.addColorStop(.796875,"#0000ff");a.addColorStop(1,"#ff00ff");this._pixelRatio=e;this._ctx=
b;this._rangeImage=a}}drawCurve(a,b,c){const d=this._ctx;if(d){var e=1<devicePixelRatio?devicePixelRatio:1;e!==this._pixelRatio&&(this.scaleChanged(),e=this._pixelRatio);var f=this.editor,g=f.filter;e*=f.scale;var h=this.element;f=this.leftMargin;var k=h.width,n=h.height,m=Math.round(8*e),l=Math.round(4*e),p=(k/m|0)+1,r=GraphicalFilterEditor.maximumChannelValueY*e|0,q=1>e?e:e|0;h=.5*q;d.fillStyle="#303030";d.fillRect(0,0,k,n);d.lineWidth=q;d.strokeStyle="#5a5a5a";d.beginPath();q=k+(l>>1);var t=(GraphicalFilterEditor.zeroChannelValueY*
e|0)+h;d.moveTo(q,t);for(let u=p-1;0<=u;u--)d.lineTo(q-l,t),q-=m,d.moveTo(q,t);d.stroke();d.beginPath();q=k+(l>>1);t=(GraphicalFilterEditor.validYRangeHeight*e|0)+h;d.moveTo(q,t);for(k=p-1;0<=k;k--)d.lineTo(q-l,t),q-=m,d.moveTo(q,t);d.stroke();if(a)for(a=g.equivalentZonesFrequencyCount.length-2;0<a;a--){q=((g.equivalentZonesFrequencyCount[a]+f)*e|0)+h;t=r;d.beginPath();for(d.moveTo(q,t);t<n;)d.lineTo(q,t+l),t+=m,d.moveTo(q,t);d.stroke()}q=1>e?2*e:2*e|0;h=.5*q;d.lineWidth=q;a=GraphicalFilterEditor.visibleBinCount-
1;for(n=b?1:0;0<=n;n--){m=n||!b?g.channelCurves[c]:g.actualChannelCurve;d.strokeStyle=n?"#707070":this._rangeImage;d.beginPath();d.moveTo(f*e|0,m[0]*e+h);for(q=1;q<a;q++)d.lineTo((f+q)*e|0,m[q]*e+h);d.lineTo((f+q+1)*e|0,m[q]*e+h);d.stroke()}}}}
class GraphicalFilterEditorSVGRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("div"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this.element.style.overflow="hidden";this.element.style.backgroundColor="#303030";this.element.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1" viewBox="0 0 1 1" version="1.1" style="transform-origin: top left; pointer-events: none;">\n\t\t\t<defs>\n\t\t\t\t<linearGradient id="editorSVGLinearGradient" x1="0" y1="0" x2="0" y2="1" gradientUnits="userSpaceOnUse">\n\t\t\t\t\t<stop offset="0" stop-color="#ff0000" />\n\t\t\t\t\t<stop offset="0.1875" stop-color="#ffff00" />\n\t\t\t\t\t<stop offset="0.39453125" stop-color="#00ff00" />\n\t\t\t\t\t<stop offset="0.60546875" stop-color="#00ffff" />\n\t\t\t\t\t<stop offset="0.796875" stop-color="#0000ff" />\n\t\t\t\t\t<stop offset="1" stop-color="#ff00ff" />\n\t\t\t\t</linearGradient>\n\t\t\t</defs>\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<g style="display:none">\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t</g>\n\t\t\t<path style="fill:none;stroke:#707070;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t\t<path style="fill:none;stroke:url(#editorSVGLinearGradient);stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t</svg>';
this._pixelRatio=1;this._showZones=!1;this._isActualChannelCurveNeeded=!0;this._svg=a=this.element.firstChild;this._svgGradient=a.getElementsByTagName("linearGradient")[0];this._svgZones=a.getElementsByTagName("g")[0];var b=a.getElementsByTagName("path");this._svgGrayCurve=b[0];this._svgCurve=b[1];a=a.getElementsByTagName("line");this._svgLines=Array(a.length);for(b=a.length-1;0<=b;b--)this._svgLines[b]=a[b];this.scaleChanged()}scaleChanged(){const a=this.element,b=this.editor;var c=b.filter;const d=
this._svg;if(a&&b&&c&&d){var e=GraphicalFilterEditorControl.controlWidth,f=GraphicalFilterEditorControl.controlHeight,g=1<devicePixelRatio?devicePixelRatio:1,h=b.scale,k=h*g,n=this.leftMargin,m=this._svgLines,l=1>k?k:k|0,p=.5*l,r=(e*k|0).toString(),q=(f*k|0).toString();d.setAttribute("width",r);d.setAttribute("height",q);d.setAttribute("viewBox",`0 0 ${r} ${q}`);d.style.transform=1===g?"":"scale("+1/g+")";this._svgGradient.setAttribute("y2",q);b.element.style.width=(e*h|0)+"px";a.style.width=(e*h|
0)+"px";a.style.height=(f*h|0)+"px";m[0].setAttribute("x2",r);m[1].setAttribute("x2",r);for(r=m.length-1;2<=r;r--)m[r].setAttribute("y2",q);q=((GraphicalFilterEditor.zeroChannelValueY*k|0)+p).toString();m[0].setAttribute("y1",q);m[0].setAttribute("y2",q);q=((GraphicalFilterEditor.validYRangeHeight*k|0)+p).toString();m[1].setAttribute("y1",q);m[1].setAttribute("y2",q);for(q=c.equivalentZonesFrequencyCount.length-2;0<q;q--)r=(((c.equivalentZonesFrequencyCount[q]+n)*k|0)+p).toString(),m[q+1].setAttribute("x1",
r),m[q+1].setAttribute("x2",r);r=l.toString()+"px";q=(4*k|0).toString();for(c=m.length-1;0<=c;c--)m[c].setAttribute("stroke-width",r),m[c].setAttribute("stroke-dasharray",q);r=(1>k?2*k:2*k|0).toString()+"px";this._svgGrayCurve.style.strokeWidth=r;this._svgCurve.style.strokeWidth=r;this._pixelRatio=g}}drawCurve(a,b,c){var d=1<devicePixelRatio?devicePixelRatio:1;d!==this._pixelRatio&&(this.scaleChanged(),d=this._pixelRatio);this._showZones!==a&&(this._showZones=a,this._svgZones.style.display=a?"":"none");
var e=this.editor;a=e.filter;d*=e.scale;e=.5*(1>d?2*d:2*d|0);const f=this.leftMargin,g=GraphicalFilterEditor.visibleBinCount;for(let h=b?1:0;0<=h;h--){const k=h||!b?a.channelCurves[c]:a.actualChannelCurve,n=h?this._svgGrayCurve:this._svgCurve;let m=1,l=0,p=k[0],r="M "+(f*d|0)+","+(p*d+e);for(;m<g;m++)k[m]!==p&&(m>l+1&&1<m&&(r+=" "+((f+m-1)*d|0)+","+(k[m-1]*d+e)),l=m,p=k[m],r+=" "+((f+l)*d|0)+","+(p*d+e));r+=" "+((f+m)*d|0)+","+(k[m-1]*d+e);n.setAttribute("d",r)}this._isActualChannelCurveNeeded!==
b&&(this._isActualChannelCurveNeeded=b,this._svgGrayCurve.style.display=b?"":"none")}}
class GraphicalFilterEditorControl{constructor(a,b,c,d,e,f){this._showZones=!1;this._editMode=GraphicalFilterEditorControl.editModeRegular;this._isActualChannelCurveNeeded=!0;this._currentChannelIndex=0;this.isSameFilterLR=!0;this.drawOffsetY=this.drawOffsetX=this.lastDrawY=this.lastDrawX=this.drawingMode=0;if(8>b||b&b-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this.filter=new GraphicalFilterEditor(b,c,d);b=function(){const h=document.createElement("div");h.className=
"GEMNUSEP";return h};c=function(h){const k=document.createElement("div");k.className="GEMNULBL";k.appendChild(document.createTextNode(h));return k};d=function(h,k,n,m,l,p){const r=document.createElement("div");r.className=p?"GEMNUIT GECLK "+p:"GEMNUIT GECLK";if(k)if(f&&(m&&f.radioHTML||!m&&f.checkHTML))r.innerHTML=m?f.radioHTML:f.checkHTML,k=r.firstChild,k.style.marginRight=m?f.radioMargin||"2px":f.checkMargin||"2px",n||(k.style.visibility="hidden");else{k=document.createElement("span");p=m?"\u25cf ":
"\u25a0 ";let q=null;if(f){let t=!1;m?f.radioCharacter&&(t=!0,p=f.radioCharacter,q=f.radioMargin||"2px"):f.checkCharacter&&(t=!0,p=f.checkCharacter,q=f.checkMargin||"2px");t&&(f.checkFontFamily&&(k.style.fontFamily=f.checkFontFamily),f.checkFontSize&&(k.style.fontSize=f.checkFontSize))}q&&(k.style.marginRight=q);k.appendChild(document.createTextNode(p));n||(k.style.visibility="hidden");r.appendChild(k)}r.appendChild(document.createTextNode(h));l&&(r.onclick=l);return r};this.element=a;a.className=
"GE";a.ariaHidden="true";this.boundMouseMove=this.mouseMove.bind(this);this._fontSize=null;f&&f.fontSize&&(this.fontSize=f.fontSize);this._lineHeight=null;f&&f.lineHeight&&(this.lineHeight=f.lineHeight);this._scale=0;this.scale=f&&f.scale&&0<f.scale?f.scale:1;this.renderer=f&&f.svgRenderer?new GraphicalFilterEditorSVGRenderer(this):new GraphicalFilterEditorCanvasRenderer(this);this.renderer.element.addEventListener("mousemove",this.boundMouseMove);this.renderer.element.oncontextmenu=cancelEvent;a.appendChild(this.renderer.element);
this.pointerHandler=new PointerHandler(this.renderer.element,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));a.oncontextmenu=cancelEvent;var g=document.createElement("div");g.className="GELBL";g.style.width="11em";g.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Cursor));g.appendChild(this.lblCursor=document.createElement("span"));g.appendChild(document.createTextNode(" dB"));this.lblCursor.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));
a.appendChild(g);g=document.createElement("div");g.className="GELBL";g.style.width="11em";g.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Curve));g.appendChild(this.lblCurve=document.createElement("span"));g.appendChild(document.createTextNode(" dB"));this.lblCurve.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));a.appendChild(g);g=document.createElement("div");g.className="GELBL";g.appendChild(this.lblFrequency=document.createElement("span"));this.lblFrequency.appendChild(document.createTextNode("0 Hz (31 Hz)"));
a.appendChild(g);this.btnMnu=document.createElement("div");this.btnMnu.className="GEBTN GECLK";this.openMenuElement=null;this.openMenuCharacter="\u25b2";this.closeMenuElement=null;this.closeMenuCharacter="\u25bc";f&&(g=!1,f.openMenuHTML&&f.closeMenuHTML?(g=!0,this.btnMnu.innerHTML=f.openMenuHTML+f.closeMenuHTML,this.openMenuElement=this.btnMnu.childNodes[0],this.closeMenuElement=this.btnMnu.childNodes[1],this.closeMenuElement.style.display="none"):f.openMenuCharacter?(g=!0,this.openMenuCharacter=
f.openMenuCharacter,this.closeMenuCharacter=f.closeMenuCharacter||this.openMenuCharacter):f.closeMenuCharacter&&(g=!0,this.closeMenuCharacter=this.openMenuCharacter=f.closeMenuCharacter),g&&(f.menuFontFamily&&(this.btnMnu.style.fontFamily=f.menuFontFamily),f.menuFontSize&&(this.btnMnu.style.fontSize=f.menuFontSize),f.menuWidth&&(this.btnMnu.style.width=f.menuWidth),f.menuPadding&&(this.btnMnu.style.padding=f.menuPadding)));this.openMenuElement||this.btnMnu.appendChild(document.createTextNode(this.openMenuCharacter));
this.btnMnu.onclick=this.btnMnu_Click.bind(this);a.appendChild(this.btnMnu);this.mnu=document.createElement("div");this.mnu.className="GEMNU";this.mnu.style.display="none";g=document.createElement("div");g.className="GEMNUH GEFILTER";g.appendChild(c(GraphicalFilterEditorStrings.SameCurve));g.appendChild(this.mnuChBL=d(GraphicalFilterEditorStrings.UseLeftCurve,!0,!0,!0,this.mnuChB_Click.bind(this,0)));g.appendChild(this.mnuChBR=d(GraphicalFilterEditorStrings.UseRightCurve,!0,!1,!0,this.mnuChB_Click.bind(this,
1)));g.appendChild(b());g.appendChild(c(GraphicalFilterEditorStrings.OneForEach));g.appendChild(this.mnuChL=d(GraphicalFilterEditorStrings.ShowLeftCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,0)));g.appendChild(this.mnuChR=d(GraphicalFilterEditorStrings.ShowRightCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,1)));this.mnu.appendChild(g);g=document.createElement("div");g.className="GEMNUH GEMNUSEPH";g.appendChild(d(GraphicalFilterEditorStrings.ResetCurve,!1,!1,!1,this.mnuResetCurve_Click.bind(this)));
g.appendChild(b());g.appendChild(c(GraphicalFilterEditorStrings.EditMode));g.appendChild(this.mnuEditRegular=d(GraphicalFilterEditorStrings.Regular,!0,!0,!0,this.mnuEditRegular_Click.bind(this)));g.appendChild(this.mnuEditZones=d(GraphicalFilterEditorStrings.Zones,!0,!1,!0,this.mnuEditZones_Click.bind(this)));g.appendChild(this.mnuEditSmoothNarrow=d(GraphicalFilterEditorStrings.SmoothNarrow,!0,!1,!0,this.mnuEditSmoothNarrow_Click.bind(this)));g.appendChild(this.mnuEditSmoothWide=d(GraphicalFilterEditorStrings.SmoothWide,
!0,!1,!0,this.mnuEditSmoothWide_Click.bind(this)));g.appendChild(this.mnuEditPeakingEq=d(GraphicalFilterEditorStrings.PeakingEq,!0,!1,!0,this.mnuEditPeakingEq_Click.bind(this)));if(f&&f.hideEditModePeakingEq||!this.filter.iirSupported)this.mnuEditPeakingEq.style.display="none";g.appendChild(this.mnuEditShelfEq=d(GraphicalFilterEditorStrings.ShelfEq,!0,!1,!0,this.mnuEditShelfEq_Click.bind(this)));if(f&&f.hideEditModeShelfEq||!this.filter.iirSupported)this.mnuEditShelfEq.style.display="none";g.appendChild(b());
g.appendChild(this.mnuNormalizeCurves=d(GraphicalFilterEditorStrings.NormalizeCurves,!0,!1,!1,this.mnuNormalizeCurves_Click.bind(this),"GEFILTER"));g.appendChild(this.mnuShowZones=d(GraphicalFilterEditorStrings.ShowZones,!0,!1,!1,this.mnuShowZones_Click.bind(this)));g.appendChild(this.mnuShowActual=d(GraphicalFilterEditorStrings.ShowActualResponse,!0,!0,!1,this.mnuShowActual_Click.bind(this)));this.mnu.appendChild(g);a.appendChild(this.mnu);e&&this.loadSettings(e);this.drawCurve()}destroy(){this.filter&&
this.filter.destroy();this.pointerHandler&&this.pointerHandler.destroy();this.renderer&&this.renderer.destroy();zeroObject(this)}loadSettings(a){if(a){var b=this.filter;if(!1===a.showZones||!0===a.showZones)this._showZones=a.showZones;a.editMode&&a.editMode>=GraphicalFilterEditorControl.editModeFirst&&a.editMode<=GraphicalFilterEditorControl.editModeLast&&(b.iirSupported||a.editMode!==GraphicalFilterEditorControl.editModePeakingEq&&a.editMode!==GraphicalFilterEditorControl.editModeShelfEq)&&(this._editMode=
a.editMode);if(!1===a.isActualChannelCurveNeeded||!0===a.isActualChannelCurveNeeded)this._isActualChannelCurveNeeded=a.isActualChannelCurveNeeded;if(0===a.currentChannelIndex||1===a.currentChannelIndex)this._currentChannelIndex=a.currentChannelIndex;if(!1===a.isSameFilterLR||!0===a.isSameFilterLR)this.isSameFilterLR=a.isSameFilterLR;var c=GraphicalFilterEditor.decodeCurve(a.leftCurve),d=GraphicalFilterEditor.decodeCurve(a.rightCurve);c&&!d?d=c:d&&!c&&(c=d);if(c){var e=b.channelCurves[0];for(let f=
GraphicalFilterEditor.visibleBinCount-1;0<=f;f--)e[f]=b.clampY(c[f])}if(d)for(c=b.channelCurves[1],e=GraphicalFilterEditor.visibleBinCount-1;0<=e;e--)c[e]=b.clampY(d[e]);this.isSameFilterLR?(this.checkMenu(this.mnuChBL,0===this._currentChannelIndex),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===this._currentChannelIndex),this.checkMenu(this.mnuChR,!1)):(this.checkMenu(this.mnuChBL,!1),this.checkMenu(this.mnuChL,0===this._currentChannelIndex),this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,
1===this._currentChannelIndex));a=!1===a.isNormalized||!0===a.isNormalized?a.isNormalized:b.isNormalized;a===b.isNormalized?b.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!0):b.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.checkMenu(this.mnuShowZones,this._showZones);this.editMode=this._editMode;this.checkMenu(this.mnuNormalizeCurves,this.filter.isNormalized);
this.checkMenu(this.mnuShowActual,this._isActualChannelCurveNeeded);this.drawCurve()}}saveSettings(){return{showZones:this._showZones,editMode:this._editMode,isActualChannelCurveNeeded:this._isActualChannelCurveNeeded,currentChannelIndex:this._currentChannelIndex,isSameFilterLR:this.isSameFilterLR,isNormalized:this.filter.isNormalized,leftCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[0]),rightCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[1])}}get scale(){return this._scale}set scale(a){0>=
a||this._scale===a||!this.element||(this._scale=a,this._fontSize||(this.element.style.fontSize=12*a+"px"),this._lineHeight||(this.element.style.lineHeight=16*a+"px"),this.renderer&&(this.renderer.scaleChanged(),this.drawCurve()))}get fontSize(){return this._fontSize}set fontSize(a){this._fontSize!==a&&this.element&&(this._fontSize=a,this.element.style.fontSize=a||12*this._scale+"px")}get lineHeight(){return this._lineHeight}set lineHeight(a){this._lineHeight!==a&&this.element&&(this._lineHeight=a,
this.element.style.lineHeight=a||16*this._scale+"px")}get showZones(){return this._showZones}set showZones(a){this._showZones=a;this.checkMenu(this.mnuShowZones,a);this.drawCurve()}get editMode(){return this._editMode}set editMode(a){if(!(a<GraphicalFilterEditorControl.editModeFirst||a>GraphicalFilterEditorControl.editModeLast)&&(this.filter.iirSupported||a!==GraphicalFilterEditorControl.editModePeakingEq&&a!==GraphicalFilterEditorControl.editModeShelfEq)){this._editMode=a;this.checkMenu(this.mnuEditRegular,
a===GraphicalFilterEditorControl.editModeRegular);this.checkMenu(this.mnuEditZones,a===GraphicalFilterEditorControl.editModeZones);this.checkMenu(this.mnuEditSmoothNarrow,a===GraphicalFilterEditorControl.editModeSmoothNarrow);this.checkMenu(this.mnuEditSmoothWide,a===GraphicalFilterEditorControl.editModeSmoothWide);this.checkMenu(this.mnuEditPeakingEq,a===GraphicalFilterEditorControl.editModePeakingEq);this.checkMenu(this.mnuEditShelfEq,a===GraphicalFilterEditorControl.editModeShelfEq);var b=GraphicalFilterEditorIIRType.None;
switch(a){case GraphicalFilterEditorControl.editModePeakingEq:b=GraphicalFilterEditorIIRType.Peaking;break;case GraphicalFilterEditorControl.editModeShelfEq:b=GraphicalFilterEditorIIRType.Shelf}this.filter.iirType!==b&&(this.mnu.className=b?"GEMNU GEEQ":"GEMNU",this.filter.changeIIRType(b,this._currentChannelIndex,this.isSameFilterLR),this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve()))}}get isActualChannelCurveNeeded(){return this._isActualChannelCurveNeeded}set isActualChannelCurveNeeded(a){this._isActualChannelCurveNeeded=
a;this.checkMenu(this.mnuShowActual,a);a&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}get currentChannelIndex(){return this._currentChannelIndex}get isNormalized(){return this.filter.isNormalized}set isNormalized(a){this.filter.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this.checkMenu(this.mnuNormalizeCurves,a);this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve())}static formatDB(a){return-40>
a?GraphicalFilterEditorStrings.MinusInfinity:0>a?GraphicalFilterEditorStrings.toFixed(a,2):0===a?GraphicalFilterEditorStrings.Minus0:"+"+GraphicalFilterEditorStrings.toFixed(a,2)}static formatFrequency(a){return a[0].toFixed(0)+" Hz ("+(1E3>a[1]?a[1]+" Hz":a[1]/1E3+" kHz")+")"}static setFirstNodeText(a,b){a.firstChild&&(a.firstChild.nodeValue=b)}btnMnu_Click(a){a.button||("none"===this.mnu.style.display?(this.mnu.style.bottom=this.btnMnu.clientHeight+"px",this.mnu.style.display="inline-block",this.openMenuElement&&
this.closeMenuElement?(this.openMenuElement.style.display="none",this.closeMenuElement.style.display=""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.closeMenuCharacter)):(this.mnu.style.display="none",this.openMenuElement&&this.closeMenuElement?(this.closeMenuElement.style.display="none",this.openMenuElement.style.display=""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.openMenuCharacter)));return!0}checkMenu(a,b){a.firstChild.style.visibility=b?"visible":"hidden";
return b}mnuChB_Click(a,b){b.button||this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR?(this._currentChannelIndex=a,this.filter.updateFilter(a,!0,!0),this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()):(this.isSameFilterLR=!0,this.filter.copyFilter(a,1-a),this._currentChannelIndex!==a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve())),this.checkMenu(this.mnuChBL,0===
a),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===a),this.checkMenu(this.mnuChR,!1));return this.btnMnu_Click(b)}mnuChLR_Click(a,b){b.button||!this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR&&(this.isSameFilterLR=!1,this.filter.updateFilter(1-this._currentChannelIndex,!1,!1)),this._currentChannelIndex!==a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()),this.checkMenu(this.mnuChBL,!1),
this.checkMenu(this.mnuChL,0===a),this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,1===a));return this.btnMnu_Click(b)}mnuResetCurve_Click(a){a.button||this.resetCurve();return this.btnMnu_Click(a)}mnuShowZones_Click(a){a.button||(this.showZones=!this._showZones);return this.btnMnu_Click(a)}mnuEditRegular_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeRegular);return this.btnMnu_Click(a)}mnuEditZones_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeZones);
return this.btnMnu_Click(a)}mnuEditSmoothNarrow_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothNarrow);return this.btnMnu_Click(a)}mnuEditSmoothWide_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothWide);return this.btnMnu_Click(a)}mnuEditPeakingEq_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModePeakingEq);return this.btnMnu_Click(a)}mnuEditShelfEq_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeShelfEq);
return this.btnMnu_Click(a)}mnuNormalizeCurves_Click(a){a.button||(this.isNormalized=!this.filter.isNormalized);return this.btnMnu_Click(a)}mnuShowActual_Click(a){a.button||(this.isActualChannelCurveNeeded=!this._isActualChannelCurveNeeded);return this.btnMnu_Click(a)}mouseDown(a){if(!a.button&&!this.drawingMode){const b=this.renderer.element.getBoundingClientRect(),c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;this.renderer.element.removeEventListener("mousemove",
this.boundMouseMove);this.drawingMode=1;switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.startSmoothEdition(this._currentChannelIndex);this.filter.changeSmoothY(this._currentChannelIndex,
c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.startSmoothEdition(this._currentChannelIndex);this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(c)]=this.filter.clampY(a),this.lastDrawX=c,this.lastDrawY=a}this.drawCurve();return!0}return!1}mouseMove(a){var b=this.renderer.element.getBoundingClientRect();
let c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;b=this.filter.channelCurves[this._currentChannelIndex];if(this.drawingMode){switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.changeSmoothY(this._currentChannelIndex,
c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:if(1<Math.abs(c-this.lastDrawX)){const d=(a-this.lastDrawY)/Math.abs(c-this.lastDrawX),e=c<this.lastDrawX?-1:1;let f=Math.abs(c-this.lastDrawX)-1;a=this.lastDrawY+d;for(c=this.lastDrawX+e;0<f;c+=e,f--)b[this.filter.clampX(c)]=this.filter.clampY(a),a+=d}b[this.filter.clampX(c)]=this.filter.clampY(a);
this.lastDrawX=c;this.lastDrawY=a}this.drawCurve()}else this._isActualChannelCurveNeeded&&(b=this.filter.actualChannelCurve);c=this.filter.clampX(c);GraphicalFilterEditorControl.setFirstNodeText(this.lblCursor,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(a)));GraphicalFilterEditorControl.setFirstNodeText(this.lblCurve,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(b[c])));GraphicalFilterEditorControl.setFirstNodeText(this.lblFrequency,GraphicalFilterEditorControl.formatFrequency(this.filter.visibleBinToFrequency(c,
!0)))}mouseUp(a){this.drawingMode&&(this.renderer.element.addEventListener("mousemove",this.boundMouseMove),this.drawingMode=0,this.commitChanges())}resetCurve(){const a=this.filter.channelCurves[this._currentChannelIndex];for(let b=a.length-1;0<=b;b--)a[b]=GraphicalFilterEditor.zeroChannelValueY;this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}getZoneY(a){return this.filter.getZoneY(this._currentChannelIndex,
a)}changeZoneY(a,b,c){this.filter.changeZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}getShelfZoneY(a){return this.filter.getShelfZoneY(this._currentChannelIndex,a)}changeShelfZoneY(a,b,c){this.filter.changeShelfZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}changeFilterY(a,b,c){this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(a)]=this.filter.clampY(b);this.drawCurve(c)}commitChanges(){this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,
!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}changeFilterLength(a){return this.filter.changeFilterLength(a,this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve(),!0):!1}changeSampleRate(a){return this.filter.changeSampleRate(a,this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),
this.drawCurve(),!0):!1}changeAudioContext(a){return this.filter.changeAudioContext(a,this._currentChannelIndex,this.isSameFilterLR)}drawCurve(a){this.renderer&&this.renderer.drawCurve(this._showZones,!a&&this._isActualChannelCurveNeeded&&!this.drawingMode,this._currentChannelIndex)}}GraphicalFilterEditorControl.controlWidth=Math.max(512,GraphicalFilterEditor.visibleBinCount);GraphicalFilterEditorControl.controlHeight=GraphicalFilterEditor.validYRangeHeight+3;
GraphicalFilterEditorControl.editModeRegular=0;GraphicalFilterEditorControl.editModeZones=1;GraphicalFilterEditorControl.editModeSmoothNarrow=2;GraphicalFilterEditorControl.editModeSmoothWide=3;GraphicalFilterEditorControl.editModePeakingEq=4;GraphicalFilterEditorControl.editModeShelfEq=5;GraphicalFilterEditorControl.editModeFirst=0;GraphicalFilterEditorControl.editModeLast=5;
class Program{static create(a,b,c,d){const e=["webkit-3d","moz-webgl","webgl","experimental-webgl"];for(let f=0;f<e.length;f++)try{const g=a.getContext(e[f],b);return new Program(g,c,d)}catch(g){}return null}constructor(a,b,c){const d=[];var e=[];const f=[];this.gl=a;var g=a.createProgram();if(!g)throw Error("Null program");this._program=g;g=a.createShader(a.VERTEX_SHADER);if(!g)throw Error("Null vertex shader");this._vs=g;g=a.createShader(a.FRAGMENT_SHADER);if(!g)throw Error("Null fragment shader");
this._fs=g;a.shaderSource(this._vs,b);a.compileShader(this._vs);if(!a.getShaderParameter(this._vs,a.COMPILE_STATUS))throw e="Vertex shader: "+a.getShaderInfoLog(this._vs),this.destroy(),alert(e),e;this.getAttribsAndUniforms(b,d,e,f);a.shaderSource(this._fs,c);a.compileShader(this._fs);if(!a.getShaderParameter(this._fs,a.COMPILE_STATUS))throw e="Fragment shader: "+a.getShaderInfoLog(this._fs),this.destroy(),alert(e),e;this.getAttribsAndUniforms(c,d,e,f);a.attachShader(this._program,this._vs);a.attachShader(this._program,
this._fs);for(b=0;b<d.length;b++)a.bindAttribLocation(this._program,b,d[b]);a.linkProgram(this._program);for(a=0;a<e.length;a++)this.prepareUniform(e[a],f[a])}getAttribsAndUniforms(a,b,c,d){a=a.split("\n");for(let n=0;n<a.length;n++){var e=a[n].trim();if("uniform"===e.substring(0,7)){e=e.split(" ");var f=e[1];for(var g=2;g<e.length;g++){var h=e[g];if(";"===h)break;var k=h.charAt(h.length-1);const m=";"===k;if(","===k||m)h=h.substring(0,h.length-1);","!==h&&h.length&&(c.push(h),d.push(f));if(m)break}}else if("attribute"===
e.substring(0,9))for(e=e.split(" "),f=2;f<e.length;f++){g=e[f];if(";"===g)break;h=g.charAt(g.length-1);k=";"===h;if(","===h||k)g=g.substring(0,g.length-1);","!==g&&g.length&&b.push(g);if(k)break}}}prepareUniform(a,b){const c=this.gl,d=c.getUniformLocation(this._program,a);if(!this[a])if("bool"===b||"int"===b||"sampler2D"===b)this[a]=function(e){c.uniform1i(d,e)};else if("float"===b)this[a]=function(e){c.uniform1f(d,e)};else if("vec2"===b)this[a]=function(e,f){c.uniform2f(d,e,f)},this[a+"v"]=function(e){c.uniform2fv(d,
e)};else if("vec3"===b)this[a]=function(e,f,g){c.uniform3f(d,e,f,g)},this[a+"v"]=function(e){c.uniform3fv(d,e)};else if("vec4"===b)this[a]=function(e,f,g,h){c.uniform4f(d,e,f,g,h)},this[a+"v"]=function(e){c.uniform4fv(d,e)};else if("mat4"===b)this[a]=function(e){c.uniformMatrix4fv(d,!1,e)};else return!1;return!0}use(){this.gl.useProgram(this._program)}destroy(){this.gl&&(this.gl.useProgram(null),this._vs&&(this.gl.detachShader(this._program,this._vs),this.gl.deleteShader(this._vs)),this._fs&&(this.gl.detachShader(this._program,
this._fs),this.gl.deleteShader(this._fs)),this._program&&this.gl.deleteProgram(this._program),zeroObject(this))}}
class Analyzer{constructor(a,b,c,d,e,f){this._alive=!1;this._lastRequest=0;this._boundAnalyze=null;this.audioContext=a;this.canvas=document.createElement("canvas");this.canvas.width=!e||0>=e?Analyzer.controlWidth:e;this.canvas.height=!f||0>=f?Analyzer.controlHeight:f;this.canvas.style.position="relative";this.canvas.style.margin="0px";this.canvas.style.padding="0px";this.canvas.style.verticalAlign="top";this.canvas.style.display="inline-block";this.canvas.style.cursor="default";c&&(this.canvas.id=
c);this.ctx=d?null:this.canvas.getContext("2d",{alpha:!1});b.appendChild(this.canvas);this._boundAnalyze=g=>{this._alive?(this._lastRequest=requestAnimationFrame(this._boundAnalyze),this.analyze(g)):this._lastRequest=0}}destroy(){this.stop();this.cleanUp();this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);zeroObject(this)}start(){if(this._alive)return!1;this._alive=!0;this._lastRequest=requestAnimationFrame(this._boundAnalyze);return!0}stop(){this._alive=!1;this._lastRequest&&
(cancelAnimationFrame(this._lastRequest),this._lastRequest=0)}}Analyzer.controlWidth=GraphicalFilterEditorControl.controlWidth;Analyzer.controlHeight=Analyzer.controlWidth;Analyzer.colors="#000000 #0B00B2 #0C00B1 #0E00AF #0E00AF #0F00AE #1000AD #1200AC #1300AB #1500AB #1600AA #1700A9 #1900A8 #1A00A6 #1B00A6 #1D00A4 #1F00A3 #2000A1 #2200A1 #2300A0 #25009E #27009D #29009C #2B009A #2D0099 #2E0098 #300096 #320095 #340094 #360092 #380090 #39008F #3C008E #3E008C #40008B #420089 #440088 #470086 #480085 #4B0083 #4C0082 #4F0080 #51007F #54007C #56007C #57007A #5A0078 #5C0076 #5F0075 #610073 #640071 #65006F #68006E #6B006C #6D006A #6F0069 #710066 #740065 #760063 #790062 #7B0060 #7D005E #80005C #82005B #850059 #860057 #890056 #8C0054 #8E0052 #910050 #93004F #96004D #97004B #9A0049 #9C0048 #9F0046 #A10045 #A40043 #A60040 #A8003F #AA003E #AD003C #AF003A #B10039 #B30037 #B60035 #B80034 #BA0032 #BC0031 #BE002E #C1002D #C3002C #C5002A #C70028 #CA0027 #CB0025 #CE0024 #CF0023 #D10022 #D30020 #D6001E #D7001D #D9001B #DB001A #DD0019 #DF0017 #E10017 #E20015 #E40014 #E60012 #E70011 #E90010 #EA000F #EC000D #ED000C #EF000B #F1000B #F2000A #F40008 #F50007 #F60006 #F70005 #F90005 #F90003 #FB0003 #FC0002 #FD0001 #FE0001 #FF0000 #FF0100 #FF0200 #FF0300 #FF0500 #FF0600 #FF0600 #FF0800 #FF0900 #FF0B00 #FF0C00 #FF0D00 #FF0F00 #FF1000 #FF1200 #FF1400 #FF1500 #FF1700 #FF1900 #FF1A00 #FF1C00 #FF1D00 #FF2000 #FF2200 #FF2300 #FF2500 #FF2700 #FF2900 #FF2B00 #FF2D00 #FF2F00 #FF3100 #FF3400 #FF3500 #FF3700 #FF3900 #FF3C00 #FF3E00 #FF4000 #FF4200 #FF4400 #FF4700 #FF4900 #FF4B00 #FF4E00 #FF5000 #FF5200 #FF5500 #FF5700 #FF5900 #FF5C00 #FF5E00 #FF6100 #FF6300 #FF6600 #FF6800 #FF6A00 #FF6C00 #FF6F00 #FF7200 #FF7400 #FF7700 #FF7900 #FF7C00 #FF7E00 #FF8000 #FF8300 #FF8500 #FF8700 #FF8A00 #FF8D00 #FF8F00 #FF9200 #FF9500 #FF9700 #FF9900 #FF9B00 #FF9E00 #FFA000 #FFA300 #FFA500 #FFA700 #FFA900 #FFAC00 #FFAE00 #FFB100 #FFB200 #FFB600 #FFB700 #FFBA00 #FFBC00 #FFBE00 #FFC100 #FFC300 #FFC400 #FFC700 #FFC900 #FFCB00 #FFCD00 #FFCF00 #FFD100 #FFD300 #FFD500 #FFD700 #FFD900 #FFDB00 #FFDD00 #FFDE00 #FFE000 #FFE100 #FFE400 #FFE500 #FFE700 #FFE900 #FFEA00 #FFEB00 #FFED00 #FFEF00 #FFF000 #FFF100 #FFF300 #FFF400 #FFF500 #FFF600 #FFF800 #FFF900 #FFFA00 #FFFB00".split(" ");
class PlainAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this._sampleRate=c.sampleRate;this._analyzerL=a.createAnalyser();this._analyzerL.fftSize=1024;this._analyzerR=a.createAnalyser();this._analyzerR.fftSize=1024;this._visibleFrequencies=c.visibleFrequencies;a=cLib.HEAP8.buffer;this._dataPtr=this._ptr=b=cLib._allocBuffer(19456+cLib._fftSizeOff(2048));this._data=new Uint8Array(a,b,1024);this._tmpPtr=b+=1024;this._tmp=new Float32Array(a,b,2048);this._windowPtr=b+=8192;this._window=new Float32Array(a,
b,1024);this._multiplierPtr=b+=4096;this._multiplier=new Float32Array(a,b,512);this._prevLPtr=b+=2048;this._prevL=new Float32Array(a,b,512);this._prevRPtr=b+=2048;this._prevR=new Float32Array(a,b,512);this._fft4gfPtr=b+2048;cLib._fftInitf(this._fft4gfPtr,2048);d=this._window;a=this._multiplier;const e=Math.PI;b=Math.exp;const f=Math.cos;c=1/Math.LN10;for(let g=0;1024>g;g++)d[g]=4*(.54-.46*f(2*e*g/1023));for(d=0;512>d;d++)a[d]=145*c*b(2.5*d/511)}analyze(a){a=this._multiplier;const b=this._tmp,c=this.ctx,
d=this._sampleRate/2048,e=this._visibleFrequencies,f=Analyzer.colors;var g;let h,k,n,m;this._analyzerL.getByteTimeDomainData(this._data);cLib._plainAnalyzer(this._fft4gfPtr,this._windowPtr,this._dataPtr,this._tmpPtr);let l=this._prevL;c.lineWidth=1;c.fillStyle="#000000";c.fillRect(0,0,512,512);for(k=h=0;511>k&&1024>h&&d>e[k+1]-e[k];){for(g=d*h;1024>h&&g+d<e[k];)h++,g=d*h;g=(4*l[k]+a[k]*lerp(g,b[h],g+d,b[h+1],e[k]))/2.5>>1;255<g?g=255:0>g&&(g=0);l[k]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(k-.5,
256.5-g);c.lineTo(k-.5,256.5);c.stroke();k++}for(h++;1024>h&&512>k;){m=n=0;do n+=b[h],m++,h++,g=d*h;while(g<e[k]&&1024>h);g=(4*l[k]+a[k]*n/m)/2.5>>1;255<g?g=255:0>g&&(g=0);l[k]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(k-.5,256.5-g);c.lineTo(k-.5,256.5);c.stroke();k++}this._analyzerR.getByteTimeDomainData(this._data);cLib._plainAnalyzer(this._fft4gfPtr,this._windowPtr,this._dataPtr,this._tmpPtr);l=this._prevR;for(k=h=0;511>k&&1024>h&&d>e[k+1]-e[k];){for(g=d*h;1024>h&&g+d<e[k];)h++,g=d*h;g=(4*l[k]+
a[k]*lerp(g,b[h],g+d,b[h+1],e[k]))/2.5>>1;255<g?g=255:0>g&&(g=0);l[k]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(k-.5,256.5);c.lineTo(k-.5,256.5+g);c.stroke();k++}for(h++;1024>h&&512>k;){m=n=0;do n+=b[h],m++,h++,g=d*h;while(g<e[k]&&1024>h);g=(4*l[k]+a[k]*n/m)/2.5>>1;255<g?g=255:0>g&&(g=0);l[k]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(k-.5,256.5);c.lineTo(k-.5,256.5+g);c.stroke();k++}}cleanUp(){this._ptr&&cLib._freeBuffer(this._ptr)}}
class SoundParticlesAnalyzer extends Analyzer{static rand(){return 65536*Math.random()|0}constructor(a,b,c,d){super(a,b,d,!0,Analyzer.controlWidth,320);this._BG_COLUMNS=31;this._BG_PARTICLES_BY_COLUMN=16;this._BG_COUNT=this._BG_COLUMNS*this._BG_PARTICLES_BY_COLUMN;this._lastTime=0;this._analyzerL=a.createAnalyser();this._analyzerL.fftSize=1024;this._analyzerL.maxDecibels=-12;this._analyzerL.minDecibels=-45;this._analyzerL.smoothingTimeConstant=0;this._analyzerR=a.createAnalyser();this._analyzerR.fftSize=
1024;this._analyzerR.maxDecibels=-12;this._analyzerR.minDecibels=-45;this._analyzerR.smoothingTimeConstant=0;a=(f,g)=>{this._COLORS[3*f]=g};b=(f,g)=>{this._COLORS[3*f+1]=g};c=(f,g)=>{this._COLORS[3*f+2]=g};d=cLib.HEAP8.buffer;var e=cLib._allocBuffer(2240+8*this._BG_COUNT+8*this._BG_COUNT+this._BG_COUNT);this._processedDataPtr=this._ptr=e;this._processedData=new Uint8Array(d,e,512);this._processedDataRPtr=e+=512;this._processedDataR=new Uint8Array(d,e,512);this._fftPtr=e+=512;this._fft=new Float32Array(d,
e,256);this._COLORSPtr=e+=1024;this._COLORS=new Float32Array(d,e,48);this._bgPosPtr=e+=192;this._bgPos=new Float32Array(d,e,2*this._BG_COUNT);this._bgSpeedYPtr=e+=8*this._BG_COUNT;this._bgSpeedY=new Float32Array(d,e,this._BG_COUNT);this._bgThetaPtr=e+=4*this._BG_COUNT;this._bgTheta=new Float32Array(d,e,this._BG_COUNT);this._bgColorPtr=e+=4*this._BG_COUNT;this._bgColor=new Uint8Array(d,e,this._BG_COUNT);a(0,.75);b(0,0);c(0,0);a(1,0);b(1,.75);c(1,0);a(2,0);b(2,0);c(2,.75);a(3,.75);b(3,0);c(3,.75);a(4,
.75);b(4,.75);c(4,0);a(5,0);b(5,.75);c(5,.75);a(6,.75);b(6,.75);c(6,.75);a(7,.75);b(7,.325);c(7,0);a(8,.75);b(8,0);c(8,.325);a(9,.325);b(9,.75);c(9,0);a(10,0);b(10,.75);c(10,.325);a(11,0);b(11,.325);c(11,.75);a(12,.325);b(12,0);c(12,.75);a(13,0);b(13,0);c(13,.75);a(14,.75);b(14,.325);c(14,0);a(15,0);b(15,.325);c(15,.75);for(let f=0,g=0;f<this._BG_COLUMNS;f++)for(a=0;a<this._BG_PARTICLES_BY_COLUMN;a++,g++)this.fillBgParticle(g,-1.2+.01953125*(SoundParticlesAnalyzer.rand()&127));a=Program.create(this.canvas,
{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0},SoundParticlesAnalyzer.vertexShaderSource,SoundParticlesAnalyzer.fragmentShaderSource);if(!a)throw this.err("Apparently your browser does not support WebGL"),Error();this._program=a;this._program.use();this._program.texColor(0);this._program.aspect(.625,1);a=this._program.gl;d=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]);e=new Float32Array([0,1,1,1,0,0,1,0]);b=a.createBuffer();c=a.createBuffer();!a.getError()&&b&&c||this.err(-1);
a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);a.clearColor(0,0,0,1);a.pixelStorei(a.UNPACK_ALIGNMENT,2);a.disable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.disable(a.DITHER);a.disable(a.SCISSOR_TEST);a.disable(a.STENCIL_TEST);a.enable(a.BLEND);a.blendFunc(a.ONE,a.ONE);a.blendEquation(a.FUNC_ADD);a.getError();d=a.createTexture();!a.getError()&&d||this.err(-2);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,
d);a.getError()&&this.err(-3);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);this.fillTexture();a.getError()&&this.err(-4);a.enableVertexAttribArray(0);a.bindBuffer(a.ARRAY_BUFFER,b);a.vertexAttribPointer(0,4,a.FLOAT,!1,0,0);a.enableVertexAttribArray(1);a.bindBuffer(a.ARRAY_BUFFER,c);a.vertexAttribPointer(1,
2,a.FLOAT,!1,0,0)}err(a){this.destroy();alert("Sorry! WebGL error :(\n"+a);throw a;}fillBgParticle(a,b){this._bgPos[a<<1]=.0078125*((SoundParticlesAnalyzer.rand()&7)-4);this._bgPos[(a<<1)+1]=b;this._bgTheta[a]=.03125*(SoundParticlesAnalyzer.rand()&63);this._bgSpeedY[a]=.125+.00390625*(SoundParticlesAnalyzer.rand()&15);this._bgColor[a]=SoundParticlesAnalyzer.rand()&15}fillTexture(){const a=this._program.gl,b=Math.sqrt,c=new Uint8Array(4096);for(let e=0;64>e;e++){let f=e-32;f*=f;for(let g=0;64>g;g++){var d=
g-32;d=b(d*d+f)/30;1<d&&(d=1);let h=d;d=1-d;d*=d;d+=.5*d;.55>d?d=0:1>d&&(d=smoothStep(.55,1,d));h=1-h;h=smoothStep(0,1,h);h*=h;h+=h;1<h&&(h=1);d+=.5*h;d=255*d|0;c[64*e+g]=255<=d?255:d}}a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,64,64,0,a.ALPHA,a.UNSIGNED_BYTE,c)}analyze(a){let b=a-this._lastTime;33<b&&(b=33);this._lastTime=a;a=this._program.gl;var c=.00390625*b,d=1-c;const e=this._processedData,f=this._processedDataR,g=this._fft,h=this._BG_COLUMNS,k=this._BG_PARTICLES_BY_COLUMN,n=this._COLORS,m=this._program,
l=this._bgPos,p=this._bgSpeedY,r=this._bgColor,q=this._bgTheta,t=Math.max;let u,y=44,w=116;b*=.001;this._analyzerL.getByteFrequencyData(e);this._analyzerR.getByteFrequencyData(f);for(u=0;256>u;u++){let v=t(e[u],f[u]);8>v&&(v=0);const x=g[u];v<x&&(v=c*v+d*x);g[u]=v;e[u]=255<=v?255:v}a.clear(a.COLOR_BUFFER_BIT);u=2;for(let v=0,x=0;v<h;v++){if(6>u)c=.00390625*e[u],u++;else if(20>u)c=.005859375*t(e[u],e[u+1]),u+=2;else if(36>u)c=.005859375*t(e[u],e[u+1],e[u+2],e[u+3]),u+=4;else if(100>u){for(c=0;u<y;u++)c=
t(c,e[u]);c*=.0078125;y+=8}else{for(c=0;u<w;u++)c=t(c,e[u]);c*=.009765625;w+=16}m.amplitude(1<=c?1:c);m.baseX(-.9+.06206897*v);for(c=0;c<k;c++,x++)1.2<l[(x<<1)+1]?this.fillBgParticle(x,-1.2):l[(x<<1)+1]+=p[x]*b,d=3*r[x],m.color(n[d],n[d+1],n[d+2]),d=x<<1,m.pos(l[d],l[d+1]),m.theta(q[x]),a.drawArrays(a.TRIANGLE_STRIP,0,4)}}cleanUp(){this._ptr&&cLib._freeBuffer(this._ptr);this._program&&this._program.destroy()}}SoundParticlesAnalyzer.vertexShaderSource="precision mediump float;\nattribute vec4 inPosition;\nattribute vec2 inTexCoord;\nuniform float amplitude;\nuniform float baseX;\nuniform vec2 pos;\nuniform vec2 aspect;\nuniform vec3 color;\nuniform float theta;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = mix(0.0625, 0.34375, amplitude);\n\tfloat bottom = 1.0 - clamp(pos.y, -1.0, 1.0);\n\tbottom = bottom * bottom * bottom * 0.125;\n\ta = (0.75 * a) + (0.25 * bottom);\n\tgl_Position = vec4(baseX + pos.x + (5.0 * (pos.y + 1.0) * pos.x * sin((2.0 * pos.y) + theta)) + (inPosition.x * aspect.x * a), pos.y + (inPosition.y * aspect.y * a), 0.0, 1.0);\n\tvTexCoord = inTexCoord;\n\tvColor = color + bottom + (0.25 * amplitude);\n}";
SoundParticlesAnalyzer.fragmentShaderSource="precision lowp float;\nuniform sampler2D texColor;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = texture2D(texColor, vTexCoord).a;\n\tgl_FragColor = vec4(vColor.rgb * a, 1.0);\n}";
class WaveletAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this._analyzerL=a.createAnalyser();this._analyzerL.fftSize=128;this._analyzerR=a.createAnalyser();this._analyzerR.fftSize=128;a=cLib.HEAP8.buffer;this._dataLPtr=this._ptr=b=cLib._allocBuffer(1536);this._dataL=new Uint8Array(a,b,128);this._dataRPtr=b+=128;this._dataR=new Uint8Array(a,b,128);this._tmpPtr=b+=128;this._tmp=new Float32Array(a,b,64);this._oL1Ptr=b+=256;this._oL1=new Float32Array(a,b,128);this._oR1Ptr=b+=512;this._oR1=
new Float32Array(a,b,128)}analyze(a){a=this.ctx;const b=Analyzer.colors,c=this._oL1,d=this._oR1;this._analyzerL.getByteTimeDomainData(this._dataL);this._analyzerR.getByteTimeDomainData(this._dataR);cLib._waveletAnalyzer(this._dataLPtr,this._dataRPtr,this._tmpPtr,this._oL1Ptr,this._oR1Ptr);let e,f,g=64,h=Analyzer.controlWidth/64,k,n=0,m=Analyzer.controlHeight-32;for(;;){e=g;for(k=0;512>k;)f=c[e],0>f&&(f=-f),f=127<=f?508:f<<2,a.fillStyle=b[f>>>1],a.fillRect(k,n,h,32),f=d[e],0>f&&(f=-f),f=127<=f?508:
f<<2,a.fillStyle=b[f>>>1],a.fillRect(k,m,h,32),e++,k+=h;h<<=1;n+=32;m-=32;if(!g)break;(g>>>=1)||(h=512)}}cleanUp(){this._ptr&&cLib._freeBuffer(this._ptr)}}function addAudioWorkletModule(a,b){return new Promise(function(c,d){try{const e=function(f,g){try{a.audioWorklet.addModule(f).then(c,d)}catch(h){d(h)}};location.href.startsWith("file://")?fetch(b).then(f=>{f.arrayBuffer().then(g=>{e(URL.createObjectURL(new Blob([g],{type:"text/javascript"})),!0)},d)},d):e(b,!1)}catch(e){d(e)}})}
class ConnectableNode{constructor(){this._enabled=!1;this._next=this._previous=null}get actualInput(){return this._enabled?this.input:this._next?this._next.actualInput:null}get actualOutput(){return this._enabled?this.output:this._previous?this._previous.actualOutput:null}nodesChanged(){const a=this._previous,b=this._next;a&&a.disconnectFromDestination();b&&this.disconnectFromDestination();a&&a.connectToDestination(this);b&&this.connectToDestination(b)}get enabled(){return this._enabled}set enabled(a){this._enabled!==
a&&(this._enabled=a,this.nodesChanged())}connectToDestination(a){this.disconnectFromDestination();if(this._next=a){a._previous=this;const b=this.actualOutput;b&&(a=a.actualInput)&&b.connect(a)}}disconnectFromDestination(){const a=this.actualOutput;a&&a.disconnect();this._next&&(this._next=this._next._previous=null)}}class DestinationNode extends ConnectableNode{constructor(a){super();this._node=a}get input(){return this._node}get output(){return null}}
class IntermediateNode extends ConnectableNode{constructor(a){super();this._node=a}get input(){return this._node}get output(){return this._node}}class SourceNode extends ConnectableNode{constructor(a){super();this._node=a}get input(){return null}get output(){return this._node}}var LibMikModMessageId;
(function(a){a[a.INIT=1]="INIT";a[a.LOAD_MODULE_BUFFER=2]="LOAD_MODULE_BUFFER";a[a.CHANGE_GENERAL_OPTIONS=3]="CHANGE_GENERAL_OPTIONS";a[a.STOP_MODULE=4]="STOP_MODULE";a[a.PLAYBACK_ERROR=5]="PLAYBACK_ERROR";a[a.PLAYBACK_ENDED=6]="PLAYBACK_ENDED"})(LibMikModMessageId||(LibMikModMessageId={}));
class LibMikMod{static isSupported(){return"AudioWorklet"in window&&"AudioWorkletNode"in window&&"WebAssembly"in window}static async init(a,b){if(!(LibMikMod.initialized||LibMikMod.initializing||LibMikMod.initializationError)){b?b.endsWith("/")||(b+="/"):b="";LibMikMod.initializing=!0;LibMikMod._currentId=0;try{const c=await (await fetch(b+"libmikmodclib.wasm?"+LibMikMod.WEB_VERSION)).arrayBuffer();await a.audioWorklet.addModule(b+"libmikmodprocessor.min.js?"+LibMikMod.WEB_VERSION);await new Promise(function(d,
e){const f=new AudioWorkletNode(a,"libmikmodprocessor");f.port.onmessage=function(g){(g=g.data)&&g.messageId===LibMikModMessageId.INIT&&LibMikMod.initializing&&!LibMikMod._currentId&&(g.errorStr?e(g.errorStr):(LibMikMod.LIB_VERSION=(g.id>>>16&255)+"."+(g.id>>>8&255)+"."+(g.id&255),d()))};f.onprocessorerror=function(g){e(g)};LibMikMod._audioNode=f;LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.INIT,buffer:c})});LibMikMod.initialized=!0}finally{LibMikMod.initialized||(LibMikMod.initializationError=
!0),LibMikMod.initializing=!1,LibMikMod.stopModule()}}}static postMessage(a){LibMikMod._audioNode&&(a.buffer?LibMikMod._audioNode.port.postMessage(a,[a.buffer]):LibMikMod._audioNode.port.postMessage(a))}static loadModule(a){if(!LibMikMod.initialized)throw Error("Library not initialized");if(!a)throw Error("Null options");if(!a.audioContext)throw Error("Null audioContext");const b=a.source;if(!b)throw Error("Null source");LibMikMod.stopModule();const c=new AudioWorkletNode(a.audioContext,"libmikmodprocessor");
LibMikMod._currentId++;c.port.onmessage=LibMikMod.handleResponse;c.onprocessorerror=LibMikMod.notifyProcessorError;LibMikMod._audioNode=c;LibMikMod.infoSongName=null;LibMikMod.infoModType=null;LibMikMod.infoComment=null;LibMikMod._onload=a.onload;LibMikMod._onerror=a.onerror;LibMikMod._onended=a.onended;const d=LibMikMod._currentId,e={hqMixer:a.hqMixer,wrap:a.wrap,loop:a.loop,fadeout:a.fadeout,reverb:a.reverb,interpolation:a.interpolation,noiseReduction:a.noiseReduction};if("lastModified"in b)if("arrayBuffer"in
b)b.arrayBuffer().then(function(f){d===LibMikMod._currentId&&LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:f,options:e})},function(f){d===LibMikMod._currentId&&LibMikMod.notifyReaderError(f)});else{const f=new FileReader;f.onerror=function(g){d===LibMikMod._currentId&&LibMikMod.notifyReaderError(g)};f.onload=function(){d===LibMikMod._currentId&&(f.result?LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,
buffer:f.result,options:e}):LibMikMod.notifyReaderError("Empty reader result"))};f.readAsArrayBuffer(b)}else LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:b,options:e})}static changeGeneralOptions(a){if(!LibMikMod.initialized)throw Error("Library not initialized");LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.CHANGE_GENERAL_OPTIONS,options:a})}static cleanUp(){LibMikMod._currentId++;LibMikMod.infoSongName=null;LibMikMod.infoModType=
null;LibMikMod.infoComment=null;LibMikMod._audioNode=null;LibMikMod._onload=null;LibMikMod._onerror=null;LibMikMod._onended=null}static stopModule(){LibMikMod._audioNode&&(LibMikMod.postMessage({id:LibMikMod._currentId,messageId:LibMikModMessageId.STOP_MODULE}),LibMikMod.cleanUp())}static notifyReaderError(a){LibMikMod.notifyError(LibMikMod.ERROR_FILE_READ,a)}static notifyProcessorError(a){LibMikMod.notifyError(LibMikMod.ERROR_PLAYBACK,a)}static notifyError(a,b){if(LibMikMod._audioNode){var c=LibMikMod._onerror;
LibMikMod.cleanUp();c&&c(a,b)}}static notifyEnded(){if(LibMikMod._audioNode){var a=LibMikMod._onended;LibMikMod.cleanUp();a&&a()}}static handleResponse(a){if(a=a.data)switch(a.messageId){case LibMikModMessageId.LOAD_MODULE_BUFFER:if(a.id!==LibMikMod._currentId||!LibMikMod._audioNode)break;a.errorCode?LibMikMod.notifyError(LibMikMod.ERROR_MODULE_LOAD,a.errorStr||a.errorCode.toString()):(LibMikMod.infoSongName=a.infoSongName||null,LibMikMod.infoModType=a.infoModType||null,LibMikMod.infoComment=a.infoComment||
null,LibMikMod._onload&&LibMikMod._onload(LibMikMod._audioNode));break;case LibMikModMessageId.PLAYBACK_ERROR:if(a.id!==LibMikMod._currentId)break;LibMikMod.notifyProcessorError(a.errorStr||a.errorCode?.toString());break;case LibMikModMessageId.PLAYBACK_ENDED:a.id===LibMikMod._currentId&&LibMikMod.notifyEnded()}}}LibMikMod.WEB_VERSION=4;LibMikMod.LIB_VERSION=null;LibMikMod.ERROR_FILE_READ=1;LibMikMod.ERROR_MODULE_LOAD=2;LibMikMod.ERROR_PLAYBACK=3;LibMikMod.initialized=!1;LibMikMod.initializing=!1;
LibMikMod.initializationError=!1;LibMikMod.infoSongName=null;LibMikMod.infoModType=null;LibMikMod.infoComment=null;LibMikMod._currentId=0;LibMikMod._audioNode=null;LibMikMod._onload=null;LibMikMod._onerror=null;LibMikMod._onended=null;
class HistoryHandler{static init(...a){HistoryHandler._handlers=a||[];window.addEventListener("popstate",HistoryHandler.historyStatePopped)}static historyStatePopped(a){if(HistoryHandler._poppedInternally)HistoryHandler._poppedInternally=!1;else if(a=HistoryHandler._handlers)for(let b=0;b<a.length;b++){const c=a[b]();if(null!==c){c||HistoryHandler.pushState();break}}}static pushState(){window.history.pushState(HistoryHandler._state,Strings.AppName)}static popState(){window.history.state&&window.history.state.id===
Strings.AppName&&(HistoryHandler._poppedInternally=!0,window.history.back())}}HistoryHandler._state={id:Strings.AppName};HistoryHandler._poppedInternally=!1;
class FocusBlocker{constructor(){this._cover=this._parentContainer=this._oldBodyOverflow=this._changedElements=null;this._coverTimeout=0}block(a){this.unblock();const b=(a||document).querySelectorAll("button,input,select,textarea,f-button,f-slider,f-list"),c=[];for(let d=b.length-1;0<=d;d--){const e=b[d],f=e.tabIndex;-1!==f&&(e.tabIndex=-1,c.push({element:e,tabIndex:f}))}this._changedElements=c;a?(this._parentContainer=a,this._cover=document.createElement("div"),this._cover.className="blocker fade",
a.appendChild(this._cover),this._coverTimeout=DelayControl.delayShortCB(()=>{this._coverTimeout&&this._cover&&this._cover.classList.add("in")})):(this._oldBodyOverflow=document.body.style.overflow,document.body.style.overflow="hidden")}unblock(){const a=this._changedElements;if(a){this._changedElements=null;for(let b=a.length-1;0<=b;b--){const c=a[b],d=c.tabIndex;null!==d?c.element.tabIndex=d:c.element.removeAttribute("tabindex")}}this._oldBodyOverflow&&(document.body.style.overflow=this._oldBodyOverflow,
this._oldBodyOverflow=null);this._coverTimeout&&(clearTimeout(this._coverTimeout),this._coverTimeout=0);if(this._parentContainer){const b=this._parentContainer,c=this._cover;this._cover=this._parentContainer=null;c&&(c.classList.remove("in"),DelayControl.delayFadeCB(function(){b.removeChild(c)}))}}}
class Alert{static removeElement(){Alert._element&&parseInt(Alert._element.dataset.timeout)===Alert._timeout&&(document.body.removeChild(Alert._element),Alert._timeout=0,Alert._element=null)}static hideByTimeout(){Alert._element&&parseInt(Alert._element.dataset.timeout)===Alert._timeout&&(Alert._timeout=0,Alert.hide())}static hide(){Alert._element&&Alert._element.classList.contains("in")&&(Alert._timeout&&clearTimeout(Alert._timeout),Alert._element.classList.remove("in"),Alert._timeout=DelayControl.delayFadeCB(Alert.removeElement),
Alert._element.dataset.timeout=Alert._timeout.toString())}static show(a,b){Alert._timeout&&(clearTimeout(Alert._timeout),Alert._timeout=0);Alert._element?(Strings.changeText(Alert._element,a),Alert._element.classList.add("in"),Alert._timeout=setTimeout(Alert.hideByTimeout,DelayControl.fadeDelayMS+(b?Alert._longDelayMS:Alert._shortDelayMS)),Alert._element.dataset.timeout=Alert._timeout.toString()):(Alert._element=document.createElement("div"),Alert._element.role="alert",Alert._element.className="alert fade",
Alert._element.onclick=Alert.hide,document.body.appendChild(Alert._element),DelayControl.delayShortCB(function(){Alert.show(a,b)}))}}Alert._shortDelayMS=2500;Alert._longDelayMS=4500;Alert._timeout=0;Alert._element=null;
class ButtonControl extends HTMLElement{static create(a,b){const c=document.createElement("f-button");a.id&&(c.id=a.id);a.className&&(c.className=a.className);a.square&&(c.square=!0);a.opaque&&(c.opaque=!0);a.unfocusable&&(c.unfocusable=!0);a.checkbox0Color&&(c.checkbox0Color=a.checkbox0Color);a.checkbox1Color&&(c.checkbox1Color=a.checkbox1Color);a.checked&&(c.checked=!0);a.checkable&&(c.checkable=!0);a.color&&(c.color=a.color);a.iconName&&(c.iconName=a.iconName);a.text&&(c.text=a.text);b||(a.onclick&&
(c.onclick=a.onclick),a.parent&&a.parent.appendChild(c));return c}constructor(){super();this._defaultFocusElement=null;this._unfocusable=this._disabled=!1;this._color=null;this._checked=this._checkable=this._opaque=this._square=!1;this._textNode=this._text=this._icon=this._iconCheck=this._checkbox1Color=this._checkbox0Color=null;this._boundClick=this.elementClick.bind(this);this._boundKeyDown=this.elementKeyDown.bind(this)}get defaultFocusElement(){return this._defaultFocusElement||this}get disabled(){return this._disabled}set disabled(a){a?
this.setAttribute("disabled",""):this.removeAttribute("disabled")}get unfocusable(){return this._unfocusable}set unfocusable(a){a?this.setAttribute("unfocusable",""):this.removeAttribute("unfocusable")}get color(){return this._color}set color(a){a?this.setAttribute("color",a):this.removeAttribute("color")}get square(){return this._square}set square(a){a?this.setAttribute("square",""):this.removeAttribute("square")}get opaque(){return this._opaque}set opaque(a){a?this.setAttribute("opaque",""):this.removeAttribute("opaque")}get checkable(){return this._checkable}set checkable(a){a?
this.setAttribute("checkable",""):this.removeAttribute("checkable")}get checked(){return this._checked}set checked(a){a?this.setAttribute("checked",""):this.removeAttribute("checked")}get checkbox0Color(){return this._checkbox0Color}set checkbox0Color(a){a?this.setAttribute("checkbox0-color",a):this.removeAttribute("checkbox0-color")}get checkbox1Color(){return this._checkbox1Color}set checkbox1Color(a){a?this.setAttribute("checkbox1-color",a):this.removeAttribute("checkbox1-color")}get iconName(){return this._icon&&
this._icon.name}set iconName(a){a?this.setAttribute("icon-name",a):this.removeAttribute("icon-name")}get text(){return this._text}set text(a){a?this.setAttribute("text",a):this.removeAttribute("text")}elementClick(a){this._disabled||(this.checked=!this._checked)}elementKeyDown(a){if(!(this._disabled||a.ctrlKey||a.metaKey||a.shiftKey||a.altKey||a.repeat||"Enter"!==a.key&&" "!==a.key))return cancelEvent(a),this.click(),!1}connectedCallback(){if(!this._defaultFocusElement){this.role="button";this.classList.add("btn");
var a=document.createElement("span");this._defaultFocusElement=a;a.tabIndex=-1;this._disabled=!this._disabled;this.attributeChangedCallback("disabled",null,this._disabled?null:"");this._unfocusable=!this._unfocusable;this.attributeChangedCallback("unfocusable",null,this._unfocusable?null:"");this._icon&&a.appendChild(this._icon);var b=this._color;b&&(this._color=null,this.attributeChangedCallback("color",null,b));this._square=!this._square;this.attributeChangedCallback("square",null,this._square?
null:"");this._opaque=!this._opaque;this.attributeChangedCallback("opaque",null,this._opaque?null:"");this._checkable&&(this._checkable=!this._checkable,this.attributeChangedCallback("checkable",null,this._checkable?null:""));this.appendChild(a)}}attributeChangedCallback(a,b,c){b=this._defaultFocusElement;switch(a){case "disabled":a=null!==c;if(this._disabled===a)break;this._disabled=a;if(!b)break;a?this.removeAttribute("tabindex"):this._unfocusable||(this.tabIndex=0);a?this.classList.add("disabled"):
this.classList.remove("disabled");break;case "unfocusable":a=null!==c;if(this._unfocusable===a)break;this._unfocusable=a;if(!b)break;a?(this.removeAttribute("tabindex"),this.removeEventListener("keydown",this._boundKeyDown)):(this._disabled||(this.tabIndex=0),this.addEventListener("keydown",this._boundKeyDown));break;case "color":if(this._color===c)break;if(!b){this._color=c;break}this._icon&&(this._icon.color=c);this._color&&this.classList.remove(this._color);(this._color=c)&&this.classList.add(c);
break;case "square":a=null!==c;if(this._square===a)break;this._square=a;if(!b)break;a?(this._iconCheck&&this._iconCheck.classList.remove("margin"),this._icon&&this._icon.classList.remove("margin"),this.classList.add("square")):(this._iconCheck&&this._iconCheck.classList.add("margin"),this._icon&&this._icon.classList.add("margin"),this.classList.remove("square"));if(b=this._text)this._text=null,this.attributeChangedCallback("text",null,b);break;case "opaque":a=null!==c;if(this._opaque===a)break;this._opaque=
a;if(!b)break;a?this.classList.remove("transparent"):this.classList.add("transparent");break;case "checkable":a=null!==c;if(this._checkable===a)break;this._checkable=a;if(!b)break;a?(this.addEventListener("click",this._boundClick,{capture:!0}),this.role="checkbox",this.ariaChecked=this._checked?"true":"false",this._iconCheck=Icon.create(this._checked?ButtonControl.iconCheckName1:ButtonControl.iconCheckName0,this._checked?this._checkbox1Color||ButtonControl.iconCheckColor1:this._checkbox0Color||ButtonControl.iconCheckColor0,
!0,this._square?null:"margin"),b.insertAdjacentElement("afterbegin",this._iconCheck)):(this.removeEventListener("click",this._boundClick,{capture:!0}),this.role="button",this.ariaChecked=null,this._iconCheck&&(b.removeChild(this._iconCheck),this._iconCheck=null));break;case "checked":b=null!==c;if(this._checked===b)break;this._checked=b;if(!this._iconCheck)break;b?(this.ariaChecked="true",this._iconCheck.name=ButtonControl.iconCheckName1,this._iconCheck.color=this._checkbox1Color||ButtonControl.iconCheckColor1):
(this.ariaChecked="false",this._iconCheck.name=ButtonControl.iconCheckName0,this._iconCheck.color=this._checkbox0Color||ButtonControl.iconCheckColor0);break;case "checkbox0-color":if(this._checkbox0Color===c)break;this._checkbox0Color=c;if(!this._iconCheck)break;this._checked||(this._iconCheck.color=c||ButtonControl.iconCheckColor0);break;case "checkbox1-color":if(this._checkbox1Color===c)break;this._checkbox1Color=c;if(!this._iconCheck)break;this._checked&&(this._iconCheck.color=c||ButtonControl.iconCheckColor1);
break;case "icon-name":c?this._icon?this._icon.name=c:(this._icon=Icon.create(c,this._color,!0,this._square?null:"margin"),b&&(this._textNode?b.insertBefore(this._icon,this._textNode):b.appendChild(this._icon))):this._icon&&(b&&b.removeChild(this._icon),this._icon=null);break;case "text":this._text!==c&&(this._text=c,b&&(this.ariaLabel=c,this._square||!c?(this._textNode&&(b.removeChild(this._textNode),this._textNode=null),c?this.title=c:this.removeAttribute("title")):(this.removeAttribute("title"),
this._textNode?this._textNode.nodeValue=c:(this._textNode=document.createTextNode(c),b.appendChild(this._textNode)))))}}}ButtonControl.iconCheckName0="icon-checkbox-0";ButtonControl.iconCheckName1="icon-checkbox-1";ButtonControl.iconCheckColor0=null;ButtonControl.iconCheckColor1="orange";ButtonControl.disabledFeatures=["shadow"];ButtonControl.observedAttributes="disabled unfocusable color square opaque checkable checked checkbox0-color checkbox1-color icon-name text".split(" ");
customElements.define("f-button",ButtonControl);
class SimpleFilterEditorControl{static sliderToY(a){return GraphicalFilterEditor.zeroChannelValueY-(a<<1)}static yToSlider(a){return Math.max(-30,Math.min(30,-(a-GraphicalFilterEditor.zeroChannelValueY)>>1))}constructor(a,b){this.element=a;this.editor=b;a.classList.add("simple-filter");b=Array(GraphicalFilterEditor.shelfEquivalentZoneCount);const c=function(d){return Formatter.formatDB(.5*d)};this.sliders=b;for(let d=0;d<b.length;d++){const e=document.createElement("span"),f=document.createElement("span"),
g=this.filterToSlider(d);let h;e.className="simple-filter-freq small-bottom-margin";switch(d){case 0:e.innerHTML="31<br/>62";h="31 / 62 Hz";break;case 1:e.innerHTML="<br/>125";h="125 Hz";break;case 2:e.innerHTML="<br/>250";h="250 Hz";break;case 3:e.innerHTML="500<br/>1k";h="500 / 1000 Hz";break;case 4:e.innerHTML="2k<br/>4k";h="2000 / 4000 Hz";break;case 5:e.innerHTML="<br/>8k";h="8000 Hz";break;default:e.innerHTML="<br/>16k",h="16000 Hz"}f.className="small-top-margin";b[d]=SliderControl.create(h,
c,SliderControlValueChild.LeftChild,!1,!0,-30,30,g,"simple-filter-slider"+(!d||AppUI.primaryInputIsTouch?"":" left-margin"),f,e);a.appendChild(b[d]);this.createHandler(b[d],d)}}filterToSlider(a){return SimpleFilterEditorControl.yToSlider(this.editor.getShelfZoneY(a))}createHandler(a,b){const c=this.editor,d=function(e){c.changeShelfZoneY(b,SimpleFilterEditorControl.sliderToY(e));c.commitChanges()};a.ondragchangecommit=d;a.onkeyboardchange=d}updateSliders(){const a=this.sliders;for(let b=0;b<a.length;b++)a[b].value=
this.filterToSlider(b)}}
class ListControlItem{constructor(a){this.index=-1;this.keyboard=this.current=this.selected=!1;this.item=null;this.element=a;a.id="listControlItem"+ListControlItem._internalId++;a.role="row";a.ariaSelected="false";a.ariaReadOnly="true"}reset(){this.index=-1;this.keyboard=this.current=this.selected=!1;this.item=null;this.element&&(this.element.classList.remove("current","selected","keyboard"),this.element.ariaSelected="false")}zero(){this.index=-1;this.keyboard=this.current=this.selected=!1;this.element=
this.item=null}}ListControlItem._internalId=0;
class ListControl extends HTMLElement{constructor(){super();this._useVirtualItems=!0;this._adapter=null;this._boundZoomChanged=this.zoomChanged.bind(this);this._boundRefreshVisibleItemsInternal=this.refreshVisibleItemsInternal.bind(this);this._boundAdjustScrollbarPaddingFromResize=this.adjustScrollbarPaddingFromResize.bind(this);var a=document.createElement("div");a.className="f-list-container";this._container=a;a=document.createElement("div");a.className="f-list-empty-message";this._emptyMessageAdded=
!1;this._emptyMessage=a;this._useVirtualItems||(this._boundNotifyCurrentItemChangedInternal=this.notifyCurrentItemChangedInternal.bind(this));this._resizeObserver=new ResizeObserver(this.resize.bind(this));this._itemMargin=this._itemHeight=1;this._itemHeightAndMargin=2;this._ignoreFirstIndex=!1;this._lastIndex=this._firstIndex=0;this._keyboardItem=this._currentItem=this._currentListItem=null;this._clientHeight=1;this._containerHeight=0;this._scrollbarPaddingScheduled=this._scrollbarPadding=!1;this._visibleCount=
1;this._items=[];this._focused=this._initialized=this._notifyCurrentItemChangedEnqueued=this._refreshVisibleItemsEnqueued=!1;this._lastKeyboardIndex=this._keyboardIndex=-1;this.deleteMode=!1;this.onitemcontextmenu=this.onitemcontrolclick=this.onitemclick=null}destroy(){this._adapter&&(this._adapter.control=null);this._resizeObserver&&this._resizeObserver.unobserve(this);this._items&&this._items.fill(null);this._boundZoomChanged&&AppUI.removeZoomHandler(this._boundZoomChanged);zeroObject(this)}get adapter(){return this._adapter}set adapter(a){this._adapter!==
a&&(this._adapter&&(this._adapter.control=null),this._adapter=a,this.clear(),a&&(a.control=this,this.prepareAdapter(),this._useVirtualItems?this.ariaRowCount=a.list.length.toString():a.list.length&&this.notifyItemsAdded(0,a.list.length-1)))}get emptyMessage(){return(this._emptyMessage?this._emptyMessage.textContent:null)||""}set emptyMessage(a){this._emptyMessage&&(this._emptyMessage.textContent=a)}prepareAdapter(){const a=this._adapter;a&&(this._itemHeight=a.itemHeight,this._itemMargin=AppUI.thickBorderPX,
this._itemHeightAndMargin=this._itemHeight+this._itemMargin,this._currentListItem=a.list.currentItem,this.adjustContainerHeight(),this.resize())}zoomChanged(){if(this._adapter){this.prepareAdapter();var a=this._items;for(let b=a.length-1;0<=b;b--)a[b].index=-1;this._useVirtualItems&&this.elementScroll()}}adjustScrollbarPadding(){const a=(this._containerHeight|0)>this._clientHeight;this._scrollbarPadding!==a&&(this._scrollbarPadding=a,this._useVirtualItems?a?this.classList.add("virtual-padding"):this.classList.remove("virtual-padding"):
this.style.padding=a?"":"0")}adjustScrollbarPaddingFromResize(){this._scrollbarPaddingScheduled=!1;this.adjustScrollbarPadding()}adjustContainerHeight(){var a=this._adapter;const b=this._container;if(a&&b){var c=(a=a.list.length)?a*this._itemHeightAndMargin-this._itemMargin:0;this._containerHeight!==c&&(this._containerHeight=c,b.style.height=c+"px",this.adjustScrollbarPadding(),a?this._emptyMessageAdded&&(this._emptyMessageAdded=!1,this.removeChild(this._emptyMessage)):this._emptyMessageAdded||(this._emptyMessageAdded=
!0,this.appendChild(this._emptyMessage)))}}clear(){if(this._container){var a=this._items;for(var b=a.length-1;0<=b;b--)if(a[b].element){const c=a[b].element.parentNode;c&&c.removeChild(a[b].element)}if(this._useVirtualItems)for(b=a.length-1;0<=b;b--)a[b].reset();else{for(b=a.length-1;0<=b;b--)a[b].zero();a.splice(0)}this._lastIndex=this._firstIndex=0;this._keyboardItem=this._currentItem=this._currentListItem=null;this._containerHeight=this.scrollTop=0;this._container.style.height="0";this._emptyMessageAdded||
(this._emptyMessageAdded=!0,this.appendChild(this._emptyMessage));this._lastKeyboardIndex=0<this._keyboardIndex?this._keyboardIndex=0:-1;this.ariaRowCount="0";this.removeAttribute("aria-activedescendant");this.adjustScrollbarPadding()}}elementScroll(){var a=this._adapter;if(a){var b=this._items,c=this._itemHeightAndMargin,d=this._firstIndex-2,e=this.scrollTop/c|0;0>d&&(d=0);if(this._ignoreFirstIndex)this._ignoreFirstIndex=!1;else if(this._firstIndex===e)return;this._firstIndex=e;var f=this._visibleCount+
(0===e?2:1===e?3:4);f>b.length&&(f=b.length);0>(e-=2)&&(e=0);if(e>d){if((d=e-d)&&d<f)for(let m=d,l=0;m<f;m++,l++)d=b[l],b[l]=b[m],b[m]=d}else if((d-=e)&&d<f)for(let m=f-1,l=m-d;0<=l;l--,m--)d=b[m],b[m]=b[l],b[l]=d;var g=a.list,h=g.length,k=a.list.currentItem,n=this._keyboardIndex;d=0;for(let m=e*c;d<f&&e<h;d++,e++,m+=c){const l=g.item(e),p=b[d];if(p.item!==l){let r=k===l;p.current!==r&&((p.current=r)?p.element.classList.add("current"):p.element.classList.remove("current"));r=n===e;p.keyboard!==r&&
((p.keyboard=r)?(p.element.classList.add("keyboard"),p.element.ariaSelected="true",this.setAttribute("aria-activedescendant",p.element.id)):(this.getAttribute("aria-activedescendant")===p.element.id&&this.removeAttribute("aria-activedescendant"),p.element.classList.remove("keyboard"),p.element.ariaSelected="false"));a.prepareElement(l,e,h,p.element);p.element.ariaRowIndex=e.toString();p.item||this.appendChild(p.element);p.item=l}p.index!==e&&(p.index=e,p.element.style.transform="translateY("+m+"px)")}for(a=
b.length;d<a;d++)c=b[d],c.item&&(c.item=null,this.removeChild(c.element));this._lastIndex=e-1;this._lastIndex<this._firstIndex&&(this._lastIndex=this._firstIndex)}}refreshVisibleItemsInternal(){this._refreshVisibleItemsEnqueued=!1;var a=this._adapter;if(a){this.adjustContainerHeight();var b=this._items,c=this._itemHeightAndMargin,d=a.list,e=d.length,f=a.list.currentItem,g=this._keyboardIndex;if(this._useVirtualItems){this._currentListItem=f;var h=0,k=this._firstIndex,n=this._visibleCount+(0===k?2:
1===k?3:4);n>b.length&&(n=b.length);0>(k-=2)&&(k=0);for(let m=k*c;h<n&&k<e;h++,k++,m+=c){const l=d.item(k),p=b[h];let r=f===l;p.current!==r&&((p.current=r)?p.element.classList.add("current"):p.element.classList.remove("current"));r=g===k;p.keyboard!==r&&((p.keyboard=r)?(p.element.classList.add("keyboard"),p.element.ariaSelected="true",this.setAttribute("aria-activedescendant",p.element.id)):(this.getAttribute("aria-activedescendant")===p.element.id&&this.removeAttribute("aria-activedescendant"),p.element.classList.remove("keyboard"),
p.element.ariaSelected="false"));a.prepareElement(l,k,e,p.element);p.element.ariaRowIndex=k.toString();p.item||this.appendChild(p.element);p.item=l;p.index!==k&&(p.index=k,p.element.style.transform="translateY("+m+"px)")}for(a=b.length;h<a;h++)d=b[h],d.item&&(d.item=null,this.removeChild(d.element))}else{h=this._visibleCount;g=0<=g&&g<b.length?b[g]:null;this._keyboardItem!==g&&(this._keyboardItem&&(this._keyboardItem.element.classList.remove("keyboard"),this._keyboardItem.element.ariaSelected="false"),
g?(g.element.classList.add("keyboard"),g.element.ariaSelected="true",this.setAttribute("aria-activedescendant",g.element.id)):this.removeAttribute("aria-activedescendant"),this._keyboardItem=g);for(let m=0,l=this.indexFromY(0);m<=h&&l<e;m++,l++)g=b[l].element,a.prepareElement(d.item(l),l,e,g),g.ariaRowIndex=l.toString()}}}resize(){const a=this._adapter;if(a){var b=this._clientHeight,c=this.clientHeight;0>c&&(c=0);var d=Math.ceil(c/this._itemHeightAndMargin)+1;if(this._visibleCount!==d&&(this._visibleCount=
d,this._useVirtualItems)){const e=this._items;for(;d+4>e.length;)e.push(new ListControlItem(a.createEmptyElement("f-list-item virtual")))}b!==c&&(this._clientHeight=c,this._useVirtualItems&&(this._ignoreFirstIndex=!0,this.elementScroll()),this._scrollbarPaddingScheduled||(this._scrollbarPaddingScheduled=!0,requestAnimationFrame(this._boundAdjustScrollbarPaddingFromResize)))}}elementClick(a){if(this._adapter&&a.target){var b=this.getBoundingClientRect();b=this.indexFromY(a.clientY-b.top);0<=this._keyboardIndex&&
(this._keyboardIndex=-1,this.refreshVisibleItems());if(0<=b){this._lastKeyboardIndex=b;const c=this._adapter.list.item(b);if(c)if(a.target.classList.contains("f-list-item"))if(this.deleteMode)this._adapter.list.removeItems(b,b);else{if(this.onitemclick)this.onitemclick(c,b,a.button)}else if(this.onitemcontrolclick)this.onitemcontrolclick(c,b,a.button,a.target)}}}elementContextMenu(a){if(!this._adapter||!this.onitemcontextmenu||!a.target)return cancelEvent(a);var b=this.getBoundingClientRect();b=this.indexFromY(a.clientY-
b.top);0<=this._keyboardIndex&&(this._keyboardIndex=-1,this.refreshVisibleItems());if(0<=b){this._lastKeyboardIndex=b;const c=this._adapter.list.item(b);if(c)this.onitemcontextmenu(c,b)}return cancelEvent(a)}elementFocus(){this._focused=!0}elementKeyDown(a){var b=this._adapter;if(!(!b||a.ctrlKey||a.metaKey||a.shiftKey||a.altKey)){var c=0,d=0;switch(a.key){case "ArrowDown":case "ArrowRight":c=1;break;case "ArrowUp":case "ArrowLeft":c=-1;break;case "PageDown":c=this._clientHeight/this._itemHeightAndMargin|
0;break;case "PageUp":c=-(this._clientHeight/this._itemHeightAndMargin|0);break;case "Home":d=-1;break;case "End":d=1;break;case "Enter":a.repeat||(d=2);break;case " ":a.repeat||(d=3);break;default:return}var e=b.list.length;if(0<e){let f=this._keyboardIndex;0>f&&(f=this._lastKeyboardIndex);this.isItemVisible(f)||(f=this.isItemVisible(b.list.currentIndex)?b.list.currentIndex:this.indexFromY(0));f=Math.min(e-1,Math.max(0,f));if(-1===d)f=0;else if(1===d)f=e-1;else{const g=f;f+=c;0>f?f=g?0:e-1:f>=e&&
(f=g===e-1?0:e-1)}this._keyboardIndex=f;this.bringItemIntoView(f);this.refreshVisibleItems();if(1<d&&(c=b.list.item(f)))switch(d){case 2:if(this.deleteMode)b.list.removeItems(f,f);else if(this.onitemclick)this.onitemclick(c,f,0);break;case 3:if(this.deleteMode)b.list.removeItems(f,f);else if(this.onitemcontrolclick&&(b=this.listControlItemFromIndex(f)))this.onitemcontrolclick(c,f,0,b.element)}}else this._keyboardIndex=-1;return cancelEvent(a)}}elementKeyUp(a){const b=this._adapter;b&&!a.ctrlKey&&
!a.metaKey&&!a.altKey&&"Tab"===a.key&&this._focused&&(a=b.list.length)&&(a=Math.min(a-1,Math.max(0,this._lastKeyboardIndex)),this.isItemVisible(a)||(a=this.isItemVisible(b.list.currentIndex)?b.list.currentIndex:this.indexFromY(0)),this._keyboardIndex=a,this.bringItemIntoView(a),this.refreshVisibleItems())}elementBlur(){this._focused=!1;this._lastKeyboardIndex=this._keyboardIndex;0<=this._keyboardIndex&&(this._keyboardIndex=-1,this.refreshVisibleItems())}listControlItemFromIndex(a){if(!this._items)return null;
const b=this._items;for(let c=b.length-1;0<=c;c--)if(b[c].index===a&&b[c].item&&b[c].element)return b[c];return null}yFromIndex(a){return a*this._itemHeightAndMargin-this.scrollTop}indexFromY(a){if(!this._adapter)return-1;a=(a+this.scrollTop+.9)/this._itemHeightAndMargin|0;return 0>a||a>=this._adapter.list.length?-1:a}isItemVisible(a){a=this.yFromIndex(a);return a>-this._itemHeight&&a<this._clientHeight}bringItemIntoView(a,b){const c=this.yFromIndex(a);0>c?b?this.centerItemIntoView(a):this.scrollTop+=
c:c>this._clientHeight-this._itemHeight&&(b?this.centerItemIntoView(a):this.scrollTop+=c-(this._clientHeight-this._itemHeight))}centerItemIntoView(a){this.scrollTop=a*this._itemHeightAndMargin-(this._clientHeight-this._itemHeight>>1)}refreshVisibleItems(){this._refreshVisibleItemsEnqueued||(this._refreshVisibleItemsEnqueued=!0,queueMicrotask(this._boundRefreshVisibleItemsInternal))}notifyCleared(){this.clear()}notifyItemsAdded(a,b){if(this._useVirtualItems)this.refreshVisibleItems();else{const g=
this._adapter;var c=b-a+1;if(!g||0>=c)return;const h=this._items,k=g.list,n=k.length;var d=k.currentItem,e=Array(c);for(var f=b;f>=a;f--){const m=k.item(f),l=new ListControlItem(g.createEmptyElement("f-list-item real"));g.prepareElement(m,f,n,l.element);l.element.ariaRowIndex=f.toString();e[f-a]=l;d===m&&(this._currentItem&&(this._currentItem.current=!1,this._currentItem.element.classList.remove("current")),this._currentItem=l,l.current=!0,l.element.classList.add("current"))}d=a>=h.length?null:h[a].element;
a>=h.length?h.push(...e):h.splice(a,0,...e);if(this._items.length!==k.length)throw Error("Assertion error: this.items.length !== list.length");this.adjustContainerHeight();for(f=0;f<c;f++)this.insertBefore(e[f].element,d);for(c=h.length-1;c>b;c--)e=h[c].element,g.prepareElementIndexOrLengthChanged(k.item(c),c,n,e),e.ariaRowIndex=c.toString();for(--a;0<=a;a--)b=h[a].element,g.prepareElementIndexOrLengthChanged(k.item(a),a,n,b),b.ariaRowIndex=a.toString()}this._adapter&&(this.ariaRowCount=this._adapter.list.length.toString())}notifyItemsRemoved(a,
b){if(this._useVirtualItems)this.refreshVisibleItems();else{const d=this._adapter;var c=b-a+1;if(!d||0>=c)return;b=this._items;const e=d.list,f=e.length;a=b.splice(a,c);for(c=a.length-1;0<=c;c--){const g=a[c];g.current&&(this._currentItem=null);this.removeChild(g.element);g.zero()}if(this._items.length!==e.length)throw Error("Assertion error: this.items.length !== list.length");for(a=b.length-1;0<=a;a--)c=b[a].element,d.prepareElementIndexOrLengthChanged(e.item(a),a,f,c),c.ariaRowIndex=a.toString();
this.adjustContainerHeight()}this._adapter&&(this.ariaRowCount=this._adapter.list.length.toString())}notifyCurrentItemChanged(a,b){this._useVirtualItems?this.refreshVisibleItems():this._notifyCurrentItemChangedEnqueued||(this._notifyCurrentItemChangedEnqueued=!0,queueMicrotask(this._boundNotifyCurrentItemChangedInternal))}notifyCurrentItemChangedInternal(){this._notifyCurrentItemChangedEnqueued=!1;var a=this._adapter;a&&(this._currentItem&&(this._currentItem.current=!1,this._currentItem.element.classList.remove("current")),
a=a.list.currentIndex,0<=a&&a<this._items.length?(this._currentItem=this._items[a],this._currentItem.current=!0,this._currentItem.element.classList.add("current")):this._currentItem=null)}connectedCallback(){if(!this._initialized){this._initialized=!0;this.classList.add("scrollable");this.style.padding="0";this.role="grid";this.ariaReadOnly="true";this.ariaRowCount="0";this.removeAttribute("aria-activedescendant");if(!this.tabIndex||0>=this.tabIndex)this.tabIndex=0;this._useVirtualItems&&this.appendChild(this._container);
this._emptyMessageAdded||(this._emptyMessageAdded=!0,this.appendChild(this._emptyMessage));this.addEventListener("focus",this.elementFocus.bind(this));this.addEventListener("keydown",this.elementKeyDown.bind(this));this.addEventListener("keyup",this.elementKeyUp.bind(this));this.addEventListener("blur",this.elementBlur.bind(this));this._useVirtualItems&&this.addEventListener("scroll",this.elementScroll.bind(this),{passive:!0});this._resizeObserver.observe(this,{box:"border-box"});this.addEventListener("click",
this.elementClick.bind(this));this.addEventListener("contextmenu",this.elementContextMenu.bind(this));this.resize();AppUI.addZoomHandler(this._boundZoomChanged)}}}customElements.define("f-list",ListControl);var SliderControlValueChild;(function(a){a[a.None=0]="None";a[a.LeftChild=1]="LeftChild";a[a.RightChild=2]="RightChild"})(SliderControlValueChild||(SliderControlValueChild={}));
class SliderControl extends HTMLElement{static create(a,b,c,d,e,f,g,h,k,n,m,l){const p=document.createElement("f-slider");a&&(p.ariaLabel=a);k&&(p.className=k);p.leftChild=n||null;p.rightChild=m||null;p.mapper=b;p.valueChild=c;p.unfocusable=d;p.vertical=e;p.manualAria=!!l;f|=0;g|=0;g<f&&(g=f);p.min=f;p.max=g;p.value=Math.max(f,Math.min(g,void 0===h?f:h|0));return p}constructor(){super();this._pointerHandler=this._innerElements=this._rightChild=this._leftChild=null;this._onvaluechangeEnabled=!0;this._mapper=
null;this._unfocusable=this._disabled=!1;this._valueChild=SliderControlValueChild.None;this._manualAria=this._vertical=!1;this._min=0;this._max=1;this._value=0;this._delta=1;this._percent=0;this._valueChangedDragging=this._forcedDragging=!1;this._boundKeyDown=this.elementKeyDown.bind(this);this._boundFocus=this.elementFocus.bind(this);this._boundBlur=this.elementBlur.bind(this);this.onkeyboardchange=this.ondragchangecommit=this.onvaluechange=null}get leftChild(){return this._leftChild}set leftChild(a){if(!this._innerElements)this._leftChild=
a;else if(this._leftChild!==a){var b=this._innerElements.focusContainer;a?this._leftChild?b.replaceChild(a,this._leftChild):b.insertBefore(a,b.firstChild):this._leftChild&&b.removeChild(this._leftChild);this._leftChild&&this._leftChild.classList.remove("f-slider-extra-child");if(this._leftChild=a)a.classList.add("f-slider-extra-child"),this._valueChild!==SliderControlValueChild.LeftChild||this._manualAria||Strings.changeText(a,this.ariaValueText||this.ariaValueNow)}}get rightChild(){return this._rightChild}set rightChild(a){if(!this._innerElements)this._rightChild=
a;else if(this._rightChild!==a){var b=this._innerElements.focusContainer;a?this._rightChild?b.replaceChild(a,this._rightChild):b.appendChild(a):this._rightChild&&b.removeChild(this._rightChild);this._rightChild&&this._rightChild.classList.remove("f-slider-extra-child");if(this._rightChild=a)a.classList.add("f-slider-extra-child"),a&&this._valueChild===SliderControlValueChild.RightChild&&!this._manualAria&&Strings.changeText(a,this.ariaValueText||this.ariaValueNow)}}get dragging(){return this._forcedDragging||
(this._pointerHandler?this._pointerHandler.captured:!1)}get mapper(){return this._mapper}set mapper(a){this._innerElements?this._mapper!==a&&(this._mapper=a,this._onvaluechangeEnabled=!1,a=this._value,this._value=this._min-1,this.value=a,this._onvaluechangeEnabled=!0):this._mapper=a}get disabled(){return this._disabled}set disabled(a){a?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get unfocusable(){return this._unfocusable}set unfocusable(a){a?this.setAttribute("unfocusable",
""):this.removeAttribute("unfocusable")}get valueChild(){return this._valueChild}set valueChild(a){this.setAttribute("value-child",a.toString())}get vertical(){return this._vertical}set vertical(a){a?this.setAttribute("vertical",""):this.removeAttribute("vertical")}get manualAria(){return this._manualAria}set manualAria(a){a?this.setAttribute("manual-aria",""):this.removeAttribute("manual-aria")}get min(){return this._min}set min(a){this.setAttribute("min",a.toString())}get max(){return this._max}set max(a){this.setAttribute("max",
a.toString())}get value(){return this._value}set value(a){a|=0;if(this._innerElements){a<this._min?a=this._min:a>this._max&&(a=this._max);var b=this._value;this._value=a;this._percent=100*(a-this._min)/this._delta;var c=this._percent+"%",d=this._innerElements;d&&(this.vertical?d.filledRuler.style.top=100-this._percent+"%":d.filledRuler.style.right=100-this._percent+"%",this.vertical?d.ruler.style.bottom=c:d.ruler.style.left=c,this.vertical?d.thumb.style.bottom=c:d.thumb.style.left=c);if(a!==b){if(!this._manualAria)switch(this._mapper?
(this.ariaValueText=b=this._mapper(a),this.ariaValueNow=a.toString()):this.ariaValueNow=b=a.toString(),this._valueChild){case SliderControlValueChild.LeftChild:this._leftChild&&Strings.changeText(this._leftChild,b);break;case SliderControlValueChild.RightChild:this._rightChild&&Strings.changeText(this._rightChild,b)}this.dragging&&(this._valueChangedDragging=!0);if(this.onvaluechange&&this._onvaluechangeEnabled)this.onvaluechange(a)}}else this._value=a}elementMouseDown(a){if(a.button||this._disabled||
!this._innerElements)return!1;this._innerElements.focusContainer.focus();this._innerElements.container.classList.add("active");this._forcedDragging=!0;this._valueChangedDragging=!1;this.elementMouseMove(a);this._forcedDragging=!1;return!0}elementMouseMove(a){if(this._innerElements){var b=this._innerElements.innerContainer.getBoundingClientRect();if(this.vertical){var c=b.bottom-b.top;a=c-(a.clientY-(b.top-3))}else c=b.right-b.left,a=a.clientX-(b.left+4);this.value=0>=c?this._min:this._min+this._delta*
a/c}}elementMouseUp(a){if(this._innerElements){this._innerElements.container.classList.remove("active");if(this.ondragchangecommit&&this._valueChangedDragging)this.ondragchangecommit(this._value);this._valueChangedDragging=!1}}elementKeyDown(a){if(!(this._pointerHandler&&this._pointerHandler.captured||this._disabled||a.ctrlKey||a.metaKey||a.shiftKey||a.altKey)){var b=this._value;switch(a.key){case "ArrowDown":case "ArrowLeft":this.value=b-1;if(this.onkeyboardchange&&this._value!==b)this.onkeyboardchange(this._value);
break;case "ArrowUp":case "ArrowRight":this.value=b+1;if(this.onkeyboardchange&&this._value!==b)this.onkeyboardchange(this._value);break;case "PageDown":this.value=b-.1*this._delta;if(this.onkeyboardchange&&this._value!==b)this.onkeyboardchange(this._value);break;case "PageUp":this.value=b+.1*this._delta;if(this.onkeyboardchange&&this._value!==b)this.onkeyboardchange(this._value);break;default:return}return cancelEvent(a)}}elementFocus(){this._innerElements?.container.classList.add("active")}elementBlur(){this._innerElements?.container.classList.remove("active")}manuallyChangeAll(a,
b,c){this.value=a;this.manuallyChangeAria(b,c)}manuallyChangeAria(a,b){this.ariaValueText=a;this.ariaValueNow=this._value.toString();switch(b){case SliderControlValueChild.LeftChild:this._leftChild&&Strings.changeText(this._leftChild,a);break;case SliderControlValueChild.RightChild:this._rightChild&&Strings.changeText(this._rightChild,a)}}connectedCallback(){if(!this._innerElements){this.role="slider";var a=this._vertical?" vertical":"",b=document.createElement("span");b.className="f-slider-focus-container"+
a;b.tabIndex=-1;var c=document.createElement("span");c.className="f-slider-container"+a;b.appendChild(c);var d=document.createElement("span");d.className="f-slider-inner-container"+a;c.appendChild(d);var e=document.createElement("span");e.className="f-slider-ruler"+a;d.appendChild(e);var f=document.createElement("span");f.className="f-slider-color f-slider-filled-ruler"+a;d.appendChild(f);var g=document.createElement("span");g.className="f-slider-color f-slider-thumb"+a;d.appendChild(g);this._innerElements=
{focusContainer:b,container:c,innerContainer:d,ruler:e,filledRuler:f,thumb:g};this._pointerHandler=new PointerHandler(c,this.elementMouseDown.bind(this),this.elementMouseMove.bind(this),this.elementMouseUp.bind(this));this._disabled=!this._disabled;this.attributeChangedCallback("disabled",null,this._disabled?null:"");this._unfocusable=!this._unfocusable;this.attributeChangedCallback("unfocusable",null,this._unfocusable?null:"");this.ariaValueMin=this._min.toString();this.ariaValueMax=this._max.toString();
this._delta=this._max-this._min;this._delta||(this._delta=1);this._vertical=!this._vertical;this.attributeChangedCallback("vertical",null,this._vertical?null:"");if(a=this._leftChild)this._leftChild=null,this.leftChild=a;if(a=this._rightChild)this._rightChild=null,this.rightChild=a;this.appendChild(b)}}attributeChangedCallback(a,b,c){b=this._innerElements;switch(a){case "disabled":a=null!==c;if(this._disabled===a)break;this._disabled=a;if(!b)break;a?this.removeAttribute("tabindex"):this._unfocusable||
(this.tabIndex=0);a?this.classList.add("disabled"):this.classList.remove("disabled");break;case "unfocusable":a=null!==c;if(this._unfocusable===a)break;this._unfocusable=a;if(!b)break;a?(this.removeAttribute("tabindex"),this.removeEventListener("keydown",this._boundKeyDown),this.removeEventListener("focus",this._boundFocus),this.removeEventListener("blur",this._boundBlur)):(this._disabled||(this.tabIndex=0),this.addEventListener("keydown",this._boundKeyDown),this.addEventListener("focus",this._boundFocus),
this.addEventListener("blur",this._boundBlur));break;case "value-child":b=parseInt(c)||0;if(1>b||2<b)b=SliderControlValueChild.None;if(this._valueChild===b)break;this._valueChild=b;this._manualAria||(this._leftChild&&this._valueChild===SliderControlValueChild.LeftChild?Strings.changeText(this._leftChild,this.ariaValueText||this.ariaValueNow):this._rightChild&&this._valueChild===SliderControlValueChild.RightChild&&Strings.changeText(this._rightChild,this.ariaValueText||this.ariaValueNow));break;case "vertical":a=
null!==c;if(this._vertical===a)break;this._vertical=a;if(!b)break;a?(this.classList.add("vertical"),b.focusContainer.classList.add("vertical"),b.container.classList.add("vertical"),b.innerContainer.classList.add("vertical"),b.ruler.classList.add("vertical"),b.filledRuler.classList.add("vertical"),b.thumb.classList.add("vertical"),b.filledRuler.style.right="",b.ruler.style.left="",b.thumb.style.left=""):(this.classList.remove("vertical"),b.focusContainer.classList.remove("vertical"),b.container.classList.remove("vertical"),
b.innerContainer.classList.remove("vertical"),b.ruler.classList.remove("vertical"),b.filledRuler.classList.remove("vertical"),b.thumb.classList.remove("vertical"),b.filledRuler.style.top="",b.ruler.style.bottom="",b.thumb.style.bottom="");this.ariaOrientation=a?"vertical":"horizontal";this._onvaluechangeEnabled=!1;b=this._value;this._value=this._min-1;this.value=b;this._onvaluechangeEnabled=!0;break;case "manual-aria":this._manualAria=null!=c;break;case "min":a=parseInt(c)||0;if(this._min===a)break;
this._min=a;if(!b){this._max<a&&(this._max=a);break}this._max<a&&(this._max=a,this.ariaValueMax=a.toString());this._delta=this._max-a;this._delta||(this._delta=1);this.ariaValueMin=a.toString();this.value=this._value;break;case "max":a=parseInt(c)||0;if(this._max===a)break;this._max=a;if(!b){this._min>a&&(this._min=a);break}this._min>a&&(this._min=a,this.ariaValueMin=a.toString());this._delta=a-this._min;this._delta||(this._delta=1);this.ariaValueMax=a.toString();this.value=this._value;break;case "value":this.value=
parseInt(c)||0}}}SliderControl.disabledFeatures=["shadow"];SliderControl.observedAttributes="disabled unfocusable value-child vertical manual-aria min max value".split(" ");customElements.define("f-slider",SliderControl);class Menu{static historyStatePopped(){return null}}
class GraphicalFilterControl extends ConnectableNode{constructor(a,b,c,d){super();this._simpleMode=!!d;this._container=a;this._outerContainer=b;d=document.createElement("div");this._simpleMode||(b.style.minWidth=GraphicalFilterControl._advancedModeMinWidth,a.appendChild(d));const e=InternalStorage.loadGraphicalFilterEditorSettings();this._simpleMode&&(e.editMode=GraphicalFilterEditorControl.editModeShelfEq);this.editor=new GraphicalFilterEditorControl(d,2048,c,this.filterChanged.bind(this),e,{svgRenderer:!0,
fontSize:AppUI.smallFontSizeREM+"rem",lineHeight:AppUI.smallContentsSizeREM+"rem",radioHTML:Icon.createHTML("icon-radio",null,!1,"menu-icon"),checkHTML:Icon.createHTML("icon-check",null,!1,"menu-icon"),openMenuHTML:`<span>${Icon.createHTML("icon-expand-less",null,!0)}</span>`,closeMenuHTML:`<span>${Icon.createHTML("icon-expand-more",null,!0)}</span>`});d=document.createElement("div");d.className="button-bottom-margin";this._simpleMode&&(b.style.minWidth=GraphicalFilterControl._simpleModeMinWidth,
a.appendChild(d));this._simpleEditor=new SimpleFilterEditorControl(d,this.editor);a=this.editor.element.querySelectorAll("div.GELBL");for(b=a.length-1;0<=b;b--)c=a[b],c.style.height="var(--button-size)",c.style.fontSize=AppUI.smallFontSizeREM+"rem",c.style.lineHeight=AppUI.contentsSizeREM+"rem",c.style.paddingTop="var(--button-padding)",c.style.paddingBottom="0";a=this.editor.element.querySelector("div.GEBTN.GECLK");a.className="btn square white transparent";a.style.width="";a.style.padding="";a.style.float=
"right"}get input(){return this.editor.filter.inputNode}get output(){return this.editor.filter.outputNode}filterChanged(){this.enabled&&this.nodesChanged()}get simpleMode(){return this._simpleMode}set simpleMode(a){if(this._simpleMode!==a){this._simpleMode=a;if(a){this._outerContainer.style.minWidth=GraphicalFilterControl._simpleModeMinWidth;this.editor.editMode=GraphicalFilterEditorControl.editModeShelfEq;this._simpleEditor.updateSliders();a=this.editor.element;var b=this._simpleEditor.element}else this._outerContainer.style.minWidth=
GraphicalFilterControl._advancedModeMinWidth,a=this._simpleEditor.element,b=this.editor.element;a&&a.parentNode&&a.parentNode.removeChild(a);this._container&&b&&!b.parentNode&&this._container.appendChild(b);this.filterChanged()}}saveSettings(){this.editor&&InternalStorage.saveGraphicalFilterEditorSettings(this.editor.saveSettings())}}GraphicalFilterControl.defaultPresets={Powerful:"oaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGgoKCgoKCgoKCfn5+fn5+enp6enp2dnZ2cnJybm5qampqZmZmYmJiXl5eWlpWVlZSUlJOTkpKSkZGRkZCQkI+Pj46Ojo6NjY2NjYyMjIyLi4uLi4uKioqKioqKioqKiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmKioqKioqKioqKioqKiouLi4uLjIyMjIyNjY2Njo6Ojo+Pj4+QkJCRkpKSk5OTk5SUlJWVlZWWlpaXl5eXmJiYmZmZmZqampqbm5ubnJycnJ2dnZ2enp6enp+fn5+fn6CgoKCgoKCgoKGhoaGhoaGhoaGhoaGhoaE="};
GraphicalFilterControl._simpleModeMinWidth="280px";GraphicalFilterControl._advancedModeMinWidth="512px";
class StereoPannerControl extends ConnectableNode{constructor(a,b){super();this._pan=InternalStorage.loadStereoPannerSettings();this._appliedGain=1;this._channelSplitter=b.createChannelSplitter(2);this._gain=b.createGain();this._channelMerger=b.createChannelMerger(2);this._rightGain=this._leftGain=!1;this.onappliedgainchange=null;b=this.commitChanges.bind(this);const c=document.createElement("span");c.className="db-label large small-left-margin";a.ariaLabel=Strings.Panning;a.min=-StereoPannerControl.maxAbsoluteValue;
a.max=StereoPannerControl.maxAbsoluteValue;a.value=this._pan;a.mapper=function(d){return(d?(0>d?Strings.RightAbbrev:Strings.LeftAbbrev)+" "+((d=Math.abs(d))>=StereoPannerControl.maxAbsoluteValue?GraphicalFilterEditorStrings.MinusInfinity:"-"+d):"-0")+" dB"};a.valueChild=SliderControlValueChild.RightChild;a.rightChild=c;a.ondragchangecommit=b;a.onkeyboardchange=b;this._slider=a;this.commitChanges(this._pan)}get input(){return this._channelSplitter}get output(){return this._channelMerger}commitChanges(a){const b=
this._channelSplitter,c=this._gain,d=this._channelMerger;if(b&&c&&d){var e=Math.abs(a),f=Math.abs(this._pan)!==e;this._pan=a;if(e){a=0<a;const g=!a;this._appliedGain=e>=StereoPannerControl.maxAbsoluteValue?0:Math.pow(10,-e/20);c.gain.value=this._appliedGain;if(a!==this._leftGain||g!==this._rightGain)b.disconnect(),c.disconnect(),this._leftGain=a,this._rightGain=g,a?(b.connect(c,0,0),c.connect(d,0,0),b.connect(d,1,1)):(b.connect(c,1,0),c.connect(d,0,1),b.connect(d,0,0))}else this._appliedGain=1,this._rightGain=
this._leftGain=!1,c.disconnect(),b.disconnect(),b.connect(d,0,0),b.connect(d,1,1);if(f&&this.enabled&&this.onappliedgainchange)this.onappliedgainchange(this._appliedGain)}}get enabled(){return super.enabled}set enabled(a){if(a!==this.enabled&&(super.enabled=a,this.onappliedgainchange))this.onappliedgainchange(this.appliedGain)}get appliedGain(){return this.enabled?this._appliedGain:1}get pan(){return this._pan}set pan(a){a=Math.max(-StereoPannerControl.maxAbsoluteValue,Math.min(StereoPannerControl.maxAbsoluteValue,
a|0));this._pan!==a&&(this._slider.value=a,this.commitChanges(a))}saveSettings(){InternalStorage.saveStereoPannerSettings(this._pan)}}StereoPannerControl.maxAbsoluteValue=20;
class MonoDownMixerControl extends ConnectableNode{static isSupported(){return"AudioWorklet"in window&&"AudioWorkletNode"in window}constructor(a){super();this._multiplier=.5;this._audioContext=a;this._audioNode=null;this._desiredEnabled=this._loaded=this._loading=!1}get input(){return this._audioNode}get output(){return this._audioNode}get enabled(){return super.enabled}set enabled(a){MonoDownMixerControl.isSupported()||(a=!1);this._desiredEnabled=a;this._audioNode?super.enabled=a:a&&(this._loaded?
this.createAudioNode():this.load())}get multiplier(){return this._multiplier}set multiplier(a){this._multiplier=a;this._audioNode&&(this._audioNode.parameters.get("multiplier").value=a)}showError(a,b){Alert.show("Error while "+a+": "+(b?b.message||b.toString():"Unknown error"),!0)}load(){this._loading||this._loaded||!this._audioContext||(this._loading=!0,addAudioWorkletModule(this._audioContext,"assets/js/monodownmixerprocessor.js?"+window.CACHE_VERSION).then(()=>{this._loading=!1;this._loaded=!0;
this.createAudioNode()},a=>{this.showError("loading the mono down-mixer script",a)}))}createAudioNode(){if(this._loaded){this._audioNode&&(this._audioNode.disconnect(),this._audioNode=null);try{const a=new AudioWorkletNode(this._audioContext,"monodownmixerprocessor");1!==a.numberOfInputs?(super.enabled=!1,this.showError("creating the mono down-mixer node","audioNode.numberOfInputs is "+a.numberOfInputs+", but should be 1")):1!==a.numberOfOutputs?(super.enabled=!1,this.showError("creating the mono down-mixer node",
"audioNode.numberOfOutputs is "+a.numberOfOutputs+", but should be 1")):2!==a.channelCount?(super.enabled=!1,this.showError("creating the mono down-mixer node","audioNode.channelCount is "+a.channelCount+", but should be 2")):(this._audioNode=a,a.onprocessorerror=b=>{this._audioNode&&this._audioNode===a&&(a.disconnect(),super.enabled=!1,this._audioNode=null,this.showError("processing the mono down-mixer",b))},a.parameters.get("multiplier").value=this._multiplier,super.enabled=this._desiredEnabled)}catch(a){super.enabled=
!1,this.showError("creating the mono down-mixer node",a)}}}}
class HostMediaSession{static setActionHandler(a,b,c){try{a.setActionHandler(b,c)}catch(d){}}static setUpMediaSession(a){if(a){var b=function(){App.player&&App.player.playPause()};HostMediaSession.setActionHandler(a,"previoustrack",function(){App.player&&App.player.previous()});HostMediaSession.setActionHandler(a,"seekbackward",function(){App.player&&App.player.seekBackward()});HostMediaSession.setActionHandler(a,"pause",b);HostMediaSession.setActionHandler(a,"play",b);HostMediaSession.setActionHandler(a,
"seekforward",function(){App.player&&App.player.seekForward()});HostMediaSession.setActionHandler(a,"nexttrack",function(){App.player&&App.player.next()})}}static cleanUpMediaSession(a){a&&(HostMediaSession.setActionHandler(a,"previoustrack",null),HostMediaSession.setActionHandler(a,"seekbackward",null),HostMediaSession.setActionHandler(a,"pause",null),HostMediaSession.setActionHandler(a,"play",null),HostMediaSession.setActionHandler(a,"seekforward",null),HostMediaSession.setActionHandler(a,"nexttrack",
null))}static getMediaSession(){if(App.hostInterface)return App.hostInterface;if(!HostMediaSession._browserWrapper){const a="mediaSession"in navigator&&"MediaMetadata"in window?navigator.mediaSession:null;if(a&&"setActionHandler"in a){HostMediaSession.setUpMediaSession(a);let b=!0,c=!1;const d="setPositionState"in a?function(e,f){try{0<=e?(e/=1E3,a.setPositionState({duration:e,position:Math.min(0<=f?f:0,e),playbackRate:1})):a.setPositionState({duration:Infinity,position:0<=f?f:0,playbackRate:1})}catch(g){}}:
function(){};HostMediaSession._browserWrapper={setPaused:function(e,f,g){b=e;a.playbackState=b||c?"paused":"playing";d(f,g)},setLoading:function(e,f,g){c=e;a.playbackState=b||c?"paused":"playing";d(f,g)},setMetadata:function(e,f,g,h,k,n,m,l){0<e?(a.metadata=new window.MediaMetadata({title:f,artist:g,album:h,artwork:[{src:"assets/images/albumArts/64x64.png",sizes:"64x64",type:"image/png"},{src:"assets/images/albumArts/96x96.png",sizes:"96x96",type:"image/png"},{src:"assets/images/albumArts/192x192.png",
sizes:"192x192",type:"image/png"},{src:"assets/images/albumArts/256x256.png",sizes:"256x256",type:"image/png"},{src:"assets/images/albumArts/512x512.png",sizes:"512x512",type:"image/png"}]}),"none"==a.playbackState&&(a.playbackState="paused"),d(m,l)):(a.metadata=null,a.playbackState="none")},cleanUpMediaSession:function(){HostMediaSession.cleanUpMediaSession(a)}}}}return HostMediaSession._browserWrapper}}HostMediaSession._browserWrapper=null;
class Player{constructor(a,b,c,...d){this._audioContextTimeout=0;this._audioContextSuspended=!0;var e=navigator.userAgent&&0<=navigator.userAgent.indexOf("Firefox")?1:"playback";this.audioContext=window.AudioContext?new window.AudioContext({latencyHint:e}):new window.webkitAudioContext({latencyHint:e});this.audioContext.suspend();this.audioContext.onstatechange=this.audioContextStateChange.bind(this);if(d&&d.length){e=Array(d.length);for(let f=0;f<d.length;f++)e[f]=d[f](this.audioContext)}else e=
[];this._intermediateNodes=e;this._destinationNode=new DestinationNode(this.audioContext.destination);this._destinationNode.enabled=!0;this._boundPlaybackError=this.onerror=this.oncurrenttimeschange=this.onpausedchange=this.onloadingchange=this.onsongchange=null;this._boundNotifySongChange=this.notifySongChange.bind(this);this._boundCheckAudioContext=this.checkAudioContext.bind(this);this._boundAutoNext=this.next.bind(this,!0);this._alive=!0;this._loading=!1;this._paused=!0;this._songToResumeTime=
this._loadedSong=this._currentPlaylistSong=this._playlist=null;this._volume=0;this._mutedByHeadsetRemoval=!1;this._firstFailedSongIndex=-1;this._lastObjectURL=null;this._resumeTimeS=this._lastTimeS=-1;this._songStartedAutomatically=!0;this.haltOnAllErrors=!1;this._nextSongVersion=0;this._nextSongObjectURL=null;this._nextSongLoadedWithError=this._nextSongLoading=!1;this._nextAudioBundle=this._nextSongAlreadyChecked=this._nextSongToPlayAfterLoading=null;this.volume=a||0;this._sourceNode=this._audio=
null;this.recreateAudioPath();this._mediaSession=c||null;b&&(this.playlist=b)}createAudioBundle(a){const b=document.createElement("audio");var c=this.audioContext.createMediaElementSource(b);c=new SourceNode(c);var d=a?(g,h,k,n,m)=>{this._audio===b?this.playbackError(g,h,k,n,m):this._nextAudioBundle&&this._nextAudioBundle.audio&&this._nextAudioBundle.audio===b&&this._nextAudioBundle.nextSong===a&&(this._nextSongLoading=!1,this._nextSongLoadedWithError=!0)}:(g,h,k,n,m)=>{this._audio===b&&this.playbackError(g,
h,k,n,m)};const e={audio:b,sourceNode:c,nextSong:a,boundPlaybackError:d};b.style.pointerEvents="none";b.style.position="absolute";b.style.left="0";b.style.top="0";b.style.zIndex="-1";b.loop=!1;b.controls=!1;b.autoplay=!1;document.body.appendChild(b);const f=()=>{this._audio===b&&this.playbackLoadStart()};b.onwaiting=f;b.onloadstart=f;b.oncanplay=a?()=>{this._audio===b?(this.playbackLoadEnd(),this._nextSongToPlayAfterLoading&&(this._nextSongToPlayAfterLoading===a&&(this._nextSongLoadedWithError=this._nextSongLoading=
!1,this.nextSongPerformFinalPlaybackSteps()),this._nextSongToPlayAfterLoading=null)):this._playlist&&this._nextAudioBundle&&this._nextAudioBundle.audio&&this._nextAudioBundle.audio===b&&this._nextAudioBundle.nextSong===a&&(this._nextSongLoadedWithError=this._nextSongLoading=!1)}:()=>{this._audio===b&&this.playbackLoadEnd()};b.onended=()=>{this._audio===b&&this.playbackEnd()};b.onerror=d;b.onpause=()=>{this._audio===b&&this.playbackPaused()};b.onplaying=()=>{this._audio===b&&this.playbackStarted()};
d=()=>{this._audio===b&&this.playbackAborted()};b.onabort=d;b.onemptied=d;b.ondurationchange=()=>{this._audio===b&&this.playbackLengthChange()};b.ontimeupdate=()=>{this._audio===b&&this.currentTimeChange()};c.enabled=!0;return e}recreateAudioPath(){const a=this._intermediateNodes;this._sourceNode&&this._sourceNode.disconnectFromDestination();for(var b=a.length-1;0<=b;b--)a[b].disconnectFromDestination();this._audio&&document.body.removeChild(this._audio);const {audio:c,sourceNode:d,boundPlaybackError:e}=
this.createAudioBundle(null);this._audio=c;this._sourceNode=d;this._boundPlaybackError=e;if(a.length){d.connectToDestination(a[0]);for(b=0;b<a.length-1;b++)a[b].connectToDestination(a[b+1]);a[a.length-1].connectToDestination(this._destinationNode)}else d.connectToDestination(this._destinationNode);this.volume=this._volume}destroy(a){this.stop();if(a){if(this._alive=!1,this._sourceNode&&this._sourceNode.disconnectFromDestination(),(a=this._intermediateNodes)&&a.length)for(let b=a.length-1;0<=b;b--)a[b].disconnectFromDestination()}else this._playlist&&
this._playlist.destroy(),(a=this._mediaSession)&&a.cleanUpMediaSession&&a.cleanUpMediaSession(),zeroObject(this)}get alive(){return this._alive}get loading(){return this._loading}get paused(){return this._paused}get volume(){return this._volume}set volume(a){this._volume=Math.max(Player.minVolume,Math.min(0,a|0));this._audio&&(this._audio.volume=a<=Player.minVolume?0:Math.pow(10,this._volume/20))}get playlist(){return this._playlist}set playlist(a){if(this._alive){var b=this._currentPlaylistSong;
this.stop();if(this._playlist=a)this._currentPlaylistSong=a.currentItem,0<a.currentIndexResumeTimeS&&this._currentPlaylistSong?(this._songToResumeTime=this._currentPlaylistSong,this._lastTimeS=a.currentIndexResumeTimeS):this._lastTimeS=0;b!==this._currentPlaylistSong&&this.notifySongChange()}}get currentSong(){return this._currentPlaylistSong}get currentTimeMS(){if(this._loadedSong&&this._audio)try{const a=this._audio.currentTime||0;this._lastTimeS=a;return 1E3*a|0}catch(a){}return 1E3*this._lastTimeS|
0}handleError(a){const b=this._lastTimeS;this.stop();this.recreateAudioPath();if(this.haltOnAllErrors){if(this.onerror)this.onerror(a)}else{var c=!1;this._playlist&&this._playlist.length?0>b&&((c=!this._songStartedAutomatically)?this._firstFailedSongIndex=-1:0>this._firstFailedSongIndex||this._firstFailedSongIndex>=this._playlist.length?this._firstFailedSongIndex=this._playlist.currentIndex:this._firstFailedSongIndex===this._playlist.currentIndex&&(this._firstFailedSongIndex=-1,c=!0)):c=!0;if(c&&
this.onerror)this.onerror(a);else queueMicrotask(this._boundAutoNext)}}audioContextStateChange(){this._alive&&"running"!==this.audioContext.state&&!this._audioContextSuspended&&(this._audioContextSuspended=!0,this.playbackPaused())}playbackLoadStart(){if(this._alive&&!this._loading){this._loading=!0;if(this.onloadingchange)this.onloadingchange(!0);this._mediaSession&&this._mediaSession.setLoading(!0,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,this._lastTimeS)}}playbackLoadEnd(){if(this._alive&&
this._loading){this._loading=!1;if(this._songToResumeTime){if(this._audio&&this._songToResumeTime===this._loadedSong&&0<this._resumeTimeS){try{this._audio.currentTime=this._resumeTimeS}catch(b){}const a=this._audio.play();a&&a.catch(Player._nop)}this._songToResumeTime=null}if(this.onloadingchange)this.onloadingchange(!1);this._mediaSession&&this._mediaSession.setLoading(!1,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,this._lastTimeS)}}playbackEnd(){this._alive&&this.next(!0)}playbackError(a,
b,c,d,e){this._alive&&this.handleError(e?e.message?e.message:"string"===typeof e?e:e.toString():"string"===typeof a?a:Strings.UnknownError)}suspendAudioContext(a){this._audioContextTimeout&&(clearTimeout(this._audioContextTimeout),this._audioContextTimeout=0);this._audioContextSuspended||(a?this._audioContextTimeout=window.setTimeout(this._boundCheckAudioContext,5E3):(this._audioContextSuspended=!0,this.audioContext.suspend()))}resumeAudioContext(){this._audioContextTimeout&&(clearTimeout(this._audioContextTimeout),
this._audioContextTimeout=0);if(this._audioContextSuspended||"running"!==this.audioContext.state)this._audioContextSuspended=!1,this.audioContext.resume()}checkAudioContext(){this._audioContextTimeout=0;this._paused?this._audioContextSuspended||(this._audioContextSuspended=!0,this.audioContext.suspend()):this._audioContextSuspended&&(this._audioContextSuspended=!1,this.audioContext.resume())}playbackPaused(){if(this._alive&&!this._paused){this._paused=!0;this.suspendAudioContext(!0);if(this._audio)try{this._lastTimeS=
this._audio.currentTime||0}catch(a){}if(this.onpausedchange)this.onpausedchange(!0);this._mediaSession&&this._mediaSession.setPaused(!0,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,this._lastTimeS)}}playbackStarted(){if(this._alive&&this._paused){if(this._mutedByHeadsetRemoval&&(this._mutedByHeadsetRemoval=!1,this._audio)){this._audio.pause();this._audio.muted=!1;return}this._firstFailedSongIndex=-1;this._paused=!1;this.resumeAudioContext();if(this._audio)try{this._lastTimeS=this._audio.currentTime||
0}catch(a){}if(this.onpausedchange)this.onpausedchange(!1);this._mediaSession&&this._mediaSession.setPaused(!1,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,this._lastTimeS)}}playbackAborted(){if(this._alive){if(this._loading){this._loading=!1;if(this.onloadingchange)this.onloadingchange(!1);this._mediaSession&&this._mediaSession.setLoading(!1,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,0)}if(!this._paused){this._paused=!0;this.suspendAudioContext(!0);if(this.onpausedchange)this.onpausedchange(!0);
this._mediaSession&&this._mediaSession.setPaused(!0,this._currentPlaylistSong?this._currentPlaylistSong.lengthMS:0,0)}}}playbackLengthChange(){this._alive&&this._audio&&this._playlist&&this._loadedSong&&this._playlist.updateSongLength(this._loadedSong,this._audio.duration)&&this.notifySongChange()}currentTimeChange(){if(this._alive&&this._audio&&this._loadedSong){try{this._lastTimeS=this._audio.currentTime||0}catch(a){}if(this.oncurrenttimeschange)this.oncurrenttimeschange(this._lastTimeS)}}notifyMediaSessionChange(){if(this._mediaSession){var a=
this._currentPlaylistSong;a?this._mediaSession.setMetadata(a.id,a.title,a.artist,a.album,a.track,a.year,a.lengthMS,this._lastTimeS):this._mediaSession.setMetadata(0,null,null,null,0,0,0,0)}}notifyCurrentTimeSChange(){if(this._alive){if(this.oncurrenttimeschange)this.oncurrenttimeschange(this._lastTimeS);this.notifyMediaSessionChange()}}notifySongChange(){if(this._alive){if(this.onsongchange)this.onsongchange(this._currentPlaylistSong,this._lastTimeS);this.notifyMediaSessionChange()}}destroyNextAudioBundle(){this._nextSongVersion++;
this._nextSongObjectURL&&(URL.revokeObjectURL(this._nextSongObjectURL),this._nextSongObjectURL=null);if(this._nextAudioBundle){const a=this._nextAudioBundle;this._nextAudioBundle=null;if(a.audio){for(;a.audio.firstChild;)a.audio.removeChild(a.audio.firstChild);a.audio.load();a.audio.parentNode&&a.audio.parentNode.removeChild(a.audio)}zeroObject(a,!0)}this._nextSongLoadedWithError=this._nextSongLoading=!1;this._nextSongAlreadyChecked=this._nextSongToPlayAfterLoading=null}preloadNextSong(){if(this._alive&&
this._playlist){var a=this._playlist.nextItem;if(this._nextSongAlreadyChecked!==a&&(this.destroyNextAudioBundle(),(this._nextSongAlreadyChecked=a)&&a.url&&(a.url.startsWith(FileUtils.localURLPrefix)||a.url.startsWith(FileUtils.fileURLPrefix))))try{const b=this._nextSongVersion,c=this.createAudioBundle(a),d=c.boundPlaybackError;this._nextAudioBundle=c;this._nextSongLoading=!0;this._nextSongToPlayAfterLoading=null;const e=g=>{if(b===this._nextSongVersion)if(c.audio){g||(this._nextSongObjectURL=URL.createObjectURL(a.file));
var h=document.createElement("source");h.src=g||this._nextSongObjectURL;h.onerror=d;c.audio.appendChild(h);c.audio.load()}else this._audio&&(g||(this._lastObjectURL=URL.createObjectURL(a.file)),h=document.createElement("source"),h.src=g||this._lastObjectURL,h.onerror=d,this._audio.appendChild(h),this._audio.load())},f=a.url.startsWith(FileUtils.fileURLPrefix)?a.url:null;a.file||f?e(a.file?null:f):FileSystemAPI.getFile(a.url.substring(FileUtils.localURLPrefix.length)).then(g=>{if(this._playlist&&b===
this._nextSongVersion){if(!this._nextAudioBundle){if(!this._nextSongLoading||this._nextSongToPlayAfterLoading!==a)return}else if(this._nextAudioBundle!==c||this._nextAudioBundle.nextSong!==a)return;g?(a.file=g,e(null)):d(Strings.FileNotFoundOrNoPermissionError)}},g=>{d(Strings.UnknownError,void 0,void 0,void 0,g)})}catch(b){this.destroyNextAudioBundle()}}}nextSongPerformFinalPlaybackSteps(){this.resumeAudioContext();this._audio.play().catch(Player._nop);this.playbackLengthChange()}setPlaylistData(){const a=
this._playlist;a&&(a.currentIndexResumeTimeS=this._lastTimeS)}previous(a){this._alive&&this._playlist&&(this._playlist.moveCurrentToPrevious(),this.play(-1,a))}seekBackward(){this._alive&&this.seekTo(-1E4,!0)}pause(){this._alive&&(this.suspendAudioContext(!1),this._loadedSong&&this._audio&&this._audio.pause())}play(a,b){if(this._alive&&this._audio){this._mutedByHeadsetRemoval&&this._audio&&(this._mutedByHeadsetRemoval=!1,this._audio.muted=!1);if(this._loadedSong&&void 0===a){this.resumeAudioContext();
var c=this._audio.play()}else if(this._playlist){void 0!==a&&0<=a&&(this._playlist.currentIndex=a);a=this._playlist.currentItem;!a&&this._playlist.length&&(this._playlist.moveCurrentToNext(),a=this._playlist.currentItem);if(!a){this.stop();return}this._loadedSong=a;this._resumeTimeS=this._lastTimeS;this._lastTimeS=-1;this._songStartedAutomatically=!!b;this._currentPlaylistSong!==a&&(this._currentPlaylistSong=a,queueMicrotask(this._boundNotifySongChange));this._nextSongToPlayAfterLoading=null;if(this._nextAudioBundle){var d=
this._nextAudioBundle;if(d.nextSong===a&&!this._nextSongLoadedWithError){c=this._audio;this._resumeTimeS=-1;this._songToResumeTime=null;this._lastObjectURL&&URL.revokeObjectURL(this._lastObjectURL);this._lastObjectURL=this._nextSongObjectURL;this._nextAudioBundle=this._nextSongObjectURL=null;this._nextSongLoading?(this.pause(),this.playbackLoadStart(),this._nextSongToPlayAfterLoading=a):this._audio.pause();this._sourceNode&&this._sourceNode.disconnectFromDestination();this._sourceNode=d.sourceNode;
this._sourceNode.connectToDestination(this._intermediateNodes.length?this._intermediateNodes[0]:this._destinationNode);this._audio=d.audio;this.volume=this._volume;this._nextSongLoading||this.nextSongPerformFinalPlaybackSteps();for(zeroObject(d,!0);c.firstChild;)c.removeChild(c.firstChild);c.load();c.parentNode&&c.parentNode.removeChild(c);return}}this.destroyNextAudioBundle();for(this.resumeAudioContext();this._audio.firstChild;)this._audio.removeChild(this._audio.firstChild);d=document.createElement("source");
if(a.url&&!a.url.startsWith(FileUtils.localURLPrefix))d.src=a.url;else if(a.file)this._lastObjectURL&&URL.revokeObjectURL(this._lastObjectURL),this._lastObjectURL=URL.createObjectURL(a.file),d.src=this._lastObjectURL;else{if(a.url){this.pause();const e=this._playlist.currentIndex,f=this._playlist.currentItem;FileSystemAPI.getFile(a.url.substring(FileUtils.localURLPrefix.length)).then(g=>{f&&!f.file&&g&&(f.file=g);this._playlist&&e===this._playlist.currentIndex&&f===this._playlist.currentItem&&(g?
(this._lastTimeS=this._resumeTimeS,this.play(e,b)):this.handleError(Strings.FileNotFoundOrNoPermissionError))},()=>{this._playlist&&e===this._playlist.currentIndex&&f===this._playlist.currentItem&&this.handleError(Strings.FileNotFoundOrNoPermissionError)})}else this.handleError(Strings.MissingSongError);return}d.onerror=this._boundPlaybackError;this._audio.appendChild(d);this._audio.load();if(this._songToResumeTime!==a||!this._resumeTimeS||0>=this._resumeTimeS)c=this._audio.play()}c&&c.catch(Player._nop)}}playSongId(a,
b){if(!this._alive||!this._audio||!this._playlist)return!1;a=this._playlist.findIndexById(a);return 0<=a?(this.play(a,b),!0):!1}playPause(){this._alive&&this._audio&&(!this._loadedSong||this._audio.paused?this.play():this.pause())}stop(){if(this._alive&&this._audio){this._songToResumeTime=this._loadedSong=null;this._lastTimeS=-1;this.destroyNextAudioBundle();if(this._currentPlaylistSong){for(;this._audio.firstChild;)this._audio.removeChild(this._audio.firstChild);this._audio.load();this._lastObjectURL&&
(URL.revokeObjectURL(this._lastObjectURL),this._lastObjectURL=null);if(this._loading){this._loading=!1;if(this.onloadingchange)this.onloadingchange(!1);this._mediaSession&&this._mediaSession.setLoading(!1,0,0)}if(!this._paused){this._paused=!0;if(this.onpausedchange)this.onpausedchange(!0);this._mediaSession&&this._mediaSession.setPaused(!0,0,0)}this._currentPlaylistSong=null;this.notifySongChange()}this._songToResumeTime=this._loadedSong=null;this._lastTimeS=-1;this.suspendAudioContext(!1)}}seekForward(){this._alive&&
this.seekTo(1E4,!0)}next(a){this._alive&&this._playlist&&(this._playlist.moveCurrentToNext(),this.play(-1,a))}seekTo(a,b){if(this._alive&&this._currentPlaylistSong&&this._currentPlaylistSong.isSeekable&&!(0>=this._currentPlaylistSong.lengthMS))if(!this._loadedSong)this._songToResumeTime||(this._songToResumeTime=this._currentPlaylistSong),this._songToResumeTime===this._currentPlaylistSong&&(this._lastTimeS=Math.min(Math.max(0,this._currentPlaylistSong.lengthMS),Math.max(0,a+(b?1E3*Math.max(0,this._lastTimeS)|
0:0)))/1E3,this.notifyCurrentTimeSChange());else if(this._audio&&this._audio.seekable&&this._audio.seekable.length){try{const c=Math.min(this._audio.duration||0,Math.max(0,a/1E3+(b?this._audio.currentTime||0:0)));this._lastTimeS=c;this._audio.currentTime=c}catch(c){}this.notifyCurrentTimeSChange()}}headsetRemoved(){this._alive&&this._audio&&(this._audio.paused?this._loadedSong&&(this._mutedByHeadsetRemoval=this._audio.muted=!0):this.pause())}}Player.minVolume=-40;Player._nop=function(){};
class InternalStorage{static async cacheGet(a,b){a=await caches.open(a);b=b?InternalStorage._playlistCachePrefix+b:InternalStorage._playlistCachePrefix;return(b=await a.match(b))?b.arrayBuffer():null}static async cachePut(a,b,c){a=await caches.open(a);b=b?InternalStorage._playlistCachePrefix+b:InternalStorage._playlistCachePrefix;return a.put(b,c)}static loadAppSettings(){try{const a=localStorage.getItem(InternalStorage._appSettingsName);if(a){const b=JSON.parse(a);if(b)return b}}catch(a){}return{playerVolume:0,
graphicalFilterControlEnabled:!1,graphicalFilterControlSimpleMode:544>window.innerWidth,stereoPannerControlEnabled:!1,monoDownMixerControlEnabled:!1}}static saveAppSettings(a){const b=localStorage.getItem(InternalStorage._appSettingsName);a?(a=JSON.stringify(a),b!==a&&localStorage.setItem(InternalStorage._appSettingsName,a)):b&&localStorage.removeItem(InternalStorage._appSettingsName)}static loadGraphicalFilterEditorSettings(){try{const a=localStorage.getItem(InternalStorage._graphicalFilterEditorSettingsName);
if(a){const b=JSON.parse(a);if(b)return b}}catch(a){}return{currentChannelIndex:0,editMode:GraphicalFilterEditorControl.editModeShelfEq,isActualChannelCurveNeeded:!0,isNormalized:!1,isSameFilterLR:!0,showZones:!0}}static saveGraphicalFilterEditorSettings(a){const b=localStorage.getItem(InternalStorage._graphicalFilterEditorSettingsName);a?(a=JSON.stringify(a),b!==a&&localStorage.setItem(InternalStorage._graphicalFilterEditorSettingsName,a)):b&&localStorage.removeItem(InternalStorage._graphicalFilterEditorSettingsName)}static loadStereoPannerSettings(){return Math.max(-StereoPannerControl.maxAbsoluteValue,
Math.min(StereoPannerControl.maxAbsoluteValue,parseInt(localStorage.getItem(InternalStorage._stereoPannerSettingsName))|0))}static saveStereoPannerSettings(a){const b=localStorage.getItem(InternalStorage._stereoPannerSettingsName);a=(a|0).toString();b!==a&&localStorage.setItem(InternalStorage._stereoPannerSettingsName,a)}static async loadPlaylist(a){a=await InternalStorage.cacheGet(InternalStorage._playlistCacheName,a);if(!a)return null;try{return Playlist.deserialize(new DataReader(a))}catch(b){return null}}static loadPlaylistWeb(a){return(a=
localStorage.getItem(a||InternalStorage._defaultPlaylistName))?Playlist.deserializeWeb(a):null}static savePlaylist(a,b){if(!b){if(!a.modified)return Promise.resolve();a.modified=!1}return InternalStorage.cachePut(InternalStorage._playlistCacheName,b,new Response(a.serialize().trimmedArrayBuffer))}static savePlaylistWeb(a,b){if(!b){if(!a.modified)return;a.modified=!1}return localStorage.setItem(b||InternalStorage._defaultPlaylistName,JSON.stringify(a.serializeWeb()))}}
InternalStorage._playlistCachePrefix="https://fplay.com.br/";InternalStorage._playlistCacheName="playlists";InternalStorage._appSettingsName="appSettings";InternalStorage._graphicalFilterEditorSettingsName="graphicalFilterEditorSettings";InternalStorage._stereoPannerSettingsName="stereoPannerSettings";InternalStorage._defaultPlaylistName="defaultPlaylist";
class Modal{static get visible(){return!!Modal._modal}static get currentModalElement(){return Modal._modal?Modal._modal._modalElement:null}static get currentModalHeaderElement(){return Modal._modal?Modal._modal._modalHeaderElement:null}static get currentModalBodyElement(){return Modal._modal?Modal._modal._modalBodyElement:null}static get currentModalFooterElement(){return Modal._modal?Modal._modal._modalFooterElement:null}static show(a){if(Modal._modal)return!1;a.okCancel?a.buttons=[{id:"cancel",
defaultCancel:!0,iconName:"icon-clear",text:a.cancelText||Strings.Cancel,color:"red",onclick:a.oncancel||Modal.hide},{id:"ok",defaultSubmit:a.okCancelSubmit,iconName:"icon-check",text:a.okText||Strings.OK,color:"green",onclick:a.onok||Modal.hide}]:a.buttons&&a.buttons.length||(a.buttons=[{id:"cancel",defaultCancel:!0,iconName:"icon-clear",text:Strings.Close,color:"red",onclick:Modal.hide}]);Modal._modal=new Modal(a);return!0}static hide(){Modal._modal&&Modal._modal.hideInternal()}static defaultCancelAction(){return Modal._modal?
Modal._modal.defaultCancelActionInternal():!1}static historyStatePopped(){if(!Modal._modal)return null;Modal._modal._fading||Modal.defaultCancelAction();return!1}constructor(a){this._options=a;this._focusBlocker=new FocusBlocker;this._focusBlocker.block();HistoryHandler.pushState();const b=document.createElement("div");this._containerElement=b;b.className=a.transparentBackground?"modal-container fade":"modal-container fade background";var c="modalHeader"+Modal._internalId;const d=document.createElement("form");
this._modalElement=d;d.tabIndex=-1;d.role="dialog";d.ariaModal="true";d.setAttribute("aria-labelledby",c);d.className="modal"+(a.fullHeight?" full-height":"");d.onsubmit=this.submit.bind(this);var e=document.createElement("h1");this._modalHeaderElement=e;(a.titleHeader||e).id=c;e.className="modal-header padding"+(a.rightHeader?" right":"");a.title?"string"===typeof a.title?e.innerHTML=a.title:e.appendChild(a.title):e.innerHTML=a.titleStringKey?Strings.translate(a.titleStringKey):Strings.Oops;this._modalBodyElement=
c=document.createElement("div");c.className="modal-body scrollable padding top-margin"+(a.leftBody?" left":"");a.html||(a.html=document.createElement("div"),a.text&&Strings.changeText(a.html,a.text));if("string"===typeof a.html)c.innerHTML=a.html;else if(Array.isArray(a.html)){var f=a.html;for(var g=0;g<f.length;g++)c.appendChild(f[g])}else c.appendChild(a.html);this._modalFooterElement=f=document.createElement("div");f.className="modal-footer padding top-border left-margin right-margin";this._defaultSubmitButton=
this._defaultCancelButton=null;if(a.buttons)for(g=0;g<a.buttons.length;g++){const h=a.buttons[g],k=ButtonControl.create(h,!0);h.defaultCancel&&(this._defaultCancelButton=k);h.defaultSubmit&&(this._defaultSubmitButton=k);k.onclick=()=>{if(!this._fading){if(h.onclick)h.onclick(h.id,k);if(this._options.onbuttonclick)this._options.onbuttonclick(h.id,k)}};f.appendChild(k)}d.appendChild(e);if(a.skipBody)for(;c.firstChild;)e=c.firstChild,c.removeChild(e),d.appendChild(e);else d.appendChild(c);d.appendChild(f);
b.appendChild(d);document.body.appendChild(b);this._boundDocumentKeyDown=this.documentKeyDown.bind(this);document.addEventListener("keydown",this._boundDocumentKeyDown,!0);this._fading=!0;DelayControl.delayShortCB(()=>{if(a.onshowing)a.onshowing();this._containerElement.classList.add("in");DelayControl.delayFadeCB(()=>{this._fading=!1;const h=this._options.onshown&&this._options.onshown()||this._modalElement;try{h.focus()}catch(k){}})})}hideInternal(){Modal._modal!==this||this._fading||this._options.onhiding&&
!1===this._options.onhiding()||(document.removeEventListener("keydown",this._boundDocumentKeyDown,!0),this._fading=!0,this._containerElement.classList.remove("in"),DelayControl.delayFadeCB(()=>{Modal._modal=null;if(this._options.returnFocusElement)try{this._options.returnFocusElement.focus()}catch(a){}if(this._options.onhidden)this._options.onhidden();document.body.removeChild(this._containerElement);HistoryHandler.popState();this._focusBlocker&&this._focusBlocker.unblock();if(this._options.buttons)for(let a=
this._options.buttons.length-1;0<=a;a--)zeroObject(this._options.buttons[a]);zeroObject(this._options);zeroObject(this)}))}documentKeyDown(a){a.ctrlKey||a.metaKey||a.shiftKey||a.altKey||a.repeat||"Escape"!==a.key||this.defaultCancelActionInternal()}defaultCancelActionInternal(){return this._defaultCancelButton?(this._defaultCancelButton.click(),!0):!1}submit(a){cancelEvent(a);this._defaultSubmitButton&&this._defaultSubmitButton.click();return!1}}Modal._internalId=0;Modal._modal=null;
class FilePickerListAdapter extends ListAdapter{constructor(a){super(a)}get itemHeight(){return AppUI.buttonSizePX}createEmptyElement(a){const b=document.createElement("div");b.className=a;ButtonControl.create({text:Strings.Selected,square:!0,checkable:!0,checkbox0Color:"pink",checkbox1Color:"green",unfocusable:!0,parent:b}).dataset.check="1";ButtonControl.create({iconName:"icon-clear",text:Strings.Delete,color:"red",square:!0,unfocusable:!0,className:"no-left-margin",parent:b}).dataset["delete"]=
"1";b.appendChild(Icon.create("icon-folder","orange",!0,"button-top-margin margin",null,Strings.FolderLabel));b.appendChild(Icon.create("icon-add-folder","green",!0,"button-top-margin margin left-margin"));b.appendChild(document.createTextNode(Formatter.none));return b}prepareElement(a,b,c,d){b=d.childNodes;a.root?(b[0].classList.add("hidden"),a.path?b[3].classList.add("hidden"):b[3].classList.remove("hidden")):(c=b[0],c.classList.remove("hidden"),a.dir?c.classList.remove("small-right-margin"):c.classList.add("small-right-margin"),
c.checked=a.selected,b[3].classList.add("hidden"));a.deletable?b[1].classList.remove("hidden"):b[1].classList.add("hidden");a.dir?(c=b[2],c.classList.remove("hidden"),a.root&&!a.deletable?c.classList.add("left-margin"):c.classList.remove("left-margin")):b[2].classList.add("hidden");b[4].nodeValue=a.name}prepareElementIndexOrLengthChanged(a,b,c,d){}}
class FilePicker{static isSupported(){return!!App.hostInterface||FileSystemAPI.isSupported()}static get visible(){return!!FilePicker._filePicker}static show(a){return FilePicker._filePicker||Modal.visible?Promise.resolve(null):new Promise(function(b){FilePicker._filePicker=new FilePicker(b,a)})}static showAddPlay(a){if(FilePicker._filePicker||Modal.visible)return null;let b=!1,c=[],d=null;FilePicker._filePicker=new FilePicker(function(){b=!0;d&&(d(null),d=null)},a,function(e){d?(d(e),d=null):c.push(e)});
return function(){if(c.length){const e=c.pop();return Promise.resolve(e)}return b?Promise.resolve(null):new Promise(function(e){d=e})}}constructor(a,b,c){const d=document.createElement("div"),e=Strings.createSrOnlyText(Strings.AddSongs);d.appendChild(e);ButtonControl.create({color:"orange",iconName:"icon-up",text:Strings.Up,parent:d,onclick:this.navigateUp.bind(this)});ButtonControl.create({iconName:"icon-checkbox-1",text:Strings.All,parent:d,onclick:this.toggleAll.bind(this)});const f=document.createElement("div");
f.className="file-picker-path padding bottom-border left";f.ariaAtomic="true";f.ariaLive="assertive";f.ariaRelevant="all";const g=Icon.create("icon-folder-open","orange",!0,"hidden",null,Strings.CurrentPathLabel);f.appendChild(g);const h=document.createElement("i");h.className="icon loading large";h.appendChild(Strings.createSrOnlyText(Strings.LoadingCurrentPathLabel));f.appendChild(h);const k=document.createElement("div");k.className="file-picker-path-element small-left-padding";f.appendChild(k);
const n=document.createElement("f-list");n.className="full-height-list fade";n.emptyMessage=Strings.NoSongsInFolder;this._callback=c||null;this._resolve=a;this._provider=App.hostType===App.hostTypeAndroid?new FilePickerAndroidProvider:new FilePickerFileSystemAPIProvider;this._list=new List;this._listAdapter=new FilePickerListAdapter(this._list);this._listControl=n;this._listControl.addEventListener("keydown",this.listKeyDown.bind(this));this._listControl.onitemclick=this.itemClick.bind(this);this._listControl.onitemcontrolclick=
this.itemControlClick.bind(this);this._listControl.adapter=this._listAdapter;this._selectedFiles=null;this._fading=this._gettingFiles=!1;this._providerVersion=0;this._path=FilePicker.lastPath;this._rootLength=FilePicker.lastRootLength;this._iconFolder=g;this._iconLoading=h;this._pathElement=k;this._boundRefreshRoot=this.refreshRoot.bind(this);this.updatePathElement(this._path);a={html:[f,n],title:d,titleHeader:e,returnFocusElement:b,skipBody:!0,fullHeight:!0,onshown:this.modalShown.bind(this),onhiding:this.modalHiding.bind(this),
onhidden:this.modalHidden.bind(this)};this._callback?a.buttons=[{id:"cancel",defaultCancel:!0,iconName:"icon-clear",text:Strings.Close,color:"red",onclick:Modal.hide},{id:"add",iconName:"icon-add",text:Strings.Add,color:"green",onclick:()=>this.modalOk(!1)},{id:"play",iconName:"icon-play",text:Strings.Play,color:"blue",onclick:()=>this.modalOk(!0)}]:(a.okCancel=!0,a.onok=()=>this.modalOk(!1));if(!Modal.show(a))throw Error("Assertion error: Modal.show() === false");}updatePathElement(a){a&&a.endsWith("/")&&
(a=a.substring(0,a.length-1));Strings.changeText(this._pathElement,a||Strings.Storage);return a}updateIconLoading(a){this._iconFolder&&this._iconLoading&&(a?(this._iconFolder.classList.add("hidden"),this._iconLoading.classList.remove("hidden")):(this._iconLoading.classList.add("hidden"),this._iconFolder.classList.remove("hidden")))}listKeyDown(a){a.ctrlKey||a.metaKey||a.shiftKey||a.altKey||a.repeat||"Backspace"!==a.key||this.navigateUp()}itemClick(a,b,c){this._gettingFiles||this._fading||(a.root&&
!a.path&&this._provider.editableRoots()?(this.updateIconLoading(!0),this._provider.addNewRoot().then(this._boundRefreshRoot,this._boundRefreshRoot)):a.dir?this.navigate(a.path):this._listControl&&(a.selected=!a.selected,this._listControl.refreshVisibleItems()))}itemControlClick(a,b,c,d){if(!this._gettingFiles&&!this._fading){if("SPAN"===d.tagName&&(d=d.parentNode,!d))return;if(d.classList.contains("f-list-item"))for(b=d.getElementsByTagName("f-button"),c=0;c<b.length;c++){const e=b[c];if(!e.classList.contains("hidden")){d=
e;d.dataset.check&&(d.checked=!d.checked);break}}d.dataset.check?a.selected=d.checked:d.dataset["delete"]&&(this.updateIconLoading(!0),this._provider.removeRoot(a).then(this._boundRefreshRoot,this._boundRefreshRoot))}}refreshRoot(a){this._path||(!0===a?this.navigate(null):this.updateIconLoading(!1))}finishNavigation(a){!this._path&&this._provider.editableRoots()&&a.push({name:Strings.AddMoreFolders,dir:0,path:"",root:!0,deletable:!1});this.updateIconLoading(!1);a.length&&this._list.addItems(a);this._listControl.classList.add("in")}navigate(a){if(FilePicker._filePicker===
this&&!this._gettingFiles&&!this._fading){var b=!this._path;this._path=a=this.updatePathElement(a);b&&(this._rootLength=a?a.length:0);this._providerVersion++;var c=this._providerVersion;this.updateIconLoading(!0);var d=null;this._listControl.classList.contains("in")&&(this._fading=!0,this._listControl.classList.remove("in"),DelayControl.delayFadeCB(()=>{FilePicker._filePicker===this&&this._provider&&c===this._providerVersion&&(this._list.clear(),this._fading=!1,d&&this.finishNavigation(d))}));this._provider.navigate(a).then(e=>
{FilePicker._filePicker===this&&this._provider&&c===this._providerVersion&&(d=e||[],this._fading||this.finishNavigation(d))},e=>{FilePicker._filePicker===this&&this._provider&&c===this._providerVersion&&(this.updateIconLoading(!1),Alert.show(e.message||("string"===typeof e.error?e.error:e.error&&e.error.message||e.toString()),!0))})}}navigateUp(){let a=this._path,b;!a||0>=(b=a.lastIndexOf("/"))?this.navigate(null):(a=a.substring(0,b),this.navigate(a.length<this._rootLength?null:a))}toggleAll(){if(FilePicker._filePicker===
this&&!this._gettingFiles&&!this._fading){var a=this._list,b=!1;for(var c=a.length-1;0<=c;c--)if(!a.item(c).selected){b=!0;break}for(c=a.length-1;0<=c;c--)a.item(c).selected=b;this._listControl.refreshVisibleItems()}}modalShown(){this.navigate(this._path);return this._listControl}modalHiding(){if(FilePicker._filePicker!==this)return!0;FilePicker._filePicker=null;this._provider&&this._provider.destroy();return!0}modalHidden(){const a=this._resolve,b=this._selectedFiles;this._selectedFiles=null;zeroObject(this);
a&&a(b)}modalOk(a){if(FilePicker._filePicker===this&&!this._gettingFiles&&!this._fading){var b=[],c=[],d=this._list,e=d.length;if(this._path)for(let g=0;g<e;g++){const h=d.item(g);h.selected&&(h.dir?b:c).push(h)}if(this._path&&(b.length||c.length)){FilePicker.lastPath=this._path;FilePicker.lastRootLength=this._rootLength;this._gettingFiles=!0;this._providerVersion++;var f=this._providerVersion;this.updateIconLoading(!0);this._provider.getFiles(b,c).then(g=>{if(FilePicker._filePicker===this&&this._provider&&
f===this._providerVersion)if(this._callback){const h=this._list;for(let k=h.length-1;0<=k;k--)h.item(k).selected=!1;this._listControl.refreshVisibleItems();this.updateIconLoading(!1);this._gettingFiles=!1;this._callback({play:a,files:g})}else this._selectedFiles=g,Modal.hide()},g=>{FilePicker._filePicker===this&&this._provider&&f===this._providerVersion&&(this.updateIconLoading(!1),this._gettingFiles=!1,Alert.show(g.message||("string"===typeof g.error?g.error:g.error&&g.error.message||g.toString()),
!0))})}else Alert.show(Strings.NothingSelected)}}}FilePicker._filePicker=null;FilePicker.lastPath=null;FilePicker.lastRootLength=0;
class AppUI{static preparePlaylist(){if(App.player&&AppUI._playlistControl){var a=App.player.playlist;a?(a.onsonglengthchange=AppUI.playlistSongLengthChange,AppUI._playlistControl.adapter=new PlaylistAdapter(a)):AppUI._playlistControl.adapter=null}}static adjustDecimal(a){var b=!0;let c=a.toFixed(5);for(c=c.substring(0,c.length-1);;){var d=c.charAt(c.length-1),e=c.charAt(c.length-2);if(d===e){if("0"!==d&&(c=c.padEnd(24,d),"9"===d&&b)){c=parseFloat(c).toFixed(5);b=!1;continue}}else if(b=c.lastIndexOf("."),
d=c.substring(b+1,b+1+2),e=c.substring(b+3,b+3+2),d===e)for(c=c.substring(0,b+1);24>c.length;)c+=d;else if(c=a.toFixed(7),b=c.lastIndexOf("."),d=c.substring(b+1,b+1+3),e=c.substring(b+4,b+4+3),d===e)for(c=c.substring(0,b+1);24>c.length;)c+=d;else c=a.toFixed(18);break}return c.replace(/0+$/,"").replace(/[,\.]$/,"")}static adjustWindow(){var a=App.hostInterface?AppUI.baseSizePX*(AppUI._fontScale=App.hostInterface.getFontScale()):.125*AppUI._ruler.getBoundingClientRect().height;if(AppUI._devicePixelRatio!==
devicePixelRatio||AppUI._1remInPX!==a){AppUI._devicePixelRatio=devicePixelRatio;AppUI._1remInPX=a;App.hostInterface?document.documentElement.style.fontSize=a!==AppUI.baseSizePX?a+"px":"":AppUI._fontScale=AppUI._1remInPX/AppUI.baseSizePX;var b=AppUI.adjustDecimal(AppUI.remToPX(AppUI.contentsSizeREM));AppUI._contentsSizePX=parseFloat(b);AppUI._buttonSizePX=AppUI._contentsSizePX+(AppUI.primaryInputIsTouch?AppUI.s6PX:AppUI.s2PX);a=Icon.baseSizePX/devicePixelRatio;var c=AppUI._contentsSizePX/a|0,d=Math.ceil(AppUI._contentsSizePX/
a);2>=d*devicePixelRatio-AppUI._contentsSizePX&&(c=d);0>=c?(a=b,AppUI._smallIconSizePX=AppUI._contentsSizePX,AppUI._largeIconSizePX=AppUI._contentsSizePX):1===c?(b=a=AppUI.adjustDecimal(a),AppUI._smallIconSizePX=parseFloat(a),AppUI._largeIconSizePX=AppUI._smallIconSizePX):(a=AppUI.adjustDecimal(Math.max(c>>1&-2,1)*Icon.baseSizePX/devicePixelRatio),b=AppUI.adjustDecimal((c&-2)*Icon.baseSizePX/devicePixelRatio),AppUI._smallIconSizePX=parseFloat(a),AppUI._largeIconSizePX=parseFloat(b));(d=(AppUI._baseThinBorderPX*
devicePixelRatio|0)/devicePixelRatio)||(d=1);c=AppUI.adjustDecimal(d);AppUI._thinBorderPX=parseFloat(c);(d=(AppUI._baseThickBorderPX*devicePixelRatio|0)/devicePixelRatio)||(d=1);d=AppUI.adjustDecimal(d);AppUI._thickBorderPX=parseFloat(d);const e=AppUI.adjustDecimal(3*AppUI.remToPX(AppUI.smallContentsSizeREM)+AppUI.s2PX);AppUI._playlistItemSizePX=parseFloat(e);AppUI._rootVariables.textContent=`:root {
				--button-size: ${AppUI._buttonSizePX}px;
				--button-padding: ${AppUI.adjustDecimal(.5*(AppUI._buttonSizePX-AppUI._contentsSizePX))}px;
				--negative-button-padding: -${AppUI.adjustDecimal(.5*(AppUI._buttonSizePX-AppUI._contentsSizePX))}px;
				--icon-size: ${a}px;
				--icon-padding: ${AppUI.adjustDecimal(.5*(AppUI._contentsSizePX-AppUI._smallIconSizePX))}px;
				--large-icon-size: ${b}px;
				--large-icon-margin: ${AppUI.adjustDecimal(Math.min(0,.5*(AppUI._contentsSizePX-AppUI._largeIconSizePX)))}px;
				--large-icon-padding: ${AppUI.adjustDecimal(Math.max(0,.5*(AppUI._contentsSizePX-AppUI._largeIconSizePX)))}px;
				--thin-border: ${c}px;
				--thick-border: ${d}px;
				--scrollbar-size: ${AppUI.primaryInputIsTouch?20:12}px;
				--playlist-item-size: ${e}px;
			}`;for(a=AppUI._zoomHandlers.length-1;0<=a;a--)AppUI._zoomHandlers[a]()}AppUI.checkPanelContainerToggleState()}static changeZoom(a){if(AppUI._webFrame)if(a=(1<=devicePixelRatio?1+Math.ceil(4*devicePixelRatio):.51>=devicePixelRatio?0:.67>=devicePixelRatio?1:.76>=devicePixelRatio?2:.81>=devicePixelRatio?3:4)+a,0>=a)AppUI._webFrame.setZoomFactor(.5);else if(21<=a)AppUI._webFrame.setZoomFactor(5);else switch(a){case 1:AppUI._webFrame.setZoomFactor(2/3);break;case 2:AppUI._webFrame.setZoomFactor(.75);
break;case 3:AppUI._webFrame.setZoomFactor(.8);break;case 4:AppUI._webFrame.setZoomFactor(.9);break;default:AppUI._webFrame.setZoomFactor((a-1)/4)}}static globalKeyHandler(a){if(a.ctrlKey||a.metaKey){if(AppUI._webFrame)switch(a.key){case "-":return a.repeat||AppUI.changeZoom(-1),cancelEvent(a);case "+":case "=":return a.repeat||AppUI.changeZoom(1),cancelEvent(a);case "0":return cancelEvent(a)}}else switch(a.key){case "Escape":return a.repeat||(Modal.visible?Modal.hide():AppUI._playlistControl&&AppUI._playlistControl.deleteMode?
AppUI.toggleDeleteMode(!0):App.player&&App.player.playPause()),cancelEvent(a);case "F1":return!a.repeat&&App.player&&App.player.previous(),cancelEvent(a);case "F2":return!a.repeat&&App.player&&App.player.playPause(),cancelEvent(a);case "F3":return!a.repeat&&App.player&&App.player.stop(),cancelEvent(a);case "F4":return!a.repeat&&App.player&&App.player.next(),cancelEvent(a);default:if(a.target===document.body&&!AppUI._panelContainerToggled&&!Modal.visible)switch(a.key){case "ArrowDown":case "ArrowRight":case "ArrowUp":case "ArrowLeft":case "PageDown":case "PageUp":case "Home":case "End":case "Enter":case " ":return cancelEvent(a),
AppUI._playlistControl.focus(),AppUI._playlistControl.elementKeyDown(a),!1}}}static historyStatePopped(){if(!AppUI._playlistControl||!AppUI._playlistControl.deleteMode){if(!AppUI._panelContainerToggled)return null;AppUI.toggleView(!1);return!0}AppUI.toggleDeleteMode(!1);return!0}static preInit(a,b){window.addEventListener("resize",AppUI.adjustCover);AppUI.adjustCover();AppUI._panelContainer.innerHTML=`
		<main id="fixed-panel">
			<header id="top-panel" class="toolbar bottom-border">
				<div aria-atomic="true" aria-live="polite">
					<p id="title-label">
						<f-icon color="pink" name="icon-title" large class="margin" sr-title="${Strings.TitleLabel}"></f-icon>-
					</p>
					<p id="artist-label">
						<f-icon color="orange" name="icon-artist" large class="margin" sr-title="${Strings.ArtistLabel}"></f-icon>-
					</p>
					<p class="sr-only">
						<span>${Strings.DurationLabel}</span><span id="assistive-song-length-label"></span>
					</p>
				</div>
				<div id="top-message" class="fade" aria-atomic="true" aria-live="assertive"></div>
			</header>

			<f-list id="playlist-control" aria-label="${Strings.Playlist}"></f-list>

			<div id="middle-panel" class="toolbar top-border">
				<f-button square class="toolbar-left hidden-normal" onclick="AppUI.toggleView(true)" text="${Strings.ShowEffects}" icon-name="icon-filter">
				</f-button><f-button square color="green" class="no-left-margin" onclick="AppUI.addFiles()" text="${Strings.AddSongs}" icon-name="icon-add-title">
				</f-button><f-button id="add-folder-button" square color="orange" onclick="AppUI.addFiles(true)" text="${Strings.AddFolders}" icon-name="icon-add-folder">
				</f-button><f-button id="info-button" square color="gray" onclick="AppUI.showSongInfo()" text="${Strings.ShowInfo}" icon-name="icon-info">
				</f-button><f-button id="search-button" square color="gray" onclick="AppUI.showSearch()" text="${Strings.Search}" icon-name="icon-search">
				</f-button><f-button square color="red" onclick="AppUI.toggleDeleteMode(true)" text="${Strings.DeleteSongs}" icon-name="icon-clear">
				</f-button><f-button square class="toolbar-right" onclick="AppUI.showAbout()" text="${Strings.Menu}" icon-name="icon-menu">
				</f-button>
			</div>

			<div id="bottom-panel" class="toolbar top-border">
				<f-slider id="seek-slider" aria-label="${Strings.Seek}" unfocusable manual-aria></f-slider>
				<div>
					<f-button square onclick="App.player && App.player.previous()" text="${Strings.Previous}" icon-name="icon-previous">
					</f-button><f-button id="play-button" square onclick="App.player && App.player.playPause()" text="${Strings.PlayPause}" icon-name="icon-play">
					</f-button><f-button square onclick="App.player && App.player.stop()" text="${Strings.Stop}" icon-name="icon-stop" id="button-stop">
					</f-button><f-button square onclick="App.player && App.player.next()" text="${Strings.Next}" icon-name="icon-next">
					</f-button><f-slider id="volume-slider" aria-label="${Strings.Volume}" min="${Player.minVolume}" max="0" value="${b.playerVolume}" value-child="${SliderControlValueChild.RightChild}" class="left-margin"></f-slider>
				</div>
			</div>
		</main>

		<aside id="optional-panel" class="scrollable">
			<div id="optional-panel-container">
				<div class="toolbar bottom-border hidden-normal">
					<f-button id="toggle-view-button" onclick="AppUI.toggleView(true)" text="${Strings.ShowPlaylist}" icon-name="icon-playlist"></f-button>
				</div>

				<div class="toolbar">
					<f-button id="graphical-filter-control-enabled" checkable text="${Strings.Enabled}">
					</f-button><f-button id="graphical-filter-control-type" icon-name="icon-filter"></f-button>
				</div>

				<div id="filter-container" class="top-margin"></div>

				<div class="top-border">
					<f-button id="stereo-panner-control-enabled" checkable text="${Strings.Panning}" icon-name="icon-multiple-stop">
					</f-button><f-slider id="stereo-panner-slider" class="left-margin"></f-slider>
				</div>

				<div class="top-border" id="mono-down-mixer-control-container">
					<f-button id="mono-down-mixer-control-enabled" checkable text="${Strings.DownMixToMono}" icon-name="icon-call-merge-flipped"></f-button>
				</div>
			</div>
		</aside>
		`;AppUI._fixedPanel=document.getElementById("fixed-panel");AppUI._middlePanel=document.getElementById("middle-panel");AppUI._optionalPanel=document.getElementById("optional-panel");AppUI._playButton=document.getElementById("play-button");AppUI._ruler=document.getElementById("ruler");AppUI._titleLabel=document.getElementById("title-label");AppUI._artistLabel=document.getElementById("artist-label");AppUI._assistiveSongLengthLabel=document.getElementById("assistive-song-length-label");AppUI._topMessage=
document.getElementById("top-message");AppUI._toggleViewButton=document.getElementById("toggle-view-button");AppUI._webFrame=a;window.addEventListener("keydown",AppUI.globalKeyHandler,!0);a&&b.devicePixelRatio&&b.devicePixelRatio!==devicePixelRatio&&a.setZoomFactor(b.devicePixelRatio);FilePicker.isSupported()&&(FilePicker.lastPath=b.filePickerLastPath||null,FilePicker.lastRootLength=b.filePickerRootLength||0,a=document.getElementById("add-folder-button"),a.parentNode.removeChild(a));AppUI._seekSlider=
document.getElementById("seek-slider");AppUI._seekSlider.disabled=!0;AppUI._seekSlider.onvaluechange=AppUI.seekSliderValueChange;AppUI._seekSlider.ondragchangecommit=AppUI.seekSliderDragChangeCommit;a=document.createElement("span");a.className="seek-label";AppUI._currentTimeS=0;Strings.changeText(a,Formatter.none);AppUI._seekSlider.leftChild=a;AppUI._songLengthLabel=document.createElement("span");AppUI._songLengthLabel.className="seek-label";Strings.changeText(AppUI._songLengthLabel,Formatter.none);
Strings.changeText(AppUI._assistiveSongLengthLabel,Formatter.none);AppUI._seekSlider.rightChild=AppUI._songLengthLabel;AppUI._volumeSlider=document.getElementById("volume-slider");AppUI._volumeSlider.mapper=function(c){return(c<=Player.minVolume?GraphicalFilterEditorStrings.MinusInfinity:c?c:"-0")+" dB"};AppUI._volumeSlider.leftChild=Icon.create("icon-volume","green",!0,"small-right-margin");a=document.createElement("span");a.className="small-left-margin";a.id="volume-label";AppUI._volumeSlider.rightChild=
a;AppUI._volumeSlider.onvaluechange=AppUI.volumeSliderValueChange;AppUI._playlistControl=document.getElementById("playlist-control");AppUI._playlistControl.emptyMessage=Strings.PlaylistControlEmptyMessage;AppUI._playlistControl.onitemclick=AppUI.playlistControlItemClick;AppUI._playlistControl.onitemcontextmenu=AppUI.playlistControlItemContextMenu;AppUI._playlistControl.onitemcontrolclick=AppUI.playlistControlItemControlClick;AppUI._graphicalFilterControlType=document.getElementById("graphical-filter-control-type");
AppUI._graphicalFilterControlType.text=b.graphicalFilterControlSimpleMode?Strings.TraditionalFilter:Strings.AdvancedFilter;AppUI._graphicalFilterControlType.onclick=AppUI.graphicalFilterControlTypeClick;AppUI._graphicalFilterControlEnabled=document.getElementById("graphical-filter-control-enabled");AppUI._graphicalFilterControlEnabled.checked=b.graphicalFilterControlEnabled||!1;AppUI._graphicalFilterControlEnabled.onclick=AppUI.graphicalFilterControlEnabledClick;AppUI._stereoPannerControlEnabled=
document.getElementById("stereo-panner-control-enabled");AppUI._stereoPannerControlEnabled.checked=b.stereoPannerControlEnabled||!1;AppUI._stereoPannerControlEnabled.onclick=AppUI.stereoPannerControlEnabledClick;MonoDownMixerControl.isSupported()?(AppUI._monoDownMixerControlEnabled=document.getElementById("mono-down-mixer-control-enabled"),AppUI._monoDownMixerControlEnabled.checked=b.monoDownMixerControlEnabled||!1,AppUI._monoDownMixerControlEnabled.onclick=AppUI.monoDownMixerControlEnabledClick):
(a=document.getElementById("mono-down-mixer-control-container"),a.parentNode.removeChild(a));App.frameless&&AppUI._panelContainer.classList.remove("web");window.addEventListener("resize",AppUI.adjustWindow,{passive:!0});AppUI.rgbMode=b.rgbMode||!1;AppUI.animatedRGBMode=b.animatedRGBMode||!1;AppUI.extraRGBMode=b.extraRGBMode||!1;AppUI.neonMode=b.neonMode||!1;AppUI.adjustWindow()}static init(a){if(App.player){AppUI._volumeSlider.value=App.player.volume;App.player.onsongchange=AppUI.playerSongChange;
App.player.onloadingchange=AppUI.playerLoadingChange;App.player.onpausedchange=AppUI.playerPausedChange;App.player.oncurrenttimeschange=AppUI.playerCurrentTimeSChange;App.player.onerror=AppUI.playerError;AppUI.preparePlaylist();AppUI.playerSongChange(App.player.currentSong,App.player.currentTimeMS/1E3);AppUI.centerCurrentSongIntoView();try{AppUI._playlistControl.focus()}catch(b){}HistoryHandler.init(Menu.historyStatePopped,Modal.historyStatePopped,AppUI.historyStatePopped);AppUI._cover.classList.remove("in");
DelayControl.delayShortCB(function(){AppUI.centerCurrentSongIntoView();DelayControl.delayFadeCB(function(){AppUI._cover&&document.body.removeChild(AppUI._cover)})})}}static adjustCover(){if(AppUI._cover){const a=document.body.getBoundingClientRect();AppUI._cover.style.transform=`scale(${a.right}, ${a.bottom})`}}static centerCurrentSongIntoView(){App.player&&App.player.playlist&&0<=App.player.playlist.currentIndex&&AppUI._playlistControl.centerItemIntoView(App.player.playlist.currentIndex)}static destroy(){zeroObject(AppUI)}static get loading(){return AppUI._loading}static get fontScale(){return AppUI._fontScale}static get smallIconSizePX(){return AppUI._smallIconSizePX}static get largeIconSizePX(){return AppUI._largeIconSizePX}static get thinBorderPX(){return AppUI._thinBorderPX}static get thickBorderPX(){return AppUI._thickBorderPX}static get buttonSizePX(){return AppUI._buttonSizePX}static get contentsSizePX(){return AppUI._contentsSizePX}static get playlistItemSizePX(){return AppUI._playlistItemSizePX}static get playlistControlElement(){return AppUI._playlistControl}static get rgbMode(){return AppUI._rgbMode}static set rgbMode(a){AppUI._rgbMode!==
a&&((AppUI._rgbMode=a)?document.body.classList.add("rgb"):(AppUI._animatedRGBMode=!1,AppUI._extraRGBMode=!1,document.body.classList.remove("rgb"),document.body.classList.remove("rgb-animated"),document.body.classList.remove("rgb-extra")))}static get animatedRGBMode(){return AppUI._animatedRGBMode}static set animatedRGBMode(a){AppUI._animatedRGBMode!==a&&((AppUI._animatedRGBMode=a)?(AppUI._rgbMode=!0,document.body.classList.add("rgb"),document.body.classList.add("rgb-animated")):document.body.classList.remove("rgb-animated"))}static get extraRGBMode(){return AppUI._extraRGBMode}static set extraRGBMode(a){AppUI._extraRGBMode!==
a&&((AppUI._extraRGBMode=a)?(AppUI._rgbMode=!0,document.body.classList.add("rgb"),document.body.classList.add("rgb-extra")):document.body.classList.remove("rgb-extra"))}static get neonMode(){return AppUI._neonMode}static set neonMode(a){AppUI._neonMode!==a&&((AppUI._neonMode=a)?document.body.classList.add("neon"):document.body.classList.remove("neon"))}static addZoomHandler(a){a&&AppUI._zoomHandlers.push(a)}static removeZoomHandler(a){if(a)for(let b=AppUI._zoomHandlers.length-1;0<=b;b--)if(AppUI._zoomHandlers[b]===
a){AppUI._zoomHandlers.splice(b,1);break}}static factorToZoom(a){return 1>=a?0:Math.round(4*a)-4}static zoomToFactor(a){return 0>=a?1:.25*(a+4)}static remToPX(a){return a*AppUI._1remInPX}static pxToREM(a){return a/AppUI._1remInPX}static playerSongChange(a,b){App.player&&AppUI._playlistControl&&(document.title=a&&a.title?a.title+" - FPlay":"FPlay",Strings.changeText(AppUI._titleLabel,a&&a.title||Formatter.none),Strings.changeText(AppUI._artistLabel,a&&a.artist||Formatter.none),App.player.playlist&&
0<=App.player.playlist.currentIndex&&!AppUI._playlistControl.deleteMode&&a&&AppUI._playlistControl.bringItemIntoView(App.player.playlist.currentIndex),0>b&&(b=0),AppUI._currentTimeS=b|0,a?(Strings.changeText(AppUI._songLengthLabel,a.length),Strings.changeText(AppUI._assistiveSongLengthLabel,a.length),AppUI._seekSlider&&(0<a.lengthMS?(AppUI._seekSlider.disabled=!1,AppUI._seekSlider.max=a.lengthMS):AppUI._seekSlider.disabled=!0,AppUI._seekSlider.manuallyChangeAll(1E3*b,Formatter.formatTimeS(AppUI._currentTimeS),
SliderControlValueChild.LeftChild))):(Strings.changeText(AppUI._songLengthLabel,Formatter.none),Strings.changeText(AppUI._assistiveSongLengthLabel,Formatter.none),AppUI._seekSlider&&(AppUI._seekSlider.disabled=!0,AppUI._seekSlider.manuallyChangeAll(0,Formatter.none,SliderControlValueChild.LeftChild))))}static playerLoadingChange(a){App.updateLoadingIcon()}static playerPausedChange(a){AppUI._playButton&&(AppUI._playButton.iconName=a?"icon-play":"icon-pause")}static playerCurrentTimeSChange(a){if(AppUI._seekSlider&&
!AppUI._seekSlider.dragging&&App.player){0>a&&(a=0);var b=a|0;if(AppUI._currentTimeS!==b){AppUI._currentTimeS=b;a=1E3*b;if(App.player.currentSong){const c=App.player.currentSong.lengthMS-a;5500>c&&2500<c&&App.player.preloadNextSong()}AppUI._seekSlider.manuallyChangeAll(a,Formatter.formatTimeS(b),SliderControlValueChild.LeftChild)}else AppUI._seekSlider.value=1E3*a}}static playerError(a){Modal.show({text:a,returnFocusElement:AppUI._playlistControl})}static playlistSongLengthChange(a){App.player&&(a===
App.player.currentSong&&(Strings.changeText(AppUI._songLengthLabel,a.length),Strings.changeText(AppUI._assistiveSongLengthLabel,a.length),AppUI._seekSlider&&(0<a.lengthMS?(AppUI._seekSlider.disabled=!1,AppUI._seekSlider.max=a.lengthMS):(AppUI._seekSlider.value=0,AppUI._seekSlider.disabled=!0))),AppUI._playlistControl&&AppUI._playlistControl.refreshVisibleItems())}static seekSliderValueChange(a){AppUI._seekSlider&&AppUI._seekSlider.dragging&&(a=a/1E3|0,AppUI._currentTimeS!==a&&(AppUI._currentTimeS=
a,AppUI._seekSlider.manuallyChangeAria(Formatter.formatTimeS(a),SliderControlValueChild.LeftChild)))}static seekSliderDragChangeCommit(a){App.player&&App.player.seekTo(a)}static volumeSliderValueChange(a){App.player&&(App.player.volume=a)}static playlistControlItemClick(a,b,c){App.player&&!c&&App.player.play(b)}static playlistControlItemContextMenu(a,b){App.player&&a&&AppUI._playlistControl&&!AppUI._playlistControl.deleteMode&&AppUI.showSongInfo(a)}static playlistControlItemControlClick(a,b,c,d){AppUI.playlistControlItemContextMenu(a,
b)}static graphicalFilterControlTypeClick(){App.graphicalFilterControl&&(App.graphicalFilterControl.simpleMode=!App.graphicalFilterControl.simpleMode,AppUI._graphicalFilterControlType.text=App.graphicalFilterControl.simpleMode?Strings.TraditionalFilter:Strings.AdvancedFilter)}static graphicalFilterControlEnabledClick(){App.graphicalFilterControl&&(App.graphicalFilterControl.enabled=AppUI._graphicalFilterControlEnabled.checked)}static stereoPannerControlEnabledClick(){App.stereoPannerControl&&(App.stereoPannerControl.enabled=
AppUI._stereoPannerControlEnabled.checked)}static monoDownMixerControlEnabledClick(){App.monoDownMixerControl&&(App.monoDownMixerControl.enabled=AppUI._monoDownMixerControlEnabled.checked)}static hideTopMessage(){0>AppUI._topMessageFading||!AppUI._topMessage||(AppUI._topMessageTimeout&&clearTimeout(AppUI._topMessageTimeout),AppUI._topMessageFading=-1,AppUI._topMessage.classList.remove("in"),AppUI._topMessageTimeout=DelayControl.delayFadeCB(function(){0<=AppUI._topMessageFading||(AppUI._topMessageFading=
0,AppUI._topMessageTimeout=0,AppUI._topMessage.style.visibility="",AppUI._topMessage.innerHTML="",AppUI._titleLabel&&AppUI._titleLabel.classList.remove("behind"),AppUI._artistLabel&&AppUI._artistLabel.classList.remove("behind"))}))}static showTopMessage(a,b){AppUI._topMessage&&(AppUI._topMessageTimeout&&clearTimeout(AppUI._topMessageTimeout),AppUI._topMessageFading=1,AppUI._titleLabel&&AppUI._titleLabel.classList.add("behind"),AppUI._artistLabel&&AppUI._artistLabel.classList.add("behind"),AppUI._topMessage.innerHTML=
a,b&&b(AppUI._topMessage),AppUI._topMessage.style.visibility="visible",AppUI._topMessageTimeout=DelayControl.delayShortCB(function(){0>=AppUI._topMessageFading||1!==AppUI._topMessageFading||(AppUI._topMessageFading=2,AppUI._topMessage.classList.add("in"),AppUI._topMessageTimeout=DelayControl.delayFadeCB(function(){2===AppUI._topMessageFading&&(AppUI._topMessageFading=0,AppUI._topMessageTimeout=0)}))}))}static async addFiles(a){if(App.player&&!AppUI._loading&&!Modal.visible&&!FilePicker.visible){var b=
App.hostType===App.hostTypeElectron;if(FilePicker.isSupported()){a=null;var c=FilePicker.showAddPlay(AppUI._playlistControl)}else a=await App.showOpenDialogWeb(a),c=null;if((a||c)&&App.player)try{App.player.playlist||(App.player.playlist=new Playlist,AppUI.preparePlaylist());const d=App.player.playlist,e=b?null:new Uint8Array(BufferedReader.minBufferLength),f=b?null:new ResizeableBuffer(2048);let g=!1;do{let h=!1;if(c){const k=await c();if(!k)break;h=k.play;a=k.files}if(!a)break;AppUI._loading=!0;
App.updateLoadingIcon();for(let k=0;k<a.length&&App.player;k++)if(b)await d.addSong(a[k])&&h&&(h=!1,App.player&&App.player.play(d.length-1));else{const n=d.length;await d.addSongWeb(a[k],e,f)&&(n==d.length?g=!0:h&&(h=!1,App.player&&App.player.play(n)))}AppUI._loading=!1;App.updateLoadingIcon()}while(c);g&&AppUI._playlistControl&&AppUI._playlistControl.refreshVisibleItems()}catch(d){Modal.show({text:"addFiles error: "+(d.message||d.toString()),returnFocusElement:AppUI._playlistControl})}finally{AppUI._loading=
!1,App.updateLoadingIcon()}}}static toggleDeleteMode(a){if(AppUI._playlistControl){AppUI._focusBlocker&&(AppUI._focusBlocker.unblock(),AppUI._focusBlocker=null);AppUI._playlistControl.deleteMode?(AppUI._playlistControl.deleteMode=!1,AppUI.hideTopMessage(),a&&HistoryHandler.popState()):(AppUI._playlistControl.deleteMode=!0,AppUI._focusBlocker=new FocusBlocker,AppUI._focusBlocker.block(AppUI._middlePanel),AppUI.showTopMessage(Strings.DeleteModeHTML,function(b){const c=document.createElement("div");
c.innerHTML=`
					<f-button color="red" onclick="
					if (App.player && App.player.playlist)
						App.player.playlist.clear();

					if (AppUI._playlistControl && AppUI._playlistControl.deleteMode)
						AppUI.toggleDeleteMode(true);
					" text="${Strings.DeleteAllSongs}" icon-name="icon-delete-all">
					</f-button><f-button color="green" onclick="
					if (AppUI._playlistControl && AppUI._playlistControl.deleteMode)
						AppUI.toggleDeleteMode(true);
					" text="${Strings.Done}" icon-name="icon-check">
					</f-button>
				`;b.appendChild(c)}),HistoryHandler.pushState());try{AppUI._playlistControl.focus()}catch(b){}}}static checkPanelContainerToggleState(){if(!(875>=window.innerWidth)&&AppUI._fixedPanel&&AppUI._optionalPanel){if(AppUI._panelContainerToggling){AppUI._panelContainerToggleVersion++;AppUI._panelContainerToggling=!1;const a=AppUI._cover.parentNode;a&&a.removeChild(AppUI._cover);AppUI._cover.classList.remove("in")}AppUI._panelContainerToggled&&(AppUI._panelContainerToggled=!1,AppUI._panelContainer.classList.remove("toggled"),
HistoryHandler.popState())}}static toggleView(a){if(AppUI._panelContainer){AppUI._panelContainerToggleVersion++;const b=AppUI._panelContainerToggleVersion,c=function(d,e){AppUI._panelContainerToggling=!0;AppUI._cover.classList.remove("in");AppUI._cover.parentNode||document.body.appendChild(AppUI._cover);DelayControl.delayShortCB(async function(){if(AppUI._panelContainerToggleVersion===b&&(AppUI._cover.classList.add("in"),await DelayControl.delayFade(),AppUI._panelContainerToggleVersion===b&&(e?AppUI._panelContainer.classList.add("toggled"):
AppUI._panelContainer.classList.remove("toggled"),AppUI._cover.classList.remove("in"),await DelayControl.delayFade(),AppUI._panelContainerToggleVersion===b))){var f=AppUI._cover.parentNode;f&&f.removeChild(AppUI._cover);AppUI._panelContainerToggling=!1;try{d.focus()}catch(g){}}})};AppUI._panelContainerToggled?(AppUI._panelContainerToggled=!1,c(AppUI._playlistControl,!1),a&&HistoryHandler.popState()):(AppUI._panelContainerToggled=!0,c(AppUI._toggleViewButton.defaultFocusElement,!0),HistoryHandler.pushState())}}static showSongInfo(a){a||
(a=App.player&&App.player.currentSong);a?Modal.show({html:`<div class="selectable-text">
				<p><b>${Strings.Title}</b><br/>${Strings.htmlEncode(a.title)}</p>
				${a.artist?`<p><b>${Strings.Artist}</b><br/>${Strings.htmlEncode(a.artist)}</p>`:""}
				${a.album?`<p><b>${Strings.Album}</b><br/>${Strings.htmlEncode(a.album)}</p>`:""}
				<div class="top-margin" style="display: flex; flex-direction: row; justify-content: center;">
					<p class="no-top-margin"><b>${Strings.Track}</b><br/>${0<a.track?a.track:Formatter.none}</p>
					<p class="no-top-margin large-left-margin"><b>${Strings.Year}</b><br/>${0<a.year?a.year:Formatter.none}</p>
					<p class="no-top-margin large-left-margin"><b>${Strings.Duration}</b><br/>${0<a.lengthMS?a.length:Formatter.none}</p>
				</div>
				<div class="top-margin" style="display: flex; flex-direction: row; justify-content: center;">
					<p class="no-top-margin"><b>${Strings.SampleRate}</b><br/>${0<a.sampleRate?a.sampleRate+" Hz":Formatter.none}</p>
					<p class="no-top-margin large-left-margin"><b>${Strings.Channels}</b><br/>${0<a.channels?a.channels:Formatter.none}</p>
				</div>
				${a.url?`<p class="top-margin"><b>${Strings.Path}</b><br/>${Strings.htmlEncode(a.url.startsWith(FileUtils.localURLPrefix)?a.url.substring(FileUtils.localURLPrefix.length):a.url.startsWith(FileUtils.fileURLPrefix)?decodeURI(a.url.substring(FileUtils.fileURLPrefix.length)):a.url)}</p>`:""}
			</div>`,title:Strings.SongInfo,returnFocusElement:AppUI._playlistControl}):Alert.show(Strings.NoSongPlaying)}static showSearch(){if(App.player&&App.player.playlist&&AppUI._playlistControl){var a=new Playlist,b=document.createElement("f-list");b.emptyMessage=Strings.NoSongsFoundInPlaylist;b.className="full-height-list";b.ariaLabel=Strings.SearchResults;b.adapter=new PlaylistAdapter(a);b.onitemclick=function(d,e,f){App.player&&App.player.playlist&&!f&&(e=App.player.playlist.findIndexById(d.id),0<=
e&&App.player.play(e))};var c=document.createElement("input");c.type="text";c.className="bottom-border";c.ariaLabel=Strings.SearchPlaceholder;c.placeholder=Strings.SearchPlaceholder;c.spellcheck=!1;c.oninput=function(){a.clear();if(App.player&&App.player.playlist){const d=App.player.playlist.findItems(c.value);d.length&&a.addItems(d)}};Modal.show({html:[c,b],skipBody:!0,fullHeight:!0,title:Strings.Search,returnFocusElement:AppUI._playlistControl,onshown:function(){return c}})}}static showAbout(){const a=
document.createElement("div"),b=function(){c.checked=AppUI.rgbMode;d.checked=AppUI.animatedRGBMode;e.checked=AppUI.extraRGBMode},c=ButtonControl.create({text:Strings.RGBMode,checkable:!0,checked:AppUI.rgbMode,parent:a,onclick:function(){AppUI.rgbMode=c.checked;b()}}),d=ButtonControl.create({text:Strings.AnimatedRGBMode,checkable:!0,checked:AppUI.animatedRGBMode,parent:a,onclick:function(){AppUI.animatedRGBMode=d.checked;b()}}),e=ButtonControl.create({text:Strings.ExtraRGBMode,checkable:!0,checked:AppUI.extraRGBMode,
parent:a,onclick:function(){AppUI.extraRGBMode=e.checked;b()}}),f=ButtonControl.create({text:Strings.NeonMode,checkable:!0,checked:AppUI.neonMode,parent:a,onclick:function(){AppUI.neonMode=f.checked}});a.insertAdjacentHTML("beforeend",`
			<h1 class="modal-header padding extra-large-top-margin extra-large-bottom-margin n-left-margin n-right-margin">
				${Strings.About+" (v"+window.CACHE_VERSION+")"}
			</h1>
			${Strings.AboutHTML} ${App.player&&App.player.audioContext?`
			<p class="large-top-margin"><small>
				Base latency: ${(App.player.audioContext.baseLatency||0).toFixed(4)} s
			</small></p><p class="small-top-margin"><small>
				Output latency: ${isNaN(App.player.audioContext.outputLatency)?"-":App.player.audioContext.outputLatency.toFixed(4)+" s"}
			</small></p><p class="small-top-margin"><small>
				Output sample rate: ${isNaN(App.player.audioContext.sampleRate)?"-":App.player.audioContext.sampleRate} Hz
			</small></p><p class="small-top-margin"><small>
				User agent: ${Strings.htmlEncode(navigator.userAgent)}
			</small></p>
		`:""}`);Modal.show({html:a,title:Strings.Options,returnFocusElement:AppUI._playlistControl,onhidden:function(){App.saveSettings(!1)}})}}AppUI.primaryInputIsTouch="matchMedia"in window?window.matchMedia("(pointer: coarse)").matches:0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;AppUI.baseSizePX=4;AppUI.s1PX=AppUI.baseSizePX;AppUI.s2PX=2*AppUI.baseSizePX;AppUI.s3PX=3*AppUI.baseSizePX;AppUI.s4PX=4*AppUI.baseSizePX;AppUI.s5PX=5*AppUI.baseSizePX;AppUI.s6PX=6*AppUI.baseSizePX;AppUI.s7PX=7*AppUI.baseSizePX;
AppUI.s8PX=8*AppUI.baseSizePX;AppUI.smallFontSizeREM=3;AppUI.smallContentsSizeREM=4;AppUI.fontSizeREM=3.5;AppUI.contentsSizeREM=6;AppUI._baseThinBorderPX=1;AppUI._baseThickBorderPX=2;AppUI._zoomHandlers=[];AppUI._rootVariables=document.getElementById("root-variables");AppUI._cover=document.getElementById("cover");AppUI._panelContainer=document.getElementById("panel-container");AppUI._loading=!1;AppUI._devicePixelRatio=-1;AppUI._1remInPX=1;AppUI._fontScale=1;AppUI._smallIconSizePX=Icon.baseSizePX;
AppUI._largeIconSizePX=Icon.baseSizePX<<1;AppUI._thinBorderPX=AppUI._baseThinBorderPX;AppUI._thickBorderPX=AppUI._baseThickBorderPX;AppUI._buttonSizePX=1;AppUI._contentsSizePX=1;AppUI._playlistItemSizePX=1;AppUI._rgbMode=!1;AppUI._animatedRGBMode=!1;AppUI._extraRGBMode=!1;AppUI._neonMode=!1;AppUI._directoryCancelled=!1;AppUI._topMessageFading=0;AppUI._topMessageTimeout=0;AppUI._focusBlocker=null;AppUI._panelContainerToggled=!1;AppUI._panelContainerToggling=!1;AppUI._panelContainerToggleVersion=0;
class App{static saveSettings(a){App.player&&App.player.alive&&(a&&App.player.setPlaylistData(),InternalStorage.saveAppSettings({devicePixelRatio,playerVolume:App.player.volume,graphicalFilterControlEnabled:App.graphicalFilterControl?App.graphicalFilterControl.enabled:!1,graphicalFilterControlSimpleMode:App.graphicalFilterControl?App.graphicalFilterControl.simpleMode:!0,stereoPannerControlEnabled:App.stereoPannerControl?App.stereoPannerControl.enabled:!1,monoDownMixerControlEnabled:App.monoDownMixerControl?
App.monoDownMixerControl.enabled:!1,filePickerLastPath:FilePicker.lastPath,filePickerRootLength:FilePicker.lastRootLength,rgbMode:AppUI.rgbMode,animatedRGBMode:AppUI.animatedRGBMode,extraRGBMode:AppUI.extraRGBMode,neonMode:AppUI.neonMode}),App.graphicalFilterControl&&App.graphicalFilterControl.saveSettings(),App.stereoPannerControl&&App.stereoPannerControl.saveSettings(),a&&App.player.playlist&&InternalStorage.savePlaylistWeb(App.player.playlist))}static mainWindowStateChanged(a,b,c){if(App._isMinimized!==
b||App._isMaximized!==c)App._isMinimized=b,App._isMaximized=c,b||(App._titleBar&&(App._titleBar.className=c?"maximized":""),App._iconRestore&&(App._iconRestore.className=c?"":"hidden"),App._iconMaximize&&(App._iconMaximize.className=c?"hidden":""))}static mainWindowClosing(){if(App.player&&App.player.alive){const a=App._closeHandlers,b=[];App.saveSettings(!0);App.player.destroy(!0);if(a&&a.length)for(let c=a.length-1;0<=c;c--)if(a[c]){const d=a[c]();d&&b.push(d)}App.hostInterface&&(b.length?Promise.all(b).then(App.destroy,
App.destroy):App.destroy())}}static destroy(){App.player&&App.player.destroy();AppUI.destroy();const a=App._ipcRenderer,b=App._exitOnDestroy?App.hostInterface:null;zeroObject(App);a&&a.invoke("mainWindowFinalClose");b&&b.exit()}static updateLoadingIcon(){App._iconLoading&&(App._iconLoading.style.display=App.loading?"":"none")}static get loading(){return(App.player?App.player.loading:!1)||AppUI.loading||App._loading}static set loading(a){App._loading!==a&&(App._loading=a,App.updateLoadingIcon())}static get installPromptReady(){return!!App._installPrompt}static showInstallPrompt(){const a=
App._installPrompt;if(a&&a.prompt)try{App._installPrompt=null,a.prompt()}catch(b){}}static beforeInstallPrompt(a){"preventDefault"in a&&a.preventDefault();App._installPrompt=a}static sortFiles(a){if(a.length){const b=Strings.comparer;a[0]["data-path"]?a.sort(function(c,d){return b(c["data-path"],d["data-path"])}):a[0].webkitRelativePath?a.sort(function(c,d){return b(c.webkitRelativePath,d.webkitRelativePath)}):a.sort(function(c,d){return b(c.name,d.name)})}return a}static async preInit(){Strings.init();
GraphicalFilterEditorStrings.init(Strings.language);Strings.toFixed=GraphicalFilterEditorStrings.toFixed;if(!App.hostInterface&&FileSystemAPI.isSupported())try{await FileSystemAPI.init()}catch(c){Alert.show(c.message||c.toString())}const a=InternalStorage.loadAppSettings(),b=window.electronWebFrame;App._ipcRenderer&&delete window.electronIpcRenderer;b&&delete window.electronWebFrame;if("serviceWorker"in navigator&&!location.href.startsWith("file://")){window.addEventListener("beforeinstallprompt",
App.beforeInstallPrompt);const c=navigator.serviceWorker.register("sw.js");c&&"then"in c&&c.then(function(d){d&&"onupdatefound"in d&&d.active&&(d.onupdatefound=function(){Modal.show({html:Strings.PleaseRefresh,title:Strings.UpdateAvailable,returnFocusElement:AppUI.playlistControlElement,okText:Strings.Refresh,okCancel:!0,onok:function(){window.location.reload()}})})})}App._ipcRenderer?(App._ipcRenderer.on("mainWindowStateChanged",App.mainWindowStateChanged),App._ipcRenderer.on("mainWindowClosing",
App.mainWindowClosing),App.triggerMainWindowStateChanged()):App.hostInterface||window.addEventListener("onpagehide"in window?"pagehide":"unload",App.mainWindowClosing);App.frameless&&(App._titleBar=document.createElement("h1"),App._titleBar.className="title-bar",App._titleBar.innerHTML=`
				<div></div>
				<i id="icon-main"></i>
				FPlay
				<span><span role="button" onclick="App.mainWindowMinimize()">${Icon.createHTML("icon-minimize")}</span><span role="button" onclick="App.mainWindowRestoreOrMaximize()">${Icon.createHTML("icon-restore",null,!1,"hidden","icon-restore-i")}${Icon.createHTML("icon-maximize",null,!1,null,"icon-maximize-i")}</span><span role="button" class="close" onclick="App.mainWindowClose()">${Icon.createHTML("icon-close")}</span></span>
			`,document.body.insertBefore(App._titleBar,document.body.firstChild),App._iconRestore=document.getElementById("icon-restore-i"),App._iconMaximize=document.getElementById("icon-maximize-i"));AppUI.preInit(b,a);App.init(a)}static init(a){App.player||(App.player=new Player(a.playerVolume,InternalStorage.loadPlaylistWeb(),HostMediaSession.getMediaSession(),function(b){App.graphicalFilterControl=new GraphicalFilterControl(document.getElementById("filter-container"),document.getElementById("optional-panel-container"),
b,a.graphicalFilterControlSimpleMode);App.graphicalFilterControl.enabled=!!a.graphicalFilterControlEnabled;return App.graphicalFilterControl},function(b){App.stereoPannerControl=new StereoPannerControl(document.getElementById("stereo-panner-slider"),b);App.stereoPannerControl.enabled=!!a.stereoPannerControlEnabled;App.stereoPannerControl.onappliedgainchange=function(c){App.monoDownMixerControl&&(App.monoDownMixerControl.multiplier=1/(1+c))};return App.stereoPannerControl},function(b){App.monoDownMixerControl=
new MonoDownMixerControl(b);App.monoDownMixerControl.enabled=MonoDownMixerControl.isSupported()&&!!a.monoDownMixerControlEnabled;return App.monoDownMixerControl}),AppUI.init(a),App.loading=!1)}static triggerMainWindowStateChanged(){App._ipcRenderer&&App._ipcRenderer.invoke("triggerMainWindowStateChanged")}static mainWindowMinimize(){App._ipcRenderer&&App._ipcRenderer.invoke("mainWindowMinimize")}static mainWindowRestoreOrMaximize(){App._ipcRenderer&&App._ipcRenderer.invoke(App._isMaximized?"mainWindowRestore":
"mainWindowMaximize")}static mainWindowClose(){App._ipcRenderer&&App._ipcRenderer.invoke("mainWindowClose")}static extractMetadata(a,b){return App._ipcRenderer.invoke("extractMetadata",a,b)}static showOpenDialogWeb(a,b){const c=document.createElement("input");c.type="file";c.multiple=!0;c.ariaLabel=Strings.AddSongs;a&&(c.webkitdirectory=!0,c.directory=!0);c.onchange=function(){if(App._fileInputPromiseResolve){var e=App._fileInputPromiseResolve;App._fileInputPromiseResolve=null;if(c.files&&c.files.length&&
(1!==c.files.length||FileUtils.isTypeSupported(c.files[0].name))){var f=Array(c.files.length);for(let g=f.length-1;0<=g;g--)f[g]=c.files[g];c.value="";e(b?f:App.sortFiles(f))}else e(null)}};a=App._fileInputPromiseResolve;App._fileInputPromiseResolve=null;const d=new Promise(function(e){App._fileInputPromiseResolve=e});c.click();a&&a(null);return d}static exit(){App._exitOnDestroy=!0;App.mainWindowClosing()}}App.hostTypeElectron="Electron";App.hostTypeAndroid="Android";
App._ipcRenderer=window.electronIpcRenderer||null;App._closeHandlers=[];App.frameless=!!window.electronIpcRenderer;App.hostInterface=window.hostInterface||null;App.hostType=App.hostInterface&&App.hostInterface.getHostType()||null;App._iconLoading=document.getElementById("icon-loading");App._titleBar=null;App._iconRestore=null;App._iconMaximize=null;App._installPrompt=null;App._fileInputPromiseResolve=null;App._loading=!0;App._isMinimized=!1;App._isMaximized=!1;App._exitOnDestroy=!1;
function main(){App.preInit().catch(console.error)}let cLib;function cancelEvent(a){a&&("isCancelled"in a&&(a.isCancelled=!0),!("preventDefault"in a)||"cancelable"in a&&!a.cancelable||a.preventDefault(),"stopPropagation"in a&&a.stopPropagation());return!1}function lerp(a,b,c,d,e){return(e-a)*(d-b)/(c-a)+b}function smoothStep(a,b,c){a=(c-a)/(b-a);return 0>=a?0:1<=a?1:a*a*(3-2*a)}
function zeroObject(a,b){for(let c in a)switch(typeof a[c]){case "function":b&&(a[c]=null);break;case "boolean":a[c]=!1;break;case "number":a[c]=0;break;default:const d=a[c];Array.isArray(d)&&d.fill(null);a[c]=null}}
function setup(){function a(c){window.CLib(c).then(function(d){cLib=d;window.main&&window.main()},function(d){alert(d);throw d;})}Array.prototype.fill||(Array.prototype.fill=function(c,d,e){var f=this.length|0;d|=0;e=void 0===e?f:e|0;e=0>e?Math.max(f+e,0):Math.min(e,f);for(d=0>d?Math.max(f+d,0):Math.min(d,f);d<e;)this[d++]=c;return this});var b=window.CLibWasmBinary;b?(delete window.CLibWasmBinary,Promise.resolve(b).then(function(c){a({wasmBinary:c})},function(){a()})):(b=window.CLibMemoryArrayBuffer)?
(delete window.CLibMemoryArrayBuffer,Promise.resolve(b).then(function(c){a({memoryInitializerRequest:{status:200,response:c}})},function(){a()})):a()}setup();
