'use strict';var __asyncValues=this&&this.__asyncValues||function(a){function b(f){e[f]=a[f]&&function(g){return new Promise(function(k,h){g=a[f](g);c(k,h,g.done,g.value)})}}function c(f,g,k,h){Promise.resolve(h).then(function(m){f({value:m,done:k})},g)}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var d=a[Symbol.asyncIterator],e;return d?d.call(a):(a="function"===typeof __values?__values(a):a[Symbol.iterator](),e={},b("next"),b("throw"),b("return"),e[Symbol.asyncIterator]=
function(){return this},e)};
class Icon{static init(){const a=document.getElementsByTagName("i");if(a)for(let b=a.length-1;0<=b;b--)Icon.prepare(a[b])}static prepare(a){if(!a)return null;const b=a.className;let c;if(b&&0<=(c=b.indexOf("icon-"))&&a.parentNode){const d=b.indexOf(" ",c);return Icon.create(d>c?b.substring(c,d):b.substring(c),d>c?b.substring(0,c)+b.substring(d+1):b.substring(0,c),null,a)}return null}static createHTML(a,b,c,d){return`<i class="icon ${b?"large":""} ${c||""}" ${d?"id="+d:""}><svg><use href="#${a}" /></svg></i>`}static create(a,
b,c,d){d=d||document.createElement("i");const e=document.createElementNS("http://www.w3.org/2000/svg","svg"),f=document.createElementNS("http://www.w3.org/2000/svg","use");f.setAttribute("href","#"+a);e.appendChild(f);c&&d.setAttribute("id",c);d.className=b?"icon "+b:"icon";d.appendChild(e);return d}static createLarge(a,b,c){return Icon.create(a,b?b+" large":"large",c)}}Icon.baseSizePX=12;
class Strings{static toFixed(a,b){return a.toFixed(b)}static init(){Strings.comparer="Intl"in window&&Intl.Collator?(new Intl.Collator(void 0,{usage:"sort",sensitivity:"variant",numeric:!0})).compare:function(b,c){return b.localeCompare(c)};const a=App.hostInterface&&App.hostInterface.getBrowserLanguage()||navigator.userLanguage||navigator.language;a&&0===a.toLowerCase().indexOf("pt")&&(Strings.language="pt-br",document.documentElement.setAttribute("lang","pt-br"),Strings.decimalSeparator=",",Strings.oppositeDecimalSeparator=
".",Strings.About="Sobre",Strings.Edit="Edit",Strings.Delete="Excluir",Strings.DeleteSongs="Excluir m\u00fasicas",Strings.DeleteAllSongs="Excluir todas",Strings.Enable="Ativar",Strings.Disable="Desativar",Strings.Enabled="Ativado",Strings.Disabled="Desativado",Strings.Selected="Selecionado",Strings.AdvancedFilter="Filtro avan\u00e7ado",Strings.TraditionalFilter="Filtro tradicional",Strings.Missing="Faltando",Strings.MissingSongError="A m\u00fasica est\u00e1 faltando! \ud83d\ude22 Por favor, apenas adicione novamente a m\u00fasica antes de tocar. Quando voc\u00ea adiciona uma m\u00fasica que est\u00e1 faltando, ela fica na mesma posi\u00e7\u00e3o dentro da playlist! \ud83d\ude0a",
Strings.FileNotFoundOrNoPermissionError="O arquivo da m\u00fasica n\u00e3o foi encontrado ou n\u00e3o foi dada permiss\u00e3o de acesso a ele! \ud83d\ude22",Strings.NothingSelected="Nada foi selecionado! \ud83d\ude05",Strings.Cancel="Cancelar",Strings.Clear="Limpar",Strings.Back="Voltar",Strings.Close="Fechar",Strings.Refresh="Recarregar",Strings.Exit="Sair",Strings.Done="Conclu\u00eddo",Strings.Up="Acima",Strings.All="Tudo",Strings.Storage="Armazenamento",Strings.Previous="Anterior",Strings.Play=
"Tocar",Strings.Pause="Pausar",Strings.PlayPause="Tocar / Pausar",Strings.Stop="Parar",Strings.Next="Pr\u00f3xima",Strings.LeftAbbrev="E",Strings.RightAbbrev="D",Strings.DownMixToMono="Fazer down-mix para mono",Strings.UnknownError="Algo saiu errado durante a reprodu\u00e7\u00e3o. \ud83d\ude22",Strings.AddFiles="Adicionar arquivos",Strings.AddSongs="Adicionar m\u00fasicas",Strings.AddFolders="Adicionar pastas",Strings.AddMoreFolders="Adicionar mais pastas\u2026",Strings.ShowEffects="Exibir efeitos",
Strings.ShowPlaylist="Exibir playlist",Strings.UpdateAvailable="Atualiza\u00e7\u00e3o dispon\u00edvel!",Strings.PleaseRefresh="Por favor, recarregue a p\u00e1gina para atualizar a aplica\u00e7\u00e3o. \ud83d\ude0a",Strings.AboutHTML='FPlay Web \u00e9 um player de \u00e1udio experimental. \ud83d\ude0a<br />\n<br />\nPara mais informa\u00e7\u00f5es sobre o projeto, seu c\u00f3digo-fonte e depend\u00eancias, confira seu reposit\u00f3rio em <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb">github.com/carlosrafaelgn/FPlayWeb</a>.<br />\n<br />\nEste projeto \u00e9 licenciado sob a <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb/blob/master/LICENSE">MIT License</a>.',
Strings.DeleteModeHTML="Clique as m\u00fasicas para exclu\u00ed-las.");Strings.translateChildren(document.body)}static translate(a){const b=Strings[a];return void 0!==b?b:a}static translateChildren(a){a=a.childNodes;for(let d=a.length-1;0<=d;d--){const e=a[d];if(!e.tagName)continue;e.childNodes&&e.childNodes.length&&Strings.translateChildren(e);let f;(f=e.getAttribute("title"))&&e.setAttribute("title",Strings.translate(f));if(f=e.getAttribute("data-string")){e.removeAttribute("data-string");var b=
0;do{let g=f.indexOf(";",b);g<b&&(g=f.length);var c=f.indexOf("|",b);0>c||c>=g?e.appendChild(document.createTextNode(Strings.translate(f))):(b=f.substring(b,c),c=f.substring(c+1,g),e.setAttribute(b,Strings.translate(c)));b=g+1}while(b<f.length)}}}static changeText(a,b){if(a){null===b&&(b="");var c=a.lastChild;c?c.nodeValue=b:a.appendChild(document.createTextNode(b))}}}Strings.language="en";Strings.decimalSeparator=".";Strings.oppositeDecimalSeparator=",";Strings.Oops="Oops\u2026";
Strings.AppName="FPlay";Strings.Menu="Menu";Strings.About="About";Strings.Edit="Edit";Strings.Delete="Delete";Strings.DeleteSongs="Delete songs";Strings.DeleteAllSongs="Delete all";Strings.Enable="Enable";Strings.Disable="Disable";Strings.Enabled="Enabled";Strings.Disabled="Disabled";Strings.Selected="Selected";Strings.AdvancedFilter="Advanced filter";Strings.TraditionalFilter="Traditional filter";Strings.Missing="Missing";Strings.MissingSongError="The song is missing! \ud83d\ude22 Please, just add it again before playing it. When you add a missing song, it keeps its position in the playlist! \ud83d\ude0a";
Strings.FileNotFoundOrNoPermissionError="The song's file could not be found or the permission to access it was not granted! \ud83d\ude22";Strings.NothingSelected="Nothing selected! \ud83d\ude05";Strings.OK="OK";Strings.Cancel="Cancel";Strings.Clear="Clear";Strings.Back="Back";Strings.Close="Close";Strings.Refresh="Refresh";Strings.Exit="Exit";Strings.Done="Done";Strings.Up="Up";Strings.All="All";Strings.Storage="Storage";Strings.Previous="Previous";Strings.Play="Play";Strings.Pause="Pause";
Strings.PlayPause="Play / Pause";Strings.Stop="Stop";Strings.Next="Next";Strings.LeftAbbrev="L";Strings.RightAbbrev="R";Strings.Volume="Volume";Strings.Panning="Panning";Strings.DownMixToMono="Down-mix to mono";Strings.UnknownError="Something went wrong during playback. \ud83d\ude22";Strings.AddFiles="Add files";Strings.AddSongs="Add songs";Strings.AddFolders="Add folders";Strings.AddMoreFolders="Add more folders\u2026";Strings.ShowEffects="Show effects";Strings.ShowPlaylist="Show playlist";
Strings.UpdateAvailable="Update available!";Strings.PleaseRefresh="Please, refresh the page to update the app. \ud83d\ude0a";Strings.AboutHTML='FPlay Web is an experimental audio player. \ud83d\ude0a<br />\n<br />\nFor more information about the project, its source code and dependencies, check out its repository at <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb">github.com/carlosrafaelgn/FPlayWeb</a>.<br />\n<br />\nThis project is licensed under the <a target="_blank" href="https://github.com/carlosrafaelgn/FPlayWeb/blob/master/LICENSE">MIT License</a>.';
Strings.DeleteModeHTML="Click songs to delete them.";class DelayControl{static delayShortCB(a){return setTimeout(a,DelayControl.shortDelayMS)}static delayUICB(a){return setTimeout(a,DelayControl.uiDelayMS)}static delayShort(){return new Promise(function(a){setTimeout(a,DelayControl.shortDelayMS)})}static delayUI(){return new Promise(function(a){setTimeout(a,DelayControl.uiDelayMS)})}}DelayControl.shortDelayMS=10;DelayControl.uiDelayMS=310;
class FileUtils{static isTypeSupported(a){const b=a.lastIndexOf(".");if(0>b)return!1;a=a.substring(b);return FileUtils.supportedExtensions[a]||FileUtils.supportedExtensions[a.toLowerCase()]||!1}static urlOrPathToURL(a){return!a||a.startsWith(FileUtils.httpURLPrefix)||a.startsWith(FileUtils.fileURLPrefix)||a.startsWith(FileUtils.localURLPrefix)?a:FileUtils.pathToURL(a)}static pathToURL(a){return encodeURI(47===a.charCodeAt(0)?FileUtils.fileURLPrefix+a:FileUtils.fileURLPrefixWindows+a.replace(FileUtils.regExpSepWindows,
"/")).replace(FileUtils.regExpHash,"%23")}static nameFromLinuxPath(a){if(!a)return a;let b=a.lastIndexOf("/");return 0<=b?a.substring(b+1):a}}FileUtils.separator="\u0004";FileUtils.httpURLPrefix="http";FileUtils.fileURLPrefix="file://";FileUtils.localURLPrefix="local://";FileUtils.fileURLPrefixWindows="file:///";FileUtils.regExpSepWindows=/\\/g;FileUtils.regExpHash=/#/g;FileUtils.supportedExtensions={".aac":!0,".mp3":!0,".wav":!0};
FileUtils.concatenatedSupportedExtensions=function(){let a="";for(let b in FileUtils.supportedExtensions)a=a?a+","+b:b;return a}();
class DataReader{constructor(a){this.arrayBuffer=a;this.dataView=new DataView(a);this.textDecoder=new TextDecoder("utf-8",{ignoreBOM:!0});this._position=0;this.length=a.byteLength}get position(){return this._position}get available(){return this.length-this._position}destroy(){zeroObject(this)}readInt8(){return this.dataView.getInt8(this._position++)}readUint8(){return this.dataView.getUint8(this._position++)}readInt16(){const a=this.dataView.getInt16(this._position,!0);this._position+=2;return a}readUint16(){const a=
this.dataView.getUint16(this._position,!0);this._position+=2;return a}readInt32(){const a=this.dataView.getInt32(this._position,!0);this._position+=4;return a}readFloat32(){const a=this.dataView.getFloat32(this._position,!0);this._position+=4;return a}readFloat64(){const a=this.dataView.getFloat64(this._position,!0);this._position+=8;return a}readString(){const a=this.dataView.getUint16(this._position,!0);this._position+=2;return a?this.textDecoder.decode(this.arrayBuffer.slice(this._position,this._position+=
a)):""}}
class DataWriter{constructor(a){this._capacity=a&&0<a?a:16384;this.arrayBuffer=new ArrayBuffer(this._capacity);this.dataView=new DataView(this.arrayBuffer);this.textEncoder=new TextEncoder;this._length=0}get trimmedArrayBuffer(){return this.arrayBuffer.slice(0,this._length)}get length(){return this._length}get capacity(){return this._capacity}destroy(){zeroObject(this)}ensureCapacity(a){a=this._length+a;a<=this._capacity||(a=new ArrayBuffer(a+(a>>2)),(new Uint8Array(a)).set(new Uint8Array(this.arrayBuffer)),this.arrayBuffer=
a,this.dataView=new DataView(this.arrayBuffer),this._capacity=a.byteLength)}writeInt8(a){this.ensureCapacity(1);this.dataView.setInt8(this._length++,a);return this}writeUint8(a){this.ensureCapacity(1);this.dataView.setUint8(this._length++,a);return this}writeInt16(a){this.ensureCapacity(2);this.dataView.setInt16(this._length,a,!0);this._length+=2;return this}writeUint16(a){this.ensureCapacity(2);this.dataView.setUint16(this._length,a,!0);this._length+=2;return this}writeInt32(a){this.ensureCapacity(4);
this.dataView.setInt32(this._length,a,!0);this._length+=4;return this}writeFloat32(a){this.ensureCapacity(4);this.dataView.setFloat32(this._length,a,!0);this._length+=4;return this}writeFloat64(a){this.ensureCapacity(8);this.dataView.setFloat64(this._length,a,!0);this._length+=8;return this}writeString(a){if(!a)return this.writeInt16(0);this.ensureCapacity(2+6*a.length);a=this.textEncoder.encodeInto(a,new Uint8Array(this.arrayBuffer,this._length+2));if(!a.written)throw Error("String encoding error");
if(65535<a.written)throw Error("String too large");this.dataView.setUint16(this._length,a.written,!0);this._length+=2+a.written;return this}}
class BufferedFileHandle{constructor(a,b){if(b.length<BufferedFileHandle.minBufferLength)throw Error("Buffer length too small: "+b.length);this.file=a;this.fileLength=a.size;this.buffer=b;this._bufferAvailable=this.bufferPosition=this.position=0;this._eof=!1}get bufferAvailable(){return this._bufferAvailable}get eof(){return this._eof}seekTo(a){if(0>a)throw Error("Invalid position");this._bufferAvailable=this.bufferPosition=0;a>=this.fileLength?(this.position=this.fileLength,this._eof=!0):(this.position=
a,this._eof=!1)}skip(a){0>=a||(a>=this._bufferAvailable?(a-=this._bufferAvailable,this.position+=a,this.position>=this.fileLength&&(this.position=this.fileLength,this._eof=!0),this._bufferAvailable=this.bufferPosition=0):(this.bufferPosition+=a,this._bufferAvailable-=a))}fillBuffer(a){if(0>=a)a=this.buffer.length;else if(0>a||a>this.buffer.length)throw Error("Invalid length");const b=this._bufferAvailable;if(a<=b||this._eof)return null;a=this.buffer.length;b&&this.bufferPosition&&(this.buffer.copyWithin(0,
this.bufferPosition,this.bufferPosition+b),this.bufferPosition=0);a-=b;return new Promise((c,d)=>{this.file.slice(this.position,this.position+a).arrayBuffer().then(e=>{e.byteLength?(this.position+=e.byteLength,this.position>=this.fileLength&&(this.position=this.fileLength,this._eof=!0),this._bufferAvailable+=e.byteLength):this._eof=!0;this.buffer.set(new Uint8Array(e),b);c()},d)})}readByte(){if(!this._bufferAvailable)return-1;this._bufferAvailable--;return this.buffer[this.bufferPosition++]}readUInt32BE(){if(4>
this._bufferAvailable)return null;this._bufferAvailable-=4;return this.buffer[this.bufferPosition++]<<24|this.buffer[this.bufferPosition++]<<16|this.buffer[this.bufferPosition++]<<8|this.buffer[this.bufferPosition++]}readUInt32LE(){if(4>this._bufferAvailable)return null;this._bufferAvailable-=4;return this.buffer[this.bufferPosition++]|this.buffer[this.bufferPosition++]<<8|this.buffer[this.bufferPosition++]<<16|this.buffer[this.bufferPosition++]<<24}readUInt16BE(){if(2>this._bufferAvailable)return null;
this._bufferAvailable-=2;return this.buffer[this.bufferPosition++]<<8|this.buffer[this.bufferPosition++]}readUInt16LE(){if(2>this._bufferAvailable)return null;this._bufferAvailable-=2;return this.buffer[this.bufferPosition++]|this.buffer[this.bufferPosition++]<<8}read(a,b,c){if(0>c)throw Error("Invalid length");const d=this._bufferAvailable;if(c<=d)return a.set(this.buffer.subarray(this.bufferPosition,this.bufferPosition+=c),b),this._bufferAvailable-=c,this._bufferAvailable||(this.bufferPosition=
0),c;let e=0;d&&(a.set(this.buffer.subarray(this.bufferPosition,this.bufferPosition+d),b),e+=d,b+=d,c-=d,this._bufferAvailable=this.bufferPosition=0);return this._eof?e:new Promise((f,g)=>{this.file.slice(this.position,this.position+c).arrayBuffer().then(k=>{k.byteLength?(this.position+=k.byteLength,this.position>=this.fileLength&&(this.position=this.fileLength,this._eof=!0)):this._eof=!0;a.set(new Uint8Array(k),b);f(k.byteLength+e)},g)})}}BufferedFileHandle.minBufferLength=32768;
class MetadataExtractor{static async extractRIFF(a,b,c){if(44>b.fileLength)return null;var d=b.readUInt32LE();if(null===d||b.fileLength<8+d)return null;var e=d;let f=!1,g=!1,k=d=0,h=0;a:for(;0<e;){var m=!1,l=0,n=void 0;switch(b.readUInt32BE()){case null:break a;case 1463899717:m=!0;e-=4;break;case 1279873876:l=b.readUInt32LE();if(null===l)break a;e-=8;if(0>l||l>e)break a;break;case 1768174368:l=b.readUInt32LE();if(null===l)break a;e-=8;if(0>l||l>e)break a;(n=b.fillBuffer(1024))&&await n;if(4<l){m=
b.readByte();var p=b.readByte();n=b.readByte();if(null===m||null===p||null===n)break a;e-=3;l-=3;if(73===m||68===p||51===n)if(d=b.fileLength-e,f&&g){d=-1;break a}}b.skip(l);(n=b.fillBuffer(1024))&&await n;continue;default:l=b.readUInt32LE();if(null===l)break a;e-=8;if(0>l||l>e)break a;b.skip(l);(n=b.fillBuffer(1024))&&await n;continue}for((n=b.fillBuffer(1024))&&await n;m&&(!f||!g)||0<l;){var r=b.readUInt32BE();p=0;if(null===r)break a;e-=4;l-=4;if(1229866575!==r){p=b.readUInt32LE();if(null===p||0>
p||p>e||!m&&p>l)break a;e-=4;l-=4}1684108385!==r&&(n=b.fillBuffer(Math.min(264,8+p)))&&await n;switch(r){case 1718449184:if(!m)break;n=b.readUInt16LE();r=b.readUInt16LE();var q=b.readUInt32LE(),u=b.readUInt32LE(),t=b.readUInt16LE();const y=b.readUInt16LE();p-=16;e-=16;l-=16;if(null===n||null===r||null===q||null===u||null===t||null===y)break a;f=!0;h||(h=u);break;case 1684108385:m&&(g=!0,k||(k=p));break;case 1229866575:for(r=function(x){b.read(c,0,x);return MetadataExtractor.finishReadingV2Frame(0,
x,c)};0<l;){(n=b.fillBuffer(8))&&await n;q=b.readUInt32BE();e-=4;l-=4;if(null===q)break a;u=b.readUInt32LE();e-=4;l-=4;if(null===u||0>u||u>l)break a;if(1>=u)b.skip(u);else{t=Math.min(257,u)-1;(n=b.fillBuffer(t))&&await n;switch(q){case 1229865293:a.title=r(t);break;case 1230000708:a.album=r(t);break;case 1229017684:a.artist=r(t);break;case 1229148740:a.year=parseInt(r(t))||0;break;case 1230262859:a.track=parseInt(r(t))||0;break;default:t=0}b.skip(u-t);e-=u;l-=u}}}0<p&&(b.skip(p),e-=p,l-=p);e&&(n=
b.fillBuffer(8))&&await n}}return f&&g?(d&&(0<d&&b.seekTo(d),(e=b.fillBuffer(1024))&&await e),a.lengthMS=1E3*k/h|0,[a,!!d]):null}static finishReadingV2Frame(a,b,c){let d=0;var e=b-1;a:for(;0<b;)switch(c[d]){case 0:case 9:case 10:case 11:case 12:case 13:case 32:case 133:case 160:b--;d++;break;default:break a}a:for(;0<b;)switch(c[e]){case 0:case 9:case 10:case 11:case 12:case 13:case 32:case 133:case 160:b--;e--;break;default:break a}e=null;switch(a){case 1:case 2:if(b&1&&d+b<c.length&&b++,2<=b&&1===
a&&(254===c[d]&&255===c[d+1]?(a=2,d+=2,b-=2):255===c[d]&&254===c[d+1]&&(d+=2,b-=2),!b))return null}switch(a){case 0:e=MetadataExtractor.textDecoderIso88591.decode(c.subarray(d,d+b));break;case 1:e=MetadataExtractor.textDecoderUtf16.decode(c.subarray(d,d+b));break;case 2:e=MetadataExtractor.textDecoderUtf16be.decode(c.subarray(d,d+b));break;case 3:e=MetadataExtractor.textDecoderUtf8.decode(c.subarray(d,d+b))}return e&&e.length?e:null}static readV2Frame(a,b,c){if(2>b)return a.skip(b),null;const d=a.readByte();
b--;if(0>d||3<d)return a.skip(b),null;let e=c[0];b>e.length&&(e=new Uint8Array(b+16),c[0]=e);a=a.read(e,0,b);return"number"===typeof a?MetadataExtractor.finishReadingV2Frame(d,a,e):a.then(function(f){return MetadataExtractor.finishReadingV2Frame(d,f,e)})}static async extractID3v1(a,b,c,d){try{b.seekTo(b.fileLength-128);const g=b.read(d,0,128);"number"!==typeof g&&await g;if(84==d[0]&&65==d[1]&&71==d[2]){var e;if(!(c&MetadataExtractor.TITLE_B)){var f=3;for(e=0;30>e&&d[f];)e++,f++;e&&(a.title=MetadataExtractor.textDecoderIso88591.decode(d.subarray(3,
3+e)))}if(!(c&MetadataExtractor.ARTIST_B)){f=33;for(e=0;30>e&&d[f];)e++,f++;e&&(a.artist=MetadataExtractor.textDecoderIso88591.decode(d.subarray(33,33+e)))}if(!(c&MetadataExtractor.ALBUM_B)){f=63;for(e=0;30>e&&d[f];)e++,f++;e&&(a.album=MetadataExtractor.textDecoderIso88591.decode(d.subarray(63,63+e)))}if(!(c&MetadataExtractor.YEAR_B)){f=93;for(e=0;4>e&&d[f];)e++,f++;e&&(a.year=parseInt(MetadataExtractor.textDecoderIso88591.decode(d.subarray(93,93+e))))}c&MetadataExtractor.TRACK_B||d[125]||!d[126]||
(a.track=d[126]&255)}}catch(g){}}static async extractID3v2Andv1(a,b,c){const d={url:FileUtils.urlOrPathToURL(a["data-path"])||""};d.url?d.url.startsWith(FileUtils.localURLPrefix)&&(d.file=a):(d.file=a,d.fileSize=a.size,d.fileName=a.name);a=b.readByte()<<24|b.readByte()<<16|b.readByte()<<8;if(1229206272!==a)if(a|=b.readByte(),1380533830===a){a=await MetadataExtractor.extractRIFF(d,b,c[0]);if(!a)return null;if(!a[1])return d}else return await MetadataExtractor.extractID3v1(d,b,0,c[0]),d;var e=b.readByte(),
f=b.readByte();a=b.readByte();var g=b.readByte();const k=b.readByte(),h=b.readByte(),m=b.readByte();a=(a&16?10:0)+(m&127|(h&127)<<7|(k&127)<<14|(g&127)<<21);if(2<(e&255)||f){for(e=0;0<a&&e!==MetadataExtractor.ALL_B;){(f=b.fillBuffer(1024))&&await f;g=b.readByte()<<24|b.readByte()<<16|b.readByte()<<8|b.readByte();f=b.readByte()<<24|b.readByte()<<16|b.readByte()<<8|b.readByte();b.skip(2);if(!g||0>=f||f>a)break;switch(g){case 1414091826:e&MetadataExtractor.TITLE_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,
f,c),d.title=g&&g.then?await g:g,d.title&&(e|=MetadataExtractor.TITLE_B));break;case 1414546737:e&MetadataExtractor.ARTIST_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,f,c),d.artist=g&&g.then?await g:g,d.artist&&(e|=MetadataExtractor.ARTIST_B));break;case 1413565506:e&MetadataExtractor.ALBUM_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,f,c),d.album=g&&g.then?await g:g,d.album&&(e|=MetadataExtractor.ALBUM_B));break;case 1414677323:e&MetadataExtractor.TRACK_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,
f,c),d.track=g&&g.then?parseInt(await g):parseInt(g),d.track?e|=MetadataExtractor.TRACK_B:d.track=0);break;case 1414284622:e&MetadataExtractor.LENGTH_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,f,c),d.lengthMS=g&&g.then?parseInt(await g):parseInt(g),d.lengthMS?e|=MetadataExtractor.LENGTH_B:d.lengthMS=0);break;case 1415136594:case 1413763651:e&MetadataExtractor.YEAR_B?b.skip(f):(g=MetadataExtractor.readV2Frame(b,f,c),d.year=g&&g.then?parseInt(await g):parseInt(g),d.year?e|=MetadataExtractor.YEAR_B:
d.year=0);break;default:b.skip(f)}a-=10+f}(e&MetadataExtractor.ALL_BUT_LENGTH_B)!==MetadataExtractor.ALL_BUT_LENGTH_B&&await MetadataExtractor.extractID3v1(d,b,e,c[0])}return d}static async extract(a,b,c){if(!a)return null;if(!a.name.endsWith(".mp3")&&!a.name.endsWith(".aac")&&!a.name.endsWith(".wav")){const d=a.name.toLowerCase();if(!d.endsWith(".mp3")&&!d.endsWith(".aac")&&!d.endsWith(".wav"))return null}b||(b=new Uint8Array(BufferedFileHandle.minBufferLength));c||(c=[new Uint8Array(256)]);try{const d=
new BufferedFileHandle(a,b);await d.fillBuffer(-1);return await MetadataExtractor.extractID3v2Andv1(a,d,c)}catch(d){return null}}}MetadataExtractor.ALL_B=63;MetadataExtractor.ALL_BUT_LENGTH_B=31;MetadataExtractor.TITLE_B=1;MetadataExtractor.ARTIST_B=2;MetadataExtractor.ALBUM_B=4;MetadataExtractor.TRACK_B=8;MetadataExtractor.YEAR_B=16;MetadataExtractor.LENGTH_B=32;MetadataExtractor.textDecoderIso88591=new TextDecoder("iso-8859-1");MetadataExtractor.textDecoderUtf16=new TextDecoder("utf-16");
MetadataExtractor.textDecoderUtf16be=new TextDecoder("utf-16be");MetadataExtractor.textDecoderUtf8=new TextDecoder("utf-8");class Formatter{static formatTimeMS(a){if(0>a)return Formatter.none;a=a/1E3|0;let b=(a/60|0)+":";a%=60;10>a&&(b+="0");return b+a}static formatTimeS(a){if(0>a)return Formatter.none;let b=(a/60|0)+":";a%=60;10>a&&(b+="0");return b+a}static formatDB(a){return 0>a?Strings.toFixed(a,1):0===a?"-"+Strings.toFixed(a,1):"+"+Strings.toFixed(a,1)}}Formatter.zero="0:00";Formatter.none="-";
Formatter.noneInt=-1;
class ListAdapter{constructor(a,b){this.list=a;this.control=b||null;a.adapter=this}destroy(){const a=this.list,b=this.control;a&&(zeroObject(this),a.adapter=null,b&&(b.adapter=null))}cleared(){this.control&&this.control.notifyCleared()}itemsChanged(a){this.control&&(this.control.notifyCleared(),this.control.notifyItemsAdded(0,a-1))}itemsAdded(a,b){this.control&&this.control.notifyItemsAdded(a,b)}itemsRemoved(a,b){this.control&&this.control.notifyItemsRemoved(a,b)}currentItemChanged(a,b){this.control&&
this.control.notifyCurrentItemChanged(a,b)}}
class List{constructor(a,b){this.items=a||[];this._currentIndex=void 0===b?-1:b;this._adapter=null;this.modified=!1;this.items.length?(0>this._currentIndex?this._currentIndex=-1:this._currentIndex>=this.items.length&&(this._currentIndex=this.items.length-1),this._currentItem=0<=this._currentIndex?this.items[this._currentIndex]:null):(this._currentIndex=-1,this._currentItem=null)}destroy(){if(this.items){this.items.fill(null);var a=this._adapter;zeroObject(this);a&&a.destroy()}}get adapter(){return this._adapter}set adapter(a){this.items&&
this._adapter!==a&&(this._adapter&&this._adapter.destroy(),this._adapter=a)}get length(){return this.items?this.items.length:0}get currentIndex(){return this._currentItem?this._currentIndex:-1}set currentIndex(a){a>=this.items.length&&(a=this.items.length-1);0>a&&(a=0);const b=a<this.items.length?this.items[a]:null,c=this._currentIndex,d=this._currentItem;this._currentIndex=b?a:-1;if(c!==a||d!==b)this.modified=!0,this._currentItem=b,this._adapter&&this._adapter.currentItemChanged(d?c:-1,this._currentIndex)}get currentItem(){return this._currentItem}item(a){return this.items[a]}estimateSerializedLength(){const a=
this.items;if(!(a&&a[0]&&"estimateSerializedLength"in a[0]))return 0;let b=0;for(let c=a.length-1;0<=c;c--)b+=a[c].estimateSerializedLength();return b+128}serialize(a){const b=this.items,c=b.length;a||(a=new DataWriter(this.estimateSerializedLength()));if(!(b&&b[0]&&"serialize"in b[0]))return a;a.writeUint8(0).writeInt32(c).writeInt32(this._currentIndex);for(let d=0;d<c;d++)b[d].serialize(a);return a}serializeWeb(){const a=this.items,b=a.length,c=Array(b);if(a&&a[0]&&"serializeWeb"in a[0])for(let d=
0;d<b;d++)c[d]=a[d].serializeWeb();return{currentIndex:this._currentIndex,items:c}}moveCurrentToPrevious(){this.currentIndex=this._currentItem?0>=this._currentIndex?this.items.length-1:this._currentIndex-1:this._currentIndex;return this._currentIndex}moveCurrentToNext(){this.currentIndex=this._currentItem?this._currentIndex>=this.items.length-1?0:this._currentIndex+1:this._currentIndex;return this._currentIndex}clear(){const a=this._currentIndex,b=this._currentItem;this.items&&this.items.fill(null);
this.modified=!0;this.items=[];this._currentIndex=-1;this._currentItem=null;this._adapter&&(this._adapter.cleared(),b&&this._adapter.currentItemChanged(a,-1))}changeItems(a){a&&a.length?(this.items&&this.items.fill(null),this.modified=!0,this.items=a.slice(),this._currentIndex=-1,this._currentItem=null,this._adapter&&this._adapter.itemsChanged(a.length)):this.clear()}addItem(a,b){if(!this.items||!a)return-1;void 0===b||0>b||b>=this.items.length?(b=this.items.length,this.items.push(a)):this.items.splice(b,
0,a);this.modified=!0;this._adapter&&this._adapter.itemsAdded(b,b);0<=this._currentIndex&&b<=this._currentIndex&&this._currentIndex++;return b}addItems(a,b){if(!this.items||!a||!a.length)return-1;void 0===b||0>b||b>=this.items.length?(b=this.items.length,this.items.push(...a)):this.items.splice(b,0,...a);this.modified=!0;this._adapter&&this._adapter.itemsAdded(b,b+a.length-1);0<=this._currentIndex&&b<=this._currentIndex&&(this._currentIndex+=a.length);return b}removeItems(a,b){if(!this.items||0>a||
a>=this.items.length)return 0;void 0===b||b>=this.items.length?b=this.items.length-1:b<a&&(b=a);const c=b-a+1;this.items.splice(a,c);this.modified=!0;0<=this._currentIndex&&(b<this._currentIndex?this._currentIndex-=c:a<=this._currentIndex&&this._currentItem&&(this._currentItem=null,this._adapter&&this._adapter.currentItemChanged(this._currentIndex,-1)));this._adapter&&this._adapter.itemsRemoved(a,b);return c}}
class FileSystemAPI{static isSupported(){return"FileSystemHandle"in window&&"showDirectoryPicker"in window}static openDatabase(a,b){return new Promise(function(c,d){function e(g,k){if(f)try{f.close()}catch(h){}k?d(k):c(g)}let f=null;try{const g=indexedDB.open(FileSystemAPI.dbName);g.onupgradeneeded=function(){g.result.createObjectStore(FileSystemAPI.dbStoreName)};g.onsuccess=function(){f=g.result;try{b(f,f.transaction(FileSystemAPI.dbStoreName,a).objectStore(FileSystemAPI.dbStoreName),e)}catch(k){e(null,
k)}};g.onerror=function(){e(null,g.error)}}catch(g){e(null,g)}})}static init(){return FileSystemAPI.openDatabase("readonly",function(a,b,c){const d=b.openCursor();d.onsuccess=function(){const e=d.result;if(e){var f=e.key.toString(),g=e.value;f&&g&&(FileSystemAPI.roots.push([f,g]),FileSystemAPI.directoryHandles.set(f,g));e.continue()}else{const k=Strings.comparer;FileSystemAPI.roots.sort(function(h,m){return k(h[0],m[0])});c()}};d.onerror=function(){c(null,d.error)}})}static async addNewRoot(){try{const a=
await window.showDirectoryPicker();if(a)return await FileSystemAPI.addRoot(a),!0}catch(a){}return!1}static addRoot(a){return a?FileSystemAPI.openDatabase("readwrite",function(b,c,d){c.put(a,a.name);const e=c.transaction;e.onabort=function(){d()};e.oncomplete=function(){const f=FileSystemAPI.roots,g=a.name;let k=!1;for(let h=f.length-1;0<=h;h--)if(f[h][0]===g){f[h][1]=a;k=!0;break}if(!k){const h=Strings.comparer;f.push([g,a]);f.sort(function(m,l){return h(m[0],l[0])})}FileSystemAPI.directoryHandles.set(g,
a);d()};e.onerror=function(){d(null,e.error)}}):Promise.resolve()}static removeRoot(a){return a?FileSystemAPI.openDatabase("readwrite",function(b,c,d){c.delete(a);const e=c.transaction;e.onabort=function(){d()};e.oncomplete=function(){const f=FileSystemAPI.roots;for(let g=f.length-1;0<=g;g--)if(f[g][0]===a){f.splice(g,1);break}d(!0)};e.onerror=function(){d(null,e.error)}}):Promise.resolve(!1)}static getRootHandles(){const a=FileSystemAPI.roots,b=Array(a.length);for(let c=a.length-1;0<=c;c--)b[c]=
a[c][1];return b}static async checkRootPermission(a){if(!a)return 0;var b=a.indexOf("/");0<b&&(a=a.substring(0,b));a=FileSystemAPI.directoryHandles.get(a);if(!a)return 0;try{switch(b={mode:"read"},await a.queryPermission(b)){case "granted":return 1;case "prompt":return"granted"===await a.requestPermission(b)?-1:0;default:return 0}}catch(c){return 0}}static async getDirectoryHandle(a,b){let c=FileSystemAPI.directoryHandles.get(a);if(c)return c;try{const d=a.lastIndexOf("/");if(0>=d||d>=a.length-1)return null;
c=b||await FileSystemAPI.getDirectoryHandle(a.substring(0,d));if(!c)return null;c=await c.getDirectoryHandle(a.substring(d+1));if(!c)return null;FileSystemAPI.directoryHandles.set(a,c);return c}catch(d){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.getDirectoryHandle(a):null}}static async getFile(a,b){try{if(b)return b.getFile();const c=a.lastIndexOf("/");if(0>=c||c>=a.length-1)return null;const d=await FileSystemAPI.getDirectoryHandle(a.substring(0,c));if(!d)return null;const e=
await d.getFileHandle(a.substring(c+1));return e?e.getFile():null}catch(c){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.getFile(a,b):null}}static async enumerate(a,b){var c;try{const g=b||await FileSystemAPI.getDirectoryHandle(a);if(!g)return null;const k=[];try{for(var d=__asyncValues(g.values()),e;e=await d.next(),!e.done;){const h=e.value;("file"!==h.kind||FileUtils.isTypeSupported(h.name))&&k.push(h)}}catch(h){var f={error:h}}finally{try{e&&!e.done&&(c=d.return)&&await c.call(d)}finally{if(f)throw f.error;
}}return k}catch(g){return 0>await FileSystemAPI.checkRootPermission(a)?FileSystemAPI.enumerate(a,b):null}}}FileSystemAPI.dbName="fplay";FileSystemAPI.dbStoreName="fplay-roots";FileSystemAPI.roots=[];FileSystemAPI.directoryHandles=new Map;
class FilePickerFileSystemAPIProvider{constructor(){this.version=0}editableRoots(){return!0}addNewRoot(){return FileSystemAPI.addNewRoot()}removeRoot(a){return FileSystemAPI.removeRoot(a.name)}async getDirectoryFiles(a,b,c,d){if((d=await FileSystemAPI.enumerate(c,d))&&a===this.version){var e=Strings.comparer;d.sort(function(g,k){return g.kind===k.kind?e(g.name,k.name):"file"===g.kind?1:-1});c.endsWith("/")||(c+="/");for(let g=0;g<d.length&&a===this.version;g++){var f=d[g];const k=c+f.name;if("file"===
f.kind){if(f=await FileSystemAPI.getFile(k,d[g]))f["data-path"]=FileUtils.localURLPrefix+k,b.push(f)}else await this.getDirectoryFiles(a,b,k,f)}}}async getFiles(a,b){this.cancel();const c=[],d=this.version;if(a)for(var e=0;e<a.length&&d===this.version;e++)await this.getDirectoryFiles(d,c,a[e].path,a[e].handle);if(b)for(a=0;a<b.length&&d===this.version;a++){e=b[a].path;const f=await FileSystemAPI.getFile(e,b[a].handle);f&&(f["data-path"]=FileUtils.localURLPrefix+e,c.push(f))}return c}async navigate(a){this.cancel();
if(!a){a=FileSystemAPI.getRootHandles();var b=Array(a.length);for(var c=a.length-1;0<=c;c--)b[c]={name:a[c].name,dir:1,path:a[c].name,root:!0,deletable:!0,handle:a[c]};return b}c=this.version;b=await FileSystemAPI.enumerate(a);if(!b||!b.length||c!==this.version)return null;a.endsWith("/")||(a+="/");c=Array(b.length);for(let e=b.length-1;0<=e;e--)c[e]={name:b[e].name,dir:"file"===b[e].kind?0:1,path:a+b[e].name,handle:b[e]};const d=Strings.comparer;c.sort(function(e,f){return e.dir===f.dir?d(e.name,
f.name):f.dir-e.dir});return c}cancel(){this.version++}destroy(){this.cancel()}}
class FilePickerAndroidProvider{constructor(){this.enumerationVersion=this.version=0}static callbackPermission(a){FilePickerAndroidProvider.permissionGranted=!!a;FilePickerAndroidProvider.callbackPermissionResolve&&(FilePickerAndroidProvider.callbackPermissionResolve(FilePickerAndroidProvider.permissionGranted),FilePickerAndroidProvider.callbackPermissionResolve=null)}static callbackClickDone(){FilePickerAndroidProvider.callbackClickDoneResolve&&(FilePickerAndroidProvider.callbackClickDoneResolve(),
FilePickerAndroidProvider.callbackClickDoneResolve=null)}static checkPermission(){FilePickerAndroidProvider.callbackPermissionResolve&&(FilePickerAndroidProvider.callbackPermissionResolve(!1),FilePickerAndroidProvider.callbackPermissionResolve=null);return App.hostInterface?App.hostInterface.checkFilePermission()?(FilePickerAndroidProvider.permissionGranted=!0,Promise.resolve(!0)):new Promise(function(a){App.hostInterface?(FilePickerAndroidProvider.callbackPermissionResolve=a,App.hostInterface.requestFilePermission()):
a(!1)}):Promise.resolve(!1)}editableRoots(){return!1}addNewRoot(){return Promise.resolve(!1)}removeRoot(a){return Promise.resolve(!1)}enumerate(a){this.enumerationVersion++;FilePickerAndroidProvider.callback&&(FilePickerAndroidProvider.callback(0,null),FilePickerAndroidProvider.callback=null);return new Promise(b=>{if(!App.hostInterface)return null;FilePickerAndroidProvider.callback=(c,d)=>{c!==this.enumerationVersion?b(null):(FilePickerAndroidProvider.callback=null,b(d))};App.hostInterface.enumerateFiles(this.enumerationVersion,
a)})}async getDirectoryFiles(a,b,c){if((c=await this.enumerate(c))&&a===this.version){var d=Strings.comparer;c.sort(function(e,f){const g=47===e.charCodeAt(0),k=47===f.charCodeAt(0);return g===k?d(e,f):g?1:-1});for(let e=0;e<c.length&&a===this.version;e++){const f=c[e];47===f.charCodeAt(0)?b.push(f):await this.getDirectoryFiles(a,b,f)}}}async getFiles(a,b){this.cancel();const c=[];var d=this.version,e=new Promise(function(g){FilePickerAndroidProvider.callbackClickDoneResolve=g}),f=App.showOpenDialogWeb(!1,
!0);await e;if(!App.hostInterface||d!==this.version)return null;if(a)for(e=0;e<a.length&&d===this.version;e++)await this.getDirectoryFiles(d,c,a[e].path);if(b&&d===this.version)for(a=0;a<b.length;a++)c.push(b[a].path);if(!App.hostInterface||!c.length)return null;for(b=c.length-1;0<=b;b--)c[b]=FileUtils.pathToURL(c[b]);App.hostInterface.setFileURLs(c);f=await f;if(!f||f.length!==c.length||d!==this.version)return null;for(d=c.length-1;0<=d;d--)f[d]["data-path"]=c[d];return f}async navigate(a){this.cancel();
var b=this.version;if(!FilePickerAndroidProvider.permissionGranted&&!await FilePickerAndroidProvider.checkPermission()||b!==this.version)return null;const c=await this.enumerate(a);if(!c||!c.length||b!==this.version)return null;b=Array(c.length);if(a)for(a=b.length-1;0<=a;a--){var d=c[a];b[a]={name:FileUtils.nameFromLinuxPath(d),dir:47===d.charCodeAt(0)?0:1,path:d}}else for(a=b.length-1;0<=a;a--){d=c[a];const f=d.indexOf(FileUtils.separator);b[a]={name:0<f?d.substring(0,f):Formatter.none,dir:1,path:0<
f?d.substring(f+1):d,root:!0}}const e=Strings.comparer;b.sort(function(f,g){return f.dir===g.dir?e(f.name,g.name):g.dir-f.dir});return b}cancel(){this.version++;this.enumerationVersion++;FilePickerAndroidProvider.callbackClickDone()}destroy(){this.cancel();App.hostInterface&&App.hostInterface.cancelFileEnumeration(this.enumerationVersion)}}FilePickerAndroidProvider.callback=null;FilePickerAndroidProvider.callbackPermissionResolve=null;FilePickerAndroidProvider.callbackClickDoneResolve=null;
FilePickerAndroidProvider.permissionGranted=!1;
class Song{constructor(a,b,c,d,e,f,g,k,h){if("string"!==typeof a){h=a;a=h.url;b=h.title;c=h.artist;d=h.album;e=h.track;f=h.lengthMS;g=h.year;if(h.file){if(!a||a.startsWith(FileUtils.localURLPrefix))this.file=h.file;b||(b=h.file.name.lastIndexOf("."),b=0<b?h.file.name.substring(0,b):h.file.name)}k=h.fileName;h=h.fileSize}this.url=a;this.isHttp=Song.isPathHttp(this.url);if(!b){a=decodeURI(a);let m=a.lastIndexOf("/");b=0<=m?a.substring(m+1):a;this.isHttp||(m=b.lastIndexOf("."),0<m&&(b=b.substring(0,
m)))}this.title=b||Formatter.none;this.artist=c||Formatter.none;this.album=d||Formatter.none;this.track=e&&0<e?e:Formatter.noneInt;this.lengthMS=f&&0<f?f:Formatter.noneInt;this.year=g&&0<g?g:Formatter.noneInt;this.length=Formatter.formatTimeMS(this.lengthMS);this.fileName=k||null;this.fileSize=h||0}static isPathHttp(a){return a.startsWith("http:")||a.startsWith("https:")||a.startsWith("icy:")}static deserialize(a){a.readUint8();a.readInt32();return new Song(a.readString(),a.readString(),a.readString(),
a.readString(),a.readInt16(),a.readInt32(),a.readInt16(),a.readString(),a.readInt32())}estimateSerializedLength(){return(this.url.length+this.title.length+this.artist.length+this.album.length+(this.fileName?this.fileName.length:0)<<1)+17}serialize(a){return a.writeUint8(0).writeInt32(0).writeString(this.url).writeString(this.title).writeString(this.artist).writeString(this.album).writeInt16(this.track).writeInt32(this.lengthMS).writeInt16(this.year).writeString(this.fileName||null).writeInt32(this.fileSize||
0)}serializeWeb(){return{url:this.url,title:this.title,artist:this.artist,album:this.album,track:this.track,lengthMS:this.lengthMS,year:this.year,fileName:this.fileName,fileSize:this.fileSize}}}
class PlaylistAdapter extends ListAdapter{constructor(a){super(a)}get itemHeight(){return AppUI.playlistItemSizePX}createEmptyElement(a){const b=document.createElement("div");b.className=a+" playlist-item";b.appendChild(Icon.create("icon-title","pink margin"));b.appendChild(document.createTextNode(Formatter.none));b.appendChild(document.createElement("br"));b.appendChild(Icon.create("icon-artist","orange margin"));a=document.createElement("span");Strings.changeText(a,Formatter.none);b.appendChild(a);
b.appendChild(document.createElement("br"));a=document.createElement("span");a.className="length";Strings.changeText(a,Formatter.none);b.appendChild(a);a=document.createElement("span");a.className="float-right";Strings.changeText(a,Formatter.none);b.appendChild(a);return b}prepareElement(a,b,c,d){d=d.childNodes;d[1].nodeValue=a.title;d[4].firstChild.nodeValue=a.artist;d[6].firstChild.nodeValue=a.length;d[7].firstChild.nodeValue=a.url||a.file?`${b+1} / ${c}`:`(${Strings.Missing}) ${b+1} / ${c}`}prepareElementIndexOrLengthChanged(a,
b,c,d){d.childNodes[7].firstChild.nodeValue=a.url||a.file?`${b+1} / ${c}`:`(${Strings.Missing}) ${b+1} / ${c}`}}
class Playlist extends List{constructor(a,b,c){super(a,b);this.missingSongs=c||null;this.onsonglengthchanged=null}static deserialize(a){a.readUint8();const b=a.readInt32(),c=a.readInt32(),d=Array(b);for(let e=0;e<b;e++)d[e]=Song.deserialize(a);return new Playlist(d,c)}static deserializeWeb(a){try{const b=JSON.parse(a);if(!b||!b.items||!b.items.length)return null;const c=b.items,d=c.length,e=Array(d),f=new Map;for(a=0;a<d;a++){const g=new Song(c[a]);e[a]=g;!g.url&&g.fileName&&f.set(g.fileName+g.fileSize,
g)}return new Playlist(e,b.currentIndex||0,f.size?f:null)}catch(b){return null}}songLengthChanged(a,b){if(0>=b||isNaN(b)||!isFinite(b)){if(0>a.lengthMS)return;b=-1}else{if(0<=a.lengthMS&&(a.lengthMS/1E3|0)===(b|0))return;b=1E3*b|0}this.modified=!0;a.lengthMS=b;a.length=Formatter.formatTimeMS(b);if(this.onsonglengthchanged)this.onsonglengthchanged(a)}clear(){this.missingSongs&&(this.missingSongs.clear(),this.missingSongs=null);super.clear()}changeItems(a){this.missingSongs&&(this.missingSongs.clear(),
this.missingSongs=null);super.changeItems(a)}removeItems(a,b){if(this.missingSongs&&this.items&&0<=a&&a<this.items.length){const c=this.missingSongs,d=this.items;void 0===b||b>=d.length?b=d.length-1:b<a&&(b=a);for(let e=a;e<=b;e++){const f=d[e];if(!f.url&&!f.file&&f.fileName&&(c.delete(f.fileName+f.fileSize),!c.size)){this.missingSongs=null;break}}}return super.removeItems(a,b)}async addSong(a,b){let c,d=0;"string"!==typeof a?(c=a.fileURL,d=a.fileSize):c=a;if(!FileUtils.isTypeSupported(c))return!1;
a=await App.extractMetadata(c,d);if(!a)return!1;super.addItem(new Song(a),b);return!0}async addSongWeb(a,b,c,d){if(!FileUtils.isTypeSupported(a.name))return!1;if(this.missingSongs){const e=a.name+a.size,f=this.missingSongs.get(e);if(f)return f.file=a,this.missingSongs.delete(e),this.missingSongs.size||(this.missingSongs=null),!0}a=await MetadataExtractor.extract(a,b,c);if(!a)return!1;super.addItem(new Song(a),d);return!0}}
class PointerHandler{constructor(a,b=null,c=null,d=null,e=!0,f=null){this.documentTarget=document.documentElement||document.body;this.element=a;this.downCallback=b;this.moveCallback=c;this.upCallback=d;this.boundExtraTouchStart=null;"onpointerdown"in a?(this.documentDownEvent="pointerdown",this.documentMoveEvent="pointermove",this.documentUpEvent="pointerup",this.documentCancelEvent="pointercancel",this.boundDocumentDown=this.pointerDown.bind(this),this.boundDocumentUp=this.pointerUp.bind(this),this.boundDocumentMove=
this.pointerMove.bind(this),"ontouchstart"in a&&(this.boundExtraTouchStart=this.extraTouchStart.bind(this))):"ontouchstart"in a?(this.documentDownEvent="touchstart",this.documentMoveEvent="touchmove",this.documentUpEvent="touchend",this.documentCancelEvent="touchcancel",this.boundDocumentDown=this.touchStart.bind(this),this.boundDocumentUp=this.touchEnd.bind(this),this.boundDocumentMove=this.touchMove.bind(this)):(this.documentDownEvent="mousedown",this.documentMoveEvent="mousemove",this.documentUpEvent=
"mouseup",this.documentCancelEvent=null,this.boundDocumentDown=this.mouseDown.bind(this),this.boundDocumentUp=this.mouseUp.bind(this),this.boundDocumentMove=this.mouseMove.bind(this));this.lazy=e;this.outsidePointerHandler=f;this.boundExtraTouchStart&&a.addEventListener("touchstart",this.boundExtraTouchStart);a.addEventListener(this.documentDownEvent,this.boundDocumentDown);e||this.addSecondaryHandlers();this._captured=!1;this.pointerId=-1}destroy(){this.element&&(this.boundExtraTouchStart&&this.element.removeEventListener("touchstart",
this.boundExtraTouchStart),this.boundDocumentDown&&this.element.removeEventListener(this.documentDownEvent,this.boundDocumentDown));this.removeSecondaryHandlers();this.mouseUp({});zeroObject(this)}get captured(){return this._captured}addSecondaryHandlers(){this.documentTarget&&(this.documentTarget.addEventListener(this.documentMoveEvent,this.boundDocumentMove,{capture:!0,passive:!1}),this.documentTarget.addEventListener(this.documentUpEvent,this.boundDocumentUp,!0),this.documentCancelEvent&&this.documentTarget.addEventListener(this.documentCancelEvent,
this.boundDocumentUp,!0))}removeSecondaryHandlers(){this.documentTarget&&(this.boundDocumentUp&&(this.documentTarget.removeEventListener(this.documentUpEvent,this.boundDocumentUp,!0),this.documentCancelEvent&&this.documentTarget.removeEventListener(this.documentCancelEvent,this.boundDocumentUp,!0)),this.boundDocumentMove&&this.documentTarget.removeEventListener(this.documentMoveEvent,this.boundDocumentMove,!0))}extraTouchStart(a){if(a.target===this.element||this.outsidePointerHandler&&this.outsidePointerHandler(a))return cancelEvent(a)}pointerDown(a){if(0<=
this.pointerId&&"mouse"!==a.pointerType)return cancelEvent(a);const b=this.mouseDown(a);this._captured&&(this.pointerId=a.pointerId);return b}pointerMove(a){if(this._captured&&a.pointerId===this.pointerId)return this.mouseMove(a)}pointerUp(a){if(this._captured&&a.pointerId===this.pointerId)return this.pointerId=-1,this.mouseUp(a)}touchStart(a){if(!(1<a.touches.length))return 0<=this.pointerId&&this.touchEnd(a),this.pointerId=1,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a=this.mouseDown(a),
void 0===a&&(this.pointerId=-1),a}touchMove(a){if(this._captured&&!(1<a.touches.length))return a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,this.mouseMove(a)}touchEnd(a){if(this._captured&&!(0>this.pointerId))return this.pointerId=-1,this.mouseUp(a)}mouseDown(a){this.mouseUp(a);if(!a.button&&(!a.target||a.target===this.element||this.outsidePointerHandler&&this.outsidePointerHandler(a))){if(this.downCallback&&!this.downCallback(a))return cancelEvent(a);this._captured=!0;this.lazy&&
this.addSecondaryHandlers();return cancelEvent(a)}}mouseMove(a){if(this._captured)return this.moveCallback&&this.moveCallback(a),cancelEvent(a)}mouseUp(a){if(this._captured)return this._captured=!1,this.lazy&&this.removeSecondaryHandlers(),this.upCallback&&this.upCallback(a),cancelEvent(a)}}
class GraphicalFilterEditorStrings{static toFixed(a,b){return a.toFixed(b)}static init(a){a&&0===a.toLowerCase().indexOf("pt")&&(GraphicalFilterEditorStrings.Minus0="-0,00",GraphicalFilterEditorStrings.Curve="Curva: ",GraphicalFilterEditorStrings.Frequency="Frequ\u00eancia: ",GraphicalFilterEditorStrings.SameCurve="Mesma curva para ambos canais",GraphicalFilterEditorStrings.UseLeftCurve="Usar curva da esquerda",GraphicalFilterEditorStrings.UseRightCurve="Usar curva da direita",GraphicalFilterEditorStrings.OneForEach=
"Uma curva por canal",GraphicalFilterEditorStrings.ShowLeftCurve="Exibir curva da esquerda",GraphicalFilterEditorStrings.ShowRightCurve="Exibir curva da direita",GraphicalFilterEditorStrings.ResetCurve="Zerar curva",GraphicalFilterEditorStrings.EditMode="Modo de edi\u00e7\u00e3o",GraphicalFilterEditorStrings.Regular="Normal",GraphicalFilterEditorStrings.Zones="Zonas",GraphicalFilterEditorStrings.SmoothNarrow="Suave (estreito)",GraphicalFilterEditorStrings.SmoothWide="Suave (largo)",GraphicalFilterEditorStrings.PeakingEq=
'Filtro "Peaking" de 10 Bandas',GraphicalFilterEditorStrings.ShelfEq='Filtro "Low Shelf" de 7 Bandas',GraphicalFilterEditorStrings.NormalizeCurves="Normalizar curvas",GraphicalFilterEditorStrings.ShowZones="Exibir zonas",GraphicalFilterEditorStrings.ShowActualResponse="Exibir resposta real",GraphicalFilterEditorStrings.toFixed=function(b,c){return b.toFixed(c).replace(".",",")})}}GraphicalFilterEditorStrings.Minus0="-0.00";GraphicalFilterEditorStrings.Cursor="Cursor: ";
GraphicalFilterEditorStrings.Curve="Curve: ";GraphicalFilterEditorStrings.Frequency="Frequency: ";GraphicalFilterEditorStrings.SameCurve="Same curve for both channels";GraphicalFilterEditorStrings.UseLeftCurve="Use left curve";GraphicalFilterEditorStrings.UseRightCurve="Use right curve";GraphicalFilterEditorStrings.OneForEach="One curve for each channel";GraphicalFilterEditorStrings.ShowLeftCurve="Show left curve";GraphicalFilterEditorStrings.ShowRightCurve="Show right curve";
GraphicalFilterEditorStrings.ResetCurve="Reset curve";GraphicalFilterEditorStrings.EditMode="Edit mode";GraphicalFilterEditorStrings.Regular="Regular";GraphicalFilterEditorStrings.Zones="Zones";GraphicalFilterEditorStrings.SmoothNarrow="Smooth (narrow)";GraphicalFilterEditorStrings.SmoothWide="Smooth (wide)";GraphicalFilterEditorStrings.PeakingEq="10-band Peaking Filter";GraphicalFilterEditorStrings.ShelfEq="7-band Low Shelf Filter";GraphicalFilterEditorStrings.NormalizeCurves="Normalize curves";
GraphicalFilterEditorStrings.ShowZones="Show zones";GraphicalFilterEditorStrings.ShowActualResponse="Show actual response";GraphicalFilterEditorStrings.MinusInfinity="-Inf.";var GraphicalFilterEditorIIRType;(function(a){a[a.None=0]="None";a[a.Peaking=1]="Peaking";a[a.Shelf=2]="Shelf"})(GraphicalFilterEditorIIRType||(GraphicalFilterEditorIIRType={}));
class Filter{constructor(a){this.source=null;this.filterChangedCallback=a}connectSourceAndDestination(a,b){a=this.connectSourceToInput(a);return this.connectOutputToDestination(b)&&a}disconnectSourceAndDestination(){const a=this.disconnectSourceFromInput();return this.disconnectOutputFromDestination()&&a}disconnectSourceFromInput(){return this.source?(this.source.disconnect(),this.source=null,!0):!1}connectSourceToInput(a){this.disconnectSourceFromInput();if(this.source=a){a.disconnect();const b=
this.inputNode;if(b)return a.connect(b,0,0),!0}return!1}connectOutputToDestination(a){const b=this.outputNode;return b?(b.disconnect(),a&&b.connect(a,0,0),!0):!1}disconnectOutputFromDestination(){const a=this.outputNode;return a?(a.disconnect(),!0):!1}destroy(){this.disconnectSourceFromInput();this.disconnectOutputFromDestination()}}
class GraphicalFilterEditor extends Filter{constructor(a,b,c,d){super(c);if(8>a||a&a-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this.filterLength=a;this._sampleRate=b.sampleRate?b.sampleRate:44100;this._isNormalized=!1;this._iirType=(this.iirSupported="createBiquadFilter"in b&&"createIIRFilter"in b)&&d||GraphicalFilterEditorIIRType.None;this.binCount=(a>>>1)+1;this.filterKernel=b.createBuffer(2,a,this._sampleRate);this.audioContext=b;this.editorPtr=cLib._graphicalFilterEditorAlloc(this.filterLength,
this._sampleRate);a=cLib.HEAP8.buffer;this.filterKernelBuffer=new Float32Array(a,cLib._graphicalFilterEditorGetFilterKernelBuffer(this.editorPtr),GraphicalFilterEditor.maximumFilterLength);this.channelCurves=[new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this.editorPtr,0),GraphicalFilterEditor.visibleBinCount),new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this.editorPtr,1),GraphicalFilterEditor.visibleBinCount)];this.actualChannelCurve=new Int32Array(a,cLib._graphicalFilterEditorGetActualChannelCurve(this.editorPtr),
GraphicalFilterEditor.visibleBinCount);this.visibleFrequencies=new Float64Array(a,cLib._graphicalFilterEditorGetVisibleFrequencies(this.editorPtr),GraphicalFilterEditor.visibleBinCount);this.equivalentZones=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZones(this.editorPtr),GraphicalFilterEditor.equivalentZoneCount);this.equivalentZonesFrequencyCount=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZonesFrequencyCount(this.editorPtr),GraphicalFilterEditor.equivalentZoneCount+1);
this.curveSnapshot=this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterActualGains=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=this.biquadFilters=this._convolver=null;this.updateFilter(0,!0,!0);this.updateActualChannelCurve(0);this.updateBuffer();this.filterChangedCallback=c}static encodeCurve(a){const b=GraphicalFilterEditor.minimumChannelValueY,c=GraphicalFilterEditor.validYRangeHeight,
d=a.length,e=Array(d<<1);let f=0;for(let g=0;g<d;g++){let k=a[g];k=k>b?0:c-k;254>=k?e[f++]=k:(e[f++]=255,e[f++]=k-254)}e.splice(f);return btoa(String.fromCharCode(...e))}static decodeCurve(a){if(!a||a.length<4*GraphicalFilterEditor.visibleBinCount/3)return null;try{a=atob(a)}catch(f){return null}if(a.length<GraphicalFilterEditor.visibleBinCount)return null;const b=GraphicalFilterEditor.validYRangeHeight,c=a.length,d=Array(GraphicalFilterEditor.visibleBinCount);let e=0;for(let f=0;f<c;f++){const g=
a.charCodeAt(f);254>=g?d[e++]=b-g:f<c-1&&(f++,d[e++]=b-(a.charCodeAt(f)+254))}return d}get sampleRate(){return this._sampleRate}get isNormalized(){return this._isNormalized}get iirType(){return this._iirType}get convolver(){return this._convolver}get inputNode(){return this.biquadFilterInput||this._convolver}get outputNode(){return this.biquadFilterOutput||this._convolver}destroy(){this.editorPtr&&(super.destroy(),cLib._graphicalFilterEditorFree(this.editorPtr),zeroObject(this))}clampX(a){return 0>=
a?0:a>=GraphicalFilterEditor.visibleBinCount?GraphicalFilterEditor.visibleBinCount-1:a}clampY(a){return a<=GraphicalFilterEditor.maximumChannelValueY?GraphicalFilterEditor.maximumChannelValueY:a>GraphicalFilterEditor.minimumChannelValueY?GraphicalFilterEditor.validYRangeHeight+1:a}dBToMagnitude(a){return Math.pow(10,a/20)}yToDB(a){return a<=GraphicalFilterEditor.maximumChannelValueY?40:a>GraphicalFilterEditor.minimumChannelValueY?-Infinity:lerp(GraphicalFilterEditor.maximumChannelValueY,40,GraphicalFilterEditor.minimumChannelValueY,
-40,a)}yToMagnitude(a){return a<=GraphicalFilterEditor.maximumChannelValueY?100:a>GraphicalFilterEditor.minimumChannelValueY?0:Math.exp(lerp(GraphicalFilterEditor.maximumChannelValueY,2,GraphicalFilterEditor.minimumChannelValueY,-2,a)*Math.LN10)}magnitudeToY(a){return 100<=a?GraphicalFilterEditor.maximumChannelValueY:.009>a?GraphicalFilterEditor.validYRangeHeight+1:Math.round(GraphicalFilterEditor.zeroChannelValueY-GraphicalFilterEditor.zeroChannelValueY*Math.log(a)/Math.LN10*.5-.4)}visibleBinToZoneIndex(a){if(a>=
GraphicalFilterEditor.visibleBinCount-1)return this.equivalentZones.length-1;if(0<a){const b=this.equivalentZonesFrequencyCount;for(let c=b.length-1;0<=c;c--)if(a>=b[c])return c}return 0}visibleBinToFrequency(a,b){const c=this.equivalentZones,d=this.visibleFrequencies;var e=GraphicalFilterEditor.visibleBinCount;if(a>=e-1)return b?[d[e-1],c[c.length-1]]:d[e-1];if(0<a)if(b){e=this.equivalentZonesFrequencyCount;for(let f=e.length-1;0<=f;f--)if(a>=e[f])return[d[a],c[f]]}else return d[a];return b?[d[0],
c[0]]:d[0]}getZoneY(a,b){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[b]]}changeZoneY(a,b,c){b=this.visibleBinToZoneIndex(b);const d=this.equivalentZonesFrequencyCount[b+1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeZoneYByIndex(a,b,c){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);const d=this.equivalentZonesFrequencyCount[b+
1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeShelfZoneYByRegularIndex(a,b,c){switch(b){case 0:case 1:this.changeZoneYByIndex(a,0,c);this.changeZoneYByIndex(a,1,c);break;case 4:case 5:this.changeZoneYByIndex(a,4,c);this.changeZoneYByIndex(a,5,c);break;case 6:case 7:this.changeZoneYByIndex(a,6,c);this.changeZoneYByIndex(a,7,c);break;default:this.changeZoneYByIndex(a,b,c)}}getShelfZoneY(a,b){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&
(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[GraphicalFilterEditor.shelfEquivalentZones[b]]]}changeShelfZoneY(a,b,c){this.changeShelfZoneYByRegularIndex(a,this.visibleBinToZoneIndex(b),c)}changeShelfZoneYByIndex(a,b,c){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);this.changeShelfZoneYByRegularIndex(a,GraphicalFilterEditor.shelfEquivalentZones[b],c)}startSmoothEdition(a){this.curveSnapshot||
(this.curveSnapshot=new Int32Array(GraphicalFilterEditor.visibleBinCount));this.curveSnapshot.set(this.channelCurves[a])}changeSmoothY(a,b,c,d){var e=this.curveSnapshot;if(e){var f=GraphicalFilterEditor.visibleBinCount;c=this.clampY(c);a=this.channelCurves[a];a.set(e);d>>=1;for(let g=b-d,k=Math.min(b,f),h=Math.max(0,g);h<k;h++)e=512*smoothStep(g,b,h)|0,a[h]=this.clampY(Math.round((c*e+a[h]*(512-e))/512));for(let g=b+d,k=Math.min(g,f),h=Math.max(0,b);h<k;h++)d=512*smoothStep(g,b,h)|0,a[h]=this.clampY(Math.round((c*
d+a[h]*(512-d))/512))}}updateBuffer(){const a=this._convolver;this._convolver||(this._convolver=this.audioContext.createConvolver(),this._convolver.normalize=!1);this._convolver.buffer=this.filterKernel;!a&&this.filterChangedCallback&&this.filterChangedCallback()}copyToChannel(a,b){if(this.filterKernel.copyToChannel)this.filterKernel.copyToChannel(a,b);else{b=this.filterKernel.getChannelData(b);for(let c=this.filterLength-1;0<=c;c--)b[c]=a[c]}}copyFromChannel(a,b){if(this.filterKernel.copyToChannel)this.filterKernel.copyFromChannel(a,
b);else{b=this.filterKernel.getChannelData(b);for(let c=this.filterLength-1;0<=c;c--)a[c]=b[c]}}copyFilter(a,b){this.copyToChannel(this.filterKernel.getChannelData(a),b);this.updateBuffer()}updateFilter(a,b,c){switch(this._iirType){case GraphicalFilterEditorIIRType.Peaking:this.updatePeakingEq(a);return;case GraphicalFilterEditorIIRType.Shelf:this.updateShelfEq(a);return}cLib._graphicalFilterEditorUpdateFilter(this.editorPtr,a,this._isNormalized);this.copyToChannel(this.filterKernelBuffer,a);b?this.copyFilter(a,
1-a):c?this.updateFilter(1-a,!1,!1):this.updateBuffer()}updateActualChannelCurve(a){this._iirType?this.updateActualChannelCurveIIR():(this.copyFromChannel(this.filterKernelBuffer,a),cLib._graphicalFilterEditorUpdateActualChannelCurve(this.editorPtr,a))}updatePeakingEq(a){var b=this.audioContext;const c=this.channelCurves[a],d=this.equivalentZones,e=this.equivalentZonesFrequencyCount;a=GraphicalFilterEditor.equivalentZoneCount;let f=this.biquadFilters,g=this.biquadFilterGains,k=!1;if(!f||!g){k=!0;
f=Array(a);g=Array(a);const l=Array(a);var h=.5*Math.log(2),m=this.audioContext.sampleRate;const n=2*Math.PI;for(let p=a-1;0<=p;p--){const r=n*d[p]/m;l[p]=1/(2*Math.sinh(r/Math.sin(r)*h))}for(h=a-1;0<=h;h--)m=b.createBiquadFilter(),m.type="peaking",m.frequency.value=d[h],m.Q.value=l[h],f[h]=m,h<a-1&&f[h+1].connect(f[h]);this.biquadFilters=f;this.biquadFilterInput=f[a-1];this.biquadFilterOutput=f[0]}for(b=a-1;0<=b;b--)g[b]=Math.max(-40,this.yToDB(c[e[b]]));for(b=a-1;0<=b;b--)f[b].gain.value=g[b]+(b<
a-1?-.15*g[b+1]:0)+(0<b?-.15*g[b-1]:0);k&&this.filterChangedCallback&&this.filterChangedCallback()}updateShelfEq(a){var b=this.audioContext,c=this.channelCurves[a],d=this.equivalentZonesFrequencyCount,e=GraphicalFilterEditor.shelfEquivalentZoneCount,f=GraphicalFilterEditor.shelfEquivalentZones;a=this.biquadFilters;let g=this.biquadFilterGains,k=this.biquadFilterActualGains;a&&g&&k||(a=Array(e),g=Array(e),k=Array(e),this.biquadFilters=a,this.biquadFilterGains=g,this.biquadFilterActualGains=k,a[e-1]=
b.createGain(),this.biquadFilterInput=a[e-1]);for(b=e-1;0<=b;b--)g[b]=Math.max(-40,this.yToDB(c[d[f[b]]]));--e;b=0;c=!1;d=a[e];d.gain.value=this.dBToMagnitude(g[e]);for(--e;0<=e;e--)f=b+(g[e]-g[e+1]),-22>f?(b=f+22,f=-22):22<f?(b=f-22,f=22):b=0,k[e]!==f?(c=!0,k[e]=f,a[e]&&a[e].disconnect(),d.disconnect(),f?(a[e]=this.createIIRFilter(e,f),d.connect(a[e]),d=a[e]):a[e]=null):a[e]&&(c&&(c=!1,d.connect(a[e])),d=a[e]);this.biquadFilterOutput!==d&&(this.biquadFilterOutput=d,this.filterChangedCallback&&this.filterChangedCallback())}createIIRFilter(a,
b){const c=this.audioContext;var d=c.sampleRate;switch(a){case 0:a=92.75;break;case 1:a=187.5;break;case 2:a=375;break;case 3:a=1500;break;case 4:a=6E3;break;default:a=12E3}b=Math.pow(10,b/40);a=6.283185307179586*a/d;d=Math.cos(a);a=1*Math.sqrt(b)*Math.sin(a)*Math.sqrt(-.5*(b+1/b)+2);return c.createIIRFilter([b*(b+1-(b-1)*d+a),2*b*(b-1-(b+1)*d),b*(b+1-(b-1)*d-a)],[b+1+(b-1)*d+a,-2*(b-1+(b+1)*d),b+1+(b-1)*d-a])}updateActualChannelCurveIIR(){var a=this.biquadFilters;if(a){var b=this.biquadFilterActualFrequencies,
c=this.biquadFilterActualAccum,d=this.biquadFilterActualMag,e=this.biquadFilterActualPhase;if(!(b&&c&&d&&e)){e=this.visibleFrequencies;b=new Float32Array(e.length);for(c=e.length-1;0<=c;c--)b[c]=e[c];c=new Float32Array(e.length);d=new Float32Array(e.length);e=new Float32Array(e.length);this.biquadFilterActualFrequencies=b;this.biquadFilterActualAccum=c;this.biquadFilterActualMag=d;this.biquadFilterActualPhase=e}var f=b.length;if(this._iirType===GraphicalFilterEditorIIRType.Shelf)c.fill(a[a.length-
1].gain.value);else{a[a.length-1].getFrequencyResponse(b,c,e);for(var g=f-1,k=1;0<=g&&isNaN(k=c[g]);)g--;for(g++;g<f;)c[g++]=k}for(g=a.length-2;0<=g;g--)if(a[g]){a[g].getFrequencyResponse(b,d,e);for(let h=0,m=0;h<f;h++)k=d[h],isNaN(k)||(m=k),c[h]*=m}a=this.actualChannelCurve;b=this.magnitudeToY;for(d=a.length-1;0<=d;d--)a[d]=b(c[d])}}changeFilterLength(a,b,c){return this.filterLength!==a?(this.filterLength=a,this.binCount=(a>>>1)+1,this.filterKernel=this.audioContext.createBuffer(2,a,this._sampleRate),
cLib._graphicalFilterEditorChangeFilterLength(this.editorPtr,a),this.updateFilter(b,c,!0),!0):!1}changeSampleRate(a,b,c){return this._sampleRate!==a?(this._sampleRate=a,this.filterKernel=this.audioContext.createBuffer(2,this.filterLength,a),this.updateFilter(b,c,!0),!0):!1}changeIsNormalized(a,b,c){return!this._isNormalized!==!a?(this._isNormalized=!!a,this.updateFilter(b,c,!0),!0):!1}changeIIRType(a,b,c){if(this._iirType!==a&&this.iirSupported){this._iirType=a;this.disconnectOutputFromDestination();
this._convolver=null;if(a=this.biquadFilters){for(let d=a.length-1;0<=d;d--)a[d]&&a[d].disconnect();a.fill(null);this.biquadFilters=null}this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=null;this.updateFilter(b,c,!0);return!0}return!1}changeAudioContext(a,b,c){if(this.audioContext!==a){this.disconnectOutputFromDestination();this._convolver=null;const d=this.biquadFilters;
if(d){for(let e=d.length-1;0<=e;e--)d[e]&&d[e].disconnect();d.fill(null);this.biquadFilters=null}this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=null;this.audioContext=a;this._sampleRate=a.sampleRate?a.sampleRate:44100;this.filterKernel=a.createBuffer(2,this.filterLength,this._sampleRate);this.updateFilter(b,c,!0);this.updateBuffer();return!0}return!1}}
GraphicalFilterEditor.visibleBinCount=500;GraphicalFilterEditor.validYRangeHeight=321;GraphicalFilterEditor.zeroChannelValueY=GraphicalFilterEditor.validYRangeHeight>>>1;GraphicalFilterEditor.maximumChannelValue=GraphicalFilterEditor.zeroChannelValueY;GraphicalFilterEditor.minimumChannelValue=-GraphicalFilterEditor.zeroChannelValueY;GraphicalFilterEditor.minusInfiniteChannelValue=GraphicalFilterEditor.minimumChannelValue-1;GraphicalFilterEditor.maximumChannelValueY=0;
GraphicalFilterEditor.minimumChannelValueY=GraphicalFilterEditor.validYRangeHeight-1;GraphicalFilterEditor.maximumFilterLength=8192;GraphicalFilterEditor.equivalentZoneCount=10;GraphicalFilterEditor.shelfEquivalentZoneCount=7;GraphicalFilterEditor.shelfEquivalentZones=[0,2,3,4,6,8,9];class GraphicalFilterEditorRenderer{constructor(a,b,c){this.element=a;this.leftMargin=b;this.editor=c}destroy(){zeroObject(this)}}
class GraphicalFilterEditorCanvasRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("canvas"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this.pixelRatio=1;this.rangeImage=this.ctx=null;this.scaleChanged()}scaleChanged(){var a=this.element,b=this.editor;if(a&&b){var c=GraphicalFilterEditorControl.controlWidth,d=GraphicalFilterEditorControl.controlHeight,e=1<devicePixelRatio?devicePixelRatio:
1,f=b.scale,g=f*e;a.width=c*g|0;a.height=d*g|0;b.element.style.width=(c*f|0)+"px";a.style.width=(c*f|0)+"px";a.style.height=(d*f|0)+"px";b=this.element.getContext("2d",{alpha:!1});if(!b)throw Error("Null canvas context");a=b.createLinearGradient(0,0,1,a.height);a.addColorStop(0,"#ff0000");a.addColorStop(.1875,"#ffff00");a.addColorStop(.39453125,"#00ff00");a.addColorStop(.60546875,"#00ffff");a.addColorStop(.796875,"#0000ff");a.addColorStop(1,"#ff00ff");this.pixelRatio=e;this.ctx=b;this.rangeImage=
a}}drawCurve(a,b,c){const d=this.ctx;if(d){var e=1<devicePixelRatio?devicePixelRatio:1;e!==this.pixelRatio&&(this.scaleChanged(),e=this.pixelRatio);var f=this.editor,g=f.filter;e*=f.scale;var k=this.element;f=this.leftMargin;var h=k.width,m=k.height,l=Math.round(8*e),n=Math.round(4*e),p=(h/l|0)+1,r=GraphicalFilterEditor.maximumChannelValueY*e|0,q=1>e?e:e|0;k=.5*q;d.fillStyle="#303030";d.fillRect(0,0,h,m);d.lineWidth=q;d.strokeStyle="#5a5a5a";d.beginPath();q=h+(n>>1);var u=(GraphicalFilterEditor.zeroChannelValueY*
e|0)+k;d.moveTo(q,u);for(let t=p-1;0<=t;t--)d.lineTo(q-n,u),q-=l,d.moveTo(q,u);d.stroke();d.beginPath();q=h+(n>>1);u=(GraphicalFilterEditor.validYRangeHeight*e|0)+k;d.moveTo(q,u);for(h=p-1;0<=h;h--)d.lineTo(q-n,u),q-=l,d.moveTo(q,u);d.stroke();if(a)for(a=g.equivalentZonesFrequencyCount.length-2;0<a;a--){q=((g.equivalentZonesFrequencyCount[a]+f)*e|0)+k;u=r;d.beginPath();for(d.moveTo(q,u);u<m;)d.lineTo(q,u+n),u+=l,d.moveTo(q,u);d.stroke()}q=1>e?2*e:2*e|0;k=.5*q;d.lineWidth=q;a=GraphicalFilterEditor.visibleBinCount-
1;for(m=b?1:0;0<=m;m--){l=m||!b?g.channelCurves[c]:g.actualChannelCurve;d.strokeStyle=m?"#707070":this.rangeImage;d.beginPath();d.moveTo(f*e|0,l[0]*e+k);for(q=1;q<a;q++)d.lineTo((f+q)*e|0,l[q]*e+k);d.lineTo((f+q+1)*e|0,l[q]*e+k);d.stroke()}}}}
class GraphicalFilterEditorSVGRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("div"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this.element.style.overflow="hidden";this.element.style.backgroundColor="#303030";this.element.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1" viewBox="0 0 1 1" version="1.1" style="transform-origin: top left; pointer-events: none;">\n\t\t\t<defs>\n\t\t\t\t<linearGradient id="editorSVGLinearGradient" x1="0" y1="0" x2="0" y2="1" gradientUnits="userSpaceOnUse">\n\t\t\t\t\t<stop offset="0" stop-color="#ff0000" />\n\t\t\t\t\t<stop offset="0.1875" stop-color="#ffff00" />\n\t\t\t\t\t<stop offset="0.39453125" stop-color="#00ff00" />\n\t\t\t\t\t<stop offset="0.60546875" stop-color="#00ffff" />\n\t\t\t\t\t<stop offset="0.796875" stop-color="#0000ff" />\n\t\t\t\t\t<stop offset="1" stop-color="#ff00ff" />\n\t\t\t\t</linearGradient>\n\t\t\t</defs>\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<g style="display:none">\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t</g>\n\t\t\t<path style="fill:none;stroke:#707070;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t\t<path style="fill:none;stroke:url(#editorSVGLinearGradient);stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t</svg>';
this.pixelRatio=1;this.showZones=!1;this.isActualChannelCurveNeeded=!0;this.svg=a=this.element.firstChild;this.svgGradient=a.getElementsByTagName("linearGradient")[0];this.svgZones=a.getElementsByTagName("g")[0];var b=a.getElementsByTagName("path");this.svgGrayCurve=b[0];this.svgCurve=b[1];a=a.getElementsByTagName("line");this.svgLines=Array(a.length);for(b=a.length-1;0<=b;b--)this.svgLines[b]=a[b];this.scaleChanged()}scaleChanged(){const a=this.element,b=this.editor;var c=b.filter;const d=this.svg;
if(a&&b&&c&&d){var e=GraphicalFilterEditorControl.controlWidth,f=GraphicalFilterEditorControl.controlHeight,g=1<devicePixelRatio?devicePixelRatio:1,k=b.scale,h=k*g,m=this.leftMargin,l=this.svgLines,n=1>h?h:h|0,p=.5*n,r=(e*h|0).toString(),q=(f*h|0).toString();d.setAttribute("width",r);d.setAttribute("height",q);d.setAttribute("viewBox",`0 0 ${r} ${q}`);d.style.transform=1===g?"":"scale("+1/g+")";this.svgGradient.setAttribute("y2",q);b.element.style.width=(e*k|0)+"px";a.style.width=(e*k|0)+"px";a.style.height=
(f*k|0)+"px";l[0].setAttribute("x2",r);l[1].setAttribute("x2",r);for(r=l.length-1;2<=r;r--)l[r].setAttribute("y2",q);q=((GraphicalFilterEditor.zeroChannelValueY*h|0)+p).toString();l[0].setAttribute("y1",q);l[0].setAttribute("y2",q);q=((GraphicalFilterEditor.validYRangeHeight*h|0)+p).toString();l[1].setAttribute("y1",q);l[1].setAttribute("y2",q);for(q=c.equivalentZonesFrequencyCount.length-2;0<q;q--)r=(((c.equivalentZonesFrequencyCount[q]+m)*h|0)+p).toString(),l[q+1].setAttribute("x1",r),l[q+1].setAttribute("x2",
r);r=n.toString()+"px";q=(4*h|0).toString();for(c=l.length-1;0<=c;c--)l[c].setAttribute("stroke-width",r),l[c].setAttribute("stroke-dasharray",q);r=(1>h?2*h:2*h|0).toString()+"px";this.svgGrayCurve.style.strokeWidth=r;this.svgCurve.style.strokeWidth=r;this.pixelRatio=g}}drawCurve(a,b,c){var d=1<devicePixelRatio?devicePixelRatio:1;d!==this.pixelRatio&&(this.scaleChanged(),d=this.pixelRatio);this.showZones!==a&&(this.showZones=a,this.svgZones.style.display=a?"":"none");var e=this.editor;a=e.filter;
d*=e.scale;e=.5*(1>d?2*d:2*d|0);const f=this.leftMargin,g=GraphicalFilterEditor.visibleBinCount;for(let k=b?1:0;0<=k;k--){const h=k||!b?a.channelCurves[c]:a.actualChannelCurve,m=k?this.svgGrayCurve:this.svgCurve;let l=1,n=0,p=h[0],r="M "+(f*d|0)+","+(p*d+e);for(;l<g;l++)h[l]!==p&&(l>n+1&&1<l&&(r+=" "+((f+l-1)*d|0)+","+(h[l-1]*d+e)),n=l,p=h[l],r+=" "+((f+n)*d|0)+","+(p*d+e));r+=" "+((f+l)*d|0)+","+(h[l-1]*d+e);m.setAttribute("d",r)}this.isActualChannelCurveNeeded!==b&&(this.isActualChannelCurveNeeded=
b,this.svgGrayCurve.style.display=b?"":"none")}}
class GraphicalFilterEditorControl{constructor(a,b,c,d,e,f){this._showZones=!1;this._editMode=GraphicalFilterEditorControl.editModeRegular;this._isActualChannelCurveNeeded=!0;this._currentChannelIndex=0;this.isSameFilterLR=!0;this.drawOffsetY=this.drawOffsetX=this.lastDrawY=this.lastDrawX=this.drawingMode=0;if(8>b||b&b-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this.filter=new GraphicalFilterEditor(b,c,d);b=function(){const k=document.createElement("div");k.className=
"GEMNUSEP";return k};c=function(k){const h=document.createElement("div");h.className="GEMNULBL";h.appendChild(document.createTextNode(k));return h};d=function(k,h,m,l,n,p){const r=document.createElement("div");r.className=p?"GEMNUIT GECLK "+p:"GEMNUIT GECLK";if(h)if(f&&(l&&f.radioHTML||!l&&f.checkHTML))r.innerHTML=l?f.radioHTML:f.checkHTML,h=r.firstChild,h.style.marginRight=l?f.radioMargin||"2px":f.checkMargin||"2px",m||(h.style.visibility="hidden");else{h=document.createElement("span");p=l?"\u25cf ":
"\u25a0 ";let q=null;if(f){let u=!1;l?f.radioCharacter&&(u=!0,p=f.radioCharacter,q=f.radioMargin||"2px"):f.checkCharacter&&(u=!0,p=f.checkCharacter,q=f.checkMargin||"2px");u&&(f.checkFontFamily&&(h.style.fontFamily=f.checkFontFamily),f.checkFontSize&&(h.style.fontSize=f.checkFontSize))}q&&(h.style.marginRight=q);h.appendChild(document.createTextNode(p));m||(h.style.visibility="hidden");r.appendChild(h)}r.appendChild(document.createTextNode(k));n&&(r.onclick=n);return r};this.element=a;a.className=
"GE";this.boundMouseMove=this.mouseMove.bind(this);this._fontSize=null;f&&f.fontSize&&(this.fontSize=f.fontSize);this._lineHeight=null;f&&f.lineHeight&&(this.lineHeight=f.lineHeight);this._scale=0;this.scale=f&&f.scale&&0<f.scale?f.scale:1;this.renderer=f&&f.svgRenderer?new GraphicalFilterEditorSVGRenderer(this):new GraphicalFilterEditorCanvasRenderer(this);this.renderer.element.addEventListener("mousemove",this.boundMouseMove);this.renderer.element.oncontextmenu=cancelEvent;a.appendChild(this.renderer.element);
this.pointerHandler=new PointerHandler(this.renderer.element,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));a.oncontextmenu=cancelEvent;var g=document.createElement("div");g.className="GELBL";g.style.width="9em";g.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Cursor));g.appendChild(this.lblCursor=document.createElement("span"));g.appendChild(document.createTextNode(" dB"));this.lblCursor.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));
a.appendChild(g);g=document.createElement("div");g.className="GELBL";g.style.width="9em";g.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Curve));g.appendChild(this.lblCurve=document.createElement("span"));g.appendChild(document.createTextNode(" dB"));this.lblCurve.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));a.appendChild(g);g=document.createElement("div");g.className="GELBL";g.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Frequency));
g.appendChild(this.lblFrequency=document.createElement("span"));this.lblFrequency.appendChild(document.createTextNode("0 Hz (31 Hz)"));a.appendChild(g);this.btnMnu=document.createElement("div");this.btnMnu.className="GEBTN GECLK";this.openMenuElement=null;this.openMenuCharacter="\u25b2";this.closeMenuElement=null;this.closeMenuCharacter="\u25bc";f&&(g=!1,f.openMenuHTML&&f.closeMenuHTML?(g=!0,this.btnMnu.innerHTML=f.openMenuHTML+f.closeMenuHTML,this.openMenuElement=this.btnMnu.childNodes[0],this.closeMenuElement=
this.btnMnu.childNodes[1],this.closeMenuElement.style.display="none"):f.openMenuCharacter?(g=!0,this.openMenuCharacter=f.openMenuCharacter,this.closeMenuCharacter=f.closeMenuCharacter||this.openMenuCharacter):f.closeMenuCharacter&&(g=!0,this.closeMenuCharacter=this.openMenuCharacter=f.closeMenuCharacter),g&&(f.menuFontFamily&&(this.btnMnu.style.fontFamily=f.menuFontFamily),f.menuFontSize&&(this.btnMnu.style.fontSize=f.menuFontSize),f.menuWidth&&(this.btnMnu.style.width=f.menuWidth),f.menuPadding&&
(this.btnMnu.style.padding=f.menuPadding)));this.openMenuElement||this.btnMnu.appendChild(document.createTextNode(this.openMenuCharacter));this.btnMnu.onclick=this.btnMnu_Click.bind(this);a.appendChild(this.btnMnu);this.mnu=document.createElement("div");this.mnu.className="GEMNU";this.mnu.style.display="none";g=document.createElement("div");g.className="GEMNUH GEFILTER";g.appendChild(c(GraphicalFilterEditorStrings.SameCurve));g.appendChild(this.mnuChBL=d(GraphicalFilterEditorStrings.UseLeftCurve,
!0,!0,!0,this.mnuChB_Click.bind(this,0)));g.appendChild(this.mnuChBR=d(GraphicalFilterEditorStrings.UseRightCurve,!0,!1,!0,this.mnuChB_Click.bind(this,1)));g.appendChild(b());g.appendChild(c(GraphicalFilterEditorStrings.OneForEach));g.appendChild(this.mnuChL=d(GraphicalFilterEditorStrings.ShowLeftCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,0)));g.appendChild(this.mnuChR=d(GraphicalFilterEditorStrings.ShowRightCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,1)));this.mnu.appendChild(g);g=document.createElement("div");
g.className="GEMNUH GEMNUSEPH";g.appendChild(d(GraphicalFilterEditorStrings.ResetCurve,!1,!1,!1,this.mnuResetCurve_Click.bind(this)));g.appendChild(b());g.appendChild(c(GraphicalFilterEditorStrings.EditMode));g.appendChild(this.mnuEditRegular=d(GraphicalFilterEditorStrings.Regular,!0,!0,!0,this.mnuEditRegular_Click.bind(this)));g.appendChild(this.mnuEditZones=d(GraphicalFilterEditorStrings.Zones,!0,!1,!0,this.mnuEditZones_Click.bind(this)));g.appendChild(this.mnuEditSmoothNarrow=d(GraphicalFilterEditorStrings.SmoothNarrow,
!0,!1,!0,this.mnuEditSmoothNarrow_Click.bind(this)));g.appendChild(this.mnuEditSmoothWide=d(GraphicalFilterEditorStrings.SmoothWide,!0,!1,!0,this.mnuEditSmoothWide_Click.bind(this)));g.appendChild(this.mnuEditPeakingEq=d(GraphicalFilterEditorStrings.PeakingEq,!0,!1,!0,this.mnuEditPeakingEq_Click.bind(this)));if(f&&f.hideEditModePeakingEq||!this.filter.iirSupported)this.mnuEditPeakingEq.style.display="none";g.appendChild(this.mnuEditShelfEq=d(GraphicalFilterEditorStrings.ShelfEq,!0,!1,!0,this.mnuEditShelfEq_Click.bind(this)));
if(f&&f.hideEditModeShelfEq||!this.filter.iirSupported)this.mnuEditShelfEq.style.display="none";g.appendChild(b());g.appendChild(this.mnuNormalizeCurves=d(GraphicalFilterEditorStrings.NormalizeCurves,!0,!1,!1,this.mnuNormalizeCurves_Click.bind(this),"GEFILTER"));g.appendChild(this.mnuShowZones=d(GraphicalFilterEditorStrings.ShowZones,!0,!1,!1,this.mnuShowZones_Click.bind(this)));g.appendChild(this.mnuShowActual=d(GraphicalFilterEditorStrings.ShowActualResponse,!0,!0,!1,this.mnuShowActual_Click.bind(this)));
this.mnu.appendChild(g);a.appendChild(this.mnu);e&&this.loadSettings(e);this.drawCurve()}destroy(){this.filter&&this.filter.destroy();this.pointerHandler&&this.pointerHandler.destroy();this.renderer&&this.renderer.destroy();zeroObject(this)}loadSettings(a){if(a){var b=this.filter;if(!1===a.showZones||!0===a.showZones)this._showZones=a.showZones;a.editMode&&a.editMode>=GraphicalFilterEditorControl.editModeFirst&&a.editMode<=GraphicalFilterEditorControl.editModeLast&&(b.iirSupported||a.editMode!==GraphicalFilterEditorControl.editModePeakingEq&&
a.editMode!==GraphicalFilterEditorControl.editModeShelfEq)&&(this._editMode=a.editMode);if(!1===a.isActualChannelCurveNeeded||!0===a.isActualChannelCurveNeeded)this._isActualChannelCurveNeeded=a.isActualChannelCurveNeeded;if(0===a.currentChannelIndex||1===a.currentChannelIndex)this._currentChannelIndex=a.currentChannelIndex;if(!1===a.isSameFilterLR||!0===a.isSameFilterLR)this.isSameFilterLR=a.isSameFilterLR;var c=GraphicalFilterEditor.decodeCurve(a.leftCurve),d=GraphicalFilterEditor.decodeCurve(a.rightCurve);
c&&!d?d=c:d&&!c&&(c=d);if(c){var e=b.channelCurves[0];for(let f=GraphicalFilterEditor.visibleBinCount-1;0<=f;f--)e[f]=b.clampY(c[f])}if(d)for(c=b.channelCurves[1],e=GraphicalFilterEditor.visibleBinCount-1;0<=e;e--)c[e]=b.clampY(d[e]);this.isSameFilterLR?(this.checkMenu(this.mnuChBL,0===this._currentChannelIndex),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===this._currentChannelIndex),this.checkMenu(this.mnuChR,!1)):(this.checkMenu(this.mnuChBL,!1),this.checkMenu(this.mnuChL,0===this._currentChannelIndex),
this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,1===this._currentChannelIndex));a=!1===a.isNormalized||!0===a.isNormalized?a.isNormalized:b.isNormalized;a===b.isNormalized?b.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!0):b.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.checkMenu(this.mnuShowZones,this._showZones);this.editMode=this._editMode;this.checkMenu(this.mnuNormalizeCurves,
this.filter.isNormalized);this.checkMenu(this.mnuShowActual,this._isActualChannelCurveNeeded);this.drawCurve()}}saveSettings(){return{showZones:this._showZones,editMode:this._editMode,isActualChannelCurveNeeded:this._isActualChannelCurveNeeded,currentChannelIndex:this._currentChannelIndex,isSameFilterLR:this.isSameFilterLR,isNormalized:this.filter.isNormalized,leftCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[0]),rightCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[1])}}get scale(){return this._scale}set scale(a){0>=
a||this._scale===a||!this.element||(this._scale=a,this._fontSize||(this.element.style.fontSize=12*a+"px"),this._lineHeight||(this.element.style.lineHeight=16*a+"px"),this.renderer&&(this.renderer.scaleChanged(),this.drawCurve()))}get fontSize(){return this._fontSize}set fontSize(a){this._fontSize!==a&&this.element&&(this._fontSize=a,this.element.style.fontSize=a||12*this._scale+"px")}get lineHeight(){return this._lineHeight}set lineHeight(a){this._lineHeight!==a&&this.element&&(this._lineHeight=a,
this.element.style.lineHeight=a||16*this._scale+"px")}get showZones(){return this._showZones}set showZones(a){this._showZones=a;this.checkMenu(this.mnuShowZones,a);this.drawCurve()}get editMode(){return this._editMode}set editMode(a){if(!(a<GraphicalFilterEditorControl.editModeFirst||a>GraphicalFilterEditorControl.editModeLast)&&(this.filter.iirSupported||a!==GraphicalFilterEditorControl.editModePeakingEq&&a!==GraphicalFilterEditorControl.editModeShelfEq)){this._editMode=a;this.checkMenu(this.mnuEditRegular,
a===GraphicalFilterEditorControl.editModeRegular);this.checkMenu(this.mnuEditZones,a===GraphicalFilterEditorControl.editModeZones);this.checkMenu(this.mnuEditSmoothNarrow,a===GraphicalFilterEditorControl.editModeSmoothNarrow);this.checkMenu(this.mnuEditSmoothWide,a===GraphicalFilterEditorControl.editModeSmoothWide);this.checkMenu(this.mnuEditPeakingEq,a===GraphicalFilterEditorControl.editModePeakingEq);this.checkMenu(this.mnuEditShelfEq,a===GraphicalFilterEditorControl.editModeShelfEq);var b=GraphicalFilterEditorIIRType.None;
switch(a){case GraphicalFilterEditorControl.editModePeakingEq:b=GraphicalFilterEditorIIRType.Peaking;break;case GraphicalFilterEditorControl.editModeShelfEq:b=GraphicalFilterEditorIIRType.Shelf}this.filter.iirType!==b&&(this.mnu.className=b?"GEMNU GEEQ":"GEMNU",this.filter.changeIIRType(b,this._currentChannelIndex,this.isSameFilterLR),this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve()))}}get isActualChannelCurveNeeded(){return this._isActualChannelCurveNeeded}set isActualChannelCurveNeeded(a){this._isActualChannelCurveNeeded=
a;this.checkMenu(this.mnuShowActual,a);a&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}get currentChannelIndex(){return this._currentChannelIndex}get isNormalized(){return this.filter.isNormalized}set isNormalized(a){this.filter.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this.checkMenu(this.mnuNormalizeCurves,a);this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve())}static formatDB(a){return-40>
a?GraphicalFilterEditorStrings.MinusInfinity:0>a?GraphicalFilterEditorStrings.toFixed(a,2):0===a?GraphicalFilterEditorStrings.Minus0:"+"+GraphicalFilterEditorStrings.toFixed(a,2)}static formatFrequency(a){return a[0].toFixed(0)+" Hz ("+(1E3>a[1]?a[1]+" Hz":a[1]/1E3+" kHz")+")"}static setFirstNodeText(a,b){a.firstChild&&(a.firstChild.nodeValue=b)}btnMnu_Click(a){a.button||("none"===this.mnu.style.display?(this.mnu.style.bottom=this.btnMnu.clientHeight+"px",this.mnu.style.display="inline-block",this.openMenuElement&&
this.closeMenuElement?(this.openMenuElement.style.display="none",this.closeMenuElement.style.display=""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.closeMenuCharacter)):(this.mnu.style.display="none",this.openMenuElement&&this.closeMenuElement?(this.closeMenuElement.style.display="none",this.openMenuElement.style.display=""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.openMenuCharacter)));return!0}checkMenu(a,b){a.firstChild.style.visibility=b?"visible":"hidden";
return b}mnuChB_Click(a,b){b.button||this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR?(this._currentChannelIndex=a,this.filter.updateFilter(a,!0,!0),this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()):(this.isSameFilterLR=!0,this.filter.copyFilter(a,1-a),this._currentChannelIndex!==a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve())),this.checkMenu(this.mnuChBL,0===
a),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===a),this.checkMenu(this.mnuChR,!1));return this.btnMnu_Click(b)}mnuChLR_Click(a,b){b.button||!this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR&&(this.isSameFilterLR=!1,this.filter.updateFilter(1-this._currentChannelIndex,!1,!1)),this._currentChannelIndex!==a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()),this.checkMenu(this.mnuChBL,!1),
this.checkMenu(this.mnuChL,0===a),this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,1===a));return this.btnMnu_Click(b)}mnuResetCurve_Click(a){a.button||this.resetCurve();return this.btnMnu_Click(a)}mnuShowZones_Click(a){a.button||(this.showZones=!this._showZones);return this.btnMnu_Click(a)}mnuEditRegular_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeRegular);return this.btnMnu_Click(a)}mnuEditZones_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeZones);
return this.btnMnu_Click(a)}mnuEditSmoothNarrow_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothNarrow);return this.btnMnu_Click(a)}mnuEditSmoothWide_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothWide);return this.btnMnu_Click(a)}mnuEditPeakingEq_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModePeakingEq);return this.btnMnu_Click(a)}mnuEditShelfEq_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeShelfEq);
return this.btnMnu_Click(a)}mnuNormalizeCurves_Click(a){a.button||(this.isNormalized=!this.filter.isNormalized);return this.btnMnu_Click(a)}mnuShowActual_Click(a){a.button||(this.isActualChannelCurveNeeded=!this._isActualChannelCurveNeeded);return this.btnMnu_Click(a)}mouseDown(a){if(!a.button&&!this.drawingMode){const b=this.renderer.element.getBoundingClientRect(),c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;this.renderer.element.removeEventListener("mousemove",
this.boundMouseMove);this.drawingMode=1;switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.startSmoothEdition(this._currentChannelIndex);this.filter.changeSmoothY(this._currentChannelIndex,
c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.startSmoothEdition(this._currentChannelIndex);this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(c)]=this.filter.clampY(a),this.lastDrawX=c,this.lastDrawY=a}this.drawCurve();return!0}return!1}mouseMove(a){var b=this.renderer.element.getBoundingClientRect();
let c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;b=this.filter.channelCurves[this._currentChannelIndex];if(this.drawingMode){switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.changeSmoothY(this._currentChannelIndex,
c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:if(1<Math.abs(c-this.lastDrawX)){const d=(a-this.lastDrawY)/Math.abs(c-this.lastDrawX),e=c<this.lastDrawX?-1:1;let f=Math.abs(c-this.lastDrawX)-1;a=this.lastDrawY+d;for(c=this.lastDrawX+e;0<f;c+=e,f--)b[this.filter.clampX(c)]=this.filter.clampY(a),a+=d}b[this.filter.clampX(c)]=this.filter.clampY(a);
this.lastDrawX=c;this.lastDrawY=a}this.drawCurve()}else this._isActualChannelCurveNeeded&&(b=this.filter.actualChannelCurve);c=this.filter.clampX(c);GraphicalFilterEditorControl.setFirstNodeText(this.lblCursor,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(a)));GraphicalFilterEditorControl.setFirstNodeText(this.lblCurve,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(b[c])));GraphicalFilterEditorControl.setFirstNodeText(this.lblFrequency,GraphicalFilterEditorControl.formatFrequency(this.filter.visibleBinToFrequency(c,
!0)))}mouseUp(a){this.drawingMode&&(this.renderer.element.addEventListener("mousemove",this.boundMouseMove),this.drawingMode=0,this.commitChanges())}resetCurve(){const a=this.filter.channelCurves[this._currentChannelIndex];for(let b=a.length-1;0<=b;b--)a[b]=GraphicalFilterEditor.zeroChannelValueY;this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}getZoneY(a){return this.filter.getZoneY(this._currentChannelIndex,
a)}changeZoneY(a,b,c){this.filter.changeZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}getShelfZoneY(a){return this.filter.getShelfZoneY(this._currentChannelIndex,a)}changeShelfZoneY(a,b,c){this.filter.changeShelfZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}changeFilterY(a,b,c){this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(a)]=this.filter.clampY(b);this.drawCurve(c)}commitChanges(){this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,
!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}changeFilterLength(a){return this.filter.changeFilterLength(a,this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve(),!0):!1}changeSampleRate(a){return this.filter.changeSampleRate(a,this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),
this.drawCurve(),!0):!1}changeAudioContext(a){return this.filter.changeAudioContext(a,this._currentChannelIndex,this.isSameFilterLR)}drawCurve(a){this.renderer&&this.renderer.drawCurve(this._showZones,!a&&this._isActualChannelCurveNeeded&&!this.drawingMode,this._currentChannelIndex)}}GraphicalFilterEditorControl.controlWidth=Math.max(512,GraphicalFilterEditor.visibleBinCount);GraphicalFilterEditorControl.controlHeight=GraphicalFilterEditor.validYRangeHeight+3;
GraphicalFilterEditorControl.editModeRegular=0;GraphicalFilterEditorControl.editModeZones=1;GraphicalFilterEditorControl.editModeSmoothNarrow=2;GraphicalFilterEditorControl.editModeSmoothWide=3;GraphicalFilterEditorControl.editModePeakingEq=4;GraphicalFilterEditorControl.editModeShelfEq=5;GraphicalFilterEditorControl.editModeFirst=0;GraphicalFilterEditorControl.editModeLast=5;
class Program{constructor(a,b,c){const d=[];var e=[];const f=[];this.gl=a;var g=a.createProgram();if(!g)throw Error("Null program");this.program=g;g=a.createShader(a.VERTEX_SHADER);if(!g)throw Error("Null vertex shader");this.vs=g;g=a.createShader(a.FRAGMENT_SHADER);if(!g)throw Error("Null fragment shader");this.fs=g;a.shaderSource(this.vs,b);a.compileShader(this.vs);if(!a.getShaderParameter(this.vs,a.COMPILE_STATUS))throw e="Vertex shader: "+a.getShaderInfoLog(this.vs),this.destroy(),alert(e),e;
this.getAttribsAndUniforms(b,d,e,f);a.shaderSource(this.fs,c);a.compileShader(this.fs);if(!a.getShaderParameter(this.fs,a.COMPILE_STATUS))throw e="Fragment shader: "+a.getShaderInfoLog(this.fs),this.destroy(),alert(e),e;this.getAttribsAndUniforms(c,d,e,f);a.attachShader(this.program,this.vs);a.attachShader(this.program,this.fs);for(b=0;b<d.length;b++)a.bindAttribLocation(this.program,b,d[b]);a.linkProgram(this.program);for(a=0;a<e.length;a++)this.prepareUniform(e[a],f[a])}static create(a,b,c,d){const e=
["webkit-3d","moz-webgl","webgl","experimental-webgl"];for(let f=0;f<e.length;f++)try{const g=a.getContext(e[f],b);return new Program(g,c,d)}catch(g){}return null}getAttribsAndUniforms(a,b,c,d){a=a.split("\n");for(let m=0;m<a.length;m++){var e=a[m].trim();if("uniform"===e.substring(0,7)){e=e.split(" ");var f=e[1];for(var g=2;g<e.length;g++){var k=e[g];if(";"===k)break;var h=k.charAt(k.length-1);const l=";"===h;if(","===h||l)k=k.substring(0,k.length-1);","!==k&&k.length&&(c.push(k),d.push(f));if(l)break}}else if("attribute"===
e.substring(0,9))for(e=e.split(" "),f=2;f<e.length;f++){g=e[f];if(";"===g)break;k=g.charAt(g.length-1);h=";"===k;if(","===k||h)g=g.substring(0,g.length-1);","!==g&&g.length&&b.push(g);if(h)break}}}prepareUniform(a,b){const c=this.gl,d=c.getUniformLocation(this.program,a);if(!this[a])if("bool"===b||"int"===b||"sampler2D"===b)this[a]=function(e){c.uniform1i(d,e)};else if("float"===b)this[a]=function(e){c.uniform1f(d,e)};else if("vec2"===b)this[a]=function(e,f){c.uniform2f(d,e,f)},this[a+"v"]=function(e){c.uniform2fv(d,
e)};else if("vec3"===b)this[a]=function(e,f,g){c.uniform3f(d,e,f,g)},this[a+"v"]=function(e){c.uniform3fv(d,e)};else if("vec4"===b)this[a]=function(e,f,g,k){c.uniform4f(d,e,f,g,k)},this[a+"v"]=function(e){c.uniform4fv(d,e)};else if("mat4"===b)this[a]=function(e){c.uniformMatrix4fv(d,!1,e)};else return!1;return!0}use(){this.gl.useProgram(this.program)}destroy(){this.gl&&(this.gl.useProgram(null),this.vs&&(this.gl.detachShader(this.program,this.vs),this.gl.deleteShader(this.vs)),this.fs&&(this.gl.detachShader(this.program,
this.fs),this.gl.deleteShader(this.fs)),this.program&&this.gl.deleteProgram(this.program),zeroObject(this))}}
class Analyzer{constructor(a,b,c,d,e,f){this.alive=!1;this.lastRequest=0;this.boundAnalyze=null;this.audioContext=a;this.canvas=document.createElement("canvas");this.canvas.width=!e||0>=e?Analyzer.controlWidth:e;this.canvas.height=!f||0>=f?Analyzer.controlHeight:f;this.canvas.style.position="relative";this.canvas.style.margin="0px";this.canvas.style.padding="0px";this.canvas.style.verticalAlign="top";this.canvas.style.display="inline-block";this.canvas.style.cursor="default";c&&(this.canvas.id=c);
this.ctx=d?null:this.canvas.getContext("2d",{alpha:!1});b.appendChild(this.canvas);this.boundAnalyze=g=>{this.alive?(this.lastRequest=requestAnimationFrame(this.boundAnalyze),this.analyze(g)):this.lastRequest=0}}destroy(){this.stop();this.cleanUp();this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);zeroObject(this)}start(){if(this.alive)return!1;this.alive=!0;this.lastRequest=requestAnimationFrame(this.boundAnalyze);return!0}stop(){this.alive=!1;this.lastRequest&&
(cancelAnimationFrame(this.lastRequest),this.lastRequest=0)}}Analyzer.controlWidth=GraphicalFilterEditorControl.controlWidth;Analyzer.controlHeight=Analyzer.controlWidth;Analyzer.colors="#000000 #0B00B2 #0C00B1 #0E00AF #0E00AF #0F00AE #1000AD #1200AC #1300AB #1500AB #1600AA #1700A9 #1900A8 #1A00A6 #1B00A6 #1D00A4 #1F00A3 #2000A1 #2200A1 #2300A0 #25009E #27009D #29009C #2B009A #2D0099 #2E0098 #300096 #320095 #340094 #360092 #380090 #39008F #3C008E #3E008C #40008B #420089 #440088 #470086 #480085 #4B0083 #4C0082 #4F0080 #51007F #54007C #56007C #57007A #5A0078 #5C0076 #5F0075 #610073 #640071 #65006F #68006E #6B006C #6D006A #6F0069 #710066 #740065 #760063 #790062 #7B0060 #7D005E #80005C #82005B #850059 #860057 #890056 #8C0054 #8E0052 #910050 #93004F #96004D #97004B #9A0049 #9C0048 #9F0046 #A10045 #A40043 #A60040 #A8003F #AA003E #AD003C #AF003A #B10039 #B30037 #B60035 #B80034 #BA0032 #BC0031 #BE002E #C1002D #C3002C #C5002A #C70028 #CA0027 #CB0025 #CE0024 #CF0023 #D10022 #D30020 #D6001E #D7001D #D9001B #DB001A #DD0019 #DF0017 #E10017 #E20015 #E40014 #E60012 #E70011 #E90010 #EA000F #EC000D #ED000C #EF000B #F1000B #F2000A #F40008 #F50007 #F60006 #F70005 #F90005 #F90003 #FB0003 #FC0002 #FD0001 #FE0001 #FF0000 #FF0100 #FF0200 #FF0300 #FF0500 #FF0600 #FF0600 #FF0800 #FF0900 #FF0B00 #FF0C00 #FF0D00 #FF0F00 #FF1000 #FF1200 #FF1400 #FF1500 #FF1700 #FF1900 #FF1A00 #FF1C00 #FF1D00 #FF2000 #FF2200 #FF2300 #FF2500 #FF2700 #FF2900 #FF2B00 #FF2D00 #FF2F00 #FF3100 #FF3400 #FF3500 #FF3700 #FF3900 #FF3C00 #FF3E00 #FF4000 #FF4200 #FF4400 #FF4700 #FF4900 #FF4B00 #FF4E00 #FF5000 #FF5200 #FF5500 #FF5700 #FF5900 #FF5C00 #FF5E00 #FF6100 #FF6300 #FF6600 #FF6800 #FF6A00 #FF6C00 #FF6F00 #FF7200 #FF7400 #FF7700 #FF7900 #FF7C00 #FF7E00 #FF8000 #FF8300 #FF8500 #FF8700 #FF8A00 #FF8D00 #FF8F00 #FF9200 #FF9500 #FF9700 #FF9900 #FF9B00 #FF9E00 #FFA000 #FFA300 #FFA500 #FFA700 #FFA900 #FFAC00 #FFAE00 #FFB100 #FFB200 #FFB600 #FFB700 #FFBA00 #FFBC00 #FFBE00 #FFC100 #FFC300 #FFC400 #FFC700 #FFC900 #FFCB00 #FFCD00 #FFCF00 #FFD100 #FFD300 #FFD500 #FFD700 #FFD900 #FFDB00 #FFDD00 #FFDE00 #FFE000 #FFE100 #FFE400 #FFE500 #FFE700 #FFE900 #FFEA00 #FFEB00 #FFED00 #FFEF00 #FFF000 #FFF100 #FFF300 #FFF400 #FFF500 #FFF600 #FFF800 #FFF900 #FFFA00 #FFFB00".split(" ");
class PlainAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this.sampleRate=c.sampleRate;this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=1024;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=1024;this.visibleFrequencies=c.visibleFrequencies;a=cLib.HEAP8.buffer;this.dataPtr=this.ptr=b=cLib._allocBuffer(19456+cLib._fftSizeOff(2048));this.data=new Uint8Array(a,b,1024);this.tmpPtr=b+=1024;this.tmp=new Float32Array(a,b,2048);this.windowPtr=b+=8192;this.window=new Float32Array(a,
b,1024);this.multiplierPtr=b+=4096;this.multiplier=new Float32Array(a,b,512);this.prevLPtr=b+=2048;this.prevL=new Float32Array(a,b,512);this.prevRPtr=b+=2048;this.prevR=new Float32Array(a,b,512);this.fft4gfPtr=b+2048;cLib._fftInitf(this.fft4gfPtr,2048);d=this.window;a=this.multiplier;const e=Math.PI;b=Math.exp;const f=Math.cos;c=1/Math.LN10;for(let g=0;1024>g;g++)d[g]=4*(.54-.46*f(2*e*g/1023));for(d=0;512>d;d++)a[d]=145*c*b(2.5*d/511)}analyze(a){a=this.multiplier;const b=this.tmp,c=this.ctx,d=this.sampleRate/
2048,e=this.visibleFrequencies,f=Analyzer.colors;var g;let k,h,m,l;this.analyzerL.getByteTimeDomainData(this.data);cLib._plainAnalyzer(this.fft4gfPtr,this.windowPtr,this.dataPtr,this.tmpPtr);let n=this.prevL;c.lineWidth=1;c.fillStyle="#000000";c.fillRect(0,0,512,512);for(h=k=0;511>h&&1024>k&&d>e[h+1]-e[h];){for(g=d*k;1024>k&&g+d<e[h];)k++,g=d*k;g=(4*n[h]+a[h]*lerp(g,b[k],g+d,b[k+1],e[h]))/2.5>>1;255<g?g=255:0>g&&(g=0);n[h]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(h-.5,256.5-g);c.lineTo(h-.5,256.5);
c.stroke();h++}for(k++;1024>k&&512>h;){l=m=0;do m+=b[k],l++,k++,g=d*k;while(g<e[h]&&1024>k);g=(4*n[h]+a[h]*m/l)/2.5>>1;255<g?g=255:0>g&&(g=0);n[h]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(h-.5,256.5-g);c.lineTo(h-.5,256.5);c.stroke();h++}this.analyzerR.getByteTimeDomainData(this.data);cLib._plainAnalyzer(this.fft4gfPtr,this.windowPtr,this.dataPtr,this.tmpPtr);n=this.prevR;for(h=k=0;511>h&&1024>k&&d>e[h+1]-e[h];){for(g=d*k;1024>k&&g+d<e[h];)k++,g=d*k;g=(4*n[h]+a[h]*lerp(g,b[k],g+d,b[k+1],e[h]))/
2.5>>1;255<g?g=255:0>g&&(g=0);n[h]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(h-.5,256.5);c.lineTo(h-.5,256.5+g);c.stroke();h++}for(k++;1024>k&&512>h;){l=m=0;do m+=b[k],l++,k++,g=d*k;while(g<e[h]&&1024>k);g=(4*n[h]+a[h]*m/l)/2.5>>1;255<g?g=255:0>g&&(g=0);n[h]=g;c.beginPath();c.strokeStyle=f[g];c.moveTo(h-.5,256.5);c.lineTo(h-.5,256.5+g);c.stroke();h++}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr)}}
class SoundParticlesAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d,!0,Analyzer.controlWidth,320);this.BG_COLUMNS=31;this.BG_PARTICLES_BY_COLUMN=16;this.BG_COUNT=this.BG_COLUMNS*this.BG_PARTICLES_BY_COLUMN;this.lastTime=0;this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=1024;this.analyzerL.maxDecibels=-12;this.analyzerL.minDecibels=-45;this.analyzerL.smoothingTimeConstant=0;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=1024;this.analyzerR.maxDecibels=-12;this.analyzerR.minDecibels=
-45;this.analyzerR.smoothingTimeConstant=0;a=(f,g)=>{this.COLORS[3*f]=g};b=(f,g)=>{this.COLORS[3*f+1]=g};c=(f,g)=>{this.COLORS[3*f+2]=g};d=cLib.HEAP8.buffer;var e=cLib._allocBuffer(2240+8*this.BG_COUNT+8*this.BG_COUNT+this.BG_COUNT);this.processedDataPtr=this.ptr=e;this.processedData=new Uint8Array(d,e,512);this.processedDataRPtr=e+=512;this.processedDataR=new Uint8Array(d,e,512);this.fftPtr=e+=512;this.fft=new Float32Array(d,e,256);this.COLORSPtr=e+=1024;this.COLORS=new Float32Array(d,e,48);this.bgPosPtr=
e+=192;this.bgPos=new Float32Array(d,e,2*this.BG_COUNT);this.bgSpeedYPtr=e+=8*this.BG_COUNT;this.bgSpeedY=new Float32Array(d,e,this.BG_COUNT);this.bgThetaPtr=e+=4*this.BG_COUNT;this.bgTheta=new Float32Array(d,e,this.BG_COUNT);this.bgColorPtr=e+=4*this.BG_COUNT;this.bgColor=new Uint8Array(d,e,this.BG_COUNT);a(0,.75);b(0,0);c(0,0);a(1,0);b(1,.75);c(1,0);a(2,0);b(2,0);c(2,.75);a(3,.75);b(3,0);c(3,.75);a(4,.75);b(4,.75);c(4,0);a(5,0);b(5,.75);c(5,.75);a(6,.75);b(6,.75);c(6,.75);a(7,.75);b(7,.325);c(7,
0);a(8,.75);b(8,0);c(8,.325);a(9,.325);b(9,.75);c(9,0);a(10,0);b(10,.75);c(10,.325);a(11,0);b(11,.325);c(11,.75);a(12,.325);b(12,0);c(12,.75);a(13,0);b(13,0);c(13,.75);a(14,.75);b(14,.325);c(14,0);a(15,0);b(15,.325);c(15,.75);for(let f=0,g=0;f<this.BG_COLUMNS;f++)for(a=0;a<this.BG_PARTICLES_BY_COLUMN;a++,g++)this.fillBgParticle(g,-1.2+.01953125*(SoundParticlesAnalyzer.rand()&127));a=Program.create(this.canvas,{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0},SoundParticlesAnalyzer.vertexShaderSource,
SoundParticlesAnalyzer.fragmentShaderSource);if(!a)throw this.err("Apparently your browser does not support WebGL"),Error();this.program=a;this.program.use();this.program.texColor(0);this.program.aspect(.625,1);a=this.program.gl;d=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]);e=new Float32Array([0,1,1,1,0,0,1,0]);b=a.createBuffer();c=a.createBuffer();!a.getError()&&b&&c||this.err(-1);a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,
c);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);a.clearColor(0,0,0,1);a.pixelStorei(a.UNPACK_ALIGNMENT,2);a.disable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.disable(a.DITHER);a.disable(a.SCISSOR_TEST);a.disable(a.STENCIL_TEST);a.enable(a.BLEND);a.blendFunc(a.ONE,a.ONE);a.blendEquation(a.FUNC_ADD);a.getError();d=a.createTexture();!a.getError()&&d||this.err(-2);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,d);a.getError()&&this.err(-3);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);
a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);this.fillTexture();a.getError()&&this.err(-4);a.enableVertexAttribArray(0);a.bindBuffer(a.ARRAY_BUFFER,b);a.vertexAttribPointer(0,4,a.FLOAT,!1,0,0);a.enableVertexAttribArray(1);a.bindBuffer(a.ARRAY_BUFFER,c);a.vertexAttribPointer(1,2,a.FLOAT,!1,0,0)}static rand(){return 65536*Math.random()|0}err(a){this.destroy();
alert("Sorry! WebGL error :(\n"+a);throw a;}fillBgParticle(a,b){this.bgPos[a<<1]=.0078125*((SoundParticlesAnalyzer.rand()&7)-4);this.bgPos[(a<<1)+1]=b;this.bgTheta[a]=.03125*(SoundParticlesAnalyzer.rand()&63);this.bgSpeedY[a]=.125+.00390625*(SoundParticlesAnalyzer.rand()&15);this.bgColor[a]=SoundParticlesAnalyzer.rand()&15}fillTexture(){const a=this.program.gl,b=Math.sqrt,c=new Uint8Array(4096);for(let e=0;64>e;e++){let f=e-32;f*=f;for(let g=0;64>g;g++){var d=g-32;d=b(d*d+f)/30;1<d&&(d=1);let k=d;
d=1-d;d*=d;d+=.5*d;.55>d?d=0:1>d&&(d=smoothStep(.55,1,d));k=1-k;k=smoothStep(0,1,k);k*=k;k+=k;1<k&&(k=1);d+=.5*k;d=255*d|0;c[64*e+g]=255<=d?255:d}}a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,64,64,0,a.ALPHA,a.UNSIGNED_BYTE,c)}analyze(a){let b=a-this.lastTime;33<b&&(b=33);this.lastTime=a;a=this.program.gl;var c=.00390625*b,d=1-c;const e=this.processedData,f=this.processedDataR,g=this.fft,k=this.BG_COLUMNS,h=this.BG_PARTICLES_BY_COLUMN,m=this.COLORS,l=this.program,n=this.bgPos,p=this.bgSpeedY,r=this.bgColor,
q=this.bgTheta,u=Math.max;let t,y=44,x=116;b*=.001;this.analyzerL.getByteFrequencyData(e);this.analyzerR.getByteFrequencyData(f);for(t=0;256>t;t++){let v=u(e[t],f[t]);8>v&&(v=0);const w=g[t];v<w&&(v=c*v+d*w);g[t]=v;e[t]=255<=v?255:v}a.clear(a.COLOR_BUFFER_BIT);t=2;for(let v=0,w=0;v<k;v++){if(6>t)c=.00390625*e[t],t++;else if(20>t)c=.005859375*u(e[t],e[t+1]),t+=2;else if(36>t)c=.005859375*u(e[t],e[t+1],e[t+2],e[t+3]),t+=4;else if(100>t){for(c=0;t<y;t++)c=u(c,e[t]);c*=.0078125;y+=8}else{for(c=0;t<x;t++)c=
u(c,e[t]);c*=.009765625;x+=16}l.amplitude(1<=c?1:c);l.baseX(-.9+.06206897*v);for(c=0;c<h;c++,w++)1.2<n[(w<<1)+1]?this.fillBgParticle(w,-1.2):n[(w<<1)+1]+=p[w]*b,d=3*r[w],l.color(m[d],m[d+1],m[d+2]),d=w<<1,l.pos(n[d],n[d+1]),l.theta(q[w]),a.drawArrays(a.TRIANGLE_STRIP,0,4)}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr);this.program&&this.program.destroy()}}SoundParticlesAnalyzer.vertexShaderSource="precision mediump float;\nattribute vec4 inPosition;\nattribute vec2 inTexCoord;\nuniform float amplitude;\nuniform float baseX;\nuniform vec2 pos;\nuniform vec2 aspect;\nuniform vec3 color;\nuniform float theta;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = mix(0.0625, 0.34375, amplitude);\n\tfloat bottom = 1.0 - clamp(pos.y, -1.0, 1.0);\n\tbottom = bottom * bottom * bottom * 0.125;\n\ta = (0.75 * a) + (0.25 * bottom);\n\tgl_Position = vec4(baseX + pos.x + (5.0 * (pos.y + 1.0) * pos.x * sin((2.0 * pos.y) + theta)) + (inPosition.x * aspect.x * a), pos.y + (inPosition.y * aspect.y * a), 0.0, 1.0);\n\tvTexCoord = inTexCoord;\n\tvColor = color + bottom + (0.25 * amplitude);\n}";
SoundParticlesAnalyzer.fragmentShaderSource="precision lowp float;\nuniform sampler2D texColor;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = texture2D(texColor, vTexCoord).a;\n\tgl_FragColor = vec4(vColor.rgb * a, 1.0);\n}";
class WaveletAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=128;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=128;a=cLib.HEAP8.buffer;this.dataLPtr=this.ptr=b=cLib._allocBuffer(1536);this.dataL=new Uint8Array(a,b,128);this.dataRPtr=b+=128;this.dataR=new Uint8Array(a,b,128);this.tmpPtr=b+=128;this.tmp=new Float32Array(a,b,64);this.oL1Ptr=b+=256;this.oL1=new Float32Array(a,b,128);this.oR1Ptr=b+=512;this.oR1=new Float32Array(a,
b,128)}analyze(a){a=this.ctx;const b=Analyzer.colors,c=this.oL1,d=this.oR1;this.analyzerL.getByteTimeDomainData(this.dataL);this.analyzerR.getByteTimeDomainData(this.dataR);cLib._waveletAnalyzer(this.dataLPtr,this.dataRPtr,this.tmpPtr,this.oL1Ptr,this.oR1Ptr);let e,f,g=64,k=Analyzer.controlWidth/64,h,m=0,l=Analyzer.controlHeight-32;for(;;){e=g;for(h=0;512>h;)f=c[e],0>f&&(f=-f),f=127<=f?508:f<<2,a.fillStyle=b[f>>>1],a.fillRect(h,m,k,32),f=d[e],0>f&&(f=-f),f=127<=f?508:f<<2,a.fillStyle=b[f>>>1],a.fillRect(h,
l,k,32),e++,h+=k;k<<=1;m+=32;l-=32;if(!g)break;(g>>>=1)||(k=512)}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr)}}
class ConnectableNode{constructor(){this._enabled=!1;this.next=this.previous=null}get actualInput(){return this._enabled?this.input:this.next?this.next.actualInput:null}get actualOutput(){return this._enabled?this.output:this.previous?this.previous.actualOutput:null}nodesChanged(){const a=this.previous,b=this.next;a&&a.disconnectFromDestination();b&&this.disconnectFromDestination();a&&a.connectToDestination(this);b&&this.connectToDestination(b)}get enabled(){return this._enabled}set enabled(a){this._enabled!==
a&&(this._enabled=a,this.nodesChanged())}connectToDestination(a){this.disconnectFromDestination();if(this.next=a){a.previous=this;const b=this.actualOutput;b&&(a=a.actualInput)&&b.connect(a)}}disconnectFromDestination(){const a=this.actualOutput;a&&a.disconnect();this.next&&(this.next=this.next.previous=null)}}class DestinationNode extends ConnectableNode{constructor(a){super();this.node=a}get input(){return this.node}get output(){return null}}
class IntermediateNode extends ConnectableNode{constructor(a){super();this.node=a}get input(){return this.node}get output(){return this.node}}class SourceNode extends ConnectableNode{constructor(a){super();this.node=a}get input(){return null}get output(){return this.node}}var LibMikModMessageId;
(function(a){a[a.INIT=1]="INIT";a[a.LOAD_MODULE_BUFFER=2]="LOAD_MODULE_BUFFER";a[a.CHANGE_GENERAL_OPTIONS=3]="CHANGE_GENERAL_OPTIONS";a[a.STOP_MODULE=4]="STOP_MODULE";a[a.PLAYBACK_ERROR=5]="PLAYBACK_ERROR";a[a.PLAYBACK_ENDED=6]="PLAYBACK_ENDED"})(LibMikModMessageId||(LibMikModMessageId={}));
class LibMikMod{static isSupported(){return"AudioWorklet"in window&&"AudioWorkletNode"in window&&"WebAssembly"in window}static async init(a,b){if(!(LibMikMod.initialized||LibMikMod.initializing||LibMikMod.initializationError)){b?b.endsWith("/")||(b+="/"):b="";LibMikMod.initializing=!0;LibMikMod.currentId=0;try{const c=await (await fetch(b+"libmikmodclib.wasm?"+LibMikMod.WEB_VERSION)).arrayBuffer();await a.audioWorklet.addModule(b+"libmikmodprocessor.min.js?"+LibMikMod.WEB_VERSION);await new Promise(function(d,
e){const f=new AudioWorkletNode(a,"libmikmodprocessor");f.port.onmessage=function(g){(g=g.data)&&g.messageId===LibMikModMessageId.INIT&&LibMikMod.initializing&&!LibMikMod.currentId&&(g.errorStr?e(g.errorStr):(LibMikMod.LIB_VERSION=(g.id>>>16&255)+"."+(g.id>>>8&255)+"."+(g.id&255),d()))};f.onprocessorerror=function(g){e(g)};LibMikMod.audioNode=f;LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.INIT,buffer:c})});LibMikMod.initialized=!0}finally{LibMikMod.initialized||(LibMikMod.initializationError=
!0),LibMikMod.initializing=!1,LibMikMod.stopModule()}}}static postMessage(a){LibMikMod.audioNode&&(a.buffer?LibMikMod.audioNode.port.postMessage(a,[a.buffer]):LibMikMod.audioNode.port.postMessage(a))}static loadModule(a){if(!LibMikMod.initialized)throw Error("Library not initialized");if(!a)throw Error("Null options");if(!a.audioContext)throw Error("Null audioContext");const b=a.source;if(!b)throw Error("Null source");LibMikMod.stopModule();const c=new AudioWorkletNode(a.audioContext,"libmikmodprocessor");
LibMikMod.currentId++;c.port.onmessage=LibMikMod.handleResponse;c.onprocessorerror=LibMikMod.notifyProcessorError;LibMikMod.audioNode=c;LibMikMod.infoSongName=null;LibMikMod.infoModType=null;LibMikMod.infoComment=null;LibMikMod.onload=a.onload;LibMikMod.onerror=a.onerror;LibMikMod.onended=a.onended;const d=LibMikMod.currentId,e={hqMixer:a.hqMixer,wrap:a.wrap,loop:a.loop,fadeout:a.fadeout,reverb:a.reverb,interpolation:a.interpolation,noiseReduction:a.noiseReduction};if("lastModified"in b)if("arrayBuffer"in
b)b.arrayBuffer().then(function(f){d===LibMikMod.currentId&&LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:f,options:e})},function(f){d===LibMikMod.currentId&&LibMikMod.notifyReaderError(f)});else{const f=new FileReader;f.onerror=function(g){d===LibMikMod.currentId&&LibMikMod.notifyReaderError(g)};f.onload=function(){d===LibMikMod.currentId&&(f.result?LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,
buffer:f.result,options:e}):LibMikMod.notifyReaderError("Empty reader result"))};f.readAsArrayBuffer(b)}else LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:b,options:e})}static changeGeneralOptions(a){if(!LibMikMod.initialized)throw Error("Library not initialized");LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.CHANGE_GENERAL_OPTIONS,options:a})}static cleanUp(){LibMikMod.currentId++;LibMikMod.infoSongName=null;LibMikMod.infoModType=
null;LibMikMod.infoComment=null;LibMikMod.audioNode=null;LibMikMod.onload=null;LibMikMod.onerror=null;LibMikMod.onended=null}static stopModule(){LibMikMod.audioNode&&(LibMikMod.postMessage({id:LibMikMod.currentId,messageId:LibMikModMessageId.STOP_MODULE}),LibMikMod.cleanUp())}static notifyReaderError(a){LibMikMod.notifyError(LibMikMod.ERROR_FILE_READ,a)}static notifyProcessorError(a){LibMikMod.notifyError(LibMikMod.ERROR_PLAYBACK,a)}static notifyError(a,b){if(LibMikMod.audioNode){var c=LibMikMod.onerror;
LibMikMod.cleanUp();c&&c(a,b)}}static notifyEnded(){if(LibMikMod.audioNode){var a=LibMikMod.onended;LibMikMod.cleanUp();a&&a()}}static handleResponse(a){var b;if(a=a.data)switch(a.messageId){case LibMikModMessageId.LOAD_MODULE_BUFFER:if(a.id!==LibMikMod.currentId||!LibMikMod.audioNode)break;if(a.errorCode)LibMikMod.notifyError(LibMikMod.ERROR_MODULE_LOAD,a.errorStr||a.errorCode.toString());else if(LibMikMod.infoSongName=a.infoSongName||null,LibMikMod.infoModType=a.infoModType||null,LibMikMod.infoComment=
a.infoComment||null,LibMikMod.onload)LibMikMod.onload(LibMikMod.audioNode);break;case LibMikModMessageId.PLAYBACK_ERROR:if(a.id!==LibMikMod.currentId)break;LibMikMod.notifyProcessorError(a.errorStr||(null===(b=a.errorCode)||void 0===b?void 0:b.toString()));break;case LibMikModMessageId.PLAYBACK_ENDED:a.id===LibMikMod.currentId&&LibMikMod.notifyEnded()}}}LibMikMod.WEB_VERSION=1;LibMikMod.LIB_VERSION=null;LibMikMod.ERROR_FILE_READ=1;LibMikMod.ERROR_MODULE_LOAD=2;LibMikMod.ERROR_PLAYBACK=3;
LibMikMod.initialized=!1;LibMikMod.initializing=!1;LibMikMod.initializationError=!1;LibMikMod.infoSongName=null;LibMikMod.infoModType=null;LibMikMod.infoComment=null;LibMikMod.currentId=0;LibMikMod.audioNode=null;LibMikMod.onload=null;LibMikMod.onerror=null;LibMikMod.onended=null;
class HistoryHandler{static init(...a){HistoryHandler.handlers=a||[];window.addEventListener("popstate",HistoryHandler.historyStatePopped)}static historyStatePopped(a){if(HistoryHandler.poppedInternally)HistoryHandler.poppedInternally=!1;else if(a=HistoryHandler.handlers)for(let b=0;b<a.length;b++){const c=a[b]();if(null!==c){c||HistoryHandler.pushState();break}}}static pushState(){window.history.pushState(HistoryHandler.state,Strings.AppName)}static popState(){window.history.state&&window.history.state.id===
Strings.AppName&&(HistoryHandler.poppedInternally=!0,window.history.back())}}HistoryHandler.state={id:Strings.AppName};HistoryHandler.poppedInternally=!1;
class FocusBlocker{constructor(){this.oldBodyOverflow=this.changedElements=null}block(){this.unblock();const a=document.querySelectorAll("button,input,select,textarea,.slider-control"),b=[];for(let c=a.length-1;0<=c;c--){const d=a[c],e=d.getAttribute("tabindex");"-1"!==e&&(d.setAttribute("tabindex","-1"),b.push({element:d,tabindex:e}))}this.changedElements=b;this.oldBodyOverflow=document.body.style.overflow;document.body.style.overflow="hidden"}unblock(){const a=this.changedElements;if(a){this.changedElements=
null;for(let b=a.length-1;0<=b;b--){const c=a[b],d=c.tabindex;d?c.element.setAttribute("tabindex",d):c.element.removeAttribute("tabindex")}}this.oldBodyOverflow&&(document.body.style.overflow=this.oldBodyOverflow,this.oldBodyOverflow=null)}}
class Alert{static removeElement(){Alert.element&&parseInt(Alert.element.getAttribute("data-timeout"))===Alert.timeout&&(document.body.removeChild(Alert.element),Alert.timeout=0,Alert.element=null)}static hideByTimeout(){Alert.element&&parseInt(Alert.element.getAttribute("data-timeout"))===Alert.timeout&&(Alert.timeout=0,Alert.hide())}static hide(){Alert.element&&Alert.element.classList.contains("in")&&(Alert.timeout&&clearTimeout(Alert.timeout),Alert.element.classList.remove("in"),Alert.timeout=
DelayControl.delayUICB(Alert.removeElement),Alert.element.setAttribute("data-timeout",Alert.timeout.toString()))}static show(a,b){Alert.timeout&&(clearTimeout(Alert.timeout),Alert.timeout=0);Alert.element?(Strings.changeText(Alert.element,a),Alert.element.classList.add("in"),Alert.timeout=setTimeout(Alert.hideByTimeout,DelayControl.uiDelayMS+(b?Alert.longDelayMS:Alert.shortDelayMS)),Alert.element.setAttribute("data-timeout",Alert.timeout.toString())):(Alert.element=document.createElement("div"),Alert.element.className=
"alert fade",Alert.element.onclick=Alert.hide,document.body.appendChild(Alert.element),DelayControl.delayShortCB(function(){Alert.show(a,b)}))}}Alert.shortDelayMS=2500;Alert.longDelayMS=4500;Alert.timeout=0;Alert.element=null;
class ButtonControl{static init(){const a=document.getElementsByTagName("button");if(a)for(let b=a.length-1;0<=b;b--)ButtonControl.prepare(a[b])}static create(a,b){const c=document.createElement("button");c.setAttribute("type","button");a.id&&c.setAttribute("id",a.id);!1===a.keyboardFocusable&&c.setAttribute("tabindex","-1");let d="btn";a.color&&(d+=" "+a.color);a.square&&(d+=" square");a.opaque||(d+=" transparent");a.className&&(d+=" "+a.className);c.className=d;const e=ButtonControl.prepare(c),
f=a.text||(a.stringKey?Strings.translate(a.stringKey):"");a.icon&&(d="large",!a.square&&f&&(d+=" margin"),!a.opaque&&a.color&&(d+=" "+a.color),e.appendChild(Icon.create(a.icon,d)));a.square?(c.setAttribute("aria-label",f),c.setAttribute("title",f)):e.appendChild(document.createTextNode(f));b||(a.onclick&&(c.onclick=a.onclick),a.parent&&a.parent.appendChild(c));return c}static prepare(a){const b=document.createElement("span");for(b.setAttribute("tabindex","-1");a.firstChild;){const c=a.firstChild;
a.removeChild(c);b.appendChild(c)}a.appendChild(b);return b}static setText(a,b){let c=a.firstChild;if(!c||"SPAN"!==c.tagName)if(c=a.querySelector("span"),!c)return;a=c.lastChild;!a||a.tagName?c.appendChild(document.createTextNode(b)):a.nodeValue=b}}
class CheckboxControl{static init(){const a=document.querySelectorAll("input[type=checkbox]");if(a)for(let b=a.length-1;0<=b;b--)CheckboxControl.prepare(a[b])}static isChecked(a){return(a=a.childInput)?a.checked:!1}static setChecked(a,b){(a=a.childInput)&&!!a.checked!==!!b&&a.click()}static create(a){var b=document.createElement("input");b.setAttribute("type","checkbox");b.setAttribute("value",a.stringKey);a.square&&b.setAttribute("data-square","1");a.id&&b.setAttribute("id",a.id);let c="btn";a.color&&
(c+=" "+a.color);a.square&&(c+=" square");a.opaque||(c+=" transparent");a.className&&(c+=" "+a.className);b.className=c;b=CheckboxControl.prepare(b,a.icon,a.iconColor,a.checkbox0Color,a.checkbox1Color);!1===a.keyboardFocusable&&b.setAttribute("tabindex","-1");a.parent&&a.parent.appendChild(b);return b}static prepare(a,b,c,d,e){const f=document.createElement("button"),g=document.createElement("span"),k=a.parentNode,h=b?null:a.getAttribute("data-square"),m=Strings.translate(a.getAttribute("title")||
a.value);f.setAttribute("type","button");f.setAttribute("role","checkbox");f.setAttribute("aria-label",m);g.setAttribute("tabindex","-1");a.setAttribute("tabindex","-1");a.setAttribute("aria-label",m);f.className=a.className;a.className="";b||(b=a.getAttribute("data-icon"));b&&!c&&(c=a.getAttribute("data-icon-color"));d||(d=a.getAttribute("data-checkbox0-color"));e||(e=a.getAttribute("data-checkbox1-color"))||(e="orange");k&&(k.insertBefore(f,a),k.removeChild(a));f.appendChild(g);g.appendChild(a);
g.appendChild(Icon.createLarge("icon-checkbox-0",(h?"":"margin")+(d?" "+d:"")));g.appendChild(Icon.createLarge("icon-checkbox-1",h?e:"margin "+e));b&&g.appendChild(Icon.createLarge(b,c?"margin "+c:"margin"));h||g.appendChild(document.createTextNode(m));a.removeAttribute("value");a.removeAttribute("title");f.onclick=CheckboxControl.click;f.childInput=a;return f}static click(a){(a=this.childInput)&&a.click()}}
class SimpleFilterEditorControl{constructor(a,b){this.element=a;this.editor=b;a.classList.add("simple-filter");this.sliders=b=Array(GraphicalFilterEditor.shelfEquivalentZoneCount);for(let c=0;c<b.length;c++){const d=document.createElement("span"),e=document.createElement("span"),f=document.createElement("span"),g=this.filterToSlider(c);e.className="simple-filter-freq small-bottom-margin";switch(c){case 0:e.innerHTML="31<br/>62";break;case 1:e.innerHTML="<br/>125";break;case 2:e.innerHTML="<br/>250";
break;case 3:e.innerHTML="500<br/>1k";break;case 4:e.innerHTML="2k<br/>4k";break;case 5:e.innerHTML="<br/>8k";break;case 6:e.innerHTML="<br/>16k"}Strings.changeText(f,SimpleFilterEditorControl.sliderToDB(g));f.className="small-top-margin";d.className="simple-filter-slider"+(!c||AppUI.primaryInputIsTouch?"":" left-margin");a.appendChild(d);b[c]=new SliderControl(d,!0,!0,-30,30,g,f,e);this.createHandler(b[c],c)}}static sliderToDB(a){return Formatter.formatDB(.5*a)}static sliderToY(a){return GraphicalFilterEditor.zeroChannelValueY-
(a<<1)}static yToSlider(a){return Math.max(-30,Math.min(30,-(a-GraphicalFilterEditor.zeroChannelValueY)>>1))}filterToSlider(a){return SimpleFilterEditorControl.yToSlider(this.editor.getShelfZoneY(a))}createHandler(a,b){const c=this.editor;a.onvaluechanged=function(e){Strings.changeText(a.leftChild,SimpleFilterEditorControl.sliderToDB(e))};const d=function(e){c.changeShelfZoneY(b,SimpleFilterEditorControl.sliderToY(e));c.commitChanges()};a.ondragended=d;a.onkeyboardchanged=d}updateSliders(){const a=
this.sliders;for(let b=0;b<a.length;b++)a[b].value=this.filterToSlider(b)}}class ListControlItem{constructor(a){this.index=-1;this.current=this.selected=!1;this.item=null;this.element=a}reset(){this.index=-1;this.current=this.selected=!1;this.item=null;this.element&&this.element.classList.remove("current","selected")}zero(){this.index=-1;this.current=this.selected=!1;this.element=this.item=null}}
class ListControl{constructor(a,b){this.element="string"===typeof a?document.getElementById(a):a;this.element.classList.add("list","scrollable");this.element.style.padding="0";this.element.getAttribute("tabindex")||this.element.setAttribute("tabindex","0");this.useVirtualItems=b;a=document.createElement("div");a.className="list-container";this.container=a;this.element.appendChild(a);this._adapter=null;this.boundZoomChanged=this.zoomChanged.bind(this);this.boundRefreshVisibleItemsInternal=this.refreshVisibleItemsInternal.bind(this);
this.boundAdjustScrollbarPaddingFromResize=this.adjustScrollbarPaddingFromResize.bind(this);b?this.element.addEventListener("scroll",this.scroll.bind(this),{passive:!0}):this.boundNotifyCurrentItemChangedInternal=this.notifyCurrentItemChangedInternal.bind(this);this.resizeObserver=new ResizeObserver(this.resize.bind(this));this.resizeObserver.observe(this.element,{box:"border-box"});this.itemMargin=this.itemHeight=1;this.itemHeightAndMargin=2;this.lastIndex=this.firstIndex=0;this.currentItem=this.currentListItem=
null;this.clientHeight=1;this.containerHeight=0;this.scrollbarPaddingScheduled=this.scrollbarPadding=!1;this.visibleCount=1;this.items=[];this.deleteMode=this.notifyCurrentItemChangedEnqueued=this.refreshVisibleItemsEnqueued=!1;this.onitemcontextmenu=this.onitemcontrolclicked=this.onitemclicked=null;a.onclick=this.containerClick.bind(this);a.oncontextmenu=this.containerContextMenu.bind(this);this.resize();AppUI.addZoomHandler(this.boundZoomChanged)}destroy(){this._adapter&&(this._adapter.control=
null);this.resizeObserver&&this.resizeObserver.unobserve(this.element);this.items&&this.items.fill(null);this.boundZoomChanged&&AppUI.removeZoomHandler(this.boundZoomChanged);zeroObject(this)}get adapter(){return this._adapter}set adapter(a){this._adapter!==a&&(this._adapter&&(this._adapter.control=null),this._adapter=a,this.clear(),a&&(a.control=this,this.prepareAdapter(),!this.useVirtualItems&&a.list.length&&this.notifyItemsAdded(0,a.list.length)))}prepareAdapter(){const a=this._adapter;a&&(this.itemHeight=
a.itemHeight,this.itemMargin=AppUI.thickBorderPX,this.itemHeightAndMargin=this.itemHeight+this.itemMargin,this.currentListItem=a.list.currentItem,this.adjustContainerHeight(),this.resize())}zoomChanged(){if(this._adapter){this.prepareAdapter();var a=this.items;for(let b=a.length-1;0<=b;b--)a[b].index=-1;this.useVirtualItems&&this.scroll()}}adjustScrollbarPadding(){const a=(this.containerHeight|0)>this.clientHeight;this.scrollbarPadding!==a&&(this.scrollbarPadding=a,this.element.style.padding=this.scrollbarPadding?
"":"0")}adjustScrollbarPaddingFromResize(){this.scrollbarPaddingScheduled=!1;this.adjustScrollbarPadding()}adjustContainerHeight(){var a=this._adapter;const b=this.container;a&&b&&(a=(a=a.list.length)?a*this.itemHeightAndMargin-this.itemMargin:0,this.containerHeight!==a&&(this.containerHeight=a,b.style.height=a+"px",this.adjustScrollbarPadding()))}clear(){var a=this.container;if(a){for(;a.firstChild;)a.removeChild(a.firstChild);a=this.items;if(this.useVirtualItems)for(var b=a.length-1;0<=b;b--)a[b].reset();
else{for(b=a.length-1;0<=b;b--)a[b].zero();a.splice(0)}this.lastIndex=this.firstIndex=0;this.currentItem=this.currentListItem=null;this.containerHeight=this.element.scrollTop=0;this.container.style.height="0";this.adjustScrollbarPadding()}}scroll(){var a=this._adapter,b=this.element;if(a&&b){var c=this.items,d=this.itemHeightAndMargin,e=this.firstIndex-2;b=b.scrollTop/d|0;0>e&&(e=0);this.firstIndex=b;var f=this.visibleCount+(0===b?2:1===b?3:4);f>c.length&&(f=c.length);0>(b-=2)&&(b=0);if(b>e){if((e=
b-e)&&e<f)for(let l=e,n=0;l<f;l++,n++)e=c[n],c[n]=c[l],c[l]=e}else if((e-=b)&&e<f)for(let l=f-1,n=l-e;0<=n;n--,l--)e=c[l],c[l]=c[n],c[n]=e;var g=a.list,k=g.length,h=a.list.currentItem;e=this.container;var m=0;for(let l=b*d;m<f&&b<k;m++,b++,l+=d){const n=g.item(b),p=c[m];if(p.item!==n){const r=h===n;p.current!==r&&((p.current=r)?p.element.classList.add("current"):p.element.classList.remove("current"));a.prepareElement(n,b,k,p.element);p.item||e.appendChild(p.element);p.item=n}p.index!==b&&(p.index=
b,p.element.style.transform="translateY("+l+"px)")}for(a=c.length;m<a;m++)d=c[m],d.item&&(d.item=null,e.removeChild(d.element));this.lastIndex=b-1;this.lastIndex<this.firstIndex&&(this.lastIndex=this.firstIndex)}}refreshVisibleItemsInternal(){this.refreshVisibleItemsEnqueued=!1;var a=this._adapter,b=this.element;if(a&&b){this.adjustContainerHeight();b=this.items;var c=this.itemHeightAndMargin,d=a.list,e=d.length,f=a.list.currentItem,g=this.container;if(this.useVirtualItems){this.currentListItem=f;
var k=0,h=this.firstIndex,m=this.visibleCount+(0===h?2:1===h?3:4);m>b.length&&(m=b.length);0>(h-=2)&&(h=0);for(let l=h*c;k<m&&h<e;k++,h++,l+=c){const n=d.item(h),p=b[k],r=f===n;p.current!==r&&((p.current=r)?p.element.classList.add("current"):p.element.classList.remove("current"));a.prepareElement(n,h,e,p.element);p.item||g.appendChild(p.element);p.item=n;p.index!==h&&(p.index=h,p.element.style.transform="translateY("+l+"px)")}for(a=b.length;k<a;k++)d=b[k],d.item&&(d.item=null,g.removeChild(d.element))}else{g=
this.visibleCount;for(let l=0,n=this.indexFromY(0);l<=g&&n<e;l++,n++)a.prepareElement(d.item(n),n,e,b[n].element)}}}resize(){const a=this._adapter;var b=this.element;if(a&&b){var c=this.clientHeight;b=b.clientHeight;0>b&&(b=0);var d=Math.ceil(b/this.itemHeightAndMargin)+1;if(this.visibleCount!==d&&(this.visibleCount=d,this.useVirtualItems)){const e=this.items;for(;d+4>e.length;)e.push(new ListControlItem(a.createEmptyElement("list-item virtual")))}c!==b&&(this.clientHeight=b,this.useVirtualItems&&
this.scroll(),this.scrollbarPaddingScheduled||(this.scrollbarPaddingScheduled=!0,requestAnimationFrame(this.boundAdjustScrollbarPaddingFromResize)))}}containerClick(a){if(this.element&&this.adapter&&a.target){var b=this.element.getBoundingClientRect();b=this.indexFromY(a.clientY-b.top);if(0<=b){const c=this.adapter.list.item(b);if(c)if(a.target.classList.contains("list-item"))if(this.deleteMode)this.adapter.list.removeItems(b,b);else{if(this.onitemclicked)this.onitemclicked(c,b,a.button)}else if(this.onitemcontrolclicked)this.onitemcontrolclicked(c,
b,a.button,a.target)}}}containerContextMenu(a){if(!(this.element&&this.adapter&&this.onitemcontextmenu&&a.target))return cancelEvent(a);var b=this.element.getBoundingClientRect();b=this.indexFromY(a.clientY-b.top);if(0<=b){const c=this.adapter.list.item(b);if(c)this.onitemcontextmenu(c,b)}return cancelEvent(a)}yFromIndex(a){return this.element?a*this.itemHeightAndMargin-this.element.scrollTop:0}indexFromY(a){if(!this.element||!this.adapter)return-1;a=(a+this.element.scrollTop+.9)/this.itemHeightAndMargin|
0;return 0>a||a>=this.adapter.list.length?-1:a}isItemVisible(a){a=this.yFromIndex(a);return 0<=a&&a<=this.clientHeight-this.itemHeight}bringItemIntoView(a,b){const c=this.yFromIndex(a);0>c?b?this.centerItemIntoView(a):this.element.scrollTop+=c:c>this.clientHeight-this.itemHeight&&(b?this.centerItemIntoView(a):this.element.scrollTop+=c-(this.clientHeight-this.itemHeight))}centerItemIntoView(a){this.element.scrollTop=a*this.itemHeightAndMargin-(this.clientHeight-this.itemHeight>>1)}refreshVisibleItems(){this.refreshVisibleItemsEnqueued||
(this.refreshVisibleItemsEnqueued=!0,queueMicrotask(this.boundRefreshVisibleItemsInternal))}notifyCleared(){this.clear()}notifyItemsAdded(a,b){if(this.useVirtualItems)this.refreshVisibleItems();else{const m=this.adapter,l=b-a+1;if(m&&!(0>=l)){var c=this.container,d=this.items,e=m.list,f=e.length,g=e.currentItem,k=Array(l);for(var h=b;h>=a;h--){const n=e.item(h),p=new ListControlItem(m.createEmptyElement("list-item real"));m.prepareElement(n,h,f,p.element);k[h-a]=p;g===n&&(this.currentItem&&(this.currentItem.current=
!1,this.currentItem.element.classList.remove("current")),this.currentItem=p,p.current=!0,p.element.classList.add("current"))}g=a>=d.length?null:d[a].element;a>=d.length?d.push(...k):d.splice(a,0,...k);if(this.items.length!==e.length)throw Error("Assertion error: this.items.length !== list.length");this.adjustContainerHeight();for(h=0;h<l;h++)c.insertBefore(k[h].element,g);for(c=d.length-1;c>b;c--)m.prepareElementIndexOrLengthChanged(e.item(c),c,f,d[c].element);for(--a;0<=a;a--)m.prepareElementIndexOrLengthChanged(e.item(a),
a,f,d[a].element)}}}notifyItemsRemoved(a,b){if(this.useVirtualItems)this.refreshVisibleItems();else{const g=this.adapter;var c=b-a+1;if(g&&!(0>=c)){var d=this.container;b=this.items;var e=g.list,f=e.length;a=b.splice(a,c);for(c=a.length-1;0<=c;c--){const k=a[c];k.current&&(this.currentItem=null);d.removeChild(k.element);k.zero()}if(this.items.length!==e.length)throw Error("Assertion error: this.items.length !== list.length");for(d=b.length-1;0<=d;d--)g.prepareElementIndexOrLengthChanged(e.item(d),
d,f,b[d].element);this.adjustContainerHeight()}}}notifyCurrentItemChanged(a,b){this.useVirtualItems?this.refreshVisibleItems():this.notifyCurrentItemChangedEnqueued||(this.notifyCurrentItemChangedEnqueued=!0,queueMicrotask(this.boundNotifyCurrentItemChangedInternal))}notifyCurrentItemChangedInternal(){this.notifyCurrentItemChangedEnqueued=!1;var a=this.adapter;a&&(this.currentItem&&(this.currentItem.current=!1,this.currentItem.element.classList.remove("current")),a=a.list.currentIndex,0<=a&&a<this.items.length?
(this.currentItem=this.items[a],this.currentItem.current=!0,this.currentItem.element.classList.add("current")):this.currentItem=null)}}
class SliderControl{constructor(a,b,c,d,e,f,g,k){this._element="string"===typeof a?document.getElementById(a):a;this._element.classList.add("slider-control");c&&this._element.classList.add("vertical");this._element.setAttribute("role","slider");b?this._element.setAttribute("tabindex","0"):this._element.setAttribute("aria-hidden","true");this.keyboardFocusable=b;a=(this.vertical=c)?" vertical":"";c=document.createElement("span");c.className="slider-control-focus-container"+a;c.setAttribute("tabindex",
"-1");this.focusContainer=c;this.onkeyboardchanged=this.ondragended=this.onvaluechanged=null;const h=document.createElement("span");h.className="slider-control-container"+a;c.appendChild(h);this.container=h;const m=document.createElement("span");m.className="slider-control-inner-container"+a;h.appendChild(m);this.innerContainer=m;var l=document.createElement("span");l.className="slider-control-ruler"+a;m.appendChild(l);this.ruler=l;l=document.createElement("span");l.className="slider-control-color slider-control-filled-ruler"+
a;m.appendChild(l);this.filledRuler=l;l=document.createElement("span");l.className="slider-control-color slider-control-thumb"+a;m.appendChild(l);this.thumb=l;this._element.appendChild(c);d>e?(this._min=e|0,this._max=d|0):(this._min=d|0,this._max=e|0);this.delta=this._max-this._min;this.delta||(this.delta=1);this._disabled=!1;this._value=d-1;this.percent=0;this.value=void 0===f?d:f;this.valueOnMouseDown=this._value;this.pointerHandler=new PointerHandler(h,this.mouseDown.bind(this),this.mouseMove.bind(this),
this.mouseUp.bind(this));b&&(this._element.setAttribute("aria-valuemin",d.toString()),this._element.setAttribute("aria-valuemax",e.toString()),this._element.addEventListener("keydown",this.keyDown.bind(this)),this._element.addEventListener("focus",this.focus.bind(this)),this._element.addEventListener("blur",this.blur.bind(this)));this._rightChild=this._leftChild=null;g&&(this.leftChild=g);k&&(this.rightChild=k)}get element(){return this._element}get leftChild(){return this._leftChild}set leftChild(a){this.focusContainer&&
(a?this._leftChild?this.focusContainer.replaceChild(a,this._leftChild):this.focusContainer.insertBefore(a,this.focusContainer.firstChild):this._leftChild&&this.focusContainer.removeChild(this._leftChild),this._leftChild=a)}get rightChild(){return this._rightChild}set rightChild(a){this.focusContainer&&(a?this._rightChild?this.focusContainer.replaceChild(a,this._rightChild):this.focusContainer.appendChild(a):this._rightChild&&this.focusContainer.removeChild(this._rightChild),this._rightChild=a)}get dragging(){return this.pointerHandler?
this.pointerHandler.captured:!1}get disabled(){return this._disabled}set disabled(a){this._disabled!==a&&(this._disabled=a,this._element&&(this.keyboardFocusable&&this._element.setAttribute("tabindex",a?"-1":"0"),this._element.style.pointerEvents=a?"none":""))}get min(){return this._min}set min(a){this._min=a|=0;a>this._max&&(this._max=a,this.keyboardFocusable&&this._element.setAttribute("aria-valuemax",a.toString()));this.delta=this._max-a;this.delta||(this.delta=1);this.keyboardFocusable&&this._element.setAttribute("aria-valuemin",
a.toString());this.value=this._value}get max(){return this._max}set max(a){this._max=a|=0;a<this._min&&(this._min=a,this.keyboardFocusable&&this._element.setAttribute("aria-valuemin",a.toString()));this.delta=a-this._min;this.delta||(this.delta=1);this.keyboardFocusable&&this._element.setAttribute("aria-valuemax",a.toString());this.value=this._value}get value(){return this._value}set value(a){a|=0;a<this._min?a=this._min:a>this._max&&(a=this._max);const b=this._value;this._value=a;this.percent=100*
(a-this._min)/this.delta;const c=this.percent+"%";this.filledRuler&&(this.vertical?this.filledRuler.style.top=100-this.percent+"%":this.filledRuler.style.right=100-this.percent+"%");this.ruler&&(this.vertical?this.ruler.style.bottom=c:this.ruler.style.left=c);this.thumb&&(this.vertical?this.thumb.style.bottom=c:this.thumb.style.left=c);if(a!==b&&(this.keyboardFocusable&&this._element.setAttribute("aria-valuenow",a.toString()),this.onvaluechanged))this.onvaluechanged(a)}mouseDown(a){if(a.button||this._disabled||
!this._element)return!1;this.focusContainer.focus();this.container.classList.add("active");this.valueOnMouseDown=this._value;this.mouseMove(a);return!0}mouseMove(a){const b=this.innerContainer.getBoundingClientRect();let c;this.vertical?(c=b.bottom-b.top,a=c-(a.clientY-(b.top-3))):(c=b.right-b.left,a=a.clientX-(b.left+4));this.value=0>=c?this._min:this._min+this.delta*a/c}mouseUp(a){this.container.classList.remove("active");if(this.ondragended&&this._value!==this.valueOnMouseDown)this.ondragended(this._value)}keyDown(a){if(!this.pointerHandler.captured){var b=
this._value;switch(a.key){case "ArrowDown":case "ArrowLeft":this.value=b-1;if(this.onkeyboardchanged&&this._value!==b)this.onkeyboardchanged(this._value);break;case "ArrowUp":case "ArrowRight":this.value=b+1;if(this.onkeyboardchanged&&this._value!==b)this.onkeyboardchanged(this._value);break;case "PageDown":this.value=b-.1*this.delta;if(this.onkeyboardchanged&&this._value!==b)this.onkeyboardchanged(this._value);break;case "PageUp":if(this.value=b+.1*this.delta,this.onkeyboardchanged&&this._value!==
b)this.onkeyboardchanged(this._value)}}}focus(){this.container.classList.add("active")}blur(){this.container.classList.remove("active")}}class Menu{static historyStatePopped(){return null}}
class GraphicalFilterControl extends ConnectableNode{constructor(a,b,c,d){super();this._simpleMode=!!d;this.container=a;this.outerContainer=b;d=document.createElement("div");this._simpleMode||(b.style.minWidth=GraphicalFilterControl.advancedModeMinWidth,a.appendChild(d));const e=InternalStorage.loadGraphicalFilterEditorSettings();this._simpleMode&&(e.editMode=GraphicalFilterEditorControl.editModeShelfEq);this.editor=new GraphicalFilterEditorControl(d,2048,c,this.filterChanged.bind(this),e,{svgRenderer:!0,
fontSize:AppUI.smallFontSizeREM+"rem",lineHeight:AppUI.smallContentsSizeREM+"rem",radioHTML:Icon.createHTML("icon-radio",!1,"menu-icon"),checkHTML:Icon.createHTML("icon-check",!1,"menu-icon"),openMenuHTML:"<span>"+Icon.createHTML("icon-expand-less",!0)+"</span>",closeMenuHTML:"<span>"+Icon.createHTML("icon-expand-more",!0)+"</span>"});d=document.createElement("div");d.className="button-bottom-margin";this._simpleMode&&(b.style.minWidth=GraphicalFilterControl.simpleModeMinWidth,a.appendChild(d));this.simpleEditor=
new SimpleFilterEditorControl(d,this.editor);a=this.editor.element.querySelectorAll("div.GELBL");for(b=a.length-1;0<=b;b--)c=a[b],c.style.height="var(--button-size)",c.style.fontSize=AppUI.smallFontSizeREM+"rem",c.style.lineHeight=AppUI.contentsSizeREM+"rem",c.style.paddingTop="var(--button-padding)",c.style.paddingBottom="0";a=this.editor.element.querySelector("div.GEBTN.GECLK");a.className="btn square white transparent";a.style.width="";a.style.padding="";a.style.float="right"}get input(){return this.editor.filter.inputNode}get output(){return this.editor.filter.outputNode}filterChanged(){this.enabled&&
this.nodesChanged()}get simpleMode(){return this._simpleMode}set simpleMode(a){if(this._simpleMode!==a){this._simpleMode=a;if(a){this.outerContainer.style.minWidth=GraphicalFilterControl.simpleModeMinWidth;this.editor.editMode=GraphicalFilterEditorControl.editModeShelfEq;this.simpleEditor.updateSliders();a=this.editor.element;var b=this.simpleEditor.element}else this.outerContainer.style.minWidth=GraphicalFilterControl.advancedModeMinWidth,a=this.simpleEditor.element,b=this.editor.element;a&&a.parentNode&&
a.parentNode.removeChild(a);this.container&&b&&!b.parentNode&&this.container.appendChild(b);this.filterChanged()}}saveSettings(){this.editor&&InternalStorage.saveGraphicalFilterEditorSettings(this.editor.saveSettings())}}GraphicalFilterControl.defaultPresets={Powerful:"oaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGgoKCgoKCgoKCfn5+fn5+enp6enp2dnZ2cnJybm5qampqZmZmYmJiXl5eWlpWVlZSUlJOTkpKSkZGRkZCQkI+Pj46Ojo6NjY2NjYyMjIyLi4uLi4uKioqKioqKioqKiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmKioqKioqKioqKioqKiouLi4uLjIyMjIyNjY2Njo6Ojo+Pj4+QkJCRkpKSk5OTk5SUlJWVlZWWlpaXl5eXmJiYmZmZmZqampqbm5ubnJycnJ2dnZ2enp6enp+fn5+fn6CgoKCgoKCgoKGhoaGhoaGhoaGhoaGhoaE="};
GraphicalFilterControl.simpleModeMinWidth="280px";GraphicalFilterControl.advancedModeMinWidth="512px";
class StereoPannerControl extends ConnectableNode{constructor(a,b){super();this._pan=InternalStorage.loadStereoPannerSettings();this._appliedGain=1;this.channelSplitter=b.createChannelSplitter(2);this.gain=b.createGain();this.channelMerger=b.createChannelMerger(2);this.rightGain=this.leftGain=!1;this.onappliedgainchanged=null;b=this.commitChanges.bind(this);this.slider=new SliderControl(a,!0,!1,-StereoPannerControl.maxAbsoluteValue,StereoPannerControl.maxAbsoluteValue,this._pan);this.label=document.createElement("span");
this.label.className="db-label large small-left-margin";this.slider.rightChild=this.label;this.slider.ondragended=b;this.slider.onkeyboardchanged=b;this.slider.onvaluechanged=this.sliderValueChanged.bind(this);this.sliderValueChanged(this._pan);this.commitChanges(this._pan)}get input(){return this.channelSplitter}get output(){return this.channelMerger}sliderValueChanged(a){Strings.changeText(this.label,(a?(0>a?Strings.RightAbbrev:Strings.LeftAbbrev)+" "+((a=Math.abs(a))>=StereoPannerControl.maxAbsoluteValue?
GraphicalFilterEditorStrings.MinusInfinity:"-"+a):"-0")+" dB")}commitChanges(a){const b=this.channelSplitter,c=this.gain,d=this.channelMerger;if(b&&c&&d){var e=Math.abs(a),f=Math.abs(this._pan)!==e;this._pan=a;if(e){a=0<a;const g=!a;this._appliedGain=e>=StereoPannerControl.maxAbsoluteValue?0:Math.pow(10,-e/20);c.gain.value=this._appliedGain;if(a!==this.leftGain||g!==this.rightGain)b.disconnect(),c.disconnect(),this.leftGain=a,this.rightGain=g,a?(b.connect(c,0,0),c.connect(d,0,0),b.connect(d,1,1)):
(b.connect(c,1,0),c.connect(d,0,1),b.connect(d,0,0))}else this._appliedGain=1,this.rightGain=this.leftGain=!1,c.disconnect(),b.disconnect(),b.connect(d,0,0),b.connect(d,1,1);if(f&&this.enabled&&this.onappliedgainchanged)this.onappliedgainchanged(this._appliedGain)}}get enabled(){return super.enabled}set enabled(a){if(a!==this.enabled&&(super.enabled=a,this.onappliedgainchanged))this.onappliedgainchanged(this.appliedGain)}get appliedGain(){return this.enabled?this._appliedGain:1}get pan(){return this._pan}set pan(a){a=
Math.max(-StereoPannerControl.maxAbsoluteValue,Math.min(StereoPannerControl.maxAbsoluteValue,a|0));this._pan!==a&&(this.slider.value=a,this.commitChanges(a))}saveSettings(){InternalStorage.saveStereoPannerSettings(this._pan)}}StereoPannerControl.maxAbsoluteValue=20;
class MonoDownMixerControl extends ConnectableNode{constructor(a){super();this._multiplier=.5;this.audioContext=a;this.audioNode=null;this.desiredEnabled=this.loaded=this.loading=!1}static isSupported(){return"AudioWorklet"in window&&"AudioWorkletNode"in window}get input(){return this.audioNode}get output(){return this.audioNode}get enabled(){return super.enabled}set enabled(a){MonoDownMixerControl.isSupported()||(a=!1);this.desiredEnabled=a;this.audioNode?super.enabled=a:a&&(this.loaded?this.createAudioNode():
this.load())}get multiplier(){return this._multiplier}set multiplier(a){this._multiplier=a;this.audioNode&&(this.audioNode.parameters.get("multiplier").value=a)}showError(a,b){Alert.show("Error while "+a+": "+(b?b.message||b.toString():"Unknown error"),!0)}load(){if(!this.loading&&!this.loaded&&this.audioContext){this.loading=!0;try{this.audioContext.audioWorklet.addModule("assets/js/monodownmixerprocessor.js?"+window.CACHE_VERSION).then(()=>{this.loading=!1;this.loaded=!0;this.createAudioNode()},
a=>{this.showError("loading the mono down-mixer script",a)})}catch(a){this.showError("loading the mono down-mixer script",a)}}}createAudioNode(){if(this.loaded){this.audioNode&&(this.audioNode.disconnect(),this.audioNode=null);try{const a=new AudioWorkletNode(this.audioContext,"monodownmixerprocessor");1!==a.numberOfInputs?(super.enabled=!1,this.showError("creating the mono down-mixer node","audioNode.numberOfInputs is "+a.numberOfInputs+", but should be 1")):1!==a.numberOfOutputs?(super.enabled=
!1,this.showError("creating the mono down-mixer node","audioNode.numberOfOutputs is "+a.numberOfOutputs+", but should be 1")):2!==a.channelCount?(super.enabled=!1,this.showError("creating the mono down-mixer node","audioNode.channelCount is "+a.channelCount+", but should be 2")):(this.audioNode=a,a.onprocessorerror=b=>{this.audioNode&&this.audioNode===a&&(a.disconnect(),super.enabled=!1,this.audioNode=null,this.showError("processing the mono down-mixer",b))},a.parameters.get("multiplier").value=this._multiplier,
super.enabled=this.desiredEnabled)}catch(a){super.enabled=!1,this.showError("creating the mono down-mixer node",a)}}}}
class Player{constructor(a,...b){this.audioContextTimeout=0;this.audioContextSuspended=!0;var c=navigator.userAgent&&0<=navigator.userAgent.indexOf("Firefox")?1:"playback";this.audioContext=window.AudioContext?new window.AudioContext({latencyHint:c}):new window.webkitAudioContext({latencyHint:c});this.audioContext.suspend();this.audioContext.onstatechange=this.audioContextStateChanged.bind(this);if(b&&b.length){c=Array(b.length);for(let d=0;d<b.length;d++)c[d]=b[d](this.audioContext)}else c=[];this.onerror=
this.oncurrenttimeschanged=this.onpausedchanged=this.onloadingchanged=this.onsongchanged=null;this.boundPlaybackError=this.playbackError.bind(this);this.boundNotifySongChanged=this.notifySongChanged.bind(this);this.boundCheckAudioContext=this.checkAudioContext.bind(this);this.audio=new Audio;this.audio.loop=!1;this.audio.controls=!1;this.audio.volume=1;b=this.playbackLoadStarted.bind(this);this.audio.onwaiting=b;this.audio.onloadstart=b;this.audio.oncanplay=this.playbackLoadEnded.bind(this);this.audio.onended=
this.playbackEnded.bind(this);this.audio.onerror=this.boundPlaybackError;this.audio.onpause=this.playbackPaused.bind(this);b=this.playbackStarted.bind(this);this.audio.onplay=b;this.audio.onplaying=b;b=this.playbackAborted.bind(this);this.audio.onabort=b;this.audio.onemptied=b;this.audio.ondurationchange=this.playbackLengthChanged.bind(this);this.audio.ontimeupdate=this.currentTimeChanged.bind(this);this.source=this.audioContext.createMediaElementSource(this.audio);this._alive=!0;this._loading=!1;
this._paused=!0;this._currentSong=this._playlist=null;this._volume=Player.maxVolume;this.lastObjectURL=null;this.volume=void 0===a?Player.maxVolume:a;this.sourceNode=new SourceNode(this.source);this.sourceNode.enabled=!0;this.destinationNode=new DestinationNode(this.audioContext.destination);this.destinationNode.enabled=!0;if(c.length){this.sourceNode.connectToDestination(c[0]);for(a=0;a<c.length-1;a++)c[a].connectToDestination(c[a+1]);c[c.length-1].connectToDestination(this.destinationNode)}else this.sourceNode.connectToDestination(this.destinationNode);
this.intermediateNodes=c;(this.mediaSession=a="mediaSession"in navigator&&"MediaMetadata"in window?navigator.mediaSession:null)&&"setActionHandler"in a&&(c=this.playPause.bind(this),a.setActionHandler("previoustrack",this.previous.bind(this)),a.setActionHandler("seekbackward",this.seekBackward.bind(this)),a.setActionHandler("pause",c),a.setActionHandler("play",c),a.setActionHandler("seekforward",this.seekForward.bind(this)),a.setActionHandler("nexttrack",this.next.bind(this)))}destroy(a){this.stop();
if(a){if(this._alive=!1,this.sourceNode.disconnectFromDestination(),(a=this.intermediateNodes)&&a.length)for(let b=0;b<a.length;b++)a[b].disconnectFromDestination()}else this._playlist&&this._playlist.destroy(),(a=this.mediaSession)&&"setActionHandler"in a&&(a.setActionHandler("previoustrack",null),a.setActionHandler("seekbackward",null),a.setActionHandler("pause",null),a.setActionHandler("play",null),a.setActionHandler("seekforward",null),a.setActionHandler("nexttrack",null)),zeroObject(this)}get alive(){return this._alive}get loading(){return this._loading}get paused(){return this._paused}get volume(){return this._volume}set volume(a){a|=
0;this._volume=0>=a?0:a>=Player.maxVolume?Player.maxVolume:a;this.audio&&(this.audio.volume=a?Math.pow(10,(this._volume-Player.maxVolume)/20):0)}get playlist(){return this._playlist}set playlist(a){this._alive&&(this.stop(),this._playlist=a)}get currentSong(){return this._currentSong}get currentTimeMS(){return this._currentSong?1E3*this.audio.currentTime|0:-1}audioContextStateChanged(){this._alive&&"running"!==this.audioContext.state&&!this.audioContextSuspended&&(this.audioContextSuspended=!0,this.playbackPaused())}playbackLoadStarted(){if(this._alive&&
!this._loading&&(this._loading=!0,this.onloadingchanged))this.onloadingchanged(!0)}playbackLoadEnded(){if(this._alive&&this._loading&&(this._loading=!1,this.onloadingchanged))this.onloadingchanged(!1)}playbackEnded(){this._alive&&this.next()}playbackError(a,b,c,d,e){if(this._alive&&(this.stop(),this.onerror))this.onerror(e?e.message?e.message:"string"===typeof e?e:e.toString():"string"===typeof a?a:Strings.UnknownError)}suspendAudioContext(a){this.audioContextTimeout&&(clearTimeout(this.audioContextTimeout),
this.audioContextTimeout=0);this.audioContextSuspended||(a?this.audioContextTimeout=window.setTimeout(this.boundCheckAudioContext,5E3):(this.audioContextSuspended=!0,this.audioContext.suspend()))}resumeAudioContext(){this.audioContextTimeout&&(clearTimeout(this.audioContextTimeout),this.audioContextTimeout=0);if(this.audioContextSuspended||"running"!==this.audioContext.state)this.audioContextSuspended=!1,this.audioContext.resume()}checkAudioContext(){this.audioContextTimeout=0;this._paused?this.audioContextSuspended||
(this.audioContextSuspended=!0,this.audioContext.suspend()):this.audioContextSuspended&&(this.audioContextSuspended=!1,this.audioContext.resume())}playbackPaused(){if(this._alive&&!this._paused){this._paused=!0;this.suspendAudioContext(!0);if(this.onpausedchanged)this.onpausedchanged(!0);App.hostInterface&&App.hostInterface.setPaused(!0)}}playbackStarted(){if(this._alive&&this._paused){this._paused=!1;this.resumeAudioContext();if(this.onpausedchanged)this.onpausedchanged(!1);App.hostInterface&&App.hostInterface.setPaused(!1)}}playbackAborted(){if(this._alive){if(this._loading&&
(this._loading=!1,this.onloadingchanged))this.onloadingchanged(!1);if(!this._paused){this._paused=!0;this.suspendAudioContext(!0);if(this.onpausedchanged)this.onpausedchanged(!0);App.hostInterface&&App.hostInterface.setPaused(!0)}}}playbackLengthChanged(){this._alive&&this.audio&&this._playlist&&this._currentSong&&(this._playlist.songLengthChanged(this._currentSong,this.audio.duration),this.mediaSession&&0<this.audio.duration&&"setPositionState"in this.mediaSession&&this.mediaSession.setPositionState({duration:this.audio.duration}))}currentTimeChanged(){if(this._alive&&
this.audio&&this._currentSong&&this.oncurrenttimeschanged)this.oncurrenttimeschanged(this.audio.currentTime)}notifySongChanged(){if(this._alive){const a=this._currentSong,b=this.mediaSession;b&&(a?(b.metadata=new window.MediaMetadata({title:a.title,artist:a.artist,album:a.album,artwork:[{src:"assets/images/albumArts/64x64.png",sizes:"64x64",type:"image/png"},{src:"assets/images/albumArts/96x96.png",sizes:"96x96",type:"image/png"},{src:"assets/images/albumArts/192x192.png",sizes:"192x192",type:"image/png"},
{src:"assets/images/albumArts/256x256.png",sizes:"256x256",type:"image/png"},{src:"assets/images/albumArts/512x512.png",sizes:"512x512",type:"image/png"}]}),0<a.lengthMS&&"setPositionState"in b&&b.setPositionState({duration:a.lengthMS/1E3})):b.playbackState="none");if(this.onsongchanged)this.onsongchanged(a)}}previous(){this._alive&&this._playlist&&(this._playlist.moveCurrentToPrevious(),this.play(-1))}seekBackward(){this._alive&&this.seekTo(-1E4,!0)}pause(){this._alive&&(this.suspendAudioContext(!1),
this._currentSong&&this.audio.pause())}play(a){if(this._alive){if(this._currentSong&&void 0===a){this.resumeAudioContext();var b=this.audio.play()}else if(this._playlist){void 0!==a&&0<=a&&(this._playlist.currentIndex=a);a=this._playlist.currentItem;!a&&this._playlist.length&&(this._playlist.moveCurrentToNext(),a=this._playlist.currentItem);if(!a){this.stop();return}this._currentSong=a;queueMicrotask(this.boundNotifySongChanged);for(this.resumeAudioContext();this.audio.firstChild;)this.audio.removeChild(this.audio.firstChild);
b=document.createElement("source");if(a.url&&!a.url.startsWith(FileUtils.localURLPrefix))b.src=a.url;else if(a.file)this.lastObjectURL&&URL.revokeObjectURL(this.lastObjectURL),this.lastObjectURL=URL.createObjectURL(a.file),b.src=this.lastObjectURL;else{if(a.url){this.pause();const c=this._playlist.currentIndex,d=this._playlist.currentItem;FileSystemAPI.getFile(a.url.substring(FileUtils.localURLPrefix.length)).then(e=>{d&&!d.file&&e&&(d.file=e);if(this._playlist&&c===this._playlist.currentIndex&&d===
this._playlist.currentItem)if(e)this.play(c);else if(this.stop(),this.onerror)this.onerror(Strings.FileNotFoundOrNoPermissionError)},()=>{if(this._playlist&&c===this._playlist.currentIndex&&d===this._playlist.currentItem&&(this.stop(),this.onerror))this.onerror(Strings.FileNotFoundOrNoPermissionError)})}else if(this.stop(),this.onerror)this.onerror(Strings.MissingSongError);return}b.onerror=this.boundPlaybackError;this.audio.appendChild(b);this.audio.load();b=this.audio.play()}b&&b.catch(Player.nop)}}playPause(){this._alive&&
(!this._currentSong||this.audio.paused?this.play():this.pause())}stop(){if(this._alive){if(this._currentSong){for(;this.audio.firstChild;)this.audio.removeChild(this.audio.firstChild);this.audio.load();this.lastObjectURL&&(URL.revokeObjectURL(this.lastObjectURL),this.lastObjectURL=null);if(this._loading&&(this._loading=!1,this.onloadingchanged))this.onloadingchanged(!1);if(!this._paused){this._paused=!0;if(this.onpausedchanged)this.onpausedchanged(!0);App.hostInterface&&App.hostInterface.setPaused(!0)}this._currentSong=
null;this.notifySongChanged()}this.suspendAudioContext(!1)}}seekForward(){this._alive&&this.seekTo(1E4,!0)}next(){this._alive&&this._playlist&&(this._playlist.moveCurrentToNext(),this.play(-1))}seekTo(a,b){this._alive&&this._currentSong&&!(0>=this._currentSong.lengthMS)&&this.audio.seekable&&this.audio.seekable.length&&(a=a/1E3+(b?this.audio.currentTime:0),this.audio.currentTime=a>this.audio.duration?this.audio.duration:0>=a?0:a)}}Player.maxVolume=40;Player.nop=function(){};
class InternalStorage{static async cacheGet(a,b){a=await caches.open(a);b=b?InternalStorage.playlistCachePrefix+b:InternalStorage.playlistCachePrefix;return(b=await a.match(b))?b.arrayBuffer():null}static async cachePut(a,b,c){a=await caches.open(a);b=b?InternalStorage.playlistCachePrefix+b:InternalStorage.playlistCachePrefix;return a.put(b,c)}static loadAppSettings(){try{const a=localStorage.getItem(InternalStorage.appSettingsName);if(a){const b=JSON.parse(a);if(b)return b}}catch(a){}return{playerVolume:100,
graphicalFilterControlEnabled:!1,graphicalFilterControlSimpleMode:544>window.innerWidth,stereoPannerControlEnabled:!1,monoDownMixerControlEnabled:!1}}static saveAppSettings(a){const b=localStorage.getItem(InternalStorage.appSettingsName);a?(a=JSON.stringify(a),b!==a&&localStorage.setItem(InternalStorage.appSettingsName,a)):b&&localStorage.removeItem(InternalStorage.appSettingsName)}static loadGraphicalFilterEditorSettings(){try{const a=localStorage.getItem(InternalStorage.graphicalFilterEditorSettingsName);
if(a){const b=JSON.parse(a);if(b)return b}}catch(a){}return{currentChannelIndex:0,editMode:GraphicalFilterEditorControl.editModeShelfEq,isActualChannelCurveNeeded:!0,isNormalized:!1,isSameFilterLR:!0,showZones:!0}}static saveGraphicalFilterEditorSettings(a){const b=localStorage.getItem(InternalStorage.graphicalFilterEditorSettingsName);a?(a=JSON.stringify(a),b!==a&&localStorage.setItem(InternalStorage.graphicalFilterEditorSettingsName,a)):b&&localStorage.removeItem(InternalStorage.graphicalFilterEditorSettingsName)}static loadStereoPannerSettings(){return Math.max(-StereoPannerControl.maxAbsoluteValue,
Math.min(StereoPannerControl.maxAbsoluteValue,parseInt(localStorage.getItem(InternalStorage.stereoPannerSettingsName))|0))}static saveStereoPannerSettings(a){const b=localStorage.getItem(InternalStorage.stereoPannerSettingsName);a=(a|0).toString();b!==a&&localStorage.setItem(InternalStorage.stereoPannerSettingsName,a)}static async loadPlaylist(a){a=await InternalStorage.cacheGet(InternalStorage.playlistCacheName,a);if(!a)return null;try{return Playlist.deserialize(new DataReader(a))}catch(b){return null}}static loadPlaylistWeb(a){return(a=
localStorage.getItem(a||InternalStorage.defaultPlaylistName))?Playlist.deserializeWeb(a):null}static savePlaylist(a,b){if(!b){if(!a.modified)return Promise.resolve();a.modified=!1}return InternalStorage.cachePut(InternalStorage.playlistCacheName,b,new Response(a.serialize().trimmedArrayBuffer))}static savePlaylistWeb(a,b){if(!b){if(!a.modified)return;a.modified=!1}return localStorage.setItem(b||InternalStorage.defaultPlaylistName,JSON.stringify(a.serializeWeb()))}}
InternalStorage.playlistCachePrefix="https://fplay.com.br/";InternalStorage.playlistCacheName="playlists";InternalStorage.appSettingsName="appSettings";InternalStorage.graphicalFilterEditorSettingsName="graphicalFilterEditorSettings";InternalStorage.stereoPannerSettingsName="stereoPannerSettings";InternalStorage.defaultPlaylistName="defaultPlaylist";
class Modal{constructor(a){this.options=a;this.focusBlocker=new FocusBlocker;this.focusBlocker.block();HistoryHandler.pushState();const b=document.createElement("div");this.containerElement=b;b.className=a.transparentBackground?"modal-container fade":"modal-container fade background";const c=document.createElement("form");this.modalElement=c;c.className="modal"+(a.fullHeight?" full-height":"");c.onsubmit=this.submit.bind(this);var d=document.createElement("div");this.modalHeaderElement=d;d.className=
"modal-header padding"+(a.rightHeader?" right":"");a.title?"string"===typeof a.title?d.innerHTML=a.title:d.appendChild(a.title):d.innerHTML=a.titleStringKey?Strings.translate(a.titleStringKey):Strings.Oops;const e=document.createElement("div");this.modalBodyElement=e;e.className="modal-body"+(a.leftBody?" left":"");a.html||(a.html=document.createElement("div"),a.text&&Strings.changeText(a.html,a.text));if("string"===typeof a.html)e.innerHTML=a.html;else if(Array.isArray(a.html)){var f=a.html;for(var g=
0;g<f.length;g++)e.appendChild(f[g])}else e.appendChild(a.html);if((f=e.getElementsByTagName("button"))&&f.length)for(g=f.length-1;0<=g;g--){const k=f[g];ButtonControl.prepare(k);k.onclick=()=>{if(!this.fading&&this.options.onbuttonclick)this.options.onbuttonclick(k.id,k)}}this.modalFooterElement=f=document.createElement("div");f.className="modal-footer padding left-margin right-margin"+(a.buttons&&1===a.buttons.length?" right":"");this.defaultSubmitButton=this.defaultCancelButton=null;if(a.buttons)for(g=
0;g<a.buttons.length;g++){const k=a.buttons[g],h=ButtonControl.create(k,!0);k.defaultCancel&&(this.defaultCancelButton=h);k.defaultSubmit&&(this.defaultSubmitButton=h);g&&(h.style.float="right");h.onclick=()=>{if(!this.fading){if(k.onclick)k.onclick(k.id,h);if(this.options.onbuttonclick)this.options.onbuttonclick(k.id,h)}};f.appendChild(h)}c.appendChild(d);if(a.skipBody)for(;e.firstChild;)d=e.firstChild,e.removeChild(d),c.appendChild(d);else c.appendChild(e);c.appendChild(f);b.appendChild(c);document.body.appendChild(b);
this.boundDocumentKeyDown=this.documentKeyDown.bind(this);document.addEventListener("keydown",this.boundDocumentKeyDown,!0);this.fading=!0;DelayControl.delayShortCB(()=>{if(a.onshowing)a.onshowing();this.containerElement.classList.add("in");DelayControl.delayUICB(()=>{this.fading=!1;if(this.options.onshown)this.options.onshown()})})}static get visible(){return!!Modal.modal}static get currentModalElement(){return Modal.modal?Modal.modal.modalElement:null}static get currentModalHeaderElement(){return Modal.modal?
Modal.modal.modalHeaderElement:null}static get currentModalBodyElement(){return Modal.modal?Modal.modal.modalBodyElement:null}static get currentModalFooterElement(){return Modal.modal?Modal.modal.modalFooterElement:null}static show(a){if(Modal.modal)return!1;a.okCancel?a.buttons=[{id:"cancel",defaultCancel:!0,icon:"icon-clear",text:a.cancelText||Strings.Cancel,color:"red",onclick:a.oncancel||Modal.hide},{id:"ok",defaultSubmit:a.okCancelSubmit,icon:"icon-check",text:a.okText||Strings.OK,color:"green",
onclick:a.onok||Modal.hide}]:a.buttons&&a.buttons.length||(a.buttons=[{id:"cancel",defaultCancel:!0,icon:"icon-clear",text:Strings.Close,onclick:Modal.hide}]);Modal.modal=new Modal(a);return!0}static hide(){Modal.modal&&Modal.modal.hideInternal()}static defaultCancelAction(){return Modal.modal?Modal.modal.defaultCancelActionInternal():!1}static historyStatePopped(){if(!Modal.modal)return null;Modal.modal.fading||Modal.defaultCancelAction();return!1}hideInternal(){Modal.modal!==this||this.fading||
this.options.onhiding&&!1===this.options.onhiding()||(document.removeEventListener("keydown",this.boundDocumentKeyDown,!0),this.fading=!0,this.containerElement.classList.remove("in"),DelayControl.delayUICB(()=>{Modal.modal=null;if(this.options.onhidden)this.options.onhidden();document.body.removeChild(this.containerElement);HistoryHandler.popState();this.focusBlocker&&this.focusBlocker.unblock();if(this.options.buttons)for(let a=this.options.buttons.length-1;0<=a;a--)zeroObject(this.options.buttons[a]);
zeroObject(this.options);zeroObject(this)}))}documentKeyDown(a){"Escape"===a.key&&this.defaultCancelActionInternal()}defaultCancelActionInternal(){return this.defaultCancelButton?(this.defaultCancelButton.click(),!0):!1}submit(a){cancelEvent(a);this.defaultSubmitButton&&this.defaultSubmitButton.click();return!1}}Modal.modal=null;
class FilePickerListAdapter extends ListAdapter{constructor(a){super(a)}get itemHeight(){return AppUI.buttonSizePX}createEmptyElement(a){const b=document.createElement("div");b.className=a;CheckboxControl.create({stringKey:"Selected",checkbox0Color:"pink",checkbox1Color:"green",square:!0,keyboardFocusable:!1,parent:b}).setAttribute("data-check","1");ButtonControl.create({icon:"icon-clear",text:Strings.Delete,color:"red",square:!0,keyboardFocusable:!1,className:"no-left-margin",parent:b}).setAttribute("data-delete",
"1");b.appendChild(Icon.createLarge("icon-folder","orange button-top-margin margin"));b.appendChild(Icon.createLarge("icon-add-folder","green button-top-margin margin small-left-margin"));b.appendChild(document.createTextNode(Formatter.none));return b}prepareElement(a,b,c,d){b=d.childNodes;a.root?(b[0].classList.add("hidden"),a.path?b[3].classList.add("hidden"):b[3].classList.remove("hidden")):(c=b[0],c.classList.remove("hidden"),a.dir?c.classList.remove("small-right-margin"):c.classList.add("small-right-margin"),
CheckboxControl.setChecked(c,a.selected),b[3].classList.add("hidden"));a.deletable?b[1].classList.remove("hidden"):b[1].classList.add("hidden");a.dir?(c=b[2],c.classList.remove("hidden"),a.root&&!a.deletable?c.classList.add("small-left-margin"):c.classList.remove("small-left-margin")):b[2].classList.add("hidden");b[4].nodeValue=a.name}prepareElementIndexOrLengthChanged(a,b,c,d){}}
class FilePicker{constructor(a){const b=document.createElement("div");ButtonControl.create({color:"orange",icon:"icon-up",text:Strings.Up,parent:b,onclick:this.navigateUp.bind(this)});ButtonControl.create({icon:"icon-checkbox-1",text:Strings.All,parent:b,onclick:this.toggleAll.bind(this)});const c=document.createElement("div");c.className="file-picker-path padding border-bottom left";const d=Icon.createLarge("icon-folder-open","orange hidden");c.appendChild(d);const e=document.createElement("i");
e.className="icon loading large";c.appendChild(e);const f=document.createElement("div");f.className="file-picker-path-element small-left-padding";c.appendChild(f);const g=document.createElement("div");g.className="file-picker-list fade bottom-margin";this.resolve=a;this.provider=App.hostType===App.hostTypeAndroid?new FilePickerAndroidProvider:new FilePickerFileSystemAPIProvider;this.list=new List;this.listAdapter=new FilePickerListAdapter(this.list);this.listControl=new ListControl(g,!0);this.listControl.onitemclicked=
this.itemClicked.bind(this);this.listControl.onitemcontrolclicked=this.itemControlClicked.bind(this);this.listControl.adapter=this.listAdapter;this.selectedFiles=null;this.fading=this.gettingFiles=!1;this.providerVersion=0;this.path=FilePicker.lastPath;this.rootLength=FilePicker.lastRootLength;this.iconFolder=d;this.iconLoading=e;this.pathElement=f;this.boundRefreshRoot=this.refreshRoot.bind(this);this.updatePathElement(this.path);if(!Modal.show({html:[c,g],title:b,rightHeader:!0,leftBody:!0,skipBody:!0,
fullHeight:!0,okCancel:!0,onshown:this.modalShown.bind(this),onhiding:this.modalHiding.bind(this),onhidden:this.modalHidden.bind(this),onok:this.modalOk.bind(this)}))throw Error("Assertion error: Modal.show() === false");}static isSupported(){return!!App.hostInterface||FileSystemAPI.isSupported()}static get visible(){return!!FilePicker.filePicker}static show(){return FilePicker.filePicker||Modal.visible?Promise.resolve(null):new Promise(function(a){FilePicker.filePicker=new FilePicker(a)})}updatePathElement(a){a&&
a.endsWith("/")&&(a=a.substring(0,a.length-1));Strings.changeText(this.pathElement,a||Strings.Storage);return a}updateIconLoading(a){this.iconFolder&&this.iconLoading&&(a?(this.iconFolder.classList.add("hidden"),this.iconLoading.classList.remove("hidden")):(this.iconLoading.classList.add("hidden"),this.iconFolder.classList.remove("hidden")))}itemClicked(a,b,c){this.gettingFiles||this.fading||(a.root&&!a.path&&this.provider.editableRoots()?(this.updateIconLoading(!0),this.provider.addNewRoot().then(this.boundRefreshRoot,
this.boundRefreshRoot)):a.dir?this.navigate(a.path):this.listControl&&(a.selected=!a.selected,this.listControl.refreshVisibleItems()))}itemControlClicked(a,b,c,d){if(!this.gettingFiles&&!this.fading){if("SPAN"===d.tagName&&(d=d.parentNode,!d))return;d.getAttribute("data-check")?a.selected=CheckboxControl.isChecked(d):d.getAttribute("data-delete")&&(this.updateIconLoading(!0),this.provider.removeRoot(a).then(this.boundRefreshRoot,this.boundRefreshRoot))}}refreshRoot(a){this.path||(!0===a?this.navigate(null):
this.updateIconLoading(!1))}finishNavigation(a){!this.path&&this.provider.editableRoots()&&a.push({name:Strings.AddMoreFolders,dir:0,path:"",root:!0,deletable:!1});this.updateIconLoading(!1);a.length&&(this.list.addItems(a),this.listControl.element.classList.add("in"))}navigate(a){if(FilePicker.filePicker===this&&!this.gettingFiles&&!this.fading){var b=!this.path;this.path=a=this.updatePathElement(a);b&&(this.rootLength=a?a.length:0);this.providerVersion++;var c=this.providerVersion;this.updateIconLoading(!0);
var d=null;this.listControl.element.classList.contains("in")&&(this.fading=!0,this.listControl.element.classList.remove("in"),DelayControl.delayUICB(()=>{FilePicker.filePicker===this&&this.provider&&c===this.providerVersion&&(this.list.clear(),this.fading=!1,d&&this.finishNavigation(d))}));this.provider.navigate(a).then(e=>{FilePicker.filePicker===this&&this.provider&&c===this.providerVersion&&(d=e||[],this.fading||this.finishNavigation(d))},e=>{FilePicker.filePicker===this&&this.provider&&c===this.providerVersion&&
(this.updateIconLoading(!1),Alert.show(e.message||("string"===typeof e.error?e.error:e.error&&e.error.message||e.toString()),!0))})}}navigateUp(){let a=this.path,b;!a||0>=(b=a.lastIndexOf("/"))?this.navigate(null):(a=a.substring(0,b),this.navigate(a.length<this.rootLength?null:a))}toggleAll(){if(FilePicker.filePicker===this&&!this.gettingFiles&&!this.fading){var a=this.list,b=!1;for(var c=a.length-1;0<=c;c--)if(!a.item(c).selected){b=!0;break}for(c=a.length-1;0<=c;c--)a.item(c).selected=b;this.listControl.refreshVisibleItems()}}modalShown(){this.navigate(this.path)}modalHiding(){if(FilePicker.filePicker!==
this)return!0;FilePicker.filePicker=null;this.provider&&this.provider.destroy();return!0}modalHidden(){const a=this.resolve,b=this.selectedFiles;this.selectedFiles=null;zeroObject(this);a&&a(b)}modalOk(){if(FilePicker.filePicker===this&&!this.gettingFiles&&!this.fading){var a=[],b=[],c=this.list,d=c.length;if(this.path)for(let f=0;f<d;f++){const g=c.item(f);g.selected&&(g.dir?a:b).push(g)}if(this.path&&(a.length||b.length)){FilePicker.lastPath=this.path;FilePicker.lastRootLength=this.rootLength;this.gettingFiles=
!0;this.providerVersion++;var e=this.providerVersion;this.updateIconLoading(!0);this.provider.getFiles(a,b).then(f=>{FilePicker.filePicker===this&&this.provider&&e===this.providerVersion&&(this.selectedFiles=f,Modal.hide())},f=>{FilePicker.filePicker===this&&this.provider&&e===this.providerVersion&&(this.updateIconLoading(!1),this.gettingFiles=!1,Alert.show(f.message||("string"===typeof f.error?f.error:f.error&&f.error.message||f.toString()),!0))})}else Alert.show(Strings.NothingSelected)}}}
FilePicker.filePicker=null;FilePicker.lastPath=null;FilePicker.lastRootLength=0;
class AppUI{static preparePlaylist(){if(App.player&&AppUI.playlistControl){var a=App.player.playlist;a?(a.onsonglengthchanged=AppUI.playlistSongLengthChanged,AppUI.playlistControl.adapter=new PlaylistAdapter(a)):AppUI.playlistControl.adapter=null}}static adjustDecimal(a){var b=!0;let c=a.toFixed(5);for(c=c.substring(0,c.length-1);;){var d=c.charAt(c.length-1),e=c.charAt(c.length-2);if(d===e){if("0"!==d&&(c=c.padEnd(24,d),"9"===d&&b)){c=parseFloat(c).toFixed(5);b=!1;continue}}else if(b=c.lastIndexOf("."),
d=c.substring(b+1,b+1+2),e=c.substring(b+3,b+3+2),d===e)for(c=c.substring(0,b+1);24>c.length;)c+=d;else if(c=a.toFixed(7),b=c.lastIndexOf("."),d=c.substring(b+1,b+1+3),e=c.substring(b+4,b+4+3),d===e)for(c=c.substring(0,b+1);24>c.length;)c+=d;else c=a.toFixed(18);break}return c.replace(/0+$/,"").replace(/[,\.]$/,"")}static adjustWindow(){var a=App.hostInterface?AppUI.baseSizePX*(AppUI._fontScale=App.hostInterface.getFontScale()):.125*AppUI.ruler.getBoundingClientRect().height;if(AppUI.devicePixelRatio!==
devicePixelRatio||AppUI._1remInPX!==a){AppUI.devicePixelRatio=devicePixelRatio;AppUI._1remInPX=a;App.hostInterface?document.documentElement.style.fontSize=a!==AppUI.baseSizePX?a+"px":"":AppUI._fontScale=AppUI._1remInPX/AppUI.baseSizePX;var b=AppUI.adjustDecimal(AppUI.remToPX(AppUI.contentsSizeREM));AppUI._contentsSizePX=parseFloat(b);AppUI._buttonSizePX=AppUI._contentsSizePX+(AppUI.primaryInputIsTouch?AppUI.s6PX:AppUI.s2PX);a=Icon.baseSizePX/devicePixelRatio;var c=AppUI._contentsSizePX/a|0;0>=c?(a=
b,AppUI._smallIconSizePX=AppUI._contentsSizePX,AppUI._largeIconSizePX=AppUI._contentsSizePX):1===c?(b=a=AppUI.adjustDecimal(a),AppUI._smallIconSizePX=parseFloat(a),AppUI._largeIconSizePX=AppUI._smallIconSizePX):(a=AppUI.adjustDecimal(Math.max(c>>1&-2,1)*Icon.baseSizePX/devicePixelRatio),b=AppUI.adjustDecimal((c&-2)*Icon.baseSizePX/devicePixelRatio),AppUI._smallIconSizePX=parseFloat(a),AppUI._largeIconSizePX=parseFloat(b));var d=(AppUI.baseThinBorderPX*devicePixelRatio|0)/devicePixelRatio;d||(d=1);
c=AppUI.adjustDecimal(d);AppUI._thinBorderPX=parseFloat(c);(d=(AppUI.baseThickBorderPX*devicePixelRatio|0)/devicePixelRatio)||(d=1);d=AppUI.adjustDecimal(d);AppUI._thickBorderPX=parseFloat(d);const e=AppUI.adjustDecimal(3*AppUI.remToPX(AppUI.smallContentsSizeREM)+AppUI.s2PX);AppUI._playlistItemSizePX=parseFloat(e);AppUI.rootVariables.textContent=`:root {
				--button-size: ${AppUI._buttonSizePX}px;
				--button-padding: ${AppUI.adjustDecimal(.5*(AppUI._buttonSizePX-AppUI._contentsSizePX))}px;
				--negative-button-padding: -${AppUI.adjustDecimal(.5*(AppUI._buttonSizePX-AppUI._contentsSizePX))}px;
				--icon-size: ${a}px;
				--icon-padding: ${AppUI.adjustDecimal(.5*(AppUI._contentsSizePX-AppUI._smallIconSizePX))}px;
				--large-icon-size: ${b}px;
				--large-icon-padding: ${AppUI.adjustDecimal(.5*(AppUI._contentsSizePX-AppUI._largeIconSizePX))}px;
				--thin-border: ${c}px;
				--thick-border: ${d}px;
				--scrollbar-size: ${AppUI.primaryInputIsTouch?20:12}px;
				--playlist-item-size: ${e}px;
			}`;for(a=AppUI.zoomHandlers.length-1;0<=a;a--)AppUI.zoomHandlers[a]()}}static changeZoom(a){if(AppUI.webFrame)if(a=(1<=devicePixelRatio?1+Math.ceil(4*devicePixelRatio):.51>=devicePixelRatio?0:.67>=devicePixelRatio?1:.76>=devicePixelRatio?2:.81>=devicePixelRatio?3:4)+a,0>=a)AppUI.webFrame.setZoomFactor(.5);else if(21<=a)AppUI.webFrame.setZoomFactor(5);else switch(a){case 1:AppUI.webFrame.setZoomFactor(2/3);break;case 2:AppUI.webFrame.setZoomFactor(.75);break;case 3:AppUI.webFrame.setZoomFactor(.8);
break;case 4:AppUI.webFrame.setZoomFactor(.9);break;default:AppUI.webFrame.setZoomFactor((a-1)/4)}}static globalKeyHandler(a){if(a.ctrlKey||a.metaKey){if(AppUI.webFrame)switch(a.key){case "-":return a.repeat||AppUI.changeZoom(-1),cancelEvent(a);case "+":case "=":return a.repeat||AppUI.changeZoom(1),cancelEvent(a);case "0":return cancelEvent(a)}}else switch(a.key){case "Escape":return a.repeat||(Modal.visible?Modal.hide():App.player&&App.player.playPause()),cancelEvent(a);case "F1":return!a.repeat&&
App.player&&App.player.previous(),cancelEvent(a);case "F2":return!a.repeat&&App.player&&App.player.playPause(),cancelEvent(a);case "F3":return!a.repeat&&App.player&&App.player.stop(),cancelEvent(a);case "F4":return!a.repeat&&App.player&&App.player.next(),cancelEvent(a)}}static historyStatePopped(){if(!AppUI.playlistControl||!AppUI.playlistControl.deleteMode)return null;AppUI.toggleDeleteMode(!1);return!0}static preInit(a,b){AppUI.webFrame=a;window.addEventListener("keydown",AppUI.globalKeyHandler,
!0);a&&b.devicePixelRatio&&b.devicePixelRatio!==devicePixelRatio&&a.setZoomFactor(b.devicePixelRatio);FilePicker.isSupported()&&(FilePicker.lastPath=b.filePickerLastPath||null,FilePicker.lastRootLength=b.filePickerRootLength||0,a=document.getElementById("add-folder-button"),a.parentNode.removeChild(a));ButtonControl.init();CheckboxControl.init();AppUI.seekSlider=new SliderControl("seek-slider",!1,!1,0,1);AppUI.seekSlider.disabled=!0;AppUI.seekSlider.onvaluechanged=AppUI.seekSliderValueChanged;AppUI.seekSlider.ondragended=
AppUI.seekSliderDragEnded;AppUI.currentTimeLabel=document.createElement("span");AppUI.currentTimeLabel.className="seek-label";AppUI.currentTimeS=0;Strings.changeText(AppUI.currentTimeLabel,Formatter.none);AppUI.seekSlider.leftChild=AppUI.currentTimeLabel;AppUI.songLengthLabel=document.createElement("span");AppUI.songLengthLabel.className="seek-label";Strings.changeText(AppUI.songLengthLabel,Formatter.none);AppUI.seekSlider.rightChild=AppUI.songLengthLabel;AppUI.volumeSlider=new SliderControl("volume-slider",
!0,!1,0,Player.maxVolume,b.playerVolume);AppUI.volumeSlider.leftChild=Icon.createLarge("icon-volume","green small-right-margin");AppUI.volumeLabel=document.createElement("span");AppUI.volumeLabel.className="small-left-margin";AppUI.volumeLabel.setAttribute("id","volume-label");Strings.changeText(AppUI.volumeLabel,AppUI.volumeStr(AppUI.volumeSlider.value));AppUI.volumeSlider.rightChild=AppUI.volumeLabel;AppUI.volumeSlider.onvaluechanged=AppUI.volumeSliderValueChanged;AppUI.playlistControl=new ListControl("playlist-control",
!0);AppUI.playlistControl.onitemclicked=AppUI.playlistControlItemClicked;AppUI.playlistControl.onitemcontextmenu=AppUI.playlistControlItemContextMenu;AppUI.graphicalFilterControlType=document.getElementById("graphical-filter-control-type");ButtonControl.setText(AppUI.graphicalFilterControlType,b.graphicalFilterControlSimpleMode?Strings.TraditionalFilter:Strings.AdvancedFilter);AppUI.graphicalFilterControlType.onclick=AppUI.graphicalFilterControlTypeClicked;AppUI.graphicalFilterControlEnabled=document.getElementById("graphical-filter-control-enabled");
AppUI.graphicalFilterControlEnabled.checked=b.graphicalFilterControlEnabled||!1;AppUI.graphicalFilterControlEnabled.onclick=AppUI.graphicalFilterControlEnabledClicked;AppUI.stereoPannerControlEnabled=document.getElementById("stereo-panner-control-enabled");AppUI.stereoPannerControlEnabled.checked=b.stereoPannerControlEnabled||!1;AppUI.stereoPannerControlEnabled.onclick=AppUI.stereoPannerControlEnabledClicked;MonoDownMixerControl.isSupported()?(AppUI.monoDownMixerControlEnabled=document.getElementById("mono-down-mixer-control-enabled"),
AppUI.monoDownMixerControlEnabled.checked=b.monoDownMixerControlEnabled||!1,AppUI.monoDownMixerControlEnabled.onclick=AppUI.monoDownMixerControlEnabledClicked):(b=document.getElementById("mono-down-mixer-control-container"),b.parentNode.removeChild(b));App.frameless&&AppUI.panelContainer.classList.remove("web");window.addEventListener("resize",AppUI.adjustWindow,{passive:!0});AppUI.adjustWindow()}static init(a){App.player&&(AppUI.volumeSlider.value=App.player.volume,App.player.onsongchanged=AppUI.playerSongChanged,
App.player.onloadingchanged=AppUI.playerLoadingChanged,App.player.onpausedchanged=AppUI.playerPausedChanged,App.player.oncurrenttimeschanged=AppUI.playerCurrentTimeSChanged,App.player.onerror=AppUI.playerError,AppUI.preparePlaylist(),AppUI.playerSongChanged(App.player.currentSong),AppUI.centerCurrentSongIntoView(),HistoryHandler.init(Menu.historyStatePopped,Modal.historyStatePopped,AppUI.historyStatePopped))}static centerCurrentSongIntoView(){App.player&&App.player.playlist&&0<=App.player.playlist.currentIndex&&
AppUI.playlistControl.centerItemIntoView(App.player.playlist.currentIndex)}static destroy(){zeroObject(AppUI)}static get loading(){return AppUI._loading}static get fontScale(){return AppUI._fontScale}static get smallIconSizePX(){return AppUI._smallIconSizePX}static get largeIconSizePX(){return AppUI._largeIconSizePX}static get thinBorderPX(){return AppUI._thinBorderPX}static get thickBorderPX(){return AppUI._thickBorderPX}static get buttonSizePX(){return AppUI._buttonSizePX}static get contentsSizePX(){return AppUI._contentsSizePX}static get playlistItemSizePX(){return AppUI._playlistItemSizePX}static addZoomHandler(a){a&&
AppUI.zoomHandlers.push(a)}static removeZoomHandler(a){if(a)for(let b=AppUI.zoomHandlers.length-1;0<=b;b--)if(AppUI.zoomHandlers[b]===a){AppUI.zoomHandlers.splice(b,1);break}}static factorToZoom(a){return 1>=a?0:Math.round(4*a)-4}static zoomToFactor(a){return 0>=a?1:.25*(a+4)}static remToPX(a){return a*AppUI._1remInPX}static pxToREM(a){return a/AppUI._1remInPX}static playerSongChanged(a){App.player&&AppUI.playlistControl&&(Strings.changeText(AppUI.titleLabel,a&&a.title||Formatter.none),Strings.changeText(AppUI.artistLabel,
a&&a.artist||Formatter.none),App.player.playlist&&0<=App.player.playlist.currentIndex&&!AppUI.playlistControl.deleteMode&&AppUI.playlistControl.bringItemIntoView(App.player.playlist.currentIndex),AppUI.currentTimeS=0,a?(Strings.changeText(AppUI.currentTimeLabel,Formatter.zero),Strings.changeText(AppUI.songLengthLabel,a.length),AppUI.seekSlider&&(AppUI.seekSlider.value=0,0<a.lengthMS?(AppUI.seekSlider.disabled=!1,AppUI.seekSlider.max=a.lengthMS):AppUI.seekSlider.disabled=!0)):(Strings.changeText(AppUI.currentTimeLabel,
Formatter.none),Strings.changeText(AppUI.songLengthLabel,Formatter.none),AppUI.seekSlider&&(AppUI.seekSlider.disabled=!0,AppUI.seekSlider.value=0)))}static playerLoadingChanged(a){App.updateLoadingIcon()}static playerPausedChanged(a){AppUI.iconPlay&&AppUI.iconPause&&(a?(AppUI.iconPause.classList.add("hidden"),AppUI.iconPlay.classList.remove("hidden")):(AppUI.iconPlay.classList.add("hidden"),AppUI.iconPause.classList.remove("hidden")))}static playerCurrentTimeSChanged(a){if(AppUI.seekSlider&&!AppUI.seekSlider.dragging){var b=
a|0;AppUI.currentTimeS!==b&&(AppUI.currentTimeS=b,Strings.changeText(AppUI.currentTimeLabel,Formatter.formatTimeS(b)));AppUI.seekSlider.value=1E3*a}}static playerError(a){Modal.show({text:a})}static playlistSongLengthChanged(a){App.player&&(a===App.player.currentSong&&(Strings.changeText(AppUI.songLengthLabel,a.length),AppUI.seekSlider&&(0<a.lengthMS?(AppUI.seekSlider.disabled=!1,AppUI.seekSlider.max=a.lengthMS):(AppUI.seekSlider.value=0,AppUI.seekSlider.disabled=!0))),AppUI.playlistControl&&AppUI.playlistControl.refreshVisibleItems())}static seekSliderValueChanged(a){AppUI.seekSlider&&
AppUI.seekSlider.dragging&&(a=a/1E3|0,AppUI.currentTimeS!==a&&(AppUI.currentTimeS=a,Strings.changeText(AppUI.currentTimeLabel,Formatter.formatTimeS(a))))}static seekSliderDragEnded(a){App.player&&App.player.currentSong&&App.player.seekTo(a)}static volumeStr(a){return(a>=Player.maxVolume?"-0":a?a-Player.maxVolume:GraphicalFilterEditorStrings.MinusInfinity)+" dB"}static volumeSliderValueChanged(a){App.player&&(App.player.volume=a);AppUI.volumeLabel&&Strings.changeText(AppUI.volumeLabel,AppUI.volumeStr(a))}static playlistControlItemClicked(a,
b,c){App.player&&!c&&App.player.play(b)}static playlistControlItemContextMenu(a,b){}static graphicalFilterControlTypeClicked(){App.graphicalFilterControl&&(App.graphicalFilterControl.simpleMode=!App.graphicalFilterControl.simpleMode,ButtonControl.setText(AppUI.graphicalFilterControlType,App.graphicalFilterControl.simpleMode?Strings.TraditionalFilter:Strings.AdvancedFilter))}static graphicalFilterControlEnabledClicked(){App.graphicalFilterControl&&(App.graphicalFilterControl.enabled=AppUI.graphicalFilterControlEnabled.checked)}static stereoPannerControlEnabledClicked(){App.stereoPannerControl&&
(App.stereoPannerControl.enabled=AppUI.stereoPannerControlEnabled.checked)}static monoDownMixerControlEnabledClicked(){App.monoDownMixerControl&&(App.monoDownMixerControl.enabled=AppUI.monoDownMixerControlEnabled.checked)}static hideTopMessage(){0>AppUI.topMessageFading||!AppUI.topMessage||(AppUI.topMessageTimeout&&clearTimeout(AppUI.topMessageTimeout),AppUI.topMessageFading=-1,AppUI.topMessage.classList.remove("in"),AppUI.topMessageTimeout=DelayControl.delayUICB(function(){0<=AppUI.topMessageFading||
(AppUI.topMessageFading=0,AppUI.topMessageTimeout=0,AppUI.topMessage.style.visibility="",AppUI.topMessage.innerHTML="",AppUI.titleLabel&&AppUI.titleLabel.classList.remove("behind"),AppUI.artistLabel&&AppUI.artistLabel.classList.remove("behind"))}))}static showTopMessage(a,b){AppUI.topMessage&&(AppUI.topMessageTimeout&&clearTimeout(AppUI.topMessageTimeout),AppUI.topMessageFading=1,AppUI.titleLabel&&AppUI.titleLabel.classList.add("behind"),AppUI.artistLabel&&AppUI.artistLabel.classList.add("behind"),
AppUI.topMessage.innerHTML=a,b&&b(AppUI.topMessage),AppUI.topMessage.style.visibility="visible",AppUI.topMessageTimeout=DelayControl.delayShortCB(function(){0>=AppUI.topMessageFading||1!==AppUI.topMessageFading||(AppUI.topMessageFading=2,AppUI.topMessage.classList.add("in"),AppUI.topMessageTimeout=DelayControl.delayUICB(function(){2===AppUI.topMessageFading&&(AppUI.topMessageFading=0,AppUI.topMessageTimeout=0)}))}))}static async addFiles(a){if(App.player&&!AppUI._loading&&!Modal.visible&&!FilePicker.visible){var b=
App.hostType===App.hostTypeElectron;if((a=FilePicker.isSupported()?await FilePicker.show():await App.showOpenDialogWeb(a))&&App.player)try{AppUI._loading=!0;App.updateLoadingIcon();App.player.playlist||(App.player.playlist=new Playlist,AppUI.preparePlaylist());const c=App.player.playlist,d=b?null:new Uint8Array(BufferedFileHandle.minBufferLength<<1),e=b?null:[new Uint8Array(256)];let f=!1;for(let g=0;g<a.length&&App.player;g++)if(b)await c.addSong(a[g]);else{const k=c.length;await c.addSongWeb(a[g],
d,e)&&k===c.length&&(f=!0)}f&&AppUI.playlistControl&&AppUI.playlistControl.refreshVisibleItems()}catch(c){Modal.show({text:"addFiles error: "+(c.message||c.toString())})}finally{AppUI._loading=!1,App.updateLoadingIcon()}}}static toggleDeleteMode(a){AppUI.playlistControl&&(AppUI.playlistControl.deleteMode?(AppUI.playlistControl.deleteMode=!1,AppUI.hideTopMessage(),a&&HistoryHandler.popState()):(AppUI.playlistControl.deleteMode=!0,AppUI.showTopMessage(Strings.DeleteModeHTML,function(b){const c=document.createElement("div");
ButtonControl.create({color:"red",icon:"icon-delete-all",text:Strings.DeleteAllSongs,parent:c,onclick:function(){App.player&&App.player.playlist&&App.player.playlist.clear();AppUI.playlistControl&&AppUI.playlistControl.deleteMode&&AppUI.toggleDeleteMode(!0)}});ButtonControl.create({color:"green",icon:"icon-check",text:Strings.Done,parent:c,onclick:function(){AppUI.playlistControl&&AppUI.playlistControl.deleteMode&&AppUI.toggleDeleteMode(!0)}});b.appendChild(c)}),HistoryHandler.pushState()))}static switchView(){AppUI.panelContainer&&
AppUI.panelContainer.classList.toggle("toggled")}static showAbout(){Modal.show({html:Strings.AboutHTML+(App.player&&App.player.audioContext?"<br/><br/><small>Base latency: "+(App.player.audioContext.baseLatency||0).toFixed(4)+" s<br/>Output latency: "+(isNaN(App.player.audioContext.outputLatency)?"-":App.player.audioContext.outputLatency.toFixed(4)+" s")+"</small>":""),title:Strings.About+" (v"+window.CACHE_VERSION+")"})}}
AppUI.primaryInputIsTouch="matchMedia"in window?window.matchMedia("(pointer: coarse)").matches:0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;AppUI.baseSizePX=4;AppUI.s1PX=AppUI.baseSizePX;AppUI.s2PX=2*AppUI.baseSizePX;AppUI.s3PX=3*AppUI.baseSizePX;AppUI.s4PX=4*AppUI.baseSizePX;AppUI.s5PX=5*AppUI.baseSizePX;AppUI.s6PX=6*AppUI.baseSizePX;AppUI.s7PX=7*AppUI.baseSizePX;AppUI.s8PX=8*AppUI.baseSizePX;AppUI.smallFontSizeREM=3;AppUI.smallContentsSizeREM=4;AppUI.fontSizeREM=3.5;
AppUI.contentsSizeREM=6;AppUI.baseThinBorderPX=1;AppUI.baseThickBorderPX=2;AppUI.zoomHandlers=[];AppUI.rootVariables=document.getElementById("root-variables");AppUI.panelContainer=document.getElementById("panel-container");AppUI.fixedPanel=document.getElementById("fixed-panel");AppUI.optionalPanel=document.getElementById("optional-panel");AppUI.iconPlay=document.getElementById("i-play");AppUI.iconPause=document.getElementById("i-pause");AppUI.ruler=document.getElementById("ruler");
AppUI.titleLabel=document.getElementById("title-label");AppUI.artistLabel=document.getElementById("artist-label");AppUI.topMessage=document.getElementById("top-message");AppUI._loading=!1;AppUI.devicePixelRatio=-1;AppUI._1remInPX=1;AppUI._fontScale=1;AppUI._smallIconSizePX=Icon.baseSizePX;AppUI._largeIconSizePX=Icon.baseSizePX<<1;AppUI._thinBorderPX=AppUI.baseThinBorderPX;AppUI._thickBorderPX=AppUI.baseThickBorderPX;AppUI._buttonSizePX=1;AppUI._contentsSizePX=1;AppUI._playlistItemSizePX=1;
AppUI.directoryCancelled=!1;AppUI.topMessageFading=0;AppUI.topMessageTimeout=0;
class App{static mainWindowStateChanged(a,b,c){if(App.isMinimized!==b||App.isMaximized!==c)App.isMinimized=b,App.isMaximized=c,b||(App.titleBar&&(App.titleBar.className=c?"maximized":""),App.iconRestore&&(App.iconRestore.className=c?"":"hidden"),App.iconMaximize&&(App.iconMaximize.className=c?"hidden":""))}static mainWindowClosing(){if(App.player&&App.player.alive){const a=App.closeHandlers,b=[],c=App.player.playlist;InternalStorage.saveAppSettings({devicePixelRatio,playerVolume:App.player.volume,
graphicalFilterControlEnabled:App.graphicalFilterControl?App.graphicalFilterControl.enabled:!1,graphicalFilterControlSimpleMode:App.graphicalFilterControl?App.graphicalFilterControl.simpleMode:!0,stereoPannerControlEnabled:App.stereoPannerControl?App.stereoPannerControl.enabled:!1,monoDownMixerControlEnabled:App.monoDownMixerControl?App.monoDownMixerControl.enabled:!1,filePickerLastPath:FilePicker.lastPath,filePickerRootLength:FilePicker.lastRootLength});App.player.destroy(!0);App.graphicalFilterControl&&
App.graphicalFilterControl.saveSettings();App.stereoPannerControl&&App.stereoPannerControl.saveSettings();if(a&&a.length)for(let d=a.length-1;0<=d;d--)if(a[d]){const e=a[d]();e&&b.push(e)}c&&InternalStorage.savePlaylistWeb(c);App.ipcRenderer&&(b.length?Promise.all(b).then(App.destroy,App.destroy):App.destroy())}}static destroy(){App.player&&App.player.destroy();AppUI.destroy();const a=App.ipcRenderer;zeroObject(App);a&&a.invoke("mainWindowFinalClose")}static updateLoadingIcon(){App.iconLoading&&(App.iconLoading.style.display=
App.loading?"":"none")}static get loading(){return(App.player?App.player.loading:!1)||AppUI.loading||App._loading}static set loading(a){App._loading!==a&&(App._loading=a,App.updateLoadingIcon())}static get installPromptReady(){return!!App.installPrompt}static showInstallPrompt(){const a=App.installPrompt;if(a&&a.prompt)try{App.installPrompt=null,a.prompt()}catch(b){}}static beforeInstallPrompt(a){"preventDefault"in a&&a.preventDefault();App.installPrompt=a}static adjustCover(){const a=document.getElementById("cover");
if(a){const b=document.body.getBoundingClientRect();a.style.transform=`scale(${Math.ceil(.5*b.right)}, ${Math.ceil(.5*b.bottom)})`}}static sortFiles(a){if(a.length){const b=Strings.comparer;a[0]["data-path"]?a.sort(function(c,d){return b(c["data-path"],d["data-path"])}):a[0].webkitRelativePath?a.sort(function(c,d){return b(c.webkitRelativePath,d.webkitRelativePath)}):a.sort(function(c,d){return b(c.name,d.name)})}return a}static async preInit(){Strings.init();Icon.init();GraphicalFilterEditorStrings.init(Strings.language);
Strings.toFixed=GraphicalFilterEditorStrings.toFixed;if(!App.hostInterface&&FileSystemAPI.isSupported())try{await FileSystemAPI.init()}catch(c){Alert.show(c.message||c.toString())}const a=InternalStorage.loadAppSettings(),b=window.electronWebFrame;App.ipcRenderer&&delete window.electronIpcRenderer;b&&delete window.electronWebFrame;if("serviceWorker"in navigator&&!location.href.startsWith("file://")){window.addEventListener("beforeinstallprompt",App.beforeInstallPrompt);const c=navigator.serviceWorker.register("sw.js");
c&&"then"in c&&c.then(function(d){d&&"onupdatefound"in d&&d.active&&(d.onupdatefound=function(){Modal.show({html:Strings.PleaseRefresh,title:Strings.UpdateAvailable,okText:Strings.Refresh,okCancel:!0,onok:function(){window.location.reload()}})})})}window.addEventListener("resize",App.adjustCover);App.adjustCover();App.ipcRenderer?(App.ipcRenderer.on("mainWindowStateChanged",App.mainWindowStateChanged),App.ipcRenderer.on("mainWindowClosing",App.mainWindowClosing),App.triggerMainWindowStateChanged()):
App.hostInterface||window.addEventListener("onpagehide"in window?"pagehide":"unload",App.mainWindowClosing);App.frameless&&(App.titleBar=document.createElement("h1"),App.titleBar.innerHTML=`
				<div></div>
				<i id="icon-main"></i>
				FPlay
				<span><span role="button" onclick="App.mainWindowMinimize()">${Icon.createHTML("icon-minimize",!1)}</span><span role="button" onclick="App.mainWindowRestoreOrMaximize()">${Icon.createHTML("icon-restore",!1,"hidden","icon-restore-i")}${Icon.createHTML("icon-maximize",!1,null,"icon-maximize-i")}</span><span role="button" class="close" onclick="App.mainWindowClose()">${Icon.createHTML("icon-close",!1)}</span></span>
			`,document.body.insertBefore(App.titleBar,document.body.firstChild),App.iconRestore=document.getElementById("icon-restore-i"),App.iconMaximize=document.getElementById("icon-maximize-i"));AppUI.preInit(b,a);App.init(a)}static init(a){if(!App.player){App.player=new Player(a.playerVolume,function(c){App.graphicalFilterControl=new GraphicalFilterControl(document.getElementById("filter-container"),document.getElementById("optional-panel-container"),c,a.graphicalFilterControlSimpleMode);App.graphicalFilterControl.enabled=
!!a.graphicalFilterControlEnabled;return App.graphicalFilterControl},function(c){App.stereoPannerControl=new StereoPannerControl(document.getElementById("stereo-panner-slider"),c);App.stereoPannerControl.enabled=!!a.stereoPannerControlEnabled;App.stereoPannerControl.onappliedgainchanged=function(d){App.monoDownMixerControl&&(App.monoDownMixerControl.multiplier=1/(1+d))};return App.stereoPannerControl},function(c){App.monoDownMixerControl=new MonoDownMixerControl(c);App.monoDownMixerControl.enabled=
MonoDownMixerControl.isSupported()&&!!a.monoDownMixerControlEnabled;return App.monoDownMixerControl});var b=InternalStorage.loadPlaylistWeb();b&&(App.player.playlist=b);AppUI.init(a);(b=document.getElementById("cover"))&&b.classList.remove("in");DelayControl.delayShortCB(function(){AppUI.centerCurrentSongIntoView();DelayControl.delayUICB(function(){window.removeEventListener("resize",App.adjustCover);const c=document.getElementById("cover");c&&document.body.removeChild(c)})});App.loading=!1}}static triggerMainWindowStateChanged(){App.ipcRenderer&&
App.ipcRenderer.invoke("triggerMainWindowStateChanged")}static mainWindowMinimize(){App.ipcRenderer&&App.ipcRenderer.invoke("mainWindowMinimize")}static mainWindowRestoreOrMaximize(){App.ipcRenderer&&App.ipcRenderer.invoke(App.isMaximized?"mainWindowRestore":"mainWindowMaximize")}static mainWindowClose(){App.ipcRenderer&&App.ipcRenderer.invoke("mainWindowClose")}static extractMetadata(a,b){return App.ipcRenderer.invoke("extractMetadata",a,b)}static showOpenDialogWeb(a,b){const c=document.createElement("input");
c.setAttribute("type","file");c.setAttribute("multiple","multiple");c.setAttribute("aria-label",Strings.AddSongs);a?(c.setAttribute("webkitdirectory","webkitdirectory"),c.setAttribute("directory","directory")):c.setAttribute("accept",FileUtils.concatenatedSupportedExtensions);c.onchange=function(){if(App.fileInputPromiseResolve){var e=App.fileInputPromiseResolve;App.fileInputPromiseResolve=null;if(c.files&&c.files.length&&(1!==c.files.length||FileUtils.isTypeSupported(c.files[0].name))){var f=Array(c.files.length);
for(let g=f.length-1;0<=g;g--)f[g]=c.files[g];c.value="";e(b?f:App.sortFiles(f))}else e(null)}};a=App.fileInputPromiseResolve;App.fileInputPromiseResolve=null;const d=new Promise(function(e){App.fileInputPromiseResolve=e});c.click();a&&a(null);return d}}App.hostTypeElectron="Electron";App.hostTypeAndroid="Android";App.ipcRenderer=window.electronIpcRenderer||null;App.closeHandlers=[];App.frameless=!!window.electronIpcRenderer;App.hostInterface=window.hostInterface||null;
App.hostType=App.hostInterface&&App.hostInterface.getHostType()||null;App.iconLoading=document.getElementById("icon-loading");App.titleBar=null;App.iconRestore=null;App.iconMaximize=null;App.installPrompt=null;App.fileInputPromiseResolve=null;App._loading=!0;App.isMinimized=!1;App.isMaximized=!1;function main(){App.preInit().catch(console.error)}let cLib;
function cancelEvent(a){a&&("isCancelled"in a&&(a.isCancelled=!0),!("preventDefault"in a)||"cancelable"in a&&!a.cancelable||a.preventDefault(),"stopPropagation"in a&&a.stopPropagation());return!1}function lerp(a,b,c,d,e){return(e-a)*(d-b)/(c-a)+b}function smoothStep(a,b,c){a=(c-a)/(b-a);return 0>=a?0:1<=a?1:a*a*(3-2*a)}
function zeroObject(a){for(let b in a)switch(typeof a[b]){case "function":break;case "boolean":a[b]=!1;break;case "number":a[b]=0;break;default:const c=a[b];Array.isArray(c)&&c.fill(null);a[b]=null}}
function setup(){function a(c){window.CLib(c).then(function(d){cLib=d;window.main&&window.main()},function(d){alert(d);throw d;})}Array.prototype.fill||(Array.prototype.fill=function(c,d,e){var f=this.length|0;d|=0;e=void 0===e?f:e|0;e=0>e?Math.max(f+e,0):Math.min(e,f);for(d=0>d?Math.max(f+d,0):Math.min(d,f);d<e;)this[d++]=c;return this});var b=window.CLibWasmBinary;b?(delete window.CLibWasmBinary,Promise.resolve(b).then(function(c){a({wasmBinary:c})},function(){a()})):(b=window.CLibMemoryArrayBuffer)?
(delete window.CLibMemoryArrayBuffer,Promise.resolve(b).then(function(c){a({memoryInitializerRequest:{status:200,response:c}})},function(){a()})):a()}setup();
