/*	MikMod Web Audio library v0.0.1
	(c) 2021 Carlos Rafael Gimenes das Neves.

	https://github.com/sezero/mikmod
	https://github.com/carlosrafaelgn/mikmod/tree/master/libmikmod/webaudio

	This library is free software; you can redistribute it and/or modify
	it under the terms of the GNU Library General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Library General Public License for more details.

	You should have received a copy of the GNU Library General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
	02111-1307, USA.
*/
"use strict";var LibMikModMessageId;(function(b){b[b.INIT=1]="INIT";b[b.LOAD_MODULE_BUFFER=2]="LOAD_MODULE_BUFFER";b[b.CHANGE_GENERAL_OPTIONS=3]="CHANGE_GENERAL_OPTIONS";b[b.STOP_MODULE=4]="STOP_MODULE";b[b.PLAYBACK_ERROR=5]="PLAYBACK_ERROR";b[b.PLAYBACK_ENDED=6]="PLAYBACK_ENDED"})(LibMikModMessageId||(LibMikModMessageId={}));
class LibMikMod{static init(b){return LibMikMod.loaded?Promise.resolve():new Promise((d,f)=>{LibMikMod.loading?f(LibMikMod.loadErrorStr="The library was still loading"):LibMikMod.loadErrorStr?f(LibMikMod.loadErrorStr):(LibMikMod.loading=!0,LibMikModCLib({wasmBinary:b}).then(e=>{LibMikMod.cLib=e;(e=e._init())?(LibMikMod.loading=!1,f(LibMikMod.loadErrorStr=LibMikMod.getStrerr(e))):(LibMikMod.loading=!1,LibMikMod.loaded=!0,LibMikMod.loadErrorStr=null,d())},e=>{LibMikMod.loading=!1;f(LibMikMod.loadErrorStr=
(e?e.message||e.toString():null)||"Unknown error while loading the library")}))})}static terminate(){LibMikMod.cLib&&(LibMikMod.cLib._terminate(),LibMikMod.cLib=null,LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static getVersion(){return LibMikMod.cLib?LibMikMod.cLib._getVersion():0}static loadModule(b,d,f){if(!LibMikMod.cLib)return 3;if(!d)return 2;var e=LibMikMod.cLib._preLoadModule(d.byteLength);if(!e)return 2;e=new Uint8Array(LibMikMod.cLib.HEAP8.buffer,e,d.byteLength);"set"in
d?e.set(d,0):e.set(new Uint8Array(d,0,d.byteLength),0);LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;f&&(void 0!==f.reverb&&0<=f.reverb&&15>=f.reverb&&(LibMikMod.lastReverb=f.reverb),void 0!==f.hqMixer&&(LibMikMod.lastHqMixer=f.hqMixer?1:0),void 0!==f.interpolation&&(LibMikMod.lastInterpolation=f.interpolation?1:0),void 0!==f.noiseReduction&&(LibMikMod.lastNoiseReduction=f.noiseReduction?1:0),void 0!==f.wrap&&(LibMikMod.lastWrap=f.wrap?1:0),void 0!==f.loop&&(LibMikMod.lastLoop=f.loop?
1:0),void 0!==f.fadeout&&(LibMikMod.lastFadeout=f.fadeout?1:0));return(b=LibMikMod.cLib._loadModule(b,LibMikMod.lastReverb,LibMikMod.lastHqMixer,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction,LibMikMod.lastWrap,LibMikMod.lastLoop,LibMikMod.lastFadeout))||LibMikMod.cLib._getAudioBuffer()?b:2}static changeGeneralOptions(b){b&&(void 0!==b.reverb&&0<=b.reverb&&15>=b.reverb&&(LibMikMod.lastReverb=b.reverb),void 0!==b.interpolation&&(LibMikMod.lastInterpolation=b.interpolation?1:0),void 0!==b.noiseReduction&&
(LibMikMod.lastNoiseReduction=b.noiseReduction?1:0),LibMikMod.cLib&&LibMikMod.cLib._changeGeneralOptions(LibMikMod.lastReverb,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction))}static stopModule(){LibMikMod.cLib&&(LibMikMod.cLib._freeModule(),LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static getString(b){if(LibMikMod.cLib&&b){const f=LibMikMod.cLib.HEAP8;let e=0;for(var d=b;f[d]&&1024>e;d++)e++;if(!e)return"";for(d=Array(e);0<e--;)d[e]=f[b+e];return String.fromCharCode.apply(String,
d)}return null}static getSongName(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getSongName()):null}static getModType(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getModType()):null}static getComment(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getComment()):null}static getErrno(){return LibMikMod.cLib?LibMikMod.cLib._getErrno():0}static getStrerr(b){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getStrerr(b)):null}static process(b){if(!LibMikMod.cLib)return!1;
let d=LibMikMod.audioBufferUsedLength;if(!d){for(var f=0;3>f;f++){d=LibMikMod.cLib._update();if(0>d)return!1;if(d){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=d;break}}if(!d)return!0}var e=null;for(f=b.length-1;0<=f;f--){const t=b[f];for(let u=t.length-1;0<=u;u--){const p=t[u];if(!e){var l=p.length<<2;if(d>=l)d=l,e=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,d>>2),LibMikMod.audioBufferPtr+=d,LibMikMod.audioBufferUsedLength-=d;
else{LibMikMod.tmpBuffer&&LibMikMod.tmpBuffer.byteLength===l||(LibMikMod.tmpBuffer=new Float32Array(p.length));l=d>>2;e=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,l);LibMikMod.audioBufferPtr=0;d=LibMikMod.audioBufferUsedLength=0;LibMikMod.tmpBuffer.set(e);let v=p.length-l;for(;0<v;){if(!d){for(e=0;3>e;e++){d=LibMikMod.cLib._update();if(0>d){if(LibMikMod.getErrno())return!1;d=0;break}if(d){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=
d;break}}if(!d){LibMikMod.tmpBuffer.fill(0,l);break}}let n=v<<2;n>d&&(n=d);const a=n>>2;e=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,a);LibMikMod.audioBufferPtr+=n;LibMikMod.audioBufferUsedLength-=n;LibMikMod.tmpBuffer.set(e,l);l+=a;v-=a}e=LibMikMod.tmpBuffer}}p.set(e)}}return!0}}LibMikMod.cLib=null;LibMikMod.tmpBuffer=null;LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;LibMikMod.lastReverb=0;LibMikMod.lastHqMixer=1;LibMikMod.lastInterpolation=1;
LibMikMod.lastNoiseReduction=1;LibMikMod.lastWrap=0;LibMikMod.lastLoop=0;LibMikMod.lastFadeout=1;LibMikMod.loading=!1;LibMikMod.loaded=!1;LibMikMod.loadErrorStr=null;
class LibMikModProcessor extends AudioWorkletProcessor{constructor(){super();this.id=0;this.ended=!1;this.port.onmessage=this.handleMessage.bind(this)}postResponse(b){this.port&&this.port.postMessage(b)}handleMessage(b){if(b=b.data)switch(b.messageId){case LibMikModMessageId.INIT:if(b.id||this.id||LibMikMod.loaded||LibMikMod.loading||LibMikMod.loadErrorStr||!b.buffer)break;LibMikMod.init(b.buffer).then(()=>{this.ended=!0;this.id=-1;this.postResponse({id:LibMikMod.getVersion(),messageId:LibMikModMessageId.INIT})},
()=>{this.ended=!0;this.id=-1;this.postResponse({id:0,messageId:LibMikModMessageId.INIT,errorCode:-1,errorStr:LibMikMod.loadErrorStr})});break;case LibMikModMessageId.LOAD_MODULE_BUFFER:if(!b.id||this.id)break;this.id=b.id;const d=LibMikMod.loadModule(sampleRate,b.buffer,b.options);d?(this.ended=!0,this.id=-1,LibMikMod.stopModule(),this.postResponse({id:b.id,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,errorCode:d,errorStr:LibMikMod.getStrerr(d)})):this.postResponse({id:this.id,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,
infoSongName:LibMikMod.getSongName(),infoModType:LibMikMod.getModType(),infoComment:LibMikMod.getComment()});break;case LibMikModMessageId.CHANGE_GENERAL_OPTIONS:if(b.id!==this.id)break;LibMikMod.changeGeneralOptions(b.options);break;case LibMikModMessageId.STOP_MODULE:b.id===this.id&&(this.ended=!0,this.id=-1,LibMikMod.stopModule())}}process(b,d,f){return this.ended?!1:LibMikMod.process(d)?!0:(this.ended||(b=this.id,d=LibMikMod.getErrno(),this.ended=!0,this.id=-1,LibMikMod.stopModule(),d?this.postResponse({id:b,
messageId:LibMikModMessageId.PLAYBACK_ERROR,errorCode:d,errorStr:LibMikMod.getStrerr(d)}):this.postResponse({id:b,messageId:LibMikModMessageId.PLAYBACK_ENDED})),!1)}}registerProcessor("libmikmodprocessor",LibMikModProcessor);
var LibMikModCLib=(()=>{var b="undefined"!==typeof document&&document.currentScript?document.currentScript.src:void 0;return function(d={}){function f(c){return a.locateFile?a.locateFile(c,m):m+c}function e(){var c=A.buffer;a.HEAP8=new Int8Array(c);a.HEAP16=new Int16Array(c);a.HEAP32=new Int32Array(c);a.HEAPU8=F=new Uint8Array(c);a.HEAPU16=new Uint16Array(c);a.HEAPU32=new Uint32Array(c);a.HEAPF32=new Float32Array(c);a.HEAPF64=new Float64Array(c)}function l(c){if(a.onAbort)a.onAbort(c);c="Aborted("+
c+")";w(c);J=!0;c=new WebAssembly.RuntimeError(c+". Build with -sASSERTIONS for more info.");B(c);throw c;}function t(c){try{if(c==x&&y)return new Uint8Array(y);if(G)return G(c);throw"both async and sync fetching of the wasm failed";}catch(g){l(g)}}function u(c){if(!y&&(K||C)){if("function"==typeof fetch&&!c.startsWith("file://"))return fetch(c,{credentials:"same-origin"}).then(g=>{if(!g.ok)throw"failed to load wasm binary file at '"+c+"'";return g.arrayBuffer()}).catch(()=>t(c));if(L)return new Promise((g,
k)=>{L(c,h=>g(new Uint8Array(h)),k)})}return Promise.resolve().then(()=>t(c))}function p(c,g,k){return u(c).then(h=>WebAssembly.instantiate(h,g)).then(h=>h).then(k,h=>{w("failed to asynchronously prepare wasm: "+h);l(h)})}function v(c,g,k,h){return c||"function"!=typeof WebAssembly.instantiateStreaming||g.startsWith("data:application/octet-stream;base64,")||g.startsWith("file://")||"function"!=typeof fetch?p(g,k,h):fetch(g,{credentials:"same-origin"}).then(r=>WebAssembly.instantiateStreaming(r,k).then(h,
function(D){w("wasm streaming compile failed: "+D);w("falling back to ArrayBuffer instantiation");return p(g,k,h)}))}function n(){function c(){if(!E&&(E=!0,a.calledRun=!0,!J)){H(M);N(a);if(a.onRuntimeInitialized)a.onRuntimeInitialized();if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)O.unshift(a.postRun.shift());H(O)}}if(!(0<q)){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)P.unshift(a.preRun.shift());H(P);0<q||(a.setStatus?
(a.setStatus("Running..."),setTimeout(function(){setTimeout(function(){a.setStatus("")},1);c()},1)):c())}}var a=d,N,B;a.ready=new Promise((c,g)=>{N=c;B=g});var Q=Object.assign({},a),K="object"==typeof window,C="function"==typeof importScripts,m="",G;if(K||C){C?m=self.location.href:"undefined"!=typeof document&&document.currentScript&&(m=document.currentScript.src);b&&(m=b);m=0!==m.indexOf("blob:")?m.substr(0,m.replace(/[?#].*/,"").lastIndexOf("/")+1):"";C&&(G=c=>{var g=new XMLHttpRequest;g.open("GET",
c,!1);g.responseType="arraybuffer";g.send(null);return new Uint8Array(g.response)});var L=(c,g,k)=>{var h=new XMLHttpRequest;h.open("GET",c,!0);h.responseType="arraybuffer";h.onload=()=>{200==h.status||0==h.status&&h.response?g(h.response):k()};h.onerror=k;h.send(null)}}a.print||console.log.bind(console);var w=a.printErr||console.error.bind(console);Object.assign(a,Q);Q=null;var y;a.wasmBinary&&(y=a.wasmBinary);"object"!=typeof WebAssembly&&l("no native wasm support detected");var A,J=!1,F,P=[],M=
[],O=[],q=0,I=null,z=null;var x="libmikmodclib.wasm";x.startsWith("data:application/octet-stream;base64,")||(x=f(x));var H=c=>{for(;0<c.length;)c.shift()(a)},R={b:(c,g,k)=>F.copyWithin(c,g,g+k),a:c=>{var g=F.length;c>>>=0;if(33554432<c)return!1;for(var k=1;4>=k;k*=2){var h=g*(1+.2/k);h=Math.min(h,c+100663296);var r=Math;h=Math.max(c,h);a:{r=r.min.call(r,33554432,h+(65536-h%65536)%65536)-A.buffer.byteLength+65535>>>16;try{A.grow(r);e();var D=1;break a}catch(S){}D=void 0}if(D)return!0}return!1}};(function(){function c(k,
h){k=k.exports;a.asm=k;A=a.asm.c;e();M.unshift(a.asm.d);q--;a.monitorRunDependencies&&a.monitorRunDependencies(q);0==q&&(null!==I&&(clearInterval(I),I=null),z&&(h=z,z=null,h()));return k}var g={a:R};q++;a.monitorRunDependencies&&a.monitorRunDependencies(q);if(a.instantiateWasm)try{return a.instantiateWasm(g,c)}catch(k){w("Module.instantiateWasm callback failed with error: "+k),B(k)}v(y,x,g,function(k){c(k.instance)}).catch(B);return{}})();a._getAudioBuffer=function(){return(a._getAudioBuffer=a.asm.f).apply(null,
arguments)};a._getAudioBufferMaxLength=function(){return(a._getAudioBufferMaxLength=a.asm.g).apply(null,arguments)};a._getAudioBufferUsedLength=function(){return(a._getAudioBufferUsedLength=a.asm.h).apply(null,arguments)};a._getVersion=function(){return(a._getVersion=a.asm.i).apply(null,arguments)};a._init=function(){return(a._init=a.asm.j).apply(null,arguments)};a._freeModule=function(){return(a._freeModule=a.asm.k).apply(null,arguments)};a._terminate=function(){return(a._terminate=a.asm.l).apply(null,
arguments)};a._preLoadModule=function(){return(a._preLoadModule=a.asm.m).apply(null,arguments)};a._loadModule=function(){return(a._loadModule=a.asm.n).apply(null,arguments)};a._changeGeneralOptions=function(){return(a._changeGeneralOptions=a.asm.o).apply(null,arguments)};a._update=function(){return(a._update=a.asm.p).apply(null,arguments)};a._getErrno=function(){return(a._getErrno=a.asm.q).apply(null,arguments)};a._getStrerr=function(){return(a._getStrerr=a.asm.r).apply(null,arguments)};a._getSongName=
function(){return(a._getSongName=a.asm.s).apply(null,arguments)};a._getModType=function(){return(a._getModType=a.asm.t).apply(null,arguments)};a._getComment=function(){return(a._getComment=a.asm.u).apply(null,arguments)};var E;z=function g(){E||n();E||(z=g)};if(a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);0<a.preInit.length;)a.preInit.pop()();n();return d.ready}})();
"object"===typeof exports&&"object"===typeof module?module.exports=LibMikModCLib:"function"===typeof define&&define.amd?define([],function(){return LibMikModCLib}):"object"===typeof exports&&(exports.LibMikModCLib=LibMikModCLib);
